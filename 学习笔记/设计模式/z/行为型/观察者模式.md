# 观察者模式

当对象间存在一对多关系时，则使用观察者模式（`Observer Pattern`）。比如，当一个对象被修改时，则会自动通知依赖它的对象。观察者模式属于行为型模式，有时也称为：发布订阅模式。

实现发布订阅模式的关键是：实现向多个订阅者发布消息。



### 介绍

**意图：**定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。

**主要解决：**一个对象状态改变给其他对象通知的问题，而且要考虑到易用和低耦合，保证高度的协作。

**何时使用：**一个对象（目标对象）的状态发生改变，所有的依赖对象（观察者对象）都将得到通知，进行广播通知。

**如何解决：**使用面向对象技术，可以将这种依赖关系弱化。

**关键代码：**在抽象类里有一个 `ArrayList` 存放观察者们。

**应用实例：** 

- 拍卖的时候，拍卖师观察最高标价，然后通知给其他竞价者竞价。
- 西游记里面悟空请求菩萨降服红孩儿，菩萨洒了一地水招来一个老乌龟，这个乌龟就是观察者，他观察菩萨洒水这个动作。

**优点：** 

- 观察者和被观察者是抽象耦合的。 
- 建立一套触发机制。

**缺点：** 

- 如果一个被观察者对象有很多的直接和间接的观察者的话，将所有的观察者都通知到会花费很多时间。
- 如果在观察者和观察目标之间有循环依赖的话，观察目标会触发它们之间进行循环调用，可能导致系统崩溃。
- 观察者模式没有相应的机制让观察者知道所观察的目标对象是怎么发生变化的，而仅仅只是知道观察目标发生了变化。

**使用场景：**

- 一个抽象模型有两个方面，其中一个方面依赖于另一个方面。将这些方面封装在独立的对象中使它们可以各自独立地改变和复用。
- 一个对象的改变将导致其他一个或多个对象也发生改变，而不知道具体有多少对象将发生改变，可以降低对象之间的耦合度。
- 一个对象必须通知其他对象，而并不知道这些对象是谁。
- 需要在系统中创建一个触发链，`A` 对象的行为将影响 `B` 对象，`B` 对象的行为将影响 `C` 对象 ……，可以使用观察者模式创建一种链式触发机制。

**注意事项：** 

- `JAVA` 中已经有了对观察者模式的支持类。
- 避免循环引用。
- 如果顺序执行，某一观察者错误会导致系统卡壳，一般采用异步方式。



### 实现

`DOM` 二级事件监听，就是最典型的观察者模式的应用。例如，当点击某元素时，触发其绑定的所有点击事件处理函数。

```js
document.addEventListener("click", () => {
    // 订阅者 1 回调
    console.log(1);
});

document.addEventListener("click", () => {
    // 订阅者 2 回调
    console.log(2);
});

// ...
```

由系统通知各个订阅者，触发它们采取相应的行动。例如，由浏览器（系统）通知事件（订阅者）触发其处理程序的执行。

##### 简单实现

```js
class Observer {
    constructor() {
        this.subscriberCbArr = []; // 订阅者回调列表
    }
    // 订阅阶段（记录订阅者，保存其回调函数）
    subscribe(callback) {
        this.subscriberCbArr.push(callback);
    }
    // 发布阶段（通知订阅者，触发其回调函数）
    publish() {
        this.subscriberCbArr.forEach(fn => fn());
    }
}

let observer = new Observer();

// 订阅
observer.subscribe(function() {
    console.log(1);
});
observer.subscribe(function() {
    console.log(2);
});

// 发布
observer.publish();
```

##### 封装优化

```js
class Observer {
    constructor() {
        this.subscribers = {};
    }
    sub(type, fn) {
        this.subscribers[type] || (this.subscribers[type] = []);
        this.subscribers[type].push(fn);
    }
    pub(type, msg) {
        this.subscribers[type].forEach(fn => fn(msg));
    }
}

let obs = new Observer();

obs.sub("click", function(msg) {console.log(msg, 1)});
obs.sub("click", function(msg) {console.log(msg, 2)});

obs.sub("mousemove", function(msg) {console.log(msg, 1)});
obs.sub("mousemove", function(msg) {console.log(msg, 2)});

obs.pub("click", "click--msg");
obs.pub("mousemove", "mousemove--msg");
```

##### 开播提醒

首先，定义一个主播类。

```js
let Anchor = (function () {
    let id = 0;
    return class {
        constructor(name, type) {
            this.id = id++; // 主播的身份标识
            this.fans = []; // 主播的粉丝列表

            this.name = name;
            this.type = type;
            // ...
        }
        // 当粉丝关注主播后，才会将其添加到主播的粉丝列表中。
        addFans(id) {
            this.fans.push(id); // 保存粉丝的id即可，通过id去数据库中查询。
        }
    }
})();
```

然后，定义一个观众类。

```js
let Viewer = (function () {
    let id = 0;
    return class {
        constructor(name, type) {
            this.id = id++;      // 用户的身份标识
            this.followers = []; // 用户的关注列表

            this.name = name;
            // ...
        }
        // 当用户关注主播后，会将其添加到该主播的粉丝列表中。
        addAnchor(id) {
            this.followers.push(id); // 保存主播的id即可，通过id去数据库中查询。
        }
        // 开播通知（当主播开播时，通知其所有粉丝）
        notify(anchor) {
            console.log(`${this.name}，你关注的 "${anchor.name}" 开播了！！！`);
        }
    }
})();
```

接着，定义一个观察者类。

```js
class Observer {
    // 订阅
    sub(viewer, anchorId) {
        // 粉丝关注主播，主播粉丝增加
        viewer.addAnchor(anchorId);
        anchorList.find(anchor => anchor.id === anchorId).addFans(viewer.id);
    }
    // 发布
    pub(anchor) {
        // 主播开播之后，通知所有粉丝
        anchor.fans.forEach(fanId => {
            viewerList.find(fan => fan.id === fanId).notify(anchor);
        });
    }
}
```

定义一个数据库。

```js
// 数据库

// 主播列表
let anchorList = [
    new Anchor("1 号主播", "游戏主播"),
    new Anchor("2 号主播", "美食主播"),
    new Anchor("3 号主播", "才艺主播")
    // ...
];

// 用户列表
let viewerList = [
    new Viewer("用户 1"),
    new Viewer("用户 2"),
    new Viewer("用户 3")
    // ...
];
```

最后，使用即可。

```js
// 使用
let obs = new Observer();

// 订阅
// 用户 1 关注主播
obs.sub(viewerList[0], 0);
obs.sub(viewerList[0], 1);
obs.sub(viewerList[0], 2);
// 用户 2 关注主播
obs.sub(viewerList[1], 1);
obs.sub(viewerList[1], 2);
// 用户 3 关注主播
obs.sub(viewerList[2], 0);
obs.sub(viewerList[2], 1);

// 发布
// 主播 1 正在开播
obs.pub(anchorList[0]);
// 主播 2 正在开播
obs.pub(anchorList[1]);
// 主播 3 正在开播
obs.pub(anchorList[2]);
```


