# `JavaScript API`

â€‹		éšç€ `Web` æµè§ˆå™¨èƒ½åŠ›çš„å¢åŠ ï¼Œå…¶å¤æ‚æ€§ä¹Ÿåœ¨è¿…é€Ÿå¢åŠ ã€‚ä»å¾ˆå¤šæ–¹é¢çœ‹ï¼Œç°ä»£ `Web` æµè§ˆå™¨å·²ç»æˆä¸ºæ„å»ºäºè¯¸å¤šè§„èŒƒä¹‹ä¸Šã€é›†ä¸åŒ `API` äºä¸€èº«çš„ â€œç‘å£«å†›åˆ€â€ã€‚æµè§ˆå™¨è§„èŒƒçš„ç”Ÿæ€åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯æ··ä¹±è€Œæ— åºçš„ã€‚ä¸€äº›è§„èŒƒå¦‚ `HTML5`ï¼Œå®šä¹‰äº†ä¸€æ‰¹å¢å¼ºå·²æœ‰æ ‡å‡†çš„ `API` å’Œæµè§ˆå™¨ç‰¹æ€§ã€‚è€Œå¦ä¸€äº›è§„èŒƒå¦‚ `Web Cryptography API` å’Œ `Notifications API`ï¼Œåªä¸ºä¸€ä¸ªç‰¹æ€§å®šä¹‰äº†ä¸€ä¸ª `API`ã€‚ä¸åŒæµè§ˆå™¨å®ç°è¿™äº›æ–° `API` çš„æƒ…å†µä¹Ÿä¸åŒï¼Œæœ‰çš„ä¼šå®ç°å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œæœ‰çš„åˆ™å¹²è„†å°šæœªå®ç°ã€‚

â€‹		æœ€ç»ˆï¼Œæ˜¯å¦ä½¿ç”¨è¿™äº›æ¯”è¾ƒæ–°çš„ `API` è¿˜è¦çœ‹é¡¹ç›®æ˜¯æ”¯æŒæ›´å¤šæµè§ˆå™¨ï¼Œè¿˜æ˜¯è¦é‡‡ç”¨æ›´å¤šç°ä»£ç‰¹æ€§ã€‚æœ‰äº› `API` å¯ä»¥é€šè¿‡è…»å­è„šæœ¬æ¥æ¨¡æ‹Ÿï¼Œä½†è…»å­è„šæœ¬é€šå¸¸ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œæ­¤å¤–ä¹Ÿä¼šå¢åŠ ç½‘ç«™ `JavaScript` ä»£ç çš„ä½“ç§¯ã€‚

â€‹		æ³¨æ„ï¼š`Web API` çš„æ•°é‡ä¹‹å¤šä»¤äººéš¾ä»¥ç½®ä¿¡ï¼ˆå‚è§ `MDN` æ–‡æ¡£çš„ `Web APIs` è¯æ¡ï¼‰ã€‚æœ¬ç« è¦ä»‹ç»çš„ `API` ä»…é™äºä¸å¤§å¤šæ•°å¼€å‘è€…æœ‰å…³ã€å·²ç»å¾—åˆ°å¤šä¸ªæµè§ˆå™¨æ”¯æŒï¼Œä¸”æœ¬ä¹¦å…¶ä»–ç« èŠ‚æ²¡æœ‰æ¶µç›–çš„éƒ¨åˆ†ã€‚



### `Atomics` ä¸ `SharedArrayBuffer`

â€‹		å¤šä¸ªä¸Šä¸‹æ–‡è®¿é—® `SharedArrayBuffer` æ—¶ï¼Œå¦‚æœåŒæ—¶å¯¹ç¼“å†²åŒºæ‰§è¡Œæ“ä½œï¼Œå°±å¯èƒ½å‡ºç°èµ„æºäº‰ç”¨é—®é¢˜ã€‚`Atomics API` é€šè¿‡å¼ºåˆ¶åŒä¸€æ—¶åˆ»åªèƒ½å¯¹ç¼“å†²åŒºæ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œå¯ä»¥è®©å¤šä¸ªä¸Šä¸‹æ–‡å®‰å…¨åœ°è¯»å†™ä¸€ä¸ª `SharedArrayBuffer`ã€‚`Atomics API` æ˜¯ `ES2017` ä¸­å®šä¹‰çš„ã€‚

â€‹		ä»”ç»†ç ”ç©¶ä¼šå‘ç° `Atomics API` éå¸¸åƒä¸€ä¸ªç®€åŒ–ç‰ˆçš„æŒ‡ä»¤é›†æ¶æ„ï¼ˆ`ISA`ï¼‰ï¼Œè¿™å¹¶éæ„å¤–ã€‚åŸå­æ“ä½œçš„æœ¬è´¨ä¼šæ’æ–¥æ“ä½œç³»ç»Ÿæˆ–è®¡ç®—æœºç¡¬ä»¶é€šå¸¸ä¼šè‡ªåŠ¨æ‰§è¡Œçš„ä¼˜åŒ–ï¼ˆæ¯”å¦‚æŒ‡ä»¤é‡æ–°æ’åºï¼‰ã€‚åŸå­æ“ä½œä¹Ÿè®©å¹¶å‘è®¿é—®å†…å­˜å˜å¾—ä¸å¯èƒ½ï¼Œå¦‚æœåº”ç”¨ä¸å½“å°±å¯èƒ½å¯¼è‡´ç¨‹åºæ‰§è¡Œå˜æ…¢ã€‚ä¸ºæ­¤ï¼Œ`Atomics API` çš„è®¾è®¡åˆè¡·æ˜¯åœ¨æœ€å°‘ä½†å¾ˆç¨³å®šçš„åŸå­è¡Œä¸ºåŸºç¡€ä¹‹ä¸Šï¼Œæ„å»ºå¤æ‚çš„å¤šçº¿ç¨‹ `JavaScript` ç¨‹åºã€‚ã€`atomic`ï¼šåŸå­ã€‘



#### `SharedArrayBuffer`

â€‹		`SharedArrayBuffer` ä¸ `ArrayBuffer` å…·æœ‰åŒæ ·çš„ `API`ã€‚äºŒè€…çš„ä¸»è¦åŒºåˆ«æ˜¯ `ArrayBuffer` å¿…é¡»åœ¨ä¸åŒæ‰§è¡Œä¸Šä¸‹æ–‡é—´åˆ‡æ¢ï¼Œ`SharedArrayBuffer` åˆ™å¯ä»¥è¢«ä»»æ„å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡åŒæ—¶ä½¿ç”¨ã€‚

â€‹		**æ³¨æ„**ï¼š`Chrome 64` å’Œ `Firefox 57` å·²ç¦ç”¨ `SharedArrayBuffer` åŠŸèƒ½ï¼Œä»¥ä¸‹ä»£ç ä¸­çš„ `SharedArrayBuffer` å¯ç”¨ `ArrayBuffer` æš‚æ—¶ä»£æ›¿ã€‚

â€‹		åœ¨å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡é—´å…±äº«å†…å­˜æ„å‘³ç€å¹¶å‘çº¿ç¨‹æ“ä½œæˆä¸ºäº†å¯èƒ½ã€‚ä¼ ç»Ÿ `JavaScript` æ“ä½œå¯¹äºå¹¶å‘å†…å­˜è®¿é—®å¯¼è‡´çš„èµ„æºäº‰ç”¨æ²¡æœ‰æä¾›ä¿æŠ¤ã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº† 4 ä¸ªä¸“ç”¨å·¥ä½œçº¿ç¨‹è®¿é—®åŒä¸€ä¸ª `SharedArrayBuffer` å¯¼è‡´çš„èµ„æºäº‰ç”¨é—®é¢˜ï¼š

```js
const workerScript = ` 
	self.onmessage = ({data}) => { 
 		const view = new Uint32Array(data);
        
 		// æ‰§è¡Œ 1 000 000 æ¬¡åŠ æ“ä½œ
 		for (let i = 0; i < 1E6; ++i) { 
 			// çº¿ç¨‹ä¸å®‰å…¨åŠ æ“ä½œä¼šå¯¼è‡´èµ„æºäº‰ç”¨
 			view[0] += 1; 
 		} 
 		self.postMessage(null); 
	}; 
`; 

const workerScriptBlobUrl = URL.createObjectURL(new Blob([workerScript])); 

// åˆ›å»ºå®¹é‡ä¸º 4 çš„å·¥ä½œçº¿ç¨‹æ± 
const workers = []; 
for (let i = 0; i < 4; ++i) { 
 	workers.push(new Worker(workerScriptBlobUrl)); 
} 

// åœ¨æœ€åä¸€ä¸ªå·¥ä½œçº¿ç¨‹å®Œæˆåæ‰“å°å‡ºæœ€ç»ˆå€¼
let responseCount = 0; 
for (const worker of workers) { 
 	worker.onmessage = () => { 
 		if (++responseCount == workers.length) { 
 			console.log(`Final buffer value: ${view[0]}`); 
 		} 
 	}; 
} 

// åˆå§‹åŒ– SharedArrayBuffer 
const sharedArrayBuffer = new SharedArrayBuffer(4); 
const view = new Uint32Array(sharedArrayBuffer); 
view[0] = 1; 

// æŠŠ SharedArrayBuffer å‘é€åˆ°æ¯ä¸ªå·¥ä½œçº¿ç¨‹
for (const worker of workers) { 
 	worker.postMessage(sharedArrayBuffer); 
} 
//ï¼ˆæœŸå¾…ç»“æœä¸º 4000001ã€‚å®é™…è¾“å‡ºå¯èƒ½ç±»ä¼¼è¿™æ ·ï¼šï¼‰
// Final buffer value: 2145106
```

â€‹		ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ`Atomics API` åº”è¿è€Œç”Ÿã€‚`Atomics API` å¯ä»¥ä¿è¯ `SharedArrayBuffer` ä¸Šçš„ `JavaScript` æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

â€‹		æ³¨æ„ï¼š`SharedArrayBuffer API` ç­‰åŒäº `ArrayBuffer API`ï¼Œå…³äºå¦‚ä½•åœ¨å¤šä¸ªä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ `SharedArrayBuffer`ï¼Œå¯ä»¥å‚è€ƒã€Šå·¥ä½œè€…çº¿ç¨‹ã€‹ä¸€ç« ã€‚



#### åŸå­æ“ä½œåŸºç¡€

â€‹		ä»»ä½•å…¨å±€ä¸Šä¸‹æ–‡ä¸­éƒ½æœ‰ `Atomics` å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸Šæš´éœ²äº†ç”¨äºæ‰§è¡Œçº¿ç¨‹å®‰å…¨æ“ä½œçš„ä¸€å¥—é™æ€æ–¹æ³•ï¼Œå…¶ä¸­å¤šæ•°æ–¹æ³•ä»¥ä¸€ä¸ª `TypedArray` å®ä¾‹ï¼ˆä¸€ä¸ª `SharedArrayBuffer` çš„å¼•ç”¨ï¼‰ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»¥ç›¸å…³æ“ä½œæ•°ä½œä¸ºåç»­å‚æ•°ã€‚

##### ç®—æœ¯åŠä½æ“ä½œæ–¹æ³•

â€‹		`Atomics API` æä¾›äº†ä¸€å¥—ç®€å•çš„æ–¹æ³•ç”¨ä»¥æ‰§è¡Œå°±åœ°ä¿®æ”¹æ“ä½œã€‚åœ¨ `ECMA` è§„èŒƒä¸­ï¼Œè¿™äº›æ–¹æ³•è¢«å®šä¹‰ä¸º `AtomicReadModifyWrite` æ“ä½œã€‚åœ¨åº•å±‚ï¼Œè¿™äº›æ–¹æ³•éƒ½ä¼šä» `SharedArrayBuffer` ä¸­æŸä¸ªä½ç½®è¯»å–å€¼ï¼Œç„¶åæ‰§è¡Œç®—æœ¯æˆ–ä½æ“ä½œï¼Œæœ€åå†æŠŠè®¡ç®—ç»“æœå†™å›ç›¸åŒçš„ä½ç½®ã€‚è¿™äº›æ“ä½œçš„åŸå­æœ¬è´¨æ„å‘³ç€ä¸Šè¿°è¯»å–ã€ä¿®æ”¹ã€å†™å›æ“ä½œä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­ã€‚

â€‹		ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†æ‰€æœ‰ç®—æœ¯æ–¹æ³•ï¼š

```js
// åˆ›å»ºå¤§å°ä¸º 1 çš„ç¼“å†²åŒº
let sharedArrayBuffer = new SharedArrayBuffer(1); 

// åŸºäºç¼“å†²åˆ›å»º Uint8Array 
let typedArray = new Uint8Array(sharedArrayBuffer); 

// æ‰€æœ‰ ArrayBuffer å…¨éƒ¨åˆå§‹åŒ–ä¸º 0 
console.log(typedArray); // Uint8Array[0]

const index = 0; 
const increment = 5; 

// å¯¹ç´¢å¼• 0 å¤„çš„å€¼æ‰§è¡ŒåŸå­åŠ  5 
Atomics.add(typedArray, index, increment); 
console.log(typedArray); // Uint8Array[5]

// å¯¹ç´¢å¼• 0 å¤„çš„å€¼æ‰§è¡ŒåŸå­å‡ 5 
Atomics.sub(typedArray, index, increment); 
console.log(typedArray); // Uint8Array[0]
```

â€‹		ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†æ‰€æœ‰ä½æ–¹æ³•ï¼š

```js
// åˆ›å»ºå¤§å°ä¸º 1 çš„ç¼“å†²åŒº
let sharedArrayBuffer = new SharedArrayBuffer(1); 

// åŸºäºç¼“å†²åˆ›å»º Uint8Array 
let typedArray = new Uint8Array(sharedArrayBuffer); 

// æ‰€æœ‰ ArrayBuffer å…¨éƒ¨åˆå§‹åŒ–ä¸º 0 
console.log(typedArray); // Uint8Array[0]

const index = 0; 

// å¯¹ç´¢å¼• 0 å¤„çš„å€¼æ‰§è¡ŒåŸå­æˆ– 0b1111 
Atomics.or(typedArray, index, 0b1111); 
console.log(typedArray); // Uint8Array[15] 

// å¯¹ç´¢å¼• 0 å¤„çš„å€¼æ‰§è¡ŒåŸå­ä¸ 0b1100 
Atomics.and(typedArray, index, 0b1100); 
console.log(typedArray); // Uint8Array[12]

// å¯¹ç´¢å¼• 0 å¤„çš„å€¼æ‰§è¡ŒåŸå­å¼‚æˆ– 0b1111 
Atomics.xor(typedArray, index, 0b1111); 
console.log(typedArray); // Uint8Array[3]
```

â€‹		å‰é¢çº¿ç¨‹ä¸å®‰å…¨çš„ä¾‹å­å¯ä»¥æ”¹å†™ä¸ºä¸‹é¢è¿™æ ·ï¼š

```js
const workerScript = ` 
 	self.onmessage = ({data}) => { 
 		const view = new Uint32Array(data); 
 		// æ‰§è¡Œ 1 000 000 æ¬¡åŠ æ“ä½œ
 		for (let i = 0; i < 1E6; ++i) { 
 			// çº¿ç¨‹å®‰å…¨çš„åŠ æ“ä½œ
 			Atomics.add(view, 0, 1); 
 		} 
 		self.postMessage(null); 
	}; 
`; 

const workerScriptBlobUrl = URL.createObjectURL(new Blob([workerScript])); 

// åˆ›å»ºå®¹é‡ä¸º 4 çš„å·¥ä½œçº¿ç¨‹æ± 
const workers = []; 
for (let i = 0; i < 4; ++i) { 
 	workers.push(new Worker(workerScriptBlobUrl)); 
} 

// åœ¨æœ€åä¸€ä¸ªå·¥ä½œçº¿ç¨‹å®Œæˆåæ‰“å°å‡ºæœ€ç»ˆå€¼
let responseCount = 0; 
for (const worker of workers) { 
 	worker.onmessage = () => { 
 		if (++responseCount == workers.length) { 
 			console.log(`Final buffer value: ${view[0]}`); 
 		} 
 	}; 
} 

// åˆå§‹åŒ– SharedArrayBuffer 
const sharedArrayBuffer = new SharedArrayBuffer(4); 
const view = new Uint32Array(sharedArrayBuffer); 
view[0] = 1; 

// æŠŠ SharedArrayBuffer å‘é€åˆ°æ¯ä¸ªå·¥ä½œçº¿ç¨‹
for (const worker of workers) { 
    worker.postMessage(sharedArrayBuffer); 
} 

//ï¼ˆæœŸå¾…ç»“æœä¸º 4000001ï¼‰
// Final buffer value: 4000001
```

##### åŸå­è¯»å†™

â€‹		æµè§ˆå™¨çš„ `JavaScript` ç¼–è¯‘å™¨å’Œ `CPU` æ¶æ„æœ¬èº«éƒ½æœ‰æƒé™é‡æ’æŒ‡ä»¤ä»¥æå‡ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œ`JavaScript` çš„å•çº¿ç¨‹ç¯å¢ƒæ˜¯å¯ä»¥éšæ—¶è¿›è¡Œè¿™ç§ä¼˜åŒ–çš„ã€‚ä½†å¤šçº¿ç¨‹ä¸‹çš„æŒ‡ä»¤é‡æ’å¯èƒ½å¯¼è‡´èµ„æºäº‰ç”¨ï¼Œè€Œä¸”æéš¾æ’é”™ã€‚

â€‹		`Atomics API` é€šè¿‡ä¸¤ç§ä¸»è¦æ–¹å¼è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

- æ‰€æœ‰åŸå­æŒ‡ä»¤ç›¸äº’ä¹‹é—´çš„é¡ºåºæ°¸è¿œä¸ä¼šé‡æ’ã€‚
- ä½¿ç”¨åŸå­è¯»æˆ–åŸå­å†™ä¿è¯æ‰€æœ‰æŒ‡ä»¤ï¼ˆåŒ…æ‹¬åŸå­å’ŒéåŸå­æŒ‡ä»¤ï¼‰éƒ½ä¸ä¼šç›¸å¯¹åŸå­è¯»/å†™é‡æ–°æ’åºã€‚è¿™æ„å‘³ç€ä½äºåŸå­è¯»/å†™ä¹‹å‰çš„æ‰€æœ‰æŒ‡ä»¤ä¼šåœ¨åŸå­è¯»/å†™å‘ç”Ÿå‰å®Œæˆï¼Œè€Œä½äºåŸå­è¯»/å†™ä¹‹åçš„æ‰€æœ‰æŒ‡ä»¤ä¼šåœ¨åŸå­è¯»/å†™å®Œæˆåæ‰ä¼šå¼€å§‹ã€‚

â€‹		é™¤äº†è¯»å†™ç¼“å†²åŒºçš„å€¼ï¼Œ`Atomics.load()` å’Œ `Atomics.store()` è¿˜å¯ä»¥æ„å»º â€œä»£ç å›´æ â€ã€‚`JavaScript` å¼•æ“ä¿è¯éåŸå­æŒ‡ä»¤å¯ä»¥ç›¸å¯¹äº `load()` æˆ– `store()` æœ¬åœ°é‡æ’ï¼Œä½†è¿™ä¸ªé‡æ’ä¸ä¼šä¾µçŠ¯åŸå­è¯»/å†™çš„è¾¹ç•Œã€‚ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†è¿™ç§è¡Œä¸ºï¼š

```js
const sharedArrayBuffer = new SharedArrayBuffer(4); 
const view = new Uint32Array(sharedArrayBuffer); 

// æ‰§è¡ŒéåŸå­å†™
view[0] = 1; 

// éåŸå­å†™å¯ä»¥ä¿è¯åœ¨è¿™ä¸ªè¯»æ“ä½œä¹‹å‰å®Œæˆï¼Œå› æ­¤è¿™é‡Œä¸€å®šä¼šè¯»åˆ° 1 
console.log(Atomics.load(view, 0)); // 1 

// æ‰§è¡ŒåŸå­å†™
Atomics.store(view, 0, 2); 

// éåŸå­è¯»å¯ä»¥ä¿è¯åœ¨åŸå­å†™å®Œæˆåå‘ç”Ÿï¼Œå› æ­¤è¿™é‡Œä¸€å®šä¼šè¯»åˆ° 2 
console.log(view[0]); // 2
```

##### åŸå­äº¤æ¢

â€‹		ä¸ºäº†ä¿è¯è¿ç»­ä¸é—´æ–­çš„å…ˆè¯»åå†™ï¼Œ `Atomics API` æä¾›äº†ä¸¤ç§æ–¹æ³•ï¼š `exchange()` å’Œ `compareExchange()`ã€‚`Atomics.exchange()`æ‰§è¡Œç®€å•çš„äº¤æ¢ï¼Œä»¥ä¿è¯å…¶ä»–çº¿ç¨‹ä¸ä¼šä¸­æ–­å€¼çš„äº¤æ¢ï¼š

```js
const sharedArrayBuffer = new SharedArrayBuffer(4); 
const view = new Uint32Array(sharedArrayBuffer); 

// åœ¨ç´¢å¼• 0 å¤„å†™å…¥ 3 
Atomics.store(view, 0, 3); 

// ä»ç´¢å¼• 0 å¤„è¯»å–å€¼ï¼Œç„¶ååœ¨ç´¢å¼• 0 å¤„å†™å…¥ 4 
console.log(Atomics.exchange(view, 0, 4)); // 3

// ä»ç´¢å¼• 0 å¤„è¯»å–å€¼
console.log(Atomics.load(view, 0)); // 4
```

â€‹		åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½åªå¸Œæœ›åœ¨ä¸Šæ¬¡è¯»å–æŸä¸ªå€¼ä¹‹åæ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¯¥å€¼çš„æƒ…å†µä¸‹æ‰å¯¹å…±äº«ç¼“å†²åŒºæ‰§è¡Œå†™æ“ä½œã€‚å¦‚æœè¿™ä¸ªå€¼æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¯ä»¥å®‰å…¨åœ°å†™å…¥æ›´æ–°åçš„å€¼ï¼›å¦‚æœè¿™ä¸ªå€¼è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆæ‰§è¡Œå†™æ“ä½œå°†ä¼šç ´åå…¶ä»–çº¿ç¨‹è®¡ç®—çš„å€¼ã€‚å¯¹äºè¿™ç§ä»»åŠ¡ï¼Œ`Atomics API` æä¾›äº† `compareExchange()` æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•åªåœ¨ç›®æ ‡ç´¢å¼•å¤„çš„å€¼ä¸é¢„æœŸå€¼åŒ¹é…æ—¶æ‰ä¼šæ‰§è¡Œå†™æ“ä½œã€‚æ¥çœ‹ä¸‹ä¾‹ï¼š

```js
const sharedArrayBuffer = new SharedArrayBuffer(4); 
const view = new Uint32Array(sharedArrayBuffer); 

// åœ¨ç´¢å¼• 0 å¤„å†™å…¥ 5 
Atomics.store(view, 0, 5); 

// ä»ç¼“å†²åŒºè¯»å–å€¼
let initial = Atomics.load(view, 0);

// å¯¹è¿™ä¸ªå€¼æ‰§è¡ŒéåŸå­æ“ä½œ
let result = initial ** 2; 

// åªåœ¨ç¼“å†²åŒºæœªè¢«ä¿®æ”¹çš„æƒ…å†µä¸‹æ‰ä¼šå‘ç¼“å†²åŒºå†™å…¥æ–°å€¼
Atomics.compareExchange(view, 0, initial, result); 

// æ£€æŸ¥å†™å…¥æˆåŠŸ
console.log(Atomics.load(view, 0)); // 25
```

â€‹		å¦‚æœå€¼ä¸åŒ¹é…ï¼Œ`compareExchange()` è°ƒç”¨åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼š

```js
const sharedArrayBuffer = new SharedArrayBuffer(4); 
const view = new Uint32Array(sharedArrayBuffer); 

// åœ¨ç´¢å¼• 0 å¤„å†™å…¥ 5 
Atomics.store(view, 0, 5); 

// ä»ç¼“å†²åŒºè¯»å–å€¼
let initial = Atomics.load(view, 0); 

// å¯¹è¿™ä¸ªå€¼æ‰§è¡ŒéåŸå­æ“ä½œ
let result = initial ** 2; 

// åªåœ¨ç¼“å†²åŒºæœªè¢«ä¿®æ”¹çš„æƒ…å†µä¸‹æ‰ä¼šå‘ç¼“å†²åŒºå†™å…¥æ–°å€¼
Atomics.compareExchange(view, 0, -1, result); 

// æ£€æŸ¥å†™å…¥å¤±è´¥
console.log(Atomics.load(view, 0)); // 5
```

##### åŸå­ `Futex` æ“ä½œä¸åŠ é”

â€‹		å¦‚æœæ²¡æœ‰æŸç§é”æœºåˆ¶ï¼Œå¤šçº¿ç¨‹ç¨‹åºå°±æ— æ³•æ”¯æŒå¤æ‚éœ€æ±‚ã€‚ä¸ºæ­¤ï¼Œ`Atomics API` æä¾›äº†æ¨¡ä»¿ `Linux Futex`ï¼ˆå¿«é€Ÿç”¨æˆ·ç©ºé—´äº’æ–¥é‡ï¼Œ`fast user-space mutex`ï¼‰çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•æœ¬èº«è™½ç„¶éå¸¸ç®€å•ï¼Œä½†å¯ä»¥ä½œä¸ºæ›´å¤æ‚é”æœºåˆ¶çš„åŸºæœ¬ç»„ä»¶ã€‚

â€‹		æ³¨æ„ï¼šæ‰€æœ‰åŸå­ `Futex` æ“ä½œåªèƒ½ç”¨äº `Int32Array` è§†å›¾ã€‚è€Œä¸”ï¼Œä¹Ÿåªèƒ½ç”¨åœ¨å·¥ä½œçº¿ç¨‹å†…éƒ¨ã€‚

â€‹		`Atomics.wait()` å’Œ `Atomics.notify()` é€šè¿‡ç¤ºä¾‹å¾ˆå®¹æ˜“ç†è§£ã€‚ä¸‹é¢è¿™ä¸ªç®€å•çš„ä¾‹å­åˆ›å»ºäº† 4 ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œç”¨äºå¯¹é•¿åº¦ä¸º 1 çš„ `Int32Array` è¿›è¡Œæ“ä½œã€‚è¿™äº›å·¥ä½œçº¿ç¨‹ä¼šä¾æ¬¡å–å¾—é”å¹¶æ‰§è¡Œè‡ªå·±çš„åŠ æ“ä½œï¼š

```js
const workerScript = ` 
	self.onmessage = ({data}) => { 
 		const view = new Int32Array(data); 
 		
		console.log('Waiting to obtain lock'); 
		
 		// é‡åˆ°åˆå§‹å€¼åˆ™åœæ­¢ï¼Œ10 000 æ¯«ç§’è¶…æ—¶
  		Atomics.wait(view, 0, 0, 1E5); 
  		
 		console.log('Obtained lock'); 
 		
 		// åœ¨ç´¢å¼• 0 å¤„åŠ  1 
 		Atomics.add(view, 0, 1); 
 		
 		console.log('Releasing lock'); 
 		
 		// åªå…è®¸ 1 ä¸ªå·¥ä½œçº¿ç¨‹ç»§ç»­æ‰§è¡Œ
 		Atomics.notify(view, 0, 1); 
 		self.postMessage(null); 
	}; 
`; 

const workerScriptBlobUrl = URL.createObjectURL(new Blob([workerScript])); 

const workers = []; 
for (let i = 0; i < 4; ++i) { 
 	workers.push(new Worker(workerScriptBlobUrl)); 
} 

// åœ¨æœ€åä¸€ä¸ªå·¥ä½œçº¿ç¨‹å®Œæˆåæ‰“å°å‡ºæœ€ç»ˆå€¼
let responseCount = 0; 
for (const worker of workers) { 
 	worker.onmessage = () => { 
 		if (++responseCount == workers.length) { 
 			console.log(`Final buffer value: ${view[0]}`); 
 		} 
 	}; 
} 

// åˆå§‹åŒ– SharedArrayBuffer 
const sharedArrayBuffer = new SharedArrayBuffer(8); 
const view = new Int32Array(sharedArrayBuffer); 

// æŠŠ SharedArrayBuffer å‘é€åˆ°æ¯ä¸ªå·¥ä½œçº¿ç¨‹
for (const worker of workers) { 
 	worker.postMessage(sharedArrayBuffer); 
} 

// 1000 æ¯«ç§’åé‡Šæ”¾ç¬¬ä¸€ä¸ªé”
setTimeout(() => Atomics.notify(view, 0, 1), 1000); 
// Waiting to obtain lock 
// Waiting to obtain lock 
// Waiting to obtain lock 
// Waiting to obtain lock 
// Obtained lock 
// Releasing lock 
// Obtained lock 
// Releasing lock 
// Obtained lock 
// Releasing lock 
// Obtained lock 
// Releasing lock 
// Final buffer value: 4
```

â€‹		å› ä¸ºæ˜¯ä½¿ç”¨ 0 æ¥åˆå§‹åŒ– `SharedArrayBuffer`ï¼Œæ‰€ä»¥æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ä¼šåˆ°è¾¾ `Atomics.wait()` å¹¶åœæ­¢æ‰§è¡Œã€‚åœ¨åœæ­¢çŠ¶æ€ä¸‹ï¼Œæ‰§è¡Œçº¿ç¨‹å­˜åœ¨äºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåœ¨ç»è¿‡æŒ‡å®šæ—¶é—´æˆ–åœ¨ç›¸åº”ç´¢å¼•ä¸Šè°ƒç”¨ `Atomics.notify()` ä¹‹å‰ï¼Œä¸€ç›´ä¿æŒæš‚åœçŠ¶æ€ã€‚ 1000 æ¯«ç§’ä¹‹åï¼Œé¡¶éƒ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¼šè°ƒç”¨ `Atomics.notify()` é‡Šæ”¾å…¶ä¸­ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åä¼šå†æ¬¡è°ƒç”¨ `Atomics.notify()` é‡Šæ”¾å¦ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šæŒç»­åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•å¹¶é€šè¿‡ `postMessage()` ä¼ å‡ºæœ€ç»ˆçš„å€¼ã€‚

â€‹		`Atomics API` è¿˜æä¾›äº† `Atomics.isLockFree()` æ–¹æ³•ã€‚ä¸è¿‡æˆ‘ä»¬åŸºæœ¬ä¸Šåº”è¯¥ä¸ä¼šç”¨åˆ°ã€‚è¿™ä¸ªæ–¹æ³•åœ¨é«˜æ€§èƒ½ç®—æ³•ä¸­å¯ä»¥ç”¨æ¥ç¡®å®šæ˜¯å¦æœ‰å¿…è¦è·å–é”ã€‚è§„èŒƒä¸­çš„ä»‹ç»å¦‚ä¸‹ï¼š

> â€‹		`Atomics.isLockFree()` æ˜¯ä¸€ä¸ªä¼˜åŒ–åŸè¯­ã€‚åŸºæœ¬ä¸Šï¼Œå¦‚æœä¸€ä¸ªåŸå­åŸè¯­ï¼ˆ`compareExchange`ã€`load`ã€`store`ã€`add`ã€`sub`ã€`and`ã€`or`ã€`xor` æˆ– `exchange`ï¼‰åœ¨ *`n`* å­—èŠ‚å¤§å°çš„æ•°æ®ä¸Šçš„åŸå­æ­¥éª¤åœ¨ä¸è°ƒç”¨ä»£ç†åœ¨ç»„æˆæ•°æ®çš„ *`n`* å­—èŠ‚ä¹‹å¤–è·å¾—é”çš„æƒ…å†µä¸‹å¯ä»¥æ‰§è¡Œï¼Œåˆ™ `Atomics.isLockFree(n)` ä¼šè¿”å› `true`ã€‚é«˜æ€§èƒ½ç®—æ³•ä¼šä½¿ç”¨ `Atomics.isLockFree` ç¡®å®šæ˜¯å¦åœ¨å…³é”®éƒ¨åˆ†ä½¿ç”¨é”æˆ–åŸå­æ“ä½œã€‚å¦‚æœåŸå­åŸè¯­éœ€è¦åŠ é”ï¼Œåˆ™ç®—æ³•æä¾›è‡ªå·±çš„é”ä¼šæ›´é«˜æ•ˆã€‚
>
> â€‹		`Atomics.isLockFree(4)` å§‹ç»ˆè¿”å› `true`ï¼Œå› ä¸ºåœ¨æ‰€æœ‰å·²çŸ¥çš„ç›¸å…³ç¡¬ä»¶ä¸Šéƒ½æ˜¯æ”¯æŒçš„ã€‚èƒ½å¤Ÿå¦‚æ­¤å‡è®¾é€šå¸¸å¯ä»¥ç®€åŒ–ç¨‹åºã€‚



### è·¨ä¸Šä¸‹æ–‡æ¶ˆæ¯

â€‹		è·¨æ–‡æ¡£æ¶ˆæ¯ï¼Œæœ‰æ—¶å€™ä¹Ÿç®€ç§°ä¸º `XDM`ï¼ˆ`cross-document messaging`ï¼‰ï¼Œæ˜¯ä¸€ç§åœ¨ä¸åŒæ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå¦‚ä¸åŒå·¥ä½œçº¿ç¨‹æˆ–ä¸åŒæºçš„é¡µé¢ï¼‰é—´ä¼ é€’ä¿¡æ¯çš„èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œ`www.wrox.com` ä¸Šçš„é¡µé¢æƒ³è¦ä¸åŒ…å«åœ¨å†…åµŒçª—æ ¼ä¸­çš„ `p2p.wrox.com` ä¸Šé¢çš„é¡µé¢é€šä¿¡ã€‚åœ¨ `XDM` ä¹‹å‰ï¼Œè¦ä»¥å®‰å…¨æ–¹å¼å®ç°è¿™ç§é€šä¿¡éœ€è¦å¾ˆå¤šå·¥ä½œã€‚`XDM` ä»¥å®‰å…¨æ˜“ç”¨çš„æ–¹å¼è§„èŒƒåŒ–äº†è¿™ä¸ªåŠŸèƒ½ã€‚



#### å†…è”çª—æ ¼

â€‹		`iframe` å…ƒç´ ï¼Œåœ¨ `JS` ä¸­å¯ä½¿ç”¨ `DOM` æ–¹æ³•è·å–ï¼Œä¹Ÿå¯ä»¥ä» `frames` é›†åˆï¼ˆé€šè¿‡å…ƒç´  `id`ã€`name` æˆ–ç´¢å¼•ï¼‰ä¸­è·å–ã€‚

```js
// DOMæ–¹æ³•
document.getElementById("myframe");

// framesé›†åˆ
frames["myframe"];
```

â€‹		é€šè¿‡å…ƒç´  `id` ä» `frames` ä¸­è·å–åˆ°çš„æ˜¯çª—æ ¼å…ƒç´ çš„å¼•ç”¨ï¼Œé€šè¿‡å…ƒç´  `name` ä» `frames` ä¸­è·å–åˆ°çš„æ˜¯çª—æ ¼å…ƒç´ çš„ `window` å¯¹è±¡ã€‚

```html
<iframe id="myframe" name="frame1"></iframe>
<script>
    document.getElementById("myframe") === frames["myframe"]; 				// true
    document.getElementById("myframe").contentWindow === frames["frame1"]; 	// true
</script>
```

â€‹		æ³¨é‡Šï¼šå†…è”çª—æ ¼çš„ `window` å¯¹è±¡é€šå¸¸å­˜åœ¨äºçª—æ ¼å…ƒç´ çš„ `contentWindow` å±æ€§ä¸Šã€‚



#### çª—å£é€šä¿¡

â€‹		æ³¨æ„ï¼šè·¨ä¸Šä¸‹æ–‡æ¶ˆæ¯ç”¨äºçª—å£ä¹‹é—´é€šä¿¡æˆ–å·¥ä½œçº¿ç¨‹ä¹‹é—´é€šä¿¡ã€‚æœ¬èŠ‚ä¸»è¦ä»‹ç»ä½¿ç”¨ `postMessage()` ä¸å…¶ä»–çª—å£é€šä¿¡ ã€‚å…³äºå·¥ä½œçº¿ç¨‹ä¹‹é—´é€šä¿¡ã€`MessageChannel` å’Œ `BroadcastChannel`ï¼Œå¯ä»¥å‚è€ƒã€Šå·¥ä½œè€…çº¿ç¨‹ã€‹ä¸€ç« ã€‚

##### å‘é€æ¶ˆæ¯

â€‹		`XDM` çš„æ ¸å¿ƒæ˜¯ `postMessage()` æ–¹æ³•ã€‚é™¤äº† `XDM`ï¼Œè¿™ä¸ªæ–¹æ³•åè¿˜åœ¨ `HTML5` ä¸­å¾ˆå¤šåœ°æ–¹ç”¨åˆ°è¿‡ï¼Œä½†ç›®çš„éƒ½ä¸€æ ·ï¼Œéƒ½æ˜¯æŠŠæ•°æ®ä¼ é€åˆ°å¦ä¸€ä¸ªä½ç½®ã€‚

â€‹		`postMessage()` æ–¹æ³•æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼šæ¶ˆæ¯å†…å®¹ã€ç›®æ ‡æ¥æ”¶æºå’Œå¯é€‰çš„å¯ä¼ è¾“å¯¹è±¡çš„æ•°ç»„ï¼ˆåªä¸å·¥ä½œçº¿ç¨‹ç›¸å…³ï¼‰ã€‚ç¬¬äºŒä¸ªå‚æ•°å¯¹äºå®‰å…¨éå¸¸é‡è¦ï¼Œå®ƒé™åˆ¶äº†æµè§ˆå™¨äº¤ä»˜æ•°æ®çš„ç›®æ ‡ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```html
<iframe id="myframe" src="http://p2p.wrox.com"></iframe><!-- åŠ è½½æ¥è‡ª"http://p2p.wrox.com"çš„å†…å®¹ -->
<script>
let iframeWindow = document.getElementById("myframe").contentWindow; 

iframeWindow.postMessage("A secret", "http://p2p.wrox.com"); // å‘æ–¹æ³•çš„è°ƒç”¨è€…å‘é€æ¶ˆæ¯ï¼ˆç»™å®ƒåˆ†æ´¾ä¸€æ¡æ¶ˆæ¯ï¼‰
</script>
```

â€‹		æœ€åä¸€è¡Œä»£ç å°è¯•å‘å†…åµŒçª—æ ¼ï¼ˆè¯¥æ–¹æ³•çš„è°ƒç”¨è€…ï¼‰ä¸­å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œè€Œä¸”æŒ‡å®šå…¶æºå¿…é¡»æ˜¯ `"http://p2p.wrox.com"`ã€‚å¦‚æœä¸å®é™…æ¥æ”¶çª—å£çš„æºåŒ¹é…ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°†ä¼šäº¤ä»˜åˆ°å†…åµŒçª—æ ¼ï¼›å¦åˆ™ï¼Œ`postMessage()` ä»€ä¹ˆä¹Ÿä¸åšã€‚è¿™ä¸ªé™åˆ¶å¯ä»¥ä¿æŠ¤ä¿¡æ¯ä¸ä¼šå› åœ°å€æ”¹å˜è€Œæ³„éœ²ã€‚å¦‚æœä¸æƒ³é™åˆ¶æ¥æ”¶ç›®æ ‡ï¼Œåˆ™å¯ä»¥ç»™ `postMessage()` çš„ç¬¬äºŒä¸ªå‚æ•°ä¼  `"*"`ï¼Œä½†ä¸æ¨èè¿™ä¹ˆåšã€‚

â€‹		æ³¨é‡Šï¼š`postMessage` ç¬¬äºŒå‚æ•°æŒ‡å®šçš„æ˜¯å‘é€çš„ç›®æ ‡æºï¼Œå®ƒå¿…é¡»ä¸å®é™…çš„æ¥æ”¶æºä¿æŒä¸€è‡´ï¼Œæ‰èƒ½æˆåŠŸåœ°æ”¶å‘æ¶ˆæ¯ã€‚

##### æ¥æ”¶æ¶ˆæ¯

â€‹		æ¥æ”¶åˆ° `XDM` æ¶ˆæ¯åï¼Œ`window` å¯¹è±¡ä¸Šä¼šè§¦å‘ `message` äº‹ä»¶ã€‚è¿™ä¸ªäº‹ä»¶æ˜¯å¼‚æ­¥è§¦å‘çš„ï¼Œå› æ­¤ä»æ¶ˆæ¯å‘å‡ºåˆ°æ¥æ”¶åˆ°æ¶ˆæ¯ï¼ˆæ¥æ”¶çª—å£è§¦å‘ `message` äº‹ä»¶ï¼‰å¯èƒ½æœ‰å»¶è¿Ÿã€‚ä¼ ç»™ `onmessage` äº‹ä»¶å¤„ç†ç¨‹åºçš„ `event` å¯¹è±¡åŒ…å«ä»¥ä¸‹ 3 æ–¹é¢é‡è¦ä¿¡æ¯ã€‚

- `data`ï¼šä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™ `postMessage()` çš„å­—ç¬¦ä¸²æ•°æ®ã€‚
- `origin`ï¼šå‘é€æ¶ˆæ¯çš„æ–‡æ¡£æºï¼Œä¾‹å¦‚ `"http://www.wrox.com"`ã€‚
- `source`ï¼šå‘é€æ¶ˆæ¯çš„æ–‡æ¡£ä¸­ `window` å¯¹è±¡çš„ä»£ç†ã€‚è¿™ä¸ªä»£ç†å¯¹è±¡ä¸»è¦ç”¨äºåœ¨å‘é€ä¸Šä¸€æ¡æ¶ˆæ¯çš„çª—å£ä¸­æ‰§è¡Œ `postMessage()` æ–¹æ³•ã€‚å¦‚æœå‘é€çª—å£æœ‰ç›¸åŒçš„æºï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡åº”è¯¥å°±æ˜¯ `window` å¯¹è±¡ã€‚

â€‹		æ¥æ”¶æ¶ˆæ¯ä¹‹åéªŒè¯å‘é€çª—å£çš„æºæ˜¯éå¸¸é‡è¦çš„ã€‚ä¸ `postMessage()` çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥ä¿è¯æ•°æ®ä¸ä¼šæ„å¤–ä¼ ç»™æœªçŸ¥é¡µé¢ä¸€æ ·ï¼Œåœ¨ `onmessage` äº‹ä»¶å¤„ç†ç¨‹åºä¸­æ£€æŸ¥å‘é€çª—å£çš„æºå¯ä»¥ä¿è¯æ•°æ®æ¥è‡ªæ­£ç¡®çš„åœ°æ–¹ã€‚åŸºæœ¬çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
window.addEventListener("message", (event) => { 
 	// ç¡®ä¿æ¥è‡ªé¢„æœŸå‘é€è€…
 	if (event.origin == "http://www.wrox.com") { 
 		// å¯¹æ•°æ®è¿›è¡Œä¸€äº›å¤„ç†
 		processMessage(event.data); 
 		// å¯é€‰ï¼šå‘æ¥æºçª—å£å‘é€ä¸€æ¡æ¶ˆæ¯
 		event.source.postMessage("Received!", event.origin === 'null' ? "*" : event.origin);
 	} 
});
```

â€‹		å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`event.source` æ˜¯æŸä¸ª `window` å¯¹è±¡çš„ä»£ç†ï¼Œè€Œéå®é™…çš„ `window` å¯¹è±¡ã€‚å› æ­¤ä¸èƒ½é€šè¿‡å®ƒè®¿é—®æ‰€æœ‰çª—å£ä¸‹çš„ä¿¡æ¯ã€‚æœ€å¥½åªåœ¨å®ƒä¸Šé¢ä½¿ç”¨ `postMessage()` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ°¸è¿œå­˜åœ¨è€Œä¸”å¯ä»¥è°ƒç”¨ã€‚æ¥çœ‹å‡ ä¸ªä¾‹å­ï¼š

â€‹		åœ¨æœ¬åœ°é¡µé¢ï¼ˆæºä¸º `"null"`ï¼‰ä¸­ï¼Œå‘æœ¬åœ°çª—æ ¼ï¼ˆæºä¸º `"null"`ï¼‰å‘é€æ¶ˆæ¯ï¼š

```html
<iframe id="myframe"></iframe>
<script>
    let iframeWindow = document.getElementById("myframe").contentWindow; 

    // å‘é€æ¶ˆæ¯ï¼ˆä¸»é¡µé¢ â†’ å†…åµŒçª—æ ¼ï¼‰
    iframeWindow.postMessage("A secret", "*");

    // æ¥æ”¶æ¶ˆæ¯ï¼ˆå†…åµŒçª—æ ¼ç›‘å¬æ¥è‡ªä¸»é¡µé¢çš„æ¶ˆæ¯ï¼‰
    iframeWindow.addEventListener("message", (event) => {
        console.log(event); // event.originä¸º"null"
        // å‘ä¸»é¡µé¢å›å¤æ¶ˆæ¯
        event.source.postMessage("Received!", event.origin === 'null' ? "*" : event.origin);
    }, false);

    // ç›‘å¬å›å¤ï¼ˆä¸»é¡µé¢ç›‘å¬æ¥è‡ªå†…åµŒçª—æ ¼çš„å›å¤ï¼‰
    window.addEventListener("message", (event) => {
        console.log(event);
    })
</script>
```

â€‹		åœ¨æœ¬åœ°é¡µé¢ï¼ˆæºä¸º `"null"`ï¼‰ä¸­ï¼Œå‘åœ¨çº¿çª—æ ¼ï¼ˆæºä¸º `"http://127.0.0.1:5500"`ï¼‰å‘é€æ¶ˆæ¯ï¼š

```html
<!-- åœ¨ä¸»é¡µé¢ä¸­ -->
<iframe id="myframe" src="http://127.0.0.1:5500/a.html"></iframe>
<script>
    let iframe = document.getElementById("myframe")
    
    // æ­¤æ—¶ï¼ŒpostMessageå¿…é¡»åœ¨loadä¸­è°ƒç”¨
    iframe.addEventListener("load", () => {
        let iframeWindow = iframe.contentWindow;
        // å‘é€æ¶ˆæ¯ï¼ˆä¸»é¡µé¢ â†’ å†…åµŒçª—æ ¼ï¼‰
        iframeWindow.postMessage("A secret", "http://127.0.0.1:5500");
    })
    
    // ç›‘å¬å›å¤ï¼ˆä¸»é¡µé¢ç›‘å¬æ¥è‡ªå†…åµŒçª—æ ¼çš„å›å¤ï¼‰
    window.addEventListener("message", (event) => {
        console.log(event);
    })
</script>

<!-- åœ¨çª—æ ¼è¿æ¥çš„å­é¡µé¢ä¸­ -->
<script>
	// æ¥æ”¶æ¶ˆæ¯å¹¶å›å¤ï¼ˆæ¥æ”¶æ¥è‡ªä¸»é¡µé¢çš„æ¶ˆæ¯ï¼Œå¹¶å›å¤å®ƒï¼‰
    window.addEventListener("message", (event) => {
        console.log(event); // event.originä¸º"null"
        // å‘ä¸»é¡µé¢å›å¤æ¶ˆæ¯
        event.source.postMessage("Received!", event.origin === 'null' ? "*" : event.origin);
    }, false);
</script>
```

â€‹		åœ¨çº¿é¡µé¢ï¼ˆæºä¸º `"http://127.0.0.1:5500"`ï¼‰ä¸åœ¨çº¿çª—æ ¼ï¼ˆæºä¸º `"http://127.0.0.1:5500"`ï¼‰ä¹‹é—´çš„åŒæºé€šä¿¡ï¼š

```html
<!-- åœ¨ä¸»é¡µé¢ä¸­ -->
<iframe id="myframe" src="http://127.0.0.1:5500/a.html"></iframe>
<script>
    let iframeWindow = document.getElementById("myframe").contentWindow; 

    // å‘é€æ¶ˆæ¯ï¼ˆä¸»é¡µé¢å‘å†…åµŒçª—æ ¼å‘é€æ¶ˆæ¯ï¼‰
    iframeWindow.postMessage("A secret", "http://127.0.0.1:5500");

    // ç›‘å¬å›å¤ï¼ˆä¸»é¡µé¢ç›‘å¬æ¥è‡ªå†…åµŒçª—æ ¼çš„å›å¤ï¼‰
    window.addEventListener("message", (event) => {
        console.log(event);
    });
    
    // æ¥æ”¶æ¶ˆæ¯ï¼ˆå†…åµŒçª—æ ¼æ¥æ”¶æ¥è‡ªä¸»é¡µé¢çš„æ¶ˆæ¯ï¼Œå¹¶å›å¤å®ƒï¼‰
    iframeWindow.addEventListener("message", (event) => {
        console.log(event); // event.originä¸º"http://127.0.0.1:5500"
        // å‘ä¸»é¡µé¢å›å¤æ¶ˆæ¯
        event.source.postMessage("Received!", event.origin === 'null' ? "*" : event.origin);
    }, false);
</script>
```

â€‹		åœ¨çº¿é¡µé¢ï¼ˆæºä¸º `"http://www.domain1.com"`ï¼‰ä¸åœ¨çº¿çª—æ ¼ï¼ˆæºä¸º `"http://www.domain2.com"`ï¼‰ä¹‹é—´çš„è·¨åŸŸé€šä¿¡ï¼š

```html
<!-- åœ¨ä¸»é¡µé¢ä¸­ -->
<iframe id="myframe" src="http://www.domain2.com/b.html"></iframe>
<script>
    let iframe = document.getElementById("myframe");

    iframe.onload = () => {
        // å‘domain2å‘é€è·¨åŸŸæ•°æ®
        iframe.contentWindow.postMessage("Sended", "http://www.domain2.com");
    }

    // ç›‘å¬å›å¤ï¼ˆä¸»é¡µé¢ç›‘å¬æ¥è‡ªå†…åµŒçª—æ ¼çš„å›å¤ï¼‰
    window.addEventListener("message", (event) => {
        console.log(event);
    });
    
    // æ¥æ”¶æ¶ˆæ¯ï¼ˆå†…åµŒçª—æ ¼æ¥æ”¶æ¥è‡ªä¸»é¡µé¢çš„æ¶ˆæ¯ï¼Œå¹¶å›å¤å®ƒï¼‰
    iframe.contentWindow.addEventListener("message", (event) => {
        console.log(event); // event.originä¸º
        
        if (event.origin !== "http://www.domain1.com") return;
        
        // å‘ä¸»é¡µé¢å›å¤æ¶ˆæ¯
        event.source.postMessage("Received!", event.origin === 'null' ? "*" : event.origin);
    }, false);
</script>
```

â€‹		åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

â€‹         <img src="images/JS%20API/image-20230209165536820.png" alt="image-20230209165536820" style="zoom:80%;" /> 

â€‹		`XDM` æœ‰ä¸€äº›æ€ªå¼‚ä¹‹å¤„ã€‚é¦–å…ˆï¼Œ`postMessage()` çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„æœ€åˆå®ç°å§‹ç»ˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åæ¥ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ”¹ä¸ºå…è®¸ä»»ä½•ç»“æ„çš„æ•°æ®ä¼ å…¥ï¼Œä¸è¿‡å¹¶éæ‰€æœ‰æµè§ˆå™¨éƒ½å®ç°äº†è¿™ä¸ªæ”¹å˜ã€‚ä¸ºæ­¤ï¼Œæœ€å¥½æ˜¯åªé€šè¿‡ `postMessage()` å‘é€å­—ç¬¦ä¸²ã€‚å¦‚æœéœ€è¦ä¼ é€’ç»“æ„åŒ–æ•°æ®ï¼Œé‚£ä¹ˆæœ€å¥½å…ˆå¯¹è¯¥æ•°æ®è°ƒç”¨ `JSON.stringify()`ï¼Œé€šè¿‡ `postMessage()` ä¼ è¿‡å»ä¹‹åï¼Œå†åœ¨ `onmessage` äº‹ä»¶å¤„ç†ç¨‹åºä¸­è°ƒç”¨ `JSON.parse()`ã€‚

â€‹		åœ¨é€šè¿‡å†…åµŒçª—æ ¼åŠ è½½ä¸åŒåŸŸæ—¶ï¼Œä½¿ç”¨ `XDM` æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚è¿™ç§æ–¹æ³•åœ¨æ··æ­ï¼ˆ`mashup`ï¼‰å’Œç¤¾äº¤åº”ç”¨ä¸­éå¸¸å¸¸ç”¨ã€‚é€šè¿‡ä½¿ç”¨ `XDM` ä¸å†…åµŒçª—æ ¼ä¸­çš„ç½‘é¡µé€šä¿¡ï¼Œå¯ä»¥ä¿è¯åŒ…å«é¡µé¢çš„å®‰å…¨ã€‚`XDM` ä¹Ÿå¯ä»¥ç”¨äºåŒæºé¡µé¢ä¹‹é—´é€šä¿¡ã€‚

â€‹		ä¸»é¡µé¢ä¸å…¶æ‰“å¼€çš„æ–°é¡µé¢ä¹‹é—´çš„åŒæºé€šä¿¡ï¼š

```js
// åœ¨ä¸»é¡µé¢ä¸­
// æ‰“å¼€æ–°é¡µé¢
let popupWin = window.open("http://127.0.0.1:58972/a.html");

// å‘é€æ¶ˆæ¯ï¼ˆä¸»é¡µé¢å‘æ–°é¡µé¢å‘é€æ¶ˆæ¯ï¼‰
popupWin.addEventListener("load", () => {
    popupWin.postMessage("Sended", "http://127.0.0.1:58972");
});

// ç›‘å¬å›å¤ï¼ˆä¸»é¡µé¢ç›‘å¬æ¥è‡ªæ–°é¡µé¢çš„å›å¤ï¼‰
window.addEventListener('message', function (event) {
    console.log(event);
}, false);

// æ¥æ”¶æ¶ˆæ¯ï¼ˆæ–°é¡µé¢æ¥æ”¶æ¥è‡ªä¸»é¡µé¢çš„æ¶ˆæ¯ï¼Œå¹¶å›å¤å®ƒï¼‰
popupWin.addEventListener("message", (event) => {
    console.log(event); // event.originä¸º"http://127.0.0.1:58972"
    // å‘ä¸»é¡µé¢å›å¤æ¶ˆæ¯
    event.source.postMessage("Received!", event.origin === 'null' ? "*" : event.origin);
}, false);
```



### `Encoding API`

â€‹		`Encoding API` ä¸»è¦ç”¨äºå®ç°å­—ç¬¦ä¸²ä¸å®šå‹æ•°ç»„ä¹‹é—´çš„è½¬æ¢ã€‚è§„èŒƒæ–°å¢äº† 4 ä¸ªç”¨äºæ‰§è¡Œè½¬æ¢çš„å…¨å±€ç±»ï¼š`TextEncoder`ã€`TextEncoderStream`ã€`TextDecoder` å’Œ `TextDecoderStream`ã€‚

â€‹		æ³¨æ„ï¼šç›¸æ¯”äºæ‰¹é‡ï¼ˆ`bulk`ï¼‰çš„ç¼–è§£ç ï¼Œå¯¹æµï¼ˆ`stream`ï¼‰ç¼–è§£ç çš„æ”¯æŒå¾ˆæœ‰é™ã€‚



#### æ–‡æœ¬ç¼–ç 

â€‹		`Encoding API` æä¾›äº†ä¸¤ç§å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå®šå‹æ•°ç»„äºŒè¿›åˆ¶æ ¼å¼çš„æ–¹æ³•ï¼šæ‰¹é‡ç¼–ç å’Œæµç¼–ç ã€‚æŠŠå­—ç¬¦ä¸²è½¬æ¢ä¸ºå®šå‹æ•°ç»„æ—¶ï¼Œç¼–ç å™¨å§‹ç»ˆä½¿ç”¨ `UTF-8`ã€‚

##### æ‰¹é‡ç¼–ç 

â€‹		æ‰€è°“æ‰¹é‡ï¼ŒæŒ‡çš„æ˜¯ `JavaScript` å¼•æ“ä¼šåŒæ­¥ç¼–ç æ•´ä¸ªå­—ç¬¦ä¸²ã€‚å¯¹äºéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œå¯èƒ½ä¼šèŠ±è¾ƒé•¿æ—¶é—´ã€‚æ‰¹é‡ç¼–ç æ˜¯é€šè¿‡ `TextEncoder` çš„å®ä¾‹å®Œæˆçš„ï¼š

```js
const textEncoder = new TextEncoder();

console.log(textEncoder); // TextEncoderÂ {encoding: 'utf-8'}
/*
TextEncoder {
	encoding: "utf-8",
	[[Prototype]]: TextEncoder {
		encode: Æ’ encode(),
		encodeInto: Æ’ encodeInto(),
		encoding: "utf-8",
		constructor: Æ’ TextEncoder(),
		Symbol(Symbol.toStringTag): "TextEncoder",
		get encoding: Æ’ encoding(),
		[[Prototype]]: Object
	}
}
*/
```

â€‹		è¿™ä¸ªå®ä¾‹ä¸Šæœ‰ä¸€ä¸ª `encode()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¹¶ä»¥ `Uint8Array` æ ¼å¼è¿”å›æ¯ä¸ªå­—ç¬¦çš„ `UTF-8` ç¼–ç ï¼š

```js
const textEncoder = new TextEncoder(); 

// è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªUint8Arrayæ•°ç»„ï¼Œç„¶åä»¥è¯¥æ ¼å¼ç¼–ç å­˜å‚¨å­—ç¬¦ä¸²ã€‚
const encodedText = textEncoder.encode('foo'); 

// f çš„ UTF-8 ç¼–ç æ˜¯ 0x66ï¼ˆå³åè¿›åˆ¶ 102ï¼‰
// o çš„ UTF-8 ç¼–ç æ˜¯ 0x6Fï¼ˆå³åè¿›åˆ¶ 111ï¼‰
console.log(encodedText); // Uint8Array(3) [102, 111, 111]
```

â€‹		ç¼–ç å™¨æ˜¯ç”¨äºå¤„ç†å­—ç¬¦çš„ï¼Œæœ‰äº›å­—ç¬¦ï¼ˆå¦‚è¡¨æƒ…ç¬¦å·ï¼‰åœ¨æœ€ç»ˆè¿”å›çš„æ•°ç»„ä¸­å¯èƒ½ä¼šå å¤šä¸ªç´¢å¼•ï¼š

```js
const textEncoder = new TextEncoder(); 
const encodedText = textEncoder.encode('ğŸ˜Š'); 

// 'ğŸ˜Š' çš„ UTF-8 ç¼–ç æ˜¯ 0xF0 0x9F 0x98 0x8Aï¼ˆå³åè¿›åˆ¶ 240ã€159ã€152ã€138ï¼‰
console.log(encodedText); // Uint8Array(4) [240, 159, 152, 138]
```

â€‹		ç¼–ç å™¨å®ä¾‹è¿˜æœ‰ä¸€ä¸ª `encodeInto()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å’Œç›®æ ‡ `Uint8Array`ï¼Œè¿”å›ä¸€ä¸ªå­—å…¸ï¼Œè¯¥å­—å…¸åŒ…å« `read` å’Œ `written` å±æ€§ï¼Œåˆ†åˆ«è¡¨ç¤ºæˆåŠŸä»æºå­—ç¬¦ä¸²è¯»å–äº†å¤šå°‘å­—ç¬¦å’Œå‘ç›®æ ‡æ•°ç»„å†™å…¥äº†å¤šå°‘å­—ç¬¦ã€‚å¦‚æœå®šå‹æ•°ç»„çš„ç©ºé—´ä¸å¤Ÿï¼Œç¼–ç å°±ä¼šæå‰ç»ˆæ­¢ï¼Œè¿”å›çš„å­—å…¸ä¼šä½“ç°è¿™ä¸ªç»“æœï¼š

```js
const textEncoder = new TextEncoder(); 

const fooArr = new Uint8Array(3); // åˆšå¥½è¶³å¤Ÿ
const barArr = new Uint8Array(2); // ç©ºé—´ä¸å¤Ÿ

// å°†å­—ç¬¦ä¸²å†™å…¥ç›®æ ‡æ•°ç»„ï¼Œå¹¶æä¾›ç›¸å…³ä¿¡æ¯
const fooResult = textEncoder.encodeInto('foo', fooArr);
const barResult = textEncoder.encodeInto('bar', barArr);

// å…¨éƒ¨å­—ç¬¦è¯»å®Œå¹¶å…¨éƒ¨å†™å…¥
console.log(fooArr); // Uint8Array(3) [102, 111, 111] 
console.log(fooResult); // { read: 3, written: 3 }

// éƒ¨åˆ†å­—ç¬¦è¯»å®Œä¸”éƒ¨åˆ†å†™å…¥
console.log(barArr); // Uint8Array(2) [98, 97] 
console.log(barResult); // { read: 2, written: 2 }
```

â€‹		`encode()` è¦æ±‚åˆ†é…ä¸€ä¸ªæ–°çš„ `Unit8Array`ï¼Œ`encodeInto()` åˆ™ä¸éœ€è¦ã€‚å¯¹äºè¿½æ±‚æ€§èƒ½çš„åº”ç”¨ï¼Œè¿™ä¸ªå·®åˆ«å¯èƒ½ä¼šå¸¦æ¥æ˜¾è‘—ä¸åŒã€‚

â€‹		æ³¨æ„ï¼šæ–‡æœ¬ç¼–ç ä¼šå§‹ç»ˆä½¿ç”¨ `UTF-8` æ ¼å¼ï¼Œè€Œä¸”å¿…é¡»å†™å…¥ `Unit8Array` å®ä¾‹ã€‚ä½¿ç”¨å…¶ä»–ç±»å‹æ•°ç»„ä¼šå¯¼è‡´ `encodeInto()` æŠ›å‡ºé”™è¯¯ã€‚

##### å¯¹æµç¼–ç 

â€‹		`TextEncoderStream` å…¶å®å°±æ˜¯ `TransformStream` å½¢å¼çš„ `TextEncoder`ã€‚å°†è§£ç åçš„æ–‡æœ¬æµï¼Œé€šè¿‡ç®¡é“è¾“å…¥**æµç¼–ç å™¨**ï¼Œå¾—åˆ°ç¼–ç åæ–‡æœ¬å—çš„æµï¼š

```js
async function* chars() { 
 	const decodedText = 'foo'; 
 	for (let char of decodedText) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, char)); 
 	} 
} 

const decodedTextStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of chars()) { 
 			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
}); 

const encodedTextStream = decodedTextStream.pipeThrough(new TextEncoderStream()); 

const readableStreamDefaultReader = encodedTextStream.getReader(); 

(async function() { 
 	while(true) { 
 		const { done, value } = await readableStreamDefaultReader.read(); 
 		if (done) { 
 			break; 
 		} else { 
 			console.log(value); 
 		} 
 	} 
})(); 

// Uint8Array[102] 
// Uint8Array[111] 
// Uint8Array[111]
```



#### æ–‡æœ¬è§£ç 

â€‹		`Encoding API` æä¾›äº†ä¸¤ç§å°†å®šå‹æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„æ–¹å¼ï¼šæ‰¹é‡è§£ç å’Œæµè§£ç ã€‚ä¸ç¼–ç å™¨ç±»ä¸åŒï¼Œåœ¨å°†å®šå‹æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œè§£ç å™¨æ”¯æŒéå¸¸å¤šçš„å­—ç¬¦ä¸²ç¼–ç ï¼Œå¯ä»¥å‚è€ƒ `Encoding Standard` è§„èŒƒçš„ `â€œNames and labelsâ€` ä¸€èŠ‚ã€‚é»˜è®¤å­—ç¬¦ç¼–ç æ ¼å¼æ˜¯ `UTF-8`ã€‚

##### æ‰¹é‡è§£ç 

â€‹		æ‰€è°“æ‰¹é‡ï¼ŒæŒ‡çš„æ˜¯ `JavaScript` å¼•æ“ä¼šåŒæ­¥è§£ç æ•´ä¸ªå­—ç¬¦ä¸²ã€‚å¯¹äºéå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼Œå¯èƒ½ä¼šèŠ±è¾ƒé•¿æ—¶é—´ã€‚æ‰¹é‡è§£ç æ˜¯é€šè¿‡ `TextDecoder` çš„å®ä¾‹å®Œæˆçš„ï¼š

```js
const textDecoder = new TextDecoder();

console.log(textDecoder); // TextDecoderÂ {encoding: 'utf-8', fatal: false, ignoreBOM: false}
/*
TextDecoderÂ {
	encoding: 'utf-8', 
	fatal: false, 
	ignoreBOM: false,
	[[Prototype]]: TextDecoder {
		decode: Æ’ decode(),
		encoding: (...),
		fatal: (...),
		ignoreBOM: (...),
		constructor: Æ’ TextDecoder(),
		Symbol(Symbol.toStringTag): "TextDecoder",
		get encoding: Æ’ encoding(),
		get fatal: Æ’ fatal(),
		get ignoreBOM: Æ’ ignoreBOM(),
		[[Prototype]]: Object
	}
}
*/
```

â€‹		è¿™ä¸ªå®ä¾‹ä¸Šæœ‰ä¸€ä¸ª `decode()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå®šå‹æ•°ç»„å‚æ•°ï¼Œè¿”å›è§£ç åçš„å­—ç¬¦ä¸²ï¼š

```js
// æ‰¹é‡ç¼–ç 
const textEncoder = new TextEncoder();
const encodedText = textEncoder.encode('foo');

// æ‰¹é‡è§£ç 
const textDecoder = new TextDecoder();
const decodedText = textDecoder.decode(encodedText);

console.log(decodedText); 'foo'
```

â€‹		æ¥çœ‹ä¸‹ä¾‹ï¼š

```js
const textDecoder = new TextDecoder(); 

// f çš„ UTF-8 ç¼–ç æ˜¯ 0x66ï¼ˆå³åè¿›åˆ¶ 102ï¼‰
// o çš„ UTF-8 ç¼–ç æ˜¯ 0x6Fï¼ˆå³åè¿›åˆ¶ 111ï¼‰
const encodedText = Uint8Array.of(102, 111, 111); 
const decodedText = textDecoder.decode(encodedText);

console.log(decodedText); // 'foo'
```

â€‹		è§£ç å™¨ä¸å…³å¿ƒä¼ å…¥çš„æ˜¯å“ªç§å®šå‹æ•°ç»„ï¼Œå®ƒåªä¼šä¸“å¿ƒè§£ç æ•´ä¸ªäºŒè¿›åˆ¶è¡¨ç¤ºã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼ŒåªåŒ…å« 8 ä½å­—ç¬¦çš„ 32 ä½å€¼è¢«è§£ç ä¸º `UTF-8` æ ¼å¼ï¼Œè§£ç å¾—åˆ°çš„å­—ç¬¦ä¸²ä¸­å¡«å……äº†ç©ºæ ¼ï¼š

```js
const textDecoder = new TextDecoder(); 

const encodedText = Uint32Array.of(102, 111, 111); 
const decodedText = textDecoder.decode(encodedText); 

console.log(decodedText); // "f   o   o   "
```

â€‹		è§£ç å™¨æ˜¯ç”¨äºå¤„ç†å®šå‹æ•°ç»„ä¸­åˆ†æ•£åœ¨å¤šä¸ªç´¢å¼•ä¸Šçš„å­—ç¬¦çš„ï¼ŒåŒ…æ‹¬è¡¨æƒ…ç¬¦å·ï¼š

```js
const textDecoder = new TextDecoder(); 

// 'ğŸ˜Š' çš„ UTF-8 ç¼–ç æ˜¯ 0xF0 0x9F 0x98 0x8Aï¼ˆå³åè¿›åˆ¶ 240ã€159ã€152ã€138ï¼‰
const encodedText = Uint8Array.of(240, 159, 152, 138);
const decodedText = textDecoder.decode(encodedText); 

console.log(decodedText); // 'ğŸ˜Š'
```

â€‹		ä¸ `TextEncoder` ä¸åŒï¼Œ`TextDecoder` å¯ä»¥å…¼å®¹å¾ˆå¤šå­—ç¬¦ç¼–ç ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­å°±ä½¿ç”¨äº† `UTF-16` è€Œéé»˜è®¤çš„ `UTF-8`ï¼š

```js
const textDecoder = new TextDecoder('utf-16'); 

// f çš„ UTF-16 ç¼–ç æ˜¯ 0x0066ï¼ˆå³åè¿›åˆ¶ 102ï¼‰
// o çš„ UTF-16 ç¼–ç æ˜¯ 0x006Fï¼ˆå³åè¿›åˆ¶ 111ï¼‰
const encodedText = Uint16Array.of(102, 111, 111); 
const decodedText = textDecoder.decode(encodedText); 

console.log(decodedText); // 'foo'
```

##### å¯¹æµè§£ç 

â€‹		`TextDecoderStream` å…¶å®å°±æ˜¯ `TransformStream` å½¢å¼çš„ `TextDecoder`ã€‚å°†ç¼–ç åçš„æ–‡æœ¬æµé€šè¿‡ç®¡é“è¾“å…¥æµè§£ç å™¨ä¼šå¾—åˆ°è§£ç åæ–‡æœ¬å—çš„æµï¼š

```js
async function* chars() { 
 	// æ¯ä¸ªå—å¿…é¡»æ˜¯ä¸€ä¸ªå®šå‹æ•°ç»„
 	const encodedText = [102, 111, 111].map((x) => Uint8Array.of(x)); 
 	for (let char of encodedText) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, char)); 
 	} 
} 

const encodedTextStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of chars()) { 
 			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
}); 

const decodedTextStream = encodedTextStream.pipeThrough(new TextDecoderStream());
const readableStreamDefaultReader = decodedTextStream.getReader(); 

(async function() { 
 	while(true) { 
 		const { done, value } = await readableStreamDefaultReader.read(); 
 		if (done) { 
 			break; 
 		} else { 
 			console.log(value); 
 		} 
 	} 
})(); 

// 'f' 
// 'o' 
// 'o'
```

â€‹		æ–‡æœ¬è§£ç å™¨æµèƒ½å¤Ÿè¯†åˆ«å¯èƒ½åˆ†æ•£åœ¨ä¸åŒå—ä¸Šçš„ä»£ç†å¯¹ã€‚è§£ç å™¨æµä¼šä¿æŒå—ç‰‡æ®µç›´åˆ°å–å¾—å®Œæ•´çš„å­—ç¬¦ã€‚æ¯”å¦‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæµè§£ç å™¨åœ¨è§£ç æµå¹¶è¾“å‡ºå­—ç¬¦ä¹‹å‰ä¼šç­‰å¾…ä¼ å…¥ 4 ä¸ªå—ï¼š

```js
async function* chars() { 
 	// 'ğŸ˜Š' çš„ UTF-8 ç¼–ç æ˜¯ 0xF0 0x9F 0x98 0x8Aï¼ˆå³åè¿›åˆ¶ 240ã€159ã€152ã€138ï¼‰
 	const encodedText = [240, 159, 152, 138].map((x) => Uint8Array.of(x)); 
 	for (let char of encodedText) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, char)); 
 	} 
} 

const encodedTextStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of chars()) { 
 			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
}); 

const decodedTextStream = encodedTextStream.pipeThrough(new TextDecoderStream()); 

const readableStreamDefaultReader = decodedTextStream.getReader(); 

(async function() { 
	while(true) { 
		const { done, value } = await readableStreamDefaultReader.read(); 
		if (done) { 
			break; 
 		} else { 
 			console.log(value); 
 		} 
 	} 
})();

// 'ğŸ˜Š'
```

â€‹		æ–‡æœ¬è§£ç å™¨æµç»å¸¸ä¸ `fetch()` ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºå“åº”ä½“å¯ä»¥ä½œä¸º `ReadableStream` æ¥å¤„ç†ã€‚æ¯”å¦‚ï¼š

```js
const response = await fetch(url); 
const stream = response.body.pipeThrough(new TextDecoderStream());
const decodedStream = stream.getReader(); 

for await (let decodedChunk of decodedStream) { 
	console.log(decodedChunk); 
}
```



### `File API` ä¸ `Blob API`

â€‹		`Web` åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªä¸»è¦çš„ç—›ç‚¹æ˜¯æ— æ³•æ“ä½œç”¨æˆ·è®¡ç®—æœºä¸Šçš„æ–‡ä»¶ã€‚2000 å¹´ä¹‹å‰ï¼Œå¤„ç†æ–‡ä»¶çš„å”¯ä¸€æ–¹å¼æ˜¯æŠŠ `<input type="file">` æ”¾åˆ°ä¸€ä¸ªè¡¨å•é‡Œï¼Œä»…æ­¤è€Œå·²ã€‚`File API` ä¸ `Blob API` æ˜¯ä¸ºäº†è®© `Web` å¼€å‘è€…èƒ½ä»¥å®‰å…¨çš„æ–¹å¼è®¿é—®å®¢æˆ·ç«¯æœºå™¨ä¸Šçš„æ–‡ä»¶ï¼Œä»è€Œæ›´å¥½åœ°ä¸è¿™äº›æ–‡ä»¶äº¤äº’è€Œè®¾è®¡çš„ã€‚



#### `File` ç±»å‹

â€‹		`File API` ä»ç„¶ä»¥è¡¨å•ä¸­çš„æ–‡ä»¶è¾“å…¥å­—æ®µä¸ºåŸºç¡€ï¼Œä½†æ˜¯å¢åŠ äº†ç›´æ¥è®¿é—®æ–‡ä»¶ä¿¡æ¯çš„èƒ½åŠ›ã€‚`HTML5` åœ¨ `DOM` ä¸Šä¸ºæ–‡ä»¶è¾“å…¥å…ƒç´ æ·»åŠ äº† `files` é›†åˆã€‚å½“ç”¨æˆ·åœ¨æ–‡ä»¶å­—æ®µä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œè¿™ä¸ª `files` é›†åˆä¸­ä¼šåŒ…å«ä¸€ç»„ `File` å¯¹è±¡ï¼Œè¡¨ç¤ºè¢«é€‰ä¸­çš„æ–‡ä»¶ã€‚æ¯ä¸ª `File` å¯¹è±¡éƒ½æœ‰ä¸€äº›åªè¯»å±æ€§ã€‚

- `name`ï¼šæœ¬åœ°ç³»ç»Ÿä¸­çš„æ–‡ä»¶åã€‚
- `size`ï¼šä»¥å­—èŠ‚è®¡çš„æ–‡ä»¶å¤§å°ã€‚
- `type`ï¼šåŒ…å«æ–‡ä»¶ `MIME` ç±»å‹çš„å­—ç¬¦ä¸²ã€‚
- `lastModified`ï¼š
- `lastModifiedDate`ï¼šè¡¨ç¤ºæ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´çš„å­—ç¬¦ä¸²ã€‚è¿™ä¸ªå±æ€§åªæœ‰ `Chome` å®ç°äº†ã€‚
- `webkitRelativePath`ï¼š

â€‹		ä¾‹å¦‚ï¼Œé€šè¿‡ç›‘å¬ `change` äº‹ä»¶ç„¶åéå† `files` é›†åˆï¼ˆ`FileList` çš„å®ä¾‹ï¼‰å¯ä»¥å–å¾—æ¯ä¸ªé€‰ä¸­æ–‡ä»¶çš„ä¿¡æ¯ï¼š

```html
<input type="file" id="files-list" multiple>
<script>
let filesList = document.getElementById("files-list"); 

filesList.addEventListener("change", (event) => { 
 	let files = event.target.files, 
 		i = 0, 
 		len = files.length; 
    
 	while (i < len) { 
 		const f = files[i]; 
 		console.log(`${f.name} (${f.type}, ${f.size} bytes)`); 
 		i++; 
 	} 
});
</script>
```

â€‹		è¿™ä¸ªä¾‹å­ç®€å•åœ°åœ¨æ§åˆ¶å°è¾“å‡ºäº†æ¯ä¸ªæ–‡ä»¶çš„ä¿¡æ¯ã€‚ä»…å°±è¿™ä¸ªèƒ½åŠ›è€Œè¨€ï¼Œå·²ç»å¯ä»¥è¯´æ˜¯ `Web` åº”ç”¨å‘å‰è¿ˆè¿›çš„ä¸€å¤§æ­¥äº†ã€‚ä¸è¿‡ï¼Œ`File API` è¿˜æä¾›äº† `FileReader` ç±»å‹ï¼Œè®©æˆ‘ä»¬å¯ä»¥å®é™…ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚



#### `FileReader` ç±»å‹

â€‹		`FileReader` ç±»å‹è¡¨ç¤ºä¸€ç§å¼‚æ­¥æ–‡ä»¶è¯»å–æœºåˆ¶ã€‚å¯ä»¥æŠŠ `FileReader` æƒ³è±¡æˆç±»ä¼¼äº `XMLHttpRequest`ï¼Œåªä¸è¿‡æ˜¯ç”¨äºä»æ–‡ä»¶ç³»ç»Ÿè¯»å–æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä»æœåŠ¡å™¨è¯»å–æ•°æ®ã€‚`FileReader` ç±»å‹æä¾›äº†å‡ ä¸ªè¯»å–æ–‡ä»¶æ•°æ®çš„æ–¹æ³•ã€‚

- `readAsText(file, encoding)`ï¼šä»æ–‡ä»¶ä¸­è¯»å–çº¯æ–‡æœ¬å†…å®¹å¹¶ä¿å­˜åœ¨ `result` å±æ€§ä¸­ã€‚ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºç¼–ç ï¼Œæ˜¯å¯é€‰çš„ã€‚
- `readAsDataURL(file)`ï¼šè¯»å–æ–‡ä»¶å¹¶å°†å†…å®¹çš„æ•°æ® `URI` ä¿å­˜åœ¨ `result` å±æ€§ä¸­ã€‚
- `readAsBinaryString(file)`ï¼šè¯»å–æ–‡ä»¶å¹¶å°†æ¯ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶æ•°æ®ä¿å­˜åœ¨ `result` å±æ€§ä¸­ã€‚
- `readAsArrayBuffer(file)`ï¼šè¯»å–æ–‡ä»¶å¹¶å°†æ–‡ä»¶å†…å®¹ä»¥ `ArrayBuffer` å½¢å¼ä¿å­˜åœ¨ `result` å±æ€§ã€‚

â€‹		è¿™äº›è¯»å–æ•°æ®çš„æ–¹æ³•ä¸ºå¤„ç†æ–‡ä»¶æ•°æ®æä¾›äº†æå¤§çš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†å‘ç”¨æˆ·æ˜¾ç¤ºå›¾ç‰‡ï¼Œå¯ä»¥å°†å›¾ç‰‡è¯»å–ä¸ºæ•°æ® `URI`ï¼Œè€Œä¸ºäº†è§£ææ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥å°†æ–‡ä»¶è¯»å–ä¸ºæ–‡æœ¬ã€‚

â€‹		å› ä¸ºè¿™äº›è¯»å–æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥æ¯ä¸ª `FileReader` ä¼šå‘å¸ƒå‡ ä¸ªäº‹ä»¶ï¼Œå…¶ä¸­ 3 ä¸ªæœ€æœ‰ç”¨çš„äº‹ä»¶æ˜¯ `progress`ã€`error` å’Œ `load`ï¼Œåˆ†åˆ«è¡¨ç¤ºè¯»å–è¿›åº¦ã€è¯»å–å‡ºé”™å’Œè¯»å–å®Œæˆã€‚

```js
new FileReader(); 
/* 
FileReaderÂ {
	error: null,
	onabort: null,
	onerror: null,
	onload: null,
	onloadend: null,
	onloadstart: null,
	onprogress: null,
	readyState: 0,
	result: null,
	[[Prototype]]: FileReader
}
*/
```

â€‹		`progress` äº‹ä»¶æ¯ 50 æ¯«ç§’å°±ä¼šè§¦å‘ä¸€æ¬¡ï¼Œå…¶ä¸ `XHR` çš„ `progress` äº‹ä»¶å…·æœ‰ç›¸åŒçš„ä¿¡æ¯ï¼š`lengthComputable`ã€`loaded` å’Œ `total`ã€‚æ­¤å¤–ï¼Œåœ¨ `progress` äº‹ä»¶ä¸­å¯ä»¥è¯»å– `FileReader` çš„ `result` å±æ€§ï¼Œå³ä½¿å…¶ä¸­å°šæœªåŒ…å«å…¨éƒ¨æ•°æ®ã€‚

- `lengthComputable`ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºä»»åŠ¡çš„è¿›åº¦æ˜¯å¦å¯ä»¥è¢«æµ‹é‡ã€‚
- `loaded`ï¼šä¸€ä¸ª 64 ä½æ— ç¬¦å·æ•´æ•°å€¼ï¼ŒæŒ‡ç¤ºä»»åŠ¡å·²å®Œæˆçš„è¿›åº¦ã€‚
- `total`ï¼šä¸€ä¸ª 64 ä½æ— ç¬¦å·æ•´æ•°å€¼ï¼ŒæŒ‡ç¤ºä»»åŠ¡çš„æ€»è¿›åº¦ã€‚

â€‹		`error` äº‹ä»¶ä¼šåœ¨ç”±äºæŸç§åŸå› æ— æ³•è¯»å–æ–‡ä»¶æ—¶è§¦å‘ã€‚è§¦å‘ `error` äº‹ä»¶æ—¶ï¼Œ`FileReader` çš„ `error` å±æ€§ä¼šåŒ…å«é”™è¯¯ä¿¡æ¯ã€‚è¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåªåŒ…å«ä¸€ä¸ªå±æ€§ï¼š`code`ã€‚è¿™ä¸ªé”™è¯¯ç çš„å€¼å¯èƒ½æ˜¯ 1ï¼ˆæœªæ‰¾åˆ°æ–‡ä»¶ï¼‰ã€2ï¼ˆå®‰å…¨é”™è¯¯ï¼‰ã€3ï¼ˆè¯»å–è¢«ä¸­æ–­ï¼‰ã€4ï¼ˆæ–‡ä»¶ä¸å¯è¯»ï¼‰æˆ– 5ï¼ˆç¼–ç é”™è¯¯ï¼‰ã€‚

â€‹		`load` äº‹ä»¶ä¼šåœ¨æ–‡ä»¶æˆåŠŸåŠ è½½åè§¦å‘ã€‚å¦‚æœ `error` äº‹ä»¶è¢«è§¦å‘ï¼Œåˆ™ä¸ä¼šå†è§¦å‘ `load` äº‹ä»¶ã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†æ‰€æœ‰è¿™ 3 ä¸ªäº‹ä»¶ï¼š

```html
<input type="file" id="files-list">
<div id="progress">è¯»å–è¿›åº¦ï¼š</div>
<div id="output">è¾“å‡ºï¼š</div>
```

```js
let filesList = document.getElementById("files-list"); 

filesList.addEventListener("change", (event) => { 
 	let info = "", 
 		output = document.getElementById("output"), 
 		progress = document.getElementById("progress"), 
 		files = event.target.files, 
 		type = "default", 
 		reader = new FileReader(); 
    
 	if (/image/.test(files[0].type)) { 
 		reader.readAsDataURL(files[0]); // å°†å›¾ç‰‡æ–‡ä»¶è¯»å–ä¸ºDataURIæ•°æ®
 		type = "image"; 
 	} else { 
 		reader.readAsText(files[0]); // å°†å…¶ä»–æ–‡ä»¶è¯»å–ä¸ºæ–‡æœ¬æ•°æ®
 		type = "text"; 
 	} 
    
 	reader.onerror = function() { 
 		output.innerHTML = "Could not read file, error code is " + reader.error.code; 
 	}; 
 
 	reader.onprogress = function(event) { 
 		if (event.lengthComputable) { 
 			progress.innerHTML = `${event.loaded}/${event.total}`; 
 		} 
 	}; 
    
 	reader.onload = function() { 
 		let html = ""; 
 		switch(type) { 
 			case "image": 
 				html = `<img src="${reader.result}">`; 
 				break;
         	case "text": 
 				html = reader.result; 
 				break; 
 		} 
 		output.innerHTML = html; 
 	}; 
});
```

â€‹		ä»¥ä¸Šä»£ç ä»è¡¨å•å­—æ®µä¸­è¯»å–ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†å…¶å†…å®¹æ˜¾ç¤ºåœ¨äº†ç½‘é¡µä¸Šã€‚å¦‚æœæ–‡ä»¶çš„ `MIME` ç±»å‹è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå›¾ç‰‡ï¼Œé‚£ä¹ˆå°±å°†å…¶è¯»å–åä¿å­˜ä¸ºæ•°æ® `URI`ï¼Œåœ¨ `load` äº‹ä»¶è§¦å‘æ—¶å°†æ•°æ® `URI` ä½œä¸ºå›¾ç‰‡æ’å…¥é¡µé¢ä¸­ã€‚å¦‚æœæ–‡ä»¶ä¸æ˜¯å›¾ç‰‡ï¼Œåˆ™è¯»å–åå°†å…¶ä¿å­˜ä¸ºæ–‡æœ¬å¹¶åŸæ ·è¾“å‡ºåˆ°ç½‘é¡µä¸Šã€‚`progress` äº‹ä»¶ç”¨äºè·Ÿè¸ªå’Œæ˜¾ç¤ºè¯»å–æ–‡ä»¶çš„è¿›åº¦ï¼Œè€Œ `error` äº‹ä»¶ç”¨äºç›‘æ§é”™è¯¯ã€‚

â€‹		å¦‚æœæƒ³æå‰ç»“æŸæ–‡ä»¶è¯»å–ï¼Œåˆ™å¯ä»¥åœ¨è¿‡ç¨‹ä¸­è°ƒç”¨ `abort()` æ–¹æ³•ï¼Œä»è€Œè§¦å‘ `abort` äº‹ä»¶ã€‚åœ¨ `load`ã€`error` å’Œ `abort` äº‹ä»¶è§¦å‘åï¼Œè¿˜ä¼šè§¦å‘ `loadend` äº‹ä»¶ã€‚`loadend` äº‹ä»¶è¡¨ç¤ºåœ¨ä¸Šè¿° 3 ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¯»å–æ“ä½œéƒ½å·²ç»ç»“æŸï¼ˆæˆ–å·²å®Œæˆï¼Œæˆ–è¢«ä¸­æ–­ï¼‰ã€‚`readAsText()` å’Œ `readAsDataURL()` æ–¹æ³•å·²ç»å¾—åˆ°äº†æ‰€æœ‰ä¸»æµæµè§ˆå™¨æ”¯æŒã€‚



#### `FileReaderSync` ç±»å‹

â€‹		é¡¾åæ€ä¹‰ï¼Œ`FileReaderSync` ç±»å‹å°±æ˜¯ `FileReader` çš„åŒæ­¥ç‰ˆæœ¬ã€‚è¿™ä¸ªç±»å‹æ‹¥æœ‰ä¸ `FileReader` ç›¸åŒçš„æ–¹æ³•ï¼Œåªæœ‰åœ¨æ•´ä¸ªæ–‡ä»¶éƒ½åŠ è½½åˆ°å†…å­˜ä¹‹åæ‰ä¼šç»§ç»­æ‰§è¡Œã€‚`FileReaderSync` åªåœ¨å·¥ä½œçº¿ç¨‹ä¸­å¯ç”¨ï¼Œå› ä¸ºå¦‚æœè¯»å–æ•´ä¸ªæ–‡ä»¶è€—æ—¶å¤ªé•¿åˆ™ä¼šå½±å“å…¨å±€ã€‚

â€‹		å‡è®¾é€šè¿‡ `postMessage()` å‘å·¥ä½œçº¿ç¨‹å‘é€äº†ä¸€ä¸ª `File` å¯¹è±¡ã€‚ä»¥ä¸‹ä»£ç ä¼šè®©å·¥ä½œçº¿ç¨‹åŒæ­¥å°†æ–‡ä»¶è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç„¶åå°†æ–‡ä»¶çš„æ•°æ® `URL` å‘å›æ¥ï¼š

```js
// worker.js 
self.omessage = (messageEvent) => { 
 	const syncReader = new FileReaderSync();
 	console.log(syncReader); // FileReaderSync {} 
    
 	// è¯»å–æ–‡ä»¶æ—¶é˜»å¡å·¥ä½œçº¿ç¨‹
 	const result = syncReader.readAsDataUrl(messageEvent.data);
    
 	// PDF æ–‡ä»¶çš„ç¤ºä¾‹å“åº”
 	console.log(result); // data:application/pdf;base64,JVBERi0xLjQK... 
    
 	// æŠŠ URL å‘å›å»
 	self.postMessage(result); 
};
```



#### `Blob` ä¸éƒ¨åˆ†è¯»å–

â€‹		æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦è¯»å–éƒ¨åˆ†æ–‡ä»¶è€Œä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ã€‚ä¸ºæ­¤ï¼Œ`File` å¯¹è±¡æä¾›äº†ä¸€ä¸ªåä¸º `slice()` çš„æ–¹æ³•ã€‚`slice()` æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šèµ·å§‹å­—èŠ‚å’Œè¦è¯»å–çš„å­—èŠ‚æ•°ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª `Blob` çš„å®ä¾‹ï¼Œè€Œ `Blob` å®é™…ä¸Šæ˜¯ `File` çš„è¶…ç±»ã€‚

â€‹		`blob` è¡¨ç¤ºäºŒè¿›åˆ¶å¤§å¯¹è±¡ï¼ˆ`binary larget object`ï¼‰ï¼Œæ˜¯ `JavaScript` å¯¹ä¸å¯ä¿®æ”¹äºŒè¿›åˆ¶æ•°æ®çš„å°è£…ç±»å‹ã€‚åŒ…å«å­—ç¬¦ä¸²çš„æ•°ç»„ã€`ArrayBuffers`ã€`ArrayBufferViews`ï¼Œç”šè‡³å…¶ä»– `Blob` éƒ½å¯ä»¥ç”¨æ¥åˆ›å»º `blob`ã€‚`Blob` æ„é€ å‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ª `options` å‚æ•°ï¼Œå¹¶åœ¨å…¶ä¸­æŒ‡å®š `MIME` ç±»å‹ï¼š

```js
console.log(new Blob(['foo'])); // Blob {size: 3, type: ""} 

console.log(new Blob(['{"a": "b"}'], { type: 'application/json' })); // {size: 10, type: "application/json"} 

console.log(new Blob(['<p>Foo</p>', '<p>Bar</p>'], { type: 'text/html' })); // {size: 20, type: "text/html"}
```

â€‹		`Blob` å¯¹è±¡æœ‰ä¸€ä¸ª `size` å±æ€§å’Œä¸€ä¸ª `type` å±æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ª `slice()` æ–¹æ³•ç”¨äºè¿›ä¸€æ­¥åˆ‡åˆ†æ•°æ®ã€‚å¦å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨ `FileReader` ä» `Blob` ä¸­è¯»å–æ•°æ®ã€‚ä¸‹é¢çš„ä¾‹å­åªä¼šè¯»å–æ–‡ä»¶çš„å‰ 32 å­—èŠ‚ï¼š

```js
let filesList = document.getElementById("files-list");

filesList.addEventListener("change", (event) => { 
 	let info = "", 
 		output = document.getElementById("output"), 
 		progress = document.getElementById("progress"), 
 		files = event.target.files, 
 		reader = new FileReader(), 
 		blob = files[0].slice(0, 32);
    
 	if (blob) { 
 		reader.readAsText(blob); 
 		reader.onerror = function() { 
 			output.innerHTML = "Could not read file, error code is " + reader.error.code; 
 		}; 
 		reader.onload = function() { 
 			output.innerHTML = reader.result; 
 		}; 
 	} else { 
 		console.log("Your browser doesn't support slice()."); 
 	} 
});
```

â€‹		åªè¯»å–éƒ¨åˆ†æ–‡ä»¶å¯ä»¥èŠ‚çœæ—¶é—´ï¼Œç‰¹åˆ«æ˜¯åœ¨åªéœ€è¦æ•°æ®ç‰¹å®šéƒ¨åˆ†ï¼ˆæ¯”å¦‚ï¼šæ–‡ä»¶å¤´ï¼‰çš„æ—¶å€™ã€‚



#### å¯¹è±¡ `URL` ä¸ `Blob`

â€‹		å¯¹è±¡ `URL` æœ‰æ—¶å€™ä¹Ÿç§°ä½œ `Blob URL`ï¼Œæ˜¯æŒ‡å¼•ç”¨å­˜å‚¨åœ¨ `File` æˆ– `Blob` ä¸­çš„æ•°æ®çš„ `URL`ã€‚å¯¹è±¡ `URL` çš„ä¼˜ç‚¹æ˜¯ä¸ç”¨æŠŠæ–‡ä»¶å†…å®¹è¯»å–åˆ° `JavaScript` ä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶ã€‚åªè¦åœ¨é€‚å½“ä½ç½®æä¾›å¯¹è±¡ `URL` å³å¯ã€‚è¦åˆ›å»ºå¯¹è±¡ `URL`ï¼Œå¯ä»¥ä½¿ç”¨ `window.URL.createObjectURL()` æ–¹æ³•å¹¶ä¼ å…¥ `File` æˆ– `Blob` å¯¹è±¡ã€‚è¿™ä¸ªå‡½æ•°è¿”å›çš„å€¼æ˜¯ä¸€ä¸ªæŒ‡å‘å†…å­˜ä¸­åœ°å€çš„å­—ç¬¦ä¸²ã€‚å› ä¸ºè¿™ä¸ªå­—ç¬¦ä¸²æ˜¯ `URL`ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ `DOM` ä¸­ç›´æ¥ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç ä½¿ç”¨å¯¹è±¡ `URL` åœ¨é¡µé¢ä¸­æ˜¾ç¤ºäº†ä¸€å¼ å›¾ç‰‡ï¼š

```js
let filesList = document.getElementById("files-list"); 

filesList.addEventListener("change", (event) => { 
 	let info = "", 
 		output = document.getElementById("output"), 
 		progress = document.getElementById("progress"), 
 		files = event.target.files, 
 		reader = new FileReader(), 
 		url = window.URL.createObjectURL(files[0]); 
    
    console.log(url); // 'blob:null/3d5df6d4-b54f-4998-bbf7-7cb4dacfca02'
    
 	if (url) { 
 		if (/image/.test(files[0].type)) { 
 			output.innerHTML = `<img src="${url}">`;
     	} else { 
 			output.innerHTML = "Not an image."; 
 		} 
 	} else { 
 		output.innerHTML = "Your browser doesn't support object URLs."; 
 	} 
});
```

â€‹		å¦‚æœæŠŠå¯¹è±¡ `URL` ç›´æ¥æ”¾åˆ° `<img>` æ ‡ç­¾ï¼Œå°±ä¸éœ€è¦æŠŠæ•°æ®å…ˆè¯»åˆ° `JavaScript` ä¸­äº†ã€‚`<img>` æ ‡ç­¾å¯ä»¥ç›´æ¥ä»ç›¸åº”çš„å†…å­˜ä½ç½®æŠŠæ•°æ®è¯»å–åˆ°é¡µé¢ä¸Šã€‚

â€‹		ä½¿ç”¨å®Œæ•°æ®ä¹‹åï¼Œæœ€å¥½èƒ½é‡Šæ”¾ä¸ä¹‹å…³è”çš„å†…å­˜ã€‚åªè¦å¯¹è±¡ `URL` åœ¨ä½¿ç”¨ä¸­ï¼Œå°±ä¸èƒ½é‡Šæ”¾å†…å­˜ã€‚å¦‚æœæƒ³è¡¨æ˜ä¸å†ä½¿ç”¨æŸä¸ªå¯¹è±¡ `URL`ï¼Œåˆ™å¯ä»¥æŠŠå®ƒä¼ ç»™ `window.URL.revokeObjectURL()`ã€‚é¡µé¢å¸è½½æ—¶ï¼Œæ‰€æœ‰å¯¹è±¡ `URL` å ç”¨çš„å†…å­˜éƒ½ä¼šè¢«é‡Šæ”¾ã€‚ä¸è¿‡ï¼Œæœ€å¥½åœ¨ä¸ä½¿ç”¨æ—¶å°±ç«‹å³é‡Šæ”¾å†…å­˜ï¼Œä»¥ä¾¿å°½å¯èƒ½ä¿æŒé¡µé¢å ç”¨æœ€å°‘èµ„æºã€‚

```js
// å½“å›¾ç‰‡åªéœ€è¦è¢«åŠ è½½ä¸€æ¬¡ï¼Œå½“åŠ è½½å®Œå›¾ç‰‡åï¼Œå°±å¯ä»¥é‡Šæ”¾å¯¹è±¡URLæ‰€å ç”¨çš„å†…å­˜äº†ã€‚
img.onload = function() {
    window.URL.revokeObjectURL(objectUrl);
}
```



#### è¯»å–æ‹–æ”¾æ–‡ä»¶

â€‹		ç»„åˆä½¿ç”¨ `HTML5` æ‹–æ”¾ `API` ä¸ `File API` å¯ä»¥åˆ›å»ºè¯»å–æ–‡ä»¶ä¿¡æ¯çš„æœ‰è¶£åŠŸèƒ½ã€‚åœ¨é¡µé¢ä¸Šåˆ›å»ºæ”¾ç½®ç›®æ ‡åï¼Œå¯ä»¥ä»æ¡Œé¢ä¸ŠæŠŠæ–‡ä»¶æ‹–åŠ¨å¹¶æ”¾åˆ°æ”¾ç½®ç›®æ ‡ã€‚è¿™æ ·ä¼šåƒæ‹–æ”¾å›¾ç‰‡æˆ–é“¾æ¥ä¸€æ ·è§¦å‘ `drop` äº‹ä»¶ã€‚è¢«æ”¾ç½®çš„æ–‡ä»¶å¯ä»¥é€šè¿‡äº‹ä»¶çš„ `event.dataTransfer.files` å±æ€§è¯»åˆ°ï¼Œè¿™ä¸ªå±æ€§ä¿å­˜ç€ä¸€ç»„ `File` å¯¹è±¡ï¼ˆ`FileList` å®ä¾‹ï¼‰ï¼Œå°±åƒæ–‡æœ¬è¾“å…¥å­—æ®µä¸€æ ·ã€‚

â€‹		ä¸‹é¢çš„ä¾‹å­ä¼šæŠŠæ‹–æ”¾åˆ°é¡µé¢æ”¾ç½®ç›®æ ‡ä¸Šçš„æ–‡ä»¶ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼š

```html
<style>
	#droptarget {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 150px;
        height: 150px;
        font-size: 12px;
        background-color: antiquewhite;
    }
</style>
<div id="droptarget">å°†æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤åŒºåŸŸ</div>
<div id="output">è¾“å‡ºï¼š</div>
```

```js
let droptarget = document.getElementById("droptarget"); 

function handleEvent(event) { 
 	let info = "", 
 		output = document.getElementById("output"), 
 		files, i, len; 
    
 	event.preventDefault(); 
    
 	if (event.type == "drop") { 
 		files = event.dataTransfer.files; 
 		i = 0; 
 		len = files.length; 
		 while (i < len) { 
 			info += `${files[i].name} (${files[i].type}, ${files[i].size} bytes)<br>`; 
 			i++; 
 		} 
 		output.innerHTML = info; 
 	} 
} 

droptarget.addEventListener("dragenter", handleEvent); 
droptarget.addEventListener("dragover", handleEvent); 
droptarget.addEventListener("drop", handleEvent);
```

â€‹		ä¸åé¢è¦ä»‹ç»çš„æ‹–æ”¾çš„ä¾‹å­ä¸€æ ·ï¼Œå¿…é¡»å–æ¶ˆ `dragenter`ã€`dragover` å’Œ `drop` çš„é»˜è®¤è¡Œä¸ºã€‚åœ¨ `drop` äº‹ä»¶å¤„ç†ç¨‹åºä¸­ï¼Œå¯ä»¥é€šè¿‡ `event.dataTransfer.files` è¯»åˆ°æ–‡ä»¶ï¼Œæ­¤æ—¶å¯ä»¥è·å–æ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯ã€‚



### åª’ä½“å…ƒç´ 

â€‹		éšç€åµŒå…¥éŸ³é¢‘å’Œè§†é¢‘å…ƒç´ åœ¨ `Web` åº”ç”¨ä¸Šçš„æµè¡Œï¼Œå¤§å¤šæ•°å†…å®¹æä¾›å•†ä¼šå¼ºè¿«ä½¿ç”¨ `Flash` ä»¥ä¾¿è¾¾åˆ°æœ€ä½³çš„è·¨æµè§ˆå™¨å…¼å®¹æ€§ã€‚`HTML5` æ–°å¢äº†ä¸¤ä¸ªä¸åª’ä½“ç›¸å…³çš„å…ƒç´ ï¼Œå³ `<audio>` å’Œ `<video>`ï¼Œä»è€Œä¸ºæµè§ˆå™¨æä¾›äº†åµŒå…¥éŸ³é¢‘å’Œè§†é¢‘çš„ç»Ÿä¸€è§£å†³æ–¹æ¡ˆã€‚

â€‹		è¿™ä¸¤ä¸ªå…ƒç´ æ—¢æ”¯æŒ `Web` å¼€å‘è€…åœ¨é¡µé¢ä¸­åµŒå…¥åª’ä½“æ–‡ä»¶ï¼Œä¹Ÿæ”¯æŒ `JavaScript` å®ç°å¯¹åª’ä½“çš„è‡ªå®šä¹‰æ§åˆ¶ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„ç”¨æ³•ï¼š

```html
<!-- åµŒå…¥è§†é¢‘ --> 
<video src="conference.mpg" id="myVideo">Video player not available.</video> 

<!-- åµŒå…¥éŸ³é¢‘ --> 
<audio src="song.mp3" id="myAudio">Audio player not available.</audio>
```

â€‹		æ¯ä¸ªå…ƒç´ è‡³å°‘è¦æ±‚æœ‰ä¸€ä¸ª `src` å±æ€§ï¼Œä»¥è¡¨ç¤ºè¦åŠ è½½çš„åª’ä½“æ–‡ä»¶ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šè¡¨ç¤ºè§†é¢‘æ’­æ”¾å™¨å¤§å°çš„ `width` å’Œ `height` å±æ€§ï¼Œä»¥åŠåœ¨è§†é¢‘åŠ è½½æœŸé—´æ˜¾ç¤ºå›¾ç‰‡ `URI` çš„ `poster` å±æ€§ã€‚å¦å¤–ï¼Œ`controls` å±æ€§å¦‚æœå­˜åœ¨ï¼Œåˆ™è¡¨ç¤ºæµè§ˆå™¨åº”è¯¥æ˜¾ç¤ºæ’­æ”¾ç•Œé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥æ§åˆ¶åª’ä½“ã€‚å¼€å§‹å’Œç»“æŸæ ‡ç­¾ä¹‹é—´çš„å†…å®¹æ˜¯åœ¨åª’ä½“æ’­æ”¾å™¨ä¸å¯ç”¨æ—¶æ˜¾ç¤ºçš„æ›¿ä»£å†…å®¹ã€‚

â€‹		ç”±äºæµè§ˆå™¨æ”¯æŒçš„åª’ä½“æ ¼å¼ä¸åŒï¼Œå› æ­¤å¯ä»¥æŒ‡å®šå¤šä¸ªä¸åŒçš„åª’ä½“æºã€‚ä¸ºæ­¤ï¼Œéœ€è¦ä»å…ƒç´ ä¸­åˆ é™¤ `src` å±æ€§ï¼Œä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª `<source>` å…ƒç´ ä»£æ›¿ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­æ‰€ç¤ºï¼š

```html
<!-- åµŒå…¥è§†é¢‘ --> 
<video id="myVideo"> 
 	<source src="conference.webm" type="video/webm; codecs='vp8, vorbis'"> 
 	<source src="conference.ogv" type="video/ogg; codecs='theora, vorbis'"> 
 	<source src="conference.mpg"> 
 	Video player not available. 
</video> 

<!-- åµŒå…¥éŸ³é¢‘ --> 
<audio id="myAudio"> 
 	<source src="song.ogg" type="audio/ogg"> 
 	<source src="song.mp3" type="audio/mpeg"> 
 	Audio player not available. 
</audio>
```

â€‹		è®¨è®ºä¸åŒéŸ³é¢‘å’Œè§†é¢‘çš„ç¼–è§£ç å™¨è¶…å‡ºäº†æœ¬ä¹¦èŒƒç•´ï¼Œä½†æµè§ˆå™¨æ”¯æŒçš„ç¼–è§£ç å™¨ç¡®å®å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œå› æ­¤æŒ‡å®šå¤šä¸ªæºæ–‡ä»¶é€šå¸¸æ˜¯å¿…éœ€çš„ã€‚



#### å±æ€§

â€‹		`<video>` å’Œ `<audio>` å…ƒç´ æä¾›äº†ç¨³å¥çš„ `JavaScript` æ¥å£ã€‚è¿™ä¸¤ä¸ªå…ƒç´ æœ‰å¾ˆå¤šå…±æœ‰å±æ€§ï¼Œå¯ä»¥ç”¨äºç¡®å®šåª’ä½“çš„å½“å‰çŠ¶æ€ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚

|         å±æ€§          |   æ•°æ®ç±»å‹   |                             è¯´æ˜                             |
| :-------------------: | :----------: | :----------------------------------------------------------: |
|      `autoplay`       |  `Boolean`   |                  å–å¾—æˆ–è®¾ç½® `autoplay` æ ‡ç­¾                  |
|      `buffered`       | `TimeRanges` |                å¯¹è±¡ï¼Œè¡¨ç¤ºå·²ä¸‹è½½ç¼“å†²çš„æ—¶é—´èŒƒå›´                |
|    `bufferedBytes`    | `ByteRanges` |                å¯¹è±¡ï¼Œè¡¨ç¤ºå·²ä¸‹è½½ç¼“å†²çš„å­—èŠ‚èŒƒå›´                |
|    `bufferingRate`    |  `Integer`   |                      å¹³å‡æ¯ç§’ä¸‹è½½çš„ä½æ•°                      |
| `bufferingThrottled`  |  `Boolean`   |                   è¡¨ç¤ºç¼“å†²æ˜¯å¦è¢«æµè§ˆå™¨æˆªæµ                   |
|      `controls`       |  `Boolean`   |   å–å¾—æˆ–è®¾ç½® `controls` å±æ€§ï¼Œç”¨äºæ˜¾ç¤ºæˆ–éšè—æµè§ˆå™¨å†…ç½®æ§ä»¶   |
|     `currentLoop`     |  `Integer`   |                    åª’ä½“å·²ç»æ’­æ”¾çš„å¾ªç¯æ¬¡æ•°                    |
|     `currentSrc`      |   `String`   |                     å½“å‰æ’­æ”¾åª’ä½“çš„ `URL`                     |
|     `currentTime`     |   `Float`    |                        å·²ç»æ’­æ”¾çš„ç§’æ•°                        |
| `defaultPlaybackRate` |   `Float`    |            å–å¾—æˆ–è®¾ç½®é»˜è®¤å›æ”¾é€Ÿç‡ã€‚é»˜è®¤ä¸º 1.0 ç§’             |
|      `duration`       |   `Float`    |                         åª’ä½“çš„æ€»ç§’æ•°                         |
|        `ended`        |  `Boolean`   |                     è¡¨ç¤ºåª’ä½“æ˜¯å¦æ’­æ”¾å®Œæˆ                     |
|        `loop`         |  `Boolean`   |           å–å¾—æˆ–è®¾ç½®åª’ä½“æ˜¯å¦åº”è¯¥åœ¨æ’­æ”¾å®Œå†å¾ªç¯å¼€å§‹           |
|        `muted`        |  `Boolean`   |                    å–å¾—æˆ–è®¾ç½®åª’ä½“æ˜¯å¦é™éŸ³                    |
|    `networkState`     |  `Integer`   | è¡¨ç¤ºåª’ä½“å½“å‰ç½‘ç»œè¿æ¥çŠ¶æ€ã€‚0 è¡¨ç¤ºç©ºï¼Œ1 è¡¨ç¤ºåŠ è½½ä¸­ï¼Œ<br />2 è¡¨ç¤ºåŠ è½½å…ƒæ•°æ®ï¼Œ3 è¡¨ç¤ºåŠ è½½äº†ç¬¬ä¸€å¸§ï¼Œ4 è¡¨ç¤ºåŠ è½½å®Œæˆ |
|       `paused`        |  `Boolean`   |                      è¡¨ç¤ºæ’­æ”¾å™¨æ˜¯å¦æš‚åœ                      |
|    `playbackRate`     |   `Float`    | å–å¾—æˆ–è®¾ç½®å½“å‰æ’­æ”¾é€Ÿç‡ã€‚ç”¨æˆ·å¯èƒ½ä¼šè®©åª’ä½“æ’­æ”¾å¿«ä¸€äº›æˆ–æ…¢ä¸€äº›ã€‚ä¸`defaultPlaybackRate` ä¸åŒï¼Œè¯¥å±æ€§ä¼šä¿æŒä¸å˜ï¼Œé™¤éå¼€å‘è€…ä¿®æ”¹ |
|       `played`        | `TimeRanges` |                 åˆ°ç›®å‰ä¸ºæ­¢å·²ç»æ’­æ”¾çš„æ—¶é—´èŒƒå›´                 |
|     `readyState`      |  `Integer`   | è¡¨ç¤ºåª’ä½“æ˜¯å¦å·²ç»å‡†å¤‡å°±ç»ªã€‚0 è¡¨ç¤ºåª’ä½“ä¸å¯ç”¨ï¼Œ1 è¡¨ç¤ºå¯ä»¥æ˜¾ç¤ºå½“å‰å¸§ï¼Œ<br />2 è¡¨ç¤ºåª’ä½“å¯ä»¥å¼€å§‹æ’­æ”¾ï¼Œ3 è¡¨ç¤ºåª’ä½“å¯ä»¥ä»å¤´æ’­åˆ°å°¾ |
|      `seekable`       | `TimeRanges` |                      å¯ä»¥è·³è½¬çš„æ—¶é—´èŒƒå›´                      |
|       `seeking`       |  `Boolean`   |            è¡¨ç¤ºæ’­æ”¾å™¨æ˜¯å¦æ­£ç§»åŠ¨åˆ°åª’ä½“æ–‡ä»¶çš„æ–°ä½ç½®            |
|         `src`         |   `String`   |                åª’ä½“æ–‡ä»¶æºã€‚å¯ä»¥åœ¨ä»»ä½•æ—¶å€™é‡å†™                |
|        `start`        |   `Float`    |    å–å¾—æˆ–è®¾ç½®åª’ä½“æ–‡ä»¶ä¸­çš„ä½ç½®ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œä»è¯¥å¤„å¼€å§‹æ’­æ”¾    |
|     `totalBytes`      |  `Integer`   |              èµ„æºéœ€è¦çš„å­—èŠ‚æ€»æ•°ï¼ˆå¦‚æœçŸ¥é“çš„è¯ï¼‰              |
|     `videoHeight`     |  `Integer`   |      è¿”å›è§†é¢‘ï¼ˆä¸ä¸€å®šæ˜¯å…ƒç´ ï¼‰çš„é«˜åº¦ã€‚åªé€‚ç”¨äº `<video>`      |
|     `videoWidth`      |  `Integer`   |      è¿”å›è§†é¢‘ï¼ˆä¸ä¸€å®šæ˜¯å…ƒç´ ï¼‰çš„å®½åº¦ã€‚åªé€‚ç”¨äº `<video>`      |
|       `volume`        |   `Float`    |             å–å¾—æˆ–è®¾ç½®å½“å‰éŸ³é‡ï¼Œå€¼ä¸º 0.0 åˆ° 1.0              |

â€‹		ä¸Šè¿°å¾ˆå¤šå±æ€§ä¹Ÿå¯ä»¥åœ¨ `<audio>` æˆ– `<video>` æ ‡ç­¾ä¸Šè®¾ç½®ã€‚æ›´å¤šå‚è€ƒï¼š[`HTML` éŸ³é¢‘/è§†é¢‘ `DOM` å‚è€ƒæ‰‹å†Œ](https://www.runoob.com/tags/ref-av-dom.html)ã€[`HTML video`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video#attributes)ã€‚



#### äº‹ä»¶

â€‹		é™¤äº†æœ‰å¾ˆå¤šå±æ€§ï¼Œåª’ä½“å…ƒç´ è¿˜æœ‰å¾ˆå¤šäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶ä¼šç›‘æ§ç”±äºåª’ä½“å›æ”¾æˆ–ç”¨æˆ·äº¤äº’å¯¼è‡´çš„ä¸åŒå±æ€§çš„å˜åŒ–ã€‚ä¸‹è¡¨åˆ—å‡ºäº†è¿™äº›äº‹ä»¶ã€‚

|         äº‹ä»¶          |                           ä½•æ—¶è§¦å‘                           |
| :-------------------: | :----------------------------------------------------------: |
|        `abort`        |                          ä¸‹è½½è¢«ä¸­æ–­                          |
|       `canplay`       |               å›æ”¾å¯ä»¥å¼€å§‹ï¼Œ`readyState` ä¸º 2                |
|   `canplaythrough`    |          å›æ”¾å¯ä»¥ç»§ç»­ï¼Œä¸åº”è¯¥ä¸­æ–­ï¼Œ`readState` ä¸º 3          |
| `canshowcurrentframe` |              å·²ç»ä¸‹è½½å½“å‰å¸§ï¼Œ`readyState` ä¸º 1               |
|   `dataunavailable`   |          ä¸èƒ½å›æ”¾ï¼Œå› ä¸ºæ²¡æœ‰æ•°æ®ï¼Œ`readyState` ä¸º 0           |
|   `durationchange`    |                 `duration` å±æ€§çš„å€¼å‘ç”Ÿå˜åŒ–                  |
|       `emptied`       |                        ç½‘ç»œè¿æ¥å…³é—­äº†                        |
|        `empty`        |                   å‘ç”Ÿäº†é”™è¯¯ï¼Œé˜»æ­¢åª’ä½“ä¸‹è½½                   |
|        `ended`        |                 åª’ä½“å·²ç»æ’­æ”¾å®Œä¸€éï¼Œä¸”åœæ­¢äº†                 |
|        `error`        |                    ä¸‹è½½æœŸé—´å‘ç”Ÿäº†ç½‘ç»œé”™è¯¯                    |
|        `load`         | æ‰€æœ‰åª’ä½“å·²ç»ä¸‹è½½å®Œæ¯•ã€‚è¿™ä¸ªäº‹ä»¶å·²è¢«åºŸå¼ƒï¼Œä½¿ç”¨ `canplaythrough` ä»£æ›¿ |
|     `loadeddata`      |                     åª’ä½“çš„ç¬¬ä¸€å¸§å·²ç»ä¸‹è½½                     |
|   `loadedmetadata`    |                     åª’ä½“çš„å…ƒæ•°æ®å·²ç»ä¸‹è½½                     |
|      `loadstart`      |                         ä¸‹è½½å·²ç»å¼€å§‹                         |
|        `pause`        |                         å›æ”¾å·²ç»æš‚åœ                         |
|        `play`         |                  åª’ä½“å·²ç»æ”¶åˆ°å¼€å§‹æ’­æ”¾çš„è¯·æ±‚                  |
|       `playing`       |                    åª’ä½“å·²ç»å®é™…å¼€å§‹æ’­æ”¾äº†                    |
|      `progress`       |                            ä¸‹è½½ä¸­                            |
|     `ratechange`      |                     åª’ä½“æ’­æ”¾é€Ÿç‡å‘ç”Ÿå˜åŒ–                     |
|       `seeked`        |                          è·³è½¬å·²ç»“æŸ                          |
|       `seeking`       |                      å›æ”¾å·²ç§»åŠ¨åˆ°æ–°ä½ç½®                      |
|       `stalled`       |                æµè§ˆå™¨å°è¯•ä¸‹è½½ï¼Œä½†å°šæœªæ”¶åˆ°æ•°æ®                |
|     `timeupdate`      |             `currentTime` è¢«éå¸¸è§„æˆ–æ„å¤–åœ°æ›´æ”¹äº†             |
|    `volumechange`     |             `volume` æˆ– `muted` å±æ€§å€¼å‘ç”Ÿäº†å˜åŒ–             |
|       `waiting`       |                   å›æ”¾æš‚åœï¼Œä»¥ä¸‹è½½æ›´å¤šæ•°æ®                   |

â€‹		è¿™äº›äº‹ä»¶è¢«è®¾è®¡å¾—å°½å¯èƒ½å…·ä½“ï¼Œä»¥ä¾¿ `Web` å¼€å‘è€…èƒ½å¤Ÿä½¿ç”¨è¾ƒå°‘çš„ `HTML` å’Œ `JavaScript` åˆ›å»ºè‡ªå®šä¹‰çš„éŸ³é¢‘/è§†é¢‘æ’­æ”¾å™¨ï¼ˆè€Œä¸æ˜¯åˆ›å»ºæ–° `Flash` å½±ç‰‡ï¼‰ã€‚



#### è‡ªå®šä¹‰åª’ä½“æ’­æ”¾å™¨

â€‹		ä½¿ç”¨ `<audio>` å’Œ `<video>` çš„ `play()` å’Œ `pause()` æ–¹æ³•ï¼Œå¯ä»¥æ‰‹åŠ¨æ§åˆ¶åª’ä½“æ–‡ä»¶çš„æ’­æ”¾ã€‚ç»¼åˆä½¿ç”¨å±æ€§ã€äº‹ä»¶å’Œè¿™äº›æ–¹æ³•ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºè‡ªå®šä¹‰çš„åª’ä½“æ’­æ”¾å™¨ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­æ‰€ç¤ºï¼š

```html
<div class="mediaplayer"> 
 	<div class="video"> 
 		<video id="player" src="movie.mov" poster="mymovie.jpg" width="300" height="200"> 
			Video player not available. 
 		</video> 
 	</div> 
 	<div class="controls"> 
 		<input type="button" value="Play" id="video-btn"> 
 		<span id="curtime">0</span>/<span id="duration">0</span> 
 	</div> 
</div>
```

â€‹		é€šè¿‡ä½¿ç”¨ `JavaScript` åˆ›å»ºä¸€ä¸ªç®€å•çš„è§†é¢‘æ’­æ”¾å™¨ï¼Œä¸Šé¢è¿™ä¸ªåŸºæœ¬çš„ `HTML` å°±å¯ä»¥è¢«æ¿€æ´»äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```js
// å–å¾—å…ƒç´ çš„å¼•ç”¨
let player = document.getElementById("player"), 
 	btn = document.getElementById("video-btn"), 
 	curtime = document.getElementById("curtime"), 
 	duration = document.getElementById("duration"); 

// æ›´æ–°æ—¶é•¿
duration.innerHTML = player.duration; 

// ä¸ºæŒ‰é’®æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åº
btn.addEventListener("click", (event) => { 
 	if (player.paused) { 
 		player.play(); 
 		btn.value = "Pause"; 
 	} else { 
 		player.pause(); 
 		btn.value = "Play"; 
 	} 
}); 

// å‘¨æœŸæ€§æ›´æ–°å½“å‰æ—¶é—´
setInterval(() => { 
 	curtime.innerHTML = player.currentTime; 
}, 250);
```

â€‹		è¿™é‡Œçš„ `JavaScript` ä»£ç ç®€å•åœ°ä¸ºæŒ‰é’®æ·»åŠ äº†äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå¯ä»¥æ ¹æ®å½“å‰çŠ¶æ€æ’­æ”¾å’Œæš‚åœè§†é¢‘ã€‚æ­¤å¤–ï¼Œè¿˜ç»™ `<video>` å…ƒç´ çš„ `load` äº‹ä»¶æ·»åŠ äº†äº‹ä»¶å¤„ç†ç¨‹åºï¼Œä»¥ä¾¿æ˜¾ç¤ºè§†é¢‘çš„æ—¶é•¿ã€‚æœ€åï¼Œé‡å¤çš„è®¡æ—¶å™¨ç”¨äºæ›´æ–°å½“å‰æ—¶é—´ã€‚é€šè¿‡ç›‘å¬æ›´å¤šäº‹ä»¶ä»¥åŠä½¿ç”¨æ›´å¤šå±æ€§ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‰©å±•è¿™ä¸ªè‡ªå®šä¹‰çš„è§†é¢‘æ’­æ”¾å™¨ã€‚åŒæ ·çš„ä»£ç ä¹Ÿå¯ä»¥ç”¨äº `<audio>` å…ƒç´ ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„éŸ³é¢‘æ’­æ”¾å™¨ã€‚



#### æ£€æµ‹ç¼–è§£ç å™¨

â€‹		å¦‚å‰æ‰€è¿°ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒ `<video>` å’Œ `<audio>` çš„æ‰€æœ‰ç¼–è§£ç å™¨ï¼Œè¿™é€šå¸¸æ„å‘³ç€å¿…é¡»æä¾›å¤šä¸ªåª’ä½“æºã€‚ä¸ºæ­¤ï¼Œä¹Ÿæœ‰ `JavaScript API` å¯ä»¥ç”¨æ¥æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒç»™å®šæ ¼å¼å’Œç¼–è§£ç å™¨ã€‚è¿™ä¸¤ä¸ªåª’ä½“å…ƒç´ éƒ½æœ‰ä¸€ä¸ªåä¸º `canPlayType()` çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ª `"æ ¼å¼/ç¼–è§£ç å™¨"` çš„å­—ç¬¦ä¸²ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼š`"probably"`ã€`"maybe"` æˆ– `""`ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œå…¶ä¸­ç©ºå­—ç¬¦ä¸²å°±æ˜¯å‡å€¼ï¼Œæ„å‘³ç€å¯ä»¥åœ¨ `if` è¯­å¥ä¸­åƒè¿™æ ·ä½¿ç”¨ `canPlayType()`ï¼š

```js
if (audio.canPlayType("audio/mpeg")) { 
 	// æ‰§è¡ŒæŸäº›æ“ä½œ
}
```

â€‹		`"probably"` å’Œ `"maybe"` éƒ½æ˜¯çœŸå€¼ï¼Œåœ¨ `if` è¯­å¥çš„ä¸Šä¸‹æ–‡ä¸­å¯ä»¥è½¬å‹ä¸º `true`ã€‚

â€‹		åœ¨åªç»™ `canPlayType()` æä¾›ä¸€ä¸ª `MIME` ç±»å‹çš„æƒ…å†µä¸‹ï¼Œæœ€å¯èƒ½è¿”å›çš„å€¼æ˜¯ `"maybe"` å’Œç©ºå­—ç¬¦ä¸²ã€‚è¿™æ˜¯å› ä¸ºæ–‡ä»¶å®é™…ä¸Šåªæ˜¯ä¸€ä¸ªåŒ…è£…éŸ³é¢‘å’Œè§†é¢‘æ•°æ®çš„å®¹å™¨ï¼Œè€ŒçœŸæ­£å†³å®šæ–‡ä»¶æ˜¯å¦å¯ä»¥æ’­æ”¾çš„æ˜¯ç¼–ç ã€‚åœ¨åŒæ—¶æä¾› `MIME` ç±»å‹å’Œç¼–è§£ç å™¨çš„æƒ…å†µä¸‹ï¼Œè¿”å›å€¼çš„å¯èƒ½æ€§ä¼šæé«˜åˆ° `"probably"`ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªä¾‹å­ï¼š

```js
let audio = document.getElementById("audio-player"); 

// å¾ˆå¯èƒ½æ˜¯"maybe"
if (audio.canPlayType("audio/ogg")) { 
 	// æ‰§è¡ŒæŸäº›æ“ä½œ
} 

// å¯èƒ½æ˜¯"probably"
if (audio.canPlayType("audio/ogg; codecs=\"vorbis\"")) { 
 	// æ‰§è¡ŒæŸäº›æ“ä½œ
}

console.log(audio.canPlayType("audio/mp3")); // 'probably'
```

â€‹		æ³¨æ„ï¼Œç¼–è§£ç å™¨å¿…é¡»æ”¾åˆ°å¼•å·ä¸­ã€‚åŒæ ·ï¼Œä¹Ÿå¯ä»¥åœ¨è§†é¢‘å…ƒç´ ä¸Šä½¿ç”¨ `canPlayType()` æ£€æµ‹è§†é¢‘æ ¼å¼ã€‚



#### éŸ³é¢‘ç±»å‹

â€‹		`<audio>` å…ƒç´ è¿˜æœ‰ä¸€ä¸ªåä¸º `Audio` çš„åŸç”Ÿ `JavaScript` æ„é€ å‡½æ•°ï¼Œæ”¯æŒåœ¨ä»»ä½•æ—¶å€™æ’­æ”¾éŸ³é¢‘ã€‚`Audio` ç±»å‹ä¸ `Image` ç±»ä¼¼ï¼Œéƒ½æ˜¯ `DOM` å…ƒç´ çš„å¯¹ç­‰ä½“ï¼Œåªæ˜¯ä¸éœ€æ’å…¥æ–‡æ¡£å³å¯å·¥ä½œã€‚è¦é€šè¿‡ `Audio` æ’­æ”¾éŸ³é¢‘ï¼Œåªéœ€åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹å¹¶ä¼ å…¥éŸ³é¢‘æºæ–‡ä»¶ï¼š

```js
let audio = new Audio("sound.mp3"); // è‡ªåŠ¨ç”Ÿæˆï¼š<audio preload="auto" src="sound.mp3"></audio>

btn.onclick = () => {
    audio.play();
};
```

â€‹		åˆ›å»º `Audio` çš„æ–°å®ä¾‹å°±ä¼šå¼€å§‹ä¸‹è½½æŒ‡å®šçš„æ–‡ä»¶ã€‚ä¸‹è½½å®Œæ¯•åï¼Œå¯ä»¥è°ƒç”¨ `play()` æ¥æ’­æ”¾éŸ³é¢‘ã€‚

â€‹		åœ¨ `iOS` ä¸­è°ƒç”¨ `play()` æ–¹æ³•ä¼šå¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œè¯·æ±‚ç”¨æˆ·æˆæƒæ’­æ”¾å£°éŸ³ã€‚ä¸ºäº†è¿ç»­æ’­æ”¾ï¼Œå¿…é¡»åœ¨ `onfinish` äº‹ä»¶å¤„ç†ç¨‹åºä¸­ç«‹å³è°ƒç”¨ `play()`ã€‚

â€‹		æ³¨æ„ï¼šæµè§ˆå™¨ç¦æ­¢åœ¨ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ä¹‹å‰æ’­æ”¾éŸ³é¢‘æ–‡ä»¶ã€‚



### åŸç”Ÿæ‹–æ”¾

â€‹		`IE4` æœ€æ—©åœ¨ç½‘é¡µä¸­ä¸º `JavaScript` å¼•å…¥äº†å¯¹æ‹–æ”¾åŠŸèƒ½çš„æ”¯æŒã€‚å½“æ—¶ï¼Œç½‘é¡µä¸­åªæœ‰ä¸¤æ ·ä¸œè¥¿å¯ä»¥è§¦å‘æ‹–æ”¾ï¼šå›¾ç‰‡å’Œæ–‡æœ¬ã€‚æ‹–åŠ¨å›¾ç‰‡å°±æ˜¯ç®€å•åœ°åœ¨å›¾ç‰‡ä¸ŠæŒ‰ä½é¼ æ ‡ä¸æ”¾ç„¶åç§»åŠ¨é¼ æ ‡ã€‚è€Œå¯¹äºæ–‡æœ¬ï¼Œå¿…é¡»å…ˆé€‰ä¸­ï¼Œç„¶åå†ä»¥åŒæ ·çš„æ–¹å¼æ‹–åŠ¨ã€‚åœ¨ `IE4` ä¸­ï¼Œå”¯ä¸€æœ‰æ•ˆçš„æ”¾ç½®ç›®æ ‡æ˜¯æ–‡æœ¬æ¡†ã€‚`IE5` æ‰©å±•äº†æ‹–æ”¾èƒ½åŠ›ï¼Œæ·»åŠ äº†æ–°çš„äº‹ä»¶ï¼Œè®©ç½‘é¡µä¸­å‡ ä¹ä¸€åˆ‡éƒ½å¯ä»¥æˆä¸ºæ”¾ç½®ç›®æ ‡ã€‚`IE5.5` åˆè¿›ä¸€æ­¥ï¼Œå…è®¸å‡ ä¹ä¸€åˆ‡éƒ½å¯ä»¥æ‹–åŠ¨ï¼ˆ`IE6` ä¹Ÿæ”¯æŒè¿™ä¸ªåŠŸèƒ½ï¼‰ã€‚`HTML5` åœ¨ `IE` çš„æ‹–æ”¾å®ç°åŸºç¡€ä¸Šæ ‡å‡†åŒ–äº†æ‹–æ”¾åŠŸèƒ½ã€‚æ‰€æœ‰ä¸»æµæµè§ˆå™¨éƒ½æ ¹æ® `HTML5` è§„èŒƒå®ç°äº†åŸç”Ÿçš„æ‹–æ”¾ã€‚

â€‹		å…³äºæ‹–æ”¾æœ€æœ‰æ„æ€çš„å¯èƒ½å°±æ˜¯å¯ä»¥è·¨çª—æ ¼ã€è·¨æµè§ˆå™¨å®¹å™¨ï¼Œæœ‰æ—¶å€™ç”šè‡³å¯ä»¥è·¨åº”ç”¨ç¨‹åºæ‹–åŠ¨å…ƒç´ ã€‚æµè§ˆå™¨å¯¹æ‹–æ”¾çš„æ”¯æŒå¯ä»¥è®©æˆ‘ä»¬å®ç°è¿™äº›åŠŸèƒ½ã€‚



#### æ‹–æ”¾äº‹ä»¶

â€‹		æ‹–æ”¾äº‹ä»¶å‡ ä¹å¯ä»¥è®©å¼€å‘è€…æ§åˆ¶æ‹–æ”¾æ“ä½œçš„æ–¹æ–¹é¢é¢ã€‚å…³é”®çš„éƒ¨åˆ†æ˜¯ç¡®å®šæ¯ä¸ªäº‹ä»¶æ˜¯åœ¨å“ªé‡Œè§¦å‘çš„ã€‚æœ‰çš„äº‹ä»¶åœ¨è¢«æ‹–æ”¾å…ƒç´ ä¸Šè§¦å‘ï¼Œæœ‰çš„äº‹ä»¶åˆ™åœ¨æ”¾ç½®ç›®æ ‡ä¸Šè§¦å‘ã€‚åœ¨æŸä¸ªå…ƒç´ è¢«æ‹–åŠ¨æ—¶ï¼Œä¼šï¼ˆæŒ‰é¡ºåºï¼‰è§¦å‘ä»¥ä¸‹äº‹ä»¶ï¼š`dragstart` ==> `drag` ==> `dragend`ã€‚

â€‹		åœ¨æŒ‰ä½é¼ æ ‡é”®ä¸æ”¾å¹¶å¼€å§‹ç§»åŠ¨é¼ æ ‡çš„é‚£ä¸€åˆ»ï¼Œè¢«æ‹–åŠ¨å…ƒç´ ä¸Šä¼šè§¦å‘ `dragstart` äº‹ä»¶ã€‚æ­¤æ—¶å…‰æ ‡ä¼šå˜æˆéæ”¾ç½®ç¬¦å·ï¼ˆåœ†ç¯ä¸­é—´ä¸€æ¡æ–œæ ï¼‰ï¼Œè¡¨ç¤ºå…ƒç´ ä¸èƒ½æ”¾åˆ°è‡ªèº«ä¸Šã€‚æ‹–åŠ¨å¼€å§‹æ—¶ï¼Œå¯ä»¥åœ¨ `ondragstart` äº‹ä»¶å¤„ç†ç¨‹åºä¸­é€šè¿‡ `JavaScript` æ‰§è¡ŒæŸäº›æ“ä½œã€‚

â€‹		`dragstart` äº‹ä»¶è§¦å‘åï¼Œåªè¦ç›®æ ‡è¿˜è¢«æ‹–åŠ¨å°±ä¼šæŒç»­è§¦å‘ `drag` äº‹ä»¶ã€‚è¿™ä¸ªäº‹ä»¶ç±»ä¼¼äº `mousemove`ï¼Œå³éšç€é¼ æ ‡ç§»åŠ¨è€Œä¸æ–­è§¦å‘ã€‚å½“æ‹–åŠ¨åœæ­¢æ—¶ï¼ˆæŠŠå…ƒç´ æ”¾åˆ°æœ‰æ•ˆæˆ–æ— æ•ˆçš„æ”¾ç½®ç›®æ ‡ä¸Šï¼‰ï¼Œä¼šè§¦å‘ `dragend` äº‹ä»¶ã€‚

â€‹		æ‰€æœ‰è¿™ 3 ä¸ªäº‹ä»¶çš„ç›®æ ‡éƒ½æ˜¯è¢«æ‹–åŠ¨çš„å…ƒç´ ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨åœ¨æ‹–åŠ¨å¼€å§‹åä¸ä¼šæ”¹å˜è¢«æ‹–åŠ¨å…ƒç´ çš„å¤–è§‚ï¼Œå› æ­¤æ˜¯å¦æ”¹å˜å¤–è§‚ç”±ä½ æ¥å†³å®šã€‚ä¸è¿‡ï¼Œå¤§å¤šæ•°æµè§ˆå™¨æ­¤æ—¶ä¼šåˆ›å»ºå…ƒç´ çš„ä¸€ä¸ªåŠé€æ˜å‰¯æœ¬ï¼Œå§‹ç»ˆè·Ÿéšåœ¨å…‰æ ‡ä¸‹æ–¹ã€‚

â€‹		åœ¨æŠŠå…ƒç´ æ‹–åŠ¨åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„æ”¾ç½®ç›®æ ‡ä¸Šæ—¶ï¼Œä¼šä¾æ¬¡è§¦å‘ä»¥ä¸‹äº‹ä»¶ï¼š`dragenter` ==> `dragover` ==> `dragleave` æˆ– `drop`ã€‚æ— è®ºæ”¾ç½®ç›®æ ‡æ˜¯å¦æœ‰æ•ˆï¼Œåªè¦æŠŠå…ƒç´ æ‹–åŠ¨åˆ°å®ƒä¸Šé¢æˆ–ä»ä¸Šé¢æ‹–å‡ºï¼Œå°±ä¼šä¾æ¬¡è§¦å‘å®ƒçš„ `dragenter`ã€`dragover` å’Œ `dragleave` äº‹ä»¶ã€‚å› ä¸º `drop` äº‹ä»¶åªåœ¨æœ‰æ•ˆçš„æ”¾ç½®ç›®æ ‡ä¸Šæ‰ä¼šè§¦å‘ã€‚

â€‹		åªè¦ä¸€æŠŠå…ƒç´ æ‹–åŠ¨åˆ°æ”¾ç½®ç›®æ ‡ä¸Šï¼Œ`dragenter` äº‹ä»¶ï¼ˆç±»ä¼¼äº `mouseover` äº‹ä»¶ï¼‰å°±ä¼šè§¦å‘ã€‚`dragenter` äº‹ä»¶è§¦å‘ä¹‹åï¼Œä¼šç«‹å³è§¦å‘ `dragover` äº‹ä»¶ï¼Œå¹¶ä¸”å…ƒç´ åœ¨æ”¾ç½®ç›®æ ‡èŒƒå›´å†…è¢«æ‹–åŠ¨æœŸé—´æ­¤äº‹ä»¶ä¼šæŒç»­è§¦å‘ã€‚å½“å…ƒç´ è¢«æ‹–åŠ¨åˆ°æ”¾ç½®ç›®æ ‡ä¹‹å¤–ï¼Œ`dragover` äº‹ä»¶åœæ­¢è§¦å‘ï¼Œ`dragleave` äº‹ä»¶è§¦å‘ï¼ˆç±»ä¼¼äº `mouseout` äº‹ä»¶ï¼‰ã€‚å¦‚æœè¢«æ‹–åŠ¨å…ƒç´ è¢«æ”¾åˆ°äº†æœ‰æ•ˆçš„ç›®æ ‡ä¸Šï¼Œåˆ™ä¼šè§¦å‘ `drop` äº‹ä»¶è€Œä¸æ˜¯ `dragleave` äº‹ä»¶ã€‚è¿™äº›äº‹ä»¶çš„ç›®æ ‡æ˜¯æ”¾ç½®ç›®æ ‡å…ƒç´ ã€‚

â€‹		å½“å°†å¯æ‹–åŠ¨å…ƒç´ æ‹–åŠ¨å¹¶æ”¾ç½®åˆ°æœ‰æ•ˆçš„ç›®æ ‡å…ƒç´ ä¸Šæ—¶ï¼Œä¸¤è€…çš„äº‹ä»¶ä¼šæŒ‰å¦‚ä¸‹ä¾æ¬¡å‘ç”Ÿï¼š

- `dragstart`ï¼šæ‹¿èµ·å…ƒç´ æ—¶è§¦å‘ï¼ˆä¸€æ¬¡ï¼‰
- `drag`ï¼šæ‹¿èµ·å…ƒç´ åå¹¶æ‹–åŠ¨å…ƒç´ æ—¶è§¦å‘ï¼ˆå¤šæ¬¡ï¼‰
- `dragenter`ï¼šè¿›å…¥ç›®æ ‡å…ƒç´ æ—¶è§¦å‘ï¼ˆä¸€æ¬¡ï¼‰
- `dragover`ï¼šåœ¨ç›®æ ‡å…ƒç´ ä¸­æ—¶è§¦å‘ï¼Œç„¶åä¸ `drag` äº‹ä»¶è¿ç»­äº¤æ›¿è§¦å‘ã€‚ç›´åˆ°æ¾å¼€å…ƒç´ å‰è§¦å‘æœ€åä¸€æ¬¡ `dragover`ã€‚
- `drop`ï¼šåœ¨æœ‰æ•ˆçš„ç›®æ ‡å…ƒç´ ä¸­æ”¾ç½®æ‹–åŠ¨å…ƒç´ æ—¶è§¦å‘ï¼ˆä¸€æ¬¡ï¼‰
- `dragend`ï¼šæ‹–åŠ¨å…ƒç´ è¢«æ”¾ç½®åè§¦å‘ï¼ˆä¸€æ¬¡ï¼‰

â€‹		å› æ­¤æ¯æ¬¡äº¤äº’æ—¶ï¼Œæœ‰å¦‚ä¸‹é¡ºåºï¼š`dragstart`ã€`drag`ã€`dragenter`ã€`dragover`ã€`drag`ã€...ã€`dragover`ã€`drop`ã€`dragend`ã€‚ å¦‚æœè¿˜æœ‰ `dragleave` äº‹ä»¶ï¼Œåˆ™å®ƒä¼šåœ¨ `dragover` ä¸ `drag` äº¤æ›¿è§¦å‘è¿‡ç¨‹ä¸­çš„ `drag` äº‹ä»¶åè§¦å‘ã€‚åˆ™å®Œæ•´çš„äº‹ä»¶è§¦å‘é¡ºåºå¦‚ä¸‹ï¼š

```
-start â†’ drag* â†’ -enter â†’ -over â†’ drag â†’ -over â†’ drag(â†’ -leave â†’ -drag* â†’ -enter) â†’...â†’ -over â†’ drop â†’ -end
```



#### è‡ªå®šä¹‰æ”¾ç½®ç›®æ ‡

â€‹		åœ¨æŠŠæŸä¸ªå…ƒç´ æ‹–åŠ¨åˆ°æ— æ•ˆæ”¾ç½®ç›®æ ‡ä¸Šæ—¶ï¼Œä¼šçœ‹åˆ°ä¸€ä¸ªç‰¹æ®Šå…‰æ ‡ï¼ˆåœ†ç¯ä¸­é—´ä¸€æ¡æ–œæ ï¼‰è¡¨ç¤ºä¸èƒ½æ”¾ä¸‹ã€‚å³ä½¿æ‰€æœ‰å…ƒç´ éƒ½æ”¯æŒæ”¾ç½®ç›®æ ‡äº‹ä»¶ï¼Œè¿™äº›å…ƒç´ é»˜è®¤ä¹Ÿæ˜¯ä¸å…è®¸æ”¾ç½®çš„ã€‚å¦‚æœæŠŠå…ƒç´ æ‹–åŠ¨åˆ°ä¸å…è®¸æ”¾ç½®çš„ç›®æ ‡ä¸Šï¼Œæ— è®ºç”¨æˆ·åŠ¨ä½œæ˜¯ä»€ä¹ˆéƒ½ä¸ä¼šè§¦å‘ `drop` äº‹ä»¶ã€‚ä¸è¿‡ï¼Œé€šè¿‡è¦†ç›– `dragenter` å’Œ `dragover` äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼Œå¯ä»¥æŠŠä»»ä½•å…ƒç´ è½¬æ¢ä¸ºæœ‰æ•ˆçš„æ”¾ç½®ç›®æ ‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ä¸€ä¸ª `ID` ä¸º `"droptarget"` çš„  `<div>` å…ƒç´ ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æŠŠå®ƒè½¬æ¢æˆä¸€ä¸ªæ”¾ç½®ç›®æ ‡ï¼š

```js
let dropTarget = document.getElementById("droptarget"); 

// æ–°æµè§ˆå™¨åªéœ€è¦é˜»æ­¢overçš„é»˜è®¤è¡Œä¸ºå³å¯
dropTarget.addEventListener("dragover", (event) => { 
 	event.preventDefault(); 
}); 

// æ—§æµè§ˆå™¨å¯èƒ½è¿˜è¦é˜»æ­¢enterçš„é»˜è®¤è¡Œä¸º
dropTarget.addEventListener("dragenter", (event) => { 
 	event.preventDefault(); 
});
```

â€‹		æ‰§è¡Œä¸Šé¢çš„ä»£ç ä¹‹åï¼ŒæŠŠå…ƒç´ æ‹–åŠ¨åˆ°è¿™ä¸ª `<div>` ä¸Šåº”è¯¥å¯ä»¥çœ‹åˆ°å…‰æ ‡å˜æˆäº†å…è®¸æ”¾ç½®çš„æ ·å­ã€‚å¦å¤–ï¼Œ`drop` äº‹ä»¶ä¹Ÿä¼šè§¦å‘ã€‚

â€‹		åœ¨æ—§ `Firefox` ä¸­ï¼Œæ”¾ç½®ï¼ˆ`drop`ï¼‰äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¼èˆªåˆ°æ”¾åœ¨æ”¾ç½®ç›®æ ‡ä¸Šçš„ `URL`ã€‚è¿™æ„å‘³ç€æŠŠå›¾ç‰‡æ‹–åŠ¨åˆ°æ”¾ç½®ç›®æ ‡ä¸Šä¼šå¯¼è‡´é¡µé¢å¯¼èˆªåˆ°å›¾ç‰‡æ–‡ä»¶ï¼ŒæŠŠæ–‡æœ¬æ‹–åŠ¨åˆ°æ”¾ç½®ç›®æ ‡ä¸Šä¼šå¯¼è‡´æ— æ•ˆ `URL` é”™è¯¯ã€‚ä¸ºé˜»æ­¢è¿™ä¸ªè¡Œä¸ºï¼Œåœ¨ `Firefox` ä¸­å¿…é¡»å–æ¶ˆ `drop` äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼š

```js
dropTarget.addEventListener("drop", (event) => { 
 	event.preventDefault(); 
});
```

â€‹		ä½†ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒå°†æ–‡ä»¶æ”¾ç½®åˆ°ç›®æ ‡å…ƒç´ ä¸Šæ—¶æ‰“å¼€è¯¥æ–‡ä»¶ï¼ˆåœ¨æœ¬é¡µæˆ–æ–°é¡µä¸­ï¼‰ã€‚å¯¹äºä¸æ”¯æŒç›´æ¥æ‰“å¼€çš„æ–‡ä»¶ï¼Œä¼šé€‰æ‹©ç«‹å³ä¸‹è½½ã€‚



#### `dataTransfer` å¯¹è±¡

â€‹		é™¤éæ•°æ®å—å½±å“ï¼Œå¦åˆ™ç®€å•çš„æ‹–æ”¾å¹¶æ²¡æœ‰å®é™…æ„ä¹‰ã€‚ä¸ºå®ç°æ‹–åŠ¨æ“ä½œä¸­çš„æ•°æ®ä¼ è¾“ï¼Œ`IE5` åœ¨ `event` å¯¹è±¡ä¸Šæš´éœ²äº† `dataTransfer` å¯¹è±¡ï¼Œç”¨äºä»è¢«æ‹–åŠ¨å…ƒç´ å‘æ”¾ç½®ç›®æ ‡ä¼ é€’å­—ç¬¦ä¸²æ•°æ®ã€‚å› ä¸ºè¿™ä¸ªå¯¹è±¡æ˜¯ `event` çš„å±æ€§ï¼Œæ‰€ä»¥åœ¨æ‹–æ”¾äº‹ä»¶çš„äº‹ä»¶å¤„ç†ç¨‹åºå¤–éƒ¨æ— æ³•è®¿é—® `dataTransfer`ã€‚åœ¨äº‹ä»¶å¤„ç†ç¨‹åºå†…éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•å®ç°æ‹–æ”¾åŠŸèƒ½ã€‚`dataTransfer` å¯¹è±¡ç°åœ¨å·²ç»çº³å…¥äº† `HTML5` å·¥ä½œè‰æ¡ˆã€‚

â€‹		`dataTransfer` å¯¹è±¡æœ‰ä¸¤ä¸ªä¸»è¦æ–¹æ³•ï¼š`getData()` å’Œ `setData()`ã€‚é¡¾åæ€ä¹‰ï¼Œ`getData()` ç”¨äºè·å– `setData()` å­˜å‚¨çš„å€¼ã€‚`setData()` çš„ç¬¬ä¸€ä¸ªå‚æ•°ä»¥åŠ `getData()` çš„å”¯ä¸€å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºè¦è®¾ç½®çš„æ•°æ®ç±»å‹ï¼š`"text"` æˆ– `"URL"`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```js
// åŸºæœ¬æ€è·¯ï¼šåœ¨dragstartä¸­å­˜å‚¨æ•°æ®ï¼Œåœ¨dropä¸­è·å–æ•°æ®ã€‚

// ä¼ é€’æ–‡æœ¬
draggable.addEventListener("dragstart", (event) => {
	event.dataTransfer.setData("text", "some text");
});
dropTarget.addEventListener("drop", (event) => {
    // é»˜è®¤æƒ…å†µä¸‹ï¼Œè·å¾—è¢«æ‹–åŠ¨çš„æ–‡æœ¬ã€‚é™¤éåœ¨startä¸­ä¿®æ”¹å®ƒã€‚
    let text = event.dataTransfer.getData("text"); 
});

// ä¼ é€’ URL 
event.dataTransfer.setData("URL", "http://www.wrox.com/"); 
let url = event.dataTransfer.getData("URL");
```

â€‹		æ³¨é‡Šï¼š`Chrome` å’Œ `Firefox` éƒ½åªæ”¯æŒåœ¨ `dragstart` ä¸­é€šè¿‡ `setData()` è®¾ç½®æ•°æ®ã€‚ä½† `Chrome` åªæ”¯æŒåœ¨ `dragstart` å’Œ `drop` ä¸­é€šè¿‡ `getData()` è·å–æ•°æ®ï¼›è€Œ `Firefox` æ”¯æŒåœ¨æ‰€æœ‰çš„æ‹–åŠ¨äº‹ä»¶ä¸­è·å¾—æ•°æ®ï¼ˆåŒ…æ‹¬æ‹–åŠ¨å…ƒç´ å’Œç›®æ ‡å…ƒç´ çš„äº‹ä»¶ï¼‰ã€‚ä¸è¿‡ï¼Œä¸€æ—¦æ•°æ®åœ¨è§¦å‘ `drop` ä¹‹å‰è¢«è·å–è¿‡ä¸€æ¬¡ä¹‹åï¼Œå°±æ— æ³•åœ¨ `drop` ä¸­è·å¾—å®ƒäº†ã€‚

â€‹		è™½ç„¶è¿™ä¸¤ç§æ•°æ®ç±»å‹æ˜¯ `IE` æœ€åˆå¼•å…¥çš„ï¼Œä½† `HTML5` å·²ç»å°†å…¶æ‰©å±•ä¸ºå…è®¸ä»»ä½• `MIME` ç±»å‹ã€‚ä¸ºå‘åå…¼å®¹ï¼Œ`HTML5` è¿˜ä¼šç»§ç»­æ”¯æŒ `"text"` å’Œ `"URL"`ï¼Œä½†å®ƒä»¬ä¼šåˆ†åˆ«è¢«æ˜ å°„åˆ° `"text/plain"` å’Œ `"text/uri-list"` ä¹‹ä¸Šã€‚

```js
draggable.addEventListener("dragstart", (event) => {
    let url = event.dataTransfer.getData('text/uri-list');
	event.dataTransfer.setData("text/uri-list", url);
});

dropTarget.addEventListener("drop", (event) => {
    let text = event.dataTransfer.getData("text/uri-list"); 
});
```

â€‹		`dataTransfer` å¯¹è±¡å®é™…ä¸Šå¯ä»¥åŒ…å«æ¯ç§ `MIME` ç±»å‹çš„ä¸€ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥åŒæ—¶ä¿å­˜æ–‡æœ¬å’Œ `URL`ï¼Œä¸¤è€…ä¸ä¼šç›¸äº’è¦†ç›–ã€‚è¿‡å»ï¼Œå­˜å‚¨åœ¨ `dataTransfer` å¯¹è±¡ä¸­çš„æ•°æ®åªèƒ½åœ¨æ”¾ç½®äº‹ä»¶ä¸­è¯»å–ã€‚å¦‚æœæ²¡æœ‰åœ¨ `ondrop` äº‹ä»¶å¤„ç†ç¨‹åºä¸­å–å¾—è¿™äº›æ•°æ®ï¼Œ`dataTransfer` å¯¹è±¡å°±ä¼šè¢«é”€æ¯ï¼Œæ•°æ®ä¹Ÿä¼šä¸¢å¤±ã€‚

â€‹		åœ¨ä»æ–‡æœ¬æ¡†æ‹–åŠ¨æ–‡æœ¬æ—¶ï¼Œæµè§ˆå™¨ä¼šè°ƒç”¨ `setData()` å¹¶å°†æ‹–åŠ¨çš„æ–‡æœ¬ä»¥ `"text"` æ ¼å¼å­˜å‚¨èµ·æ¥ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨æ‹–åŠ¨é“¾æ¥æˆ–å›¾ç‰‡æ—¶ï¼Œæµè§ˆå™¨ä¼šè°ƒç”¨ `setData()` å¹¶æŠŠ `URL` å­˜å‚¨èµ·æ¥ã€‚å½“æ•°æ®è¢«æ”¾ç½®åœ¨ç›®æ ‡ä¸Šæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `getData()` è·å–è¿™äº›æ•°æ®ã€‚å½“ç„¶ï¼Œå¯ä»¥åœ¨ `dragstart` äº‹ä»¶ä¸­æ‰‹åŠ¨è°ƒç”¨ `setData()` å­˜å‚¨è‡ªå®šä¹‰æ•°æ®ï¼Œä»¥ä¾¿å°†æ¥ä½¿ç”¨ã€‚

â€‹		ä½œä¸ºæ–‡æœ¬çš„æ•°æ®å’Œä½œä¸º `URL` çš„æ•°æ®æœ‰ä¸€ä¸ªåŒºåˆ«ã€‚å½“æŠŠæ•°æ®ä½œä¸ºæ–‡æœ¬å­˜å‚¨æ—¶ï¼Œæ•°æ®ä¸ä¼šè¢«ç‰¹æ®Šå¯¹å¾…ã€‚è€Œå½“æŠŠæ•°æ®ä½œä¸º `URL` å­˜å‚¨æ—¶ï¼Œæ•°æ®ä¼šè¢«ä½œä¸ºç½‘é¡µä¸­çš„ä¸€ä¸ªé“¾æ¥ï¼Œæ„å‘³ç€å¦‚æœæŠŠå®ƒæ”¾åˆ°å¦ä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œæµè§ˆå™¨ä¼šå¯¼èˆªåˆ°è¯¥ `URL`ã€‚

â€‹		ç›´åˆ°ç‰ˆæœ¬ 5ï¼Œ`Firefox` éƒ½ä¸èƒ½æ­£ç¡®åœ°æŠŠ `"url"` æ˜ å°„ä¸º `"text/uri-list"` æˆ–æŠŠ `"text"` æ˜ å°„ä¸º `"text/plain"`ã€‚ä¸è¿‡ï¼Œå®ƒå¯ä»¥æŠŠ `"Text"`ï¼ˆç¬¬ä¸€ä¸ªå­—æ¯å¤§å†™ï¼‰æ­£ç¡®æ˜ å°„ä¸º `"text/plain"`ã€‚åœ¨é€šè¿‡ `dataTransfer` è·å–æ•°æ®æ—¶ï¼Œä¸ºä¿æŒæœ€å¤§å…¼å®¹æ€§ï¼Œéœ€è¦å¯¹ `URL` æ£€æµ‹ä¸¤ä¸ªå€¼å¹¶å¯¹æ–‡æœ¬ä½¿ç”¨ `"Text"`ï¼š

```js
let dataTransfer = event.dataTransfer; 
// è¯»å– URL 
let url = dataTransfer.getData("url") || dataTransfer.getData("text/uri-list"); 
// è¯»å–æ–‡æœ¬
let text = dataTransfer.getData("Text");
```

â€‹		è¿™é‡Œè¦æ³¨æ„ï¼Œé¦–å…ˆåº”è¯¥å°è¯•çŸ­æ•°æ®åã€‚è¿™æ˜¯å› ä¸ºç›´åˆ°ç‰ˆæœ¬ 10ï¼Œ`IE` éƒ½ä¸æ”¯æŒæ‰©å±•çš„ç±»å‹åï¼Œè€Œä¸”ä¼šåœ¨é‡åˆ°æ— æ³•è¯†åˆ«çš„ç±»å‹åæ—¶æŠ›å‡ºé”™è¯¯ã€‚ä¸è¿‡ï¼Œå¯¹äºç°ä»£æµè§ˆå™¨æ¥è¯´ï¼Œè¿™äº›é—®é¢˜æ—©å·²å¾—åˆ°è§£å†³ã€‚



#### `dropEffect` ä¸ `effectAllowed`

â€‹		`dataTransfer` å¯¹è±¡ä¸ä»…å¯ä»¥ç”¨äºå®ç°ç®€å•çš„æ•°æ®ä¼ è¾“ï¼Œè¿˜å¯ä»¥ç”¨äºç¡®å®šèƒ½å¤Ÿå¯¹è¢«æ‹–åŠ¨å…ƒç´ å’Œæ”¾ç½®ç›®æ ‡æ‰§è¡Œä»€ä¹ˆæ“ä½œã€‚ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ä¸ªå±æ€§ï¼š`dropEffect` ä¸ `effectAllowed`ã€‚

â€‹		`dropEffect` å±æ€§å¯ä»¥å‘Šè¯‰æµè§ˆå™¨å…è®¸å“ªç§æ”¾ç½®è¡Œä¸ºã€‚è¿™ä¸ªå±æ€§æœ‰ä»¥ä¸‹ 4 ç§å¯èƒ½çš„å€¼ã€‚

- `"none"`ï¼šè¢«æ‹–åŠ¨å…ƒç´ ä¸èƒ½æ”¾åˆ°è¿™é‡Œã€‚è¿™æ˜¯é™¤æ–‡æœ¬æ¡†ä¹‹å¤–æ‰€æœ‰å…ƒç´ çš„é»˜è®¤å€¼ã€‚
- `"move"`ï¼šè¢«æ‹–åŠ¨å…ƒç´ åº”è¯¥ç§»åŠ¨åˆ°æ”¾ç½®ç›®æ ‡ã€‚
- `"copy"`ï¼šè¢«æ‹–åŠ¨å…ƒç´ åº”è¯¥å¤åˆ¶åˆ°æ”¾ç½®ç›®æ ‡ã€‚
- `"link"`ï¼šè¡¨ç¤ºæ”¾ç½®ç›®æ ‡ä¼šå¯¼èˆªåˆ°è¢«æ‹–åŠ¨å…ƒç´ ï¼ˆä»…åœ¨å®ƒæ˜¯ `URL` çš„æƒ…å†µä¸‹ï¼‰ã€‚

â€‹		åœ¨æŠŠå…ƒç´ æ‹–åŠ¨åˆ°æ”¾ç½®ç›®æ ‡ä¸Šæ—¶ï¼Œä¸Šè¿°æ¯ç§å€¼éƒ½ä¼šå¯¼è‡´æ˜¾ç¤ºä¸€ç§ä¸åŒçš„å…‰æ ‡ã€‚ä¸è¿‡ï¼Œæ˜¯å¦å¯¼è‡´å…‰æ ‡ç¤ºæ„çš„åŠ¨ä½œè¿˜è¦å–å†³äºå¼€å‘è€…ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœæ²¡æœ‰ä»£ç å‚ä¸ï¼Œåˆ™æ²¡æœ‰ä»€ä¹ˆä¼šè‡ªåŠ¨ç§»åŠ¨ã€å¤åˆ¶æˆ–é“¾æ¥ã€‚å”¯ä¸€ä¸ç”¨è€ƒè™‘çš„å°±æ˜¯å…‰æ ‡è‡ªå·±ä¼šå˜ã€‚ä¸ºäº†ä½¿ç”¨ `dropEffect` å±æ€§ï¼Œå¿…é¡»åœ¨æ”¾ç½®ç›®æ ‡çš„ `ondragenter` äº‹ä»¶å¤„ç†ç¨‹åºä¸­è®¾ç½®å®ƒã€‚

â€‹		é™¤éåŒæ—¶è®¾ç½® `effectAllowed`ï¼Œå¦åˆ™ `dropEffect` å±æ€§ä¹Ÿæ²¡æœ‰ç”¨ã€‚`effectAllowed` å±æ€§è¡¨ç¤ºå¯¹è¢«æ‹–åŠ¨å…ƒç´ æ˜¯å¦å…è®¸ `dropEffect` ã€‚è¿™ä¸ªå±æ€§æœ‰å¦‚ä¸‹å‡ ä¸ªå¯èƒ½çš„å€¼ã€‚

- `"uninitialized"`ï¼šæ²¡æœ‰ç»™è¢«æ‹–åŠ¨å…ƒç´ è®¾ç½®åŠ¨ä½œã€‚
- `"none"`ï¼šè¢«æ‹–åŠ¨å…ƒç´ ä¸Šæ²¡æœ‰å…è®¸çš„æ“ä½œã€‚
- `"copy"`ï¼šåªå…è®¸ `"copy"` è¿™ç§ `dropEffect`ã€‚
- `"link"`ï¼šåªå…è®¸ `"link"` è¿™ç§ `dropEffect`ã€‚
- `"move"`ï¼šåªå…è®¸ `"move"` è¿™ç§ `dropEffect`ã€‚
- `"copyLink"`ï¼šå…è®¸ `"copy"` å’Œ `"link"` ä¸¤ç§ `dropEffect`ã€‚
- `"copyMove"`ï¼šå…è®¸ `"copy"` å’Œ `"move"` ä¸¤ç§ `dropEffect`ã€‚
- `"linkMove"`ï¼šå…è®¸ `"link"` å’Œ `"move"` ä¸¤ç§ `dropEffect`ã€‚
- `"all"`ï¼šå…è®¸æ‰€æœ‰ `dropEffect`ã€‚

â€‹		å¿…é¡»åœ¨ `ondragstart` äº‹ä»¶å¤„ç†ç¨‹åºä¸­è®¾ç½®è¿™ä¸ªå±æ€§ã€‚

```js
draggable.ondragstart = function(event) {
    event.dataTransfer.effectAllowed = 'move';
};

dragTarget.ondragenter = function(event) {
    event.dataTransfer.dropEffect = 'move';
};
```

â€‹		å‡è®¾æˆ‘ä»¬æƒ³å…è®¸ç”¨æˆ·æŠŠæ–‡æœ¬ä»ä¸€ä¸ªæ–‡æœ¬æ¡†ç§»åŠ¨åˆ°ä¸€ä¸ª `<div>` å…ƒç´ ä¸­ã€‚é‚£ä¹ˆå¿…é¡»åŒæ—¶æŠŠ `dropEffect` å’Œ `effectAllowed` å±æ€§è®¾ç½®ä¸º `"move"`ã€‚å› ä¸º `<div>` å…ƒç´ ä¸Šæ”¾ç½®äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºæ˜¯ä»€ä¹ˆä¹Ÿä¸åšï¼Œæ‰€ä»¥æ–‡æœ¬ä¸ä¼šè‡ªåŠ¨åœ°ç§»åŠ¨è‡ªå·±ã€‚å¦‚æœè¦†ç›–äº†è¿™ä¸ªé»˜è®¤è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™æ®µæ–‡æœ¬å°±ä¼šè‡ªåŠ¨ä»æ–‡æœ¬æ¡†ä¸­è¢«ç§»é™¤ã€‚ç„¶åæ˜¯å¦æŠŠæ–‡æœ¬æ’å…¥ `<div>` å…ƒç´ å°±å–å†³äºä½ äº†ã€‚å¦‚æœæ˜¯æŠŠ `dropEffect` å’Œ `effectAllowed` å±æ€§è®¾ç½®ä¸º `"copy"`ï¼Œé‚£ä¹ˆæ–‡æœ¬æ¡†ä¸­çš„æ–‡æœ¬ä¸ä¼šè‡ªåŠ¨è¢«ç§»é™¤ï¼Œå› ä¸ºåªæ˜¯å¤åˆ¶æ–‡æœ¬è€Œå·²ã€‚

```html
<input id="draggable" type="text">
<div id="droptarget">ç›®æ ‡åŒºåŸŸ</div>
<script>
    // æ‹–åŠ¨å…ƒç´ 
    let draggable = document.querySelector("#draggable");

    draggable.addEventListener("dragstart", (event) => {
        event.dataTransfer.effectAllowed = 'move';
    });
    
    // ç›®æ ‡å…ƒç´ 
    let droptarget = document.getElementById("droptarget");

    droptarget.addEventListener("dragenter", (event) => {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    });

    droptarget.addEventListener("dragover", (event) => {
        event.preventDefault();
    });
    
    droptarget.addEventListener("drop", (event) => {
        event.preventDefault();
        event.target.innerText = event.dataTransfer.getData('text');
    });
</script>
```

â€‹		å°†è¢«æ‹–åŠ¨å…ƒç´ æ”¾ç½®åˆ°ç›®æ ‡å…ƒç´ ä¸­ï¼š

```html
<div>
	<p id="source" ondragstart="dragstart_handler(event);" draggable="true">
		Select this element, drag it to the Drop Zone and then release the selection to move the element.
  	</p>
</div>
<div id="target" 
     ondrop="drop_handler(event);" 
     ondragover="dragover_handler(event);" 
     ondragenter="dragenter_handler(event);"
>
    Drop Zone
</div>
<style>
    div {
      margin: 0em;
      padding: 2em;
    }

    #source {
      color: blue;
      border: 1px solid black;
    }

    #target {
      border: 1px solid black;
    }
</style>
<script>
	function dragstart_handler(ev) {
      	// Add this element's id to the drag payload so the drop handler will
      	// know which element to add to its tree
      	ev.dataTransfer.setData("text", ev.target.id);
      	ev.dataTransfer.effectAllowed = "move";
    }

    function dragenter_handler(ev) {
		ev.preventDefault();
        
      	// Set the dropEffect to move
      	ev.dataTransfer.dropEffect = "move";
    }
    
    function dragover_handler(ev) {
      	ev.preventDefault();
    }
    
	function drop_handler(ev) {
      	ev.preventDefault();
        
      	// Get the id of the target and add the moved element to the target's DOM
      	var data = ev.dataTransfer.getData("text");
      	ev.target.appendChild(document.getElementById(data));
    }
</script>
```



#### å¯æ‹–åŠ¨èƒ½åŠ›

â€‹		é»˜è®¤æƒ…å†µä¸‹ï¼Œå›¾ç‰‡ã€é“¾æ¥å’Œæ–‡æœ¬æ˜¯å¯æ‹–åŠ¨çš„ï¼Œè¿™æ„å‘³ç€æ— é¡»é¢å¤–ä»£ç ç”¨æˆ·ä¾¿å¯ä»¥æ‹–åŠ¨å®ƒä»¬ã€‚æ–‡æœ¬åªæœ‰åœ¨è¢«é€‰ä¸­åæ‰å¯ä»¥æ‹–åŠ¨ï¼Œè€Œå›¾ç‰‡å’Œé“¾æ¥åœ¨ä»»æ„æ—¶å€™éƒ½æ˜¯å¯ä»¥æ‹–åŠ¨çš„ã€‚

â€‹		æˆ‘ä»¬ä¹Ÿå¯ä»¥è®©å…¶ä»–å…ƒç´ å˜å¾—å¯ä»¥æ‹–åŠ¨ã€‚`HTML5` åœ¨æ‰€æœ‰ `HTML` å…ƒç´ ä¸Šè§„å®šäº†ä¸€ä¸ª `draggable` å±æ€§ï¼Œè¡¨ç¤ºå…ƒç´ æ˜¯å¦å¯ä»¥æ‹–åŠ¨ã€‚å›¾ç‰‡å’Œé“¾æ¥çš„ `draggable` å±æ€§è‡ªåŠ¨è¢«è®¾ç½®ä¸º `true`ï¼Œè€Œå…¶ä»–æ‰€æœ‰å…ƒç´ æ­¤å±æ€§çš„é»˜è®¤å€¼ä¸º `false`ã€‚å¦‚æœæƒ³è®©å…¶ä»–å…ƒç´ å¯æ‹–åŠ¨ï¼Œæˆ–è€…ä¸å…è®¸å›¾ç‰‡å’Œé“¾æ¥è¢«æ‹–åŠ¨ï¼Œéƒ½å¯ä»¥è®¾ç½®è¿™ä¸ªå±æ€§ã€‚ä¾‹å¦‚ï¼š

```html
<!-- ç¦æ­¢æ‹–åŠ¨å›¾ç‰‡ --> 
<img src="smile.gif" draggable="false" alt="Smiley face"> 

<!-- è®©å…ƒç´ å¯ä»¥æ‹–åŠ¨ --> 
<div draggable="true">...</div>
```



#### å…¶ä»–æˆå‘˜

â€‹		`HTML5` è§„èŒƒè¿˜ä¸º `dataTransfer` å¯¹è±¡å®šä¹‰äº†ä¸‹åˆ—æ–¹æ³•ã€‚

- `addElement(element)`ï¼šä¸ºæ‹–åŠ¨æ“ä½œæ·»åŠ å…ƒç´ ã€‚è¿™çº¯ç²¹æ˜¯ä¸ºäº†ä¼ è¾“æ•°æ®ï¼Œä¸ä¼šå½±å“æ‹–åŠ¨æ“ä½œçš„å¤–è§‚ã€‚
- `clearData(format)`ï¼šæ¸…é™¤ä»¥ç‰¹å®šæ ¼å¼å­˜å‚¨çš„æ•°æ®ï¼Œè¯¥æ–¹æ³•åªèƒ½åœ¨ `dragstart` ä¸­ä½¿ç”¨ã€‚
- `setDragImage(element, x, y)`ï¼šå…è®¸æŒ‡å®šæ‹–åŠ¨å‘ç”Ÿæ—¶æ˜¾ç¤ºåœ¨å…‰æ ‡ä¸‹é¢çš„å›¾ç‰‡ã€‚è¿™ä¸ªæ–¹æ³•å¿…é¡»æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼šè¦æ˜¾ç¤ºçš„ `HTML` å…ƒç´ åŠåœ¨æ˜¾ç¤ºå…ƒç´ ä¸Šæ ‡è¯†å…‰æ ‡ä½ç½®çš„ *`x`* å’Œ *`y`* åæ ‡ã€‚è¿™é‡Œçš„ `HTML` å…ƒç´ å¯ä»¥æ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œæ­¤æ—¶æ˜¾ç¤ºå›¾ç‰‡ï¼›ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä»»ä½•å…ƒç´ ï¼Œæ­¤æ—¶æ˜¾ç¤ºæ¸²æŸ“åçš„å…ƒç´ ã€‚è¯¥æ–¹æ³•ä¹Ÿåªèƒ½åœ¨ `dragstart` ä¸­ä½¿ç”¨ã€‚
- `types`ï¼šå½“å‰å­˜å‚¨çš„æ•°æ®ç±»å‹åˆ—è¡¨ã€‚å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä»¥å­—ç¬¦ä¸²å…ƒç´ çš„å½¢å¼ä¿å­˜æ•°æ®ç±»å‹ï¼Œå¦‚ `['text/plain', 'text/html']`ã€‚

â€‹		æ³¨é‡Šï¼š`Chrome` å’Œ `Firefox` éƒ½æ”¯æŒåœ¨ç›®æ ‡å…ƒç´ çš„æ‰€æœ‰æ‹–åŠ¨äº‹ä»¶ä¸­è®¿é—® `types` å±æ€§ã€‚ä½†å¯¹äºè¢«æ‹–åŠ¨å…ƒç´ ï¼Œ`Chrome` æµè§ˆå™¨åªå…è®¸åœ¨å…¶ `dragstart` äº‹ä»¶ä¸­è®¿é—®æ­¤å±æ€§ï¼›è€Œ `Firefox` å…è®¸å…¶æ‰€æœ‰æ‹–åŠ¨äº‹ä»¶è®¿é—®ã€‚å¦å¤–ï¼Œ`Firefox` æä¾›çš„æ•°æ®ç±»å‹ä¿¡æ¯ä¹Ÿæ¯” `Chrome` æ›´ä¸°å¯Œã€‚

```js
draggable.addEventListener('dragstart', (event) => {
	// æ¸…é™¤æ–‡æœ¬ç±»å‹çš„æ•°æ®
    event.dataTransfer.clearData('text');
    
	// æ¸…é™¤æ‰€æœ‰ç±»å‹çš„æ•°æ®
    event.dataTransfer.clearData();
});
```

â€‹		æ›´å¤šå‚è€ƒï¼š[`DataTransfer.addElement`](https://developer.mozilla.org/en-US/docs/Web/API/DataTransfer/addElement) 



### `Notifications API`

â€‹		`Notifications API` ç”¨äºå‘ç”¨æˆ·æ˜¾ç¤ºé€šçŸ¥ã€‚æ— è®ºä»å“ªä¸ªè§’åº¦çœ‹ï¼Œè¿™é‡Œçš„é€šçŸ¥éƒ½å¾ˆç±»ä¼¼ `alert()` å¯¹è¯æ¡†ï¼šéƒ½ä½¿ç”¨ `JavaScript API` è§¦å‘é¡µé¢å¤–éƒ¨çš„æµè§ˆå™¨è¡Œä¸ºï¼Œè€Œä¸”éƒ½å…è®¸é¡µé¢å¤„ç†ç”¨æˆ·ä¸å¯¹è¯æ¡†æˆ–é€šçŸ¥å¼¹å±‚çš„äº¤äº’ã€‚ä¸è¿‡ï¼Œé€šçŸ¥æä¾›æ›´çµæ´»çš„è‡ªå®šä¹‰èƒ½åŠ›ã€‚

â€‹		`Notifications API` åœ¨ `Service Worker` ä¸­éå¸¸æœ‰ç”¨ã€‚æ¸è¿› `Web` åº”ç”¨ï¼ˆ`PWA`ï¼Œ`Progressive Web Application`ï¼‰é€šè¿‡è§¦å‘é€šçŸ¥å¯ä»¥åœ¨é¡µé¢ä¸æ´»è·ƒæ—¶å‘ç”¨æˆ·æ˜¾ç¤ºæ¶ˆæ¯ï¼Œçœ‹èµ·æ¥å°±åƒåŸç”Ÿåº”ç”¨ã€‚ç›®å‰ï¼Œ`Firefox` æµè§ˆå™¨ç»™äºˆäº†è¿™äº› `API` è‰¯å¥½çš„æ”¯æŒã€‚



#### é€šçŸ¥æƒé™

â€‹		`Notifications API` æœ‰è¢«æ»¥ç”¨çš„å¯èƒ½ï¼Œå› æ­¤é»˜è®¤ä¼šå¼€å¯ä¸¤é¡¹å®‰å…¨æªæ–½ï¼š

- é€šçŸ¥åªèƒ½åœ¨è¿è¡Œåœ¨å®‰å…¨ä¸Šä¸‹æ–‡çš„ä»£ç ä¸­è¢«è§¦å‘ï¼›
- é€šçŸ¥å¿…é¡»æŒ‰ç…§æ¯ä¸ªæºçš„åŸåˆ™æ˜ç¡®å¾—åˆ°ç”¨æˆ·å…è®¸ã€‚

â€‹		ç”¨æˆ·æˆæƒæ˜¾ç¤ºé€šçŸ¥æ˜¯é€šè¿‡æµè§ˆå™¨å†…éƒ¨çš„ä¸€ä¸ªå¯¹è¯æ¡†å®Œæˆçš„ã€‚é™¤éç”¨æˆ·æ²¡æœ‰æ˜ç¡®ç»™å‡ºå…è®¸æˆ–æ‹’ç»çš„ç­”å¤ï¼Œå¦åˆ™è¿™ä¸ªæƒé™è¯·æ±‚å¯¹æ¯ä¸ªåŸŸåªä¼šå‡ºç°ä¸€æ¬¡ã€‚æµè§ˆå™¨ä¼šè®°ä½ç”¨æˆ·çš„é€‰æ‹©ï¼Œå¦‚æœè¢«æ‹’ç»åˆ™æ— æ³•é‡æ¥ã€‚

â€‹		é¡µé¢å¯ä»¥ä½¿ç”¨å…¨å±€å¯¹è±¡ `Notification` ä¸Šçš„ `requestPemission()` æ–¹æ³•å‘ç”¨æˆ·è¯·æ±‚è·å–é€šçŸ¥æƒé™ã€‚æ‰§è¡Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨æµè§ˆå™¨å†…éƒ¨çš„æˆæƒè¯¢é—®å¯¹è¯æ¡†ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªæœŸçº¦ï¼Œç”¨æˆ·åœ¨æˆæƒå¯¹è¯æ¡†ä¸Šæ‰§è¡Œæ“ä½œåè¿™ä¸ªæœŸçº¦å°±ä¼šç«‹å³è¢«è§£å†³ï¼Œå¦åˆ™ä¸€ç›´å¤„äºå¾…å®šçŠ¶æ€ã€‚

```js
Notification.requestPermission().then((permission) => { 
	console.log('User responded to permission request:', permission); 
});
```

â€‹		åœ¨ç›‘å¬ `requestPermission` æœŸçº¦çš„ `then` å›è°ƒä¸­ï¼Œå¯ä»¥æ¥æ”¶ä¸€ä¸ªè¡¨ç¤ºç”¨æˆ·æˆæƒçŠ¶æ€çš„ `permission` å‚æ•°ã€‚`"granted"` å€¼æ„å‘³ç€ç”¨æˆ·æ˜ç¡®æˆæƒäº†æ˜¾ç¤ºé€šçŸ¥çš„æƒé™ã€‚é™¤æ­¤ä¹‹å¤–çš„å…¶ä»–å€¼æ„å‘³ç€æ˜¾ç¤ºé€šçŸ¥ä¼šé™é»˜å¤±è´¥ã€‚å¦‚æœç”¨æˆ·æ‹’ç»æˆæƒï¼Œè¿™ä¸ªå€¼å°±æ˜¯ `"denied"`ã€‚ä¸€æ—¦æ‹’ç»ï¼Œå°±æ— æ³•é€šè¿‡ç¼–ç¨‹æ–¹å¼æŒ½å›ï¼Œå› ä¸ºä¸å¯èƒ½å†è§¦å‘æˆæƒæç¤ºã€‚ã€`granted`ï¼šæˆäºˆï¼›`denied`ï¼šæ‹’ç»ã€‘



#### æ˜¾ç¤ºå’Œéšè—é€šçŸ¥

â€‹		`Notification` æ„é€ å‡½æ•°ç”¨äºåˆ›å»ºå’Œæ˜¾ç¤ºé€šçŸ¥ã€‚æœ€ç®€å•çš„é€šçŸ¥å½¢å¼æ˜¯åªæ˜¾ç¤ºä¸€ä¸ªæ ‡é¢˜ï¼Œè¿™ä¸ªæ ‡é¢˜å†…å®¹å¯ä»¥ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ ç»™ `Notification` æ„é€ å‡½æ•°ã€‚ä»¥ä¸‹é¢è¿™ç§æ–¹å¼è°ƒç”¨ `Notification`ï¼Œåº”è¯¥ä¼šç«‹å³æ˜¾ç¤ºé€šçŸ¥ï¼ˆé™¤éå…³é—­äº†æµè§ˆå™¨é€šçŸ¥åŠŸèƒ½ï¼‰ï¼š

```js
new Notification('Title text!');
/*
NotificationÂ {
	actions: [],
	badge: "",
	body: "",
	data: null,
	dir: "auto",
	icon: "",
	image: "",
	lang: "",
	onclick: null,
	onclose: null,
	onerror: null,
	onshow: null,
	renotify: false,
	requireInteraction: false,
	silent: false,
	tag: "",
	timestamp: 1676277875524,
	title: "Title text!",
	vibrate: [],
	[[Prototype]]: Notification
}
*/
```

â€‹		å¯ä»¥é€šè¿‡ `options` å‚æ•°å¯¹é€šçŸ¥è¿›è¡Œè‡ªå®šä¹‰ï¼ŒåŒ…æ‹¬è®¾ç½®é€šçŸ¥çš„ä¸»ä½“ã€å›¾ç‰‡å’ŒæŒ¯åŠ¨ç­‰ï¼š

```js
new Notification('Title text!', {
 	body: 'Body text!', 
 	image: 'path/to/image.png', 
 	vibrate: true 
});
```

â€‹		è°ƒç”¨è¿™ä¸ªæ„é€ å‡½æ•°è¿”å›çš„ `Notification` å®ä¾‹çš„ `close()` æ–¹æ³•å¯ä»¥å…³é—­æ˜¾ç¤ºçš„é€šçŸ¥ã€‚ä¸‹ä¾‹å±•ç¤ºäº†æ˜¾ç¤ºé€šçŸ¥å 1000 æ¯«ç§’å†å…³é—­å®ƒï¼š

```js
const n = new Notification('I will close in 1000ms'); 
setTimeout(() => n.close(), 1000);
```



#### é€šçŸ¥ç”Ÿå‘½å‘¨æœŸå›è°ƒ

â€‹		é€šçŸ¥å¹¶éåªç”¨äºæ˜¾ç¤ºæ–‡æœ¬å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ç”¨äºå®ç°äº¤äº’ã€‚`Notifications API` æä¾›äº† 4 ä¸ªç”¨äºæ·»åŠ å›è°ƒçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š

- `onshow`ï¼šåœ¨é€šçŸ¥è¢«æ˜¾ç¤ºæ—¶è§¦å‘ï¼›
- `onclick`ï¼šåœ¨é€šçŸ¥è¢«ç‚¹å‡»æ—¶è§¦å‘ï¼›ä¸åŒ…æ‹¬ç‚¹å‡»é€šçŸ¥ä¿¡æ¯çš„å…³é—­æŒ‰é’®ã€‚
- `onclose`ï¼šåœ¨é€šçŸ¥è¢«å…³é—­æ—¶è§¦å‘ï¼›å³é€šçŸ¥æ¶ˆå¤±ã€é€šè¿‡ç‚¹å‡»é€šçŸ¥æ¡ï¼ˆä¸åŒ…æ‹¬å…³é—­æŒ‰é’®ï¼‰æˆ–è°ƒç”¨ `close()` å…³é—­æ—¶ã€‚
- `onerror`ï¼šåœ¨é€šçŸ¥è¢«é˜»æ­¢æ—¶è§¦å‘ã€‚å³åœ¨å‘ç”Ÿé”™è¯¯é˜»æ­¢é€šçŸ¥æ˜¾ç¤ºæ—¶ã€‚

â€‹		ä¸‹é¢çš„ä»£ç å°†æ¯ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶éƒ½é€šè¿‡æ—¥å¿—æ‰“å°äº†å‡ºæ¥ï¼š

```js
const n = new Notification('foo'); 

n.onshow = () => console.log('Notification was shown!'); 
n.onclick = () => console.log('Notification was clicked!'); 
n.onclose = () => console.log('Notification was closed!'); 
n.onerror = () => console.log('Notification experienced an error!');
```



### `Page Visibility API`

â€‹		`Web` å¼€å‘ä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯å¼€å‘è€…ä¸çŸ¥é“ç”¨æˆ·ä»€ä¹ˆæ—¶å€™çœŸæ­£åœ¨ä½¿ç”¨é¡µé¢ã€‚å¦‚æœé¡µé¢è¢«æœ€å°åŒ–æˆ–éšè—åœ¨å…¶ä»–æ ‡ç­¾é¡µåé¢ï¼Œé‚£ä¹ˆè½®è¯¢æœåŠ¡å™¨æˆ–æ›´æ–°åŠ¨ç”»ç­‰åŠŸèƒ½å¯èƒ½å°±æ²¡æœ‰å¿…è¦äº†ã€‚`Page Visibility API` æ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›é¡µé¢å¯¹ç”¨æˆ·æ˜¯å¦å¯è§çš„ä¿¡æ¯ã€‚

â€‹		è¿™ä¸ª `API` æœ¬èº«éå¸¸ç®€å•ï¼Œç”± 3 éƒ¨åˆ†æ„æˆã€‚

- `document.visibilityState` å€¼ï¼Œè¡¨ç¤ºä¸‹é¢ 4 ç§çŠ¶æ€ä¹‹ä¸€ã€‚
  - é¡µé¢åœ¨åå°æ ‡ç­¾é¡µæˆ–æµè§ˆå™¨ä¸­æœ€å°åŒ–äº†ã€‚
  - é¡µé¢åœ¨å‰å°æ ‡ç­¾é¡µä¸­ã€‚
  - å®é™…é¡µé¢éšè—äº†ï¼Œä½†å¯¹é¡µé¢çš„é¢„è§ˆæ˜¯å¯è§çš„ï¼ˆä¾‹å¦‚åœ¨ `Windows 7` ä¸Šï¼Œç”¨æˆ·é¼ æ ‡ç§»åˆ°ä»»åŠ¡æ å›¾æ ‡ä¸Šä¼šæ˜¾ç¤ºç½‘é¡µé¢„è§ˆï¼‰ã€‚
  - é¡µé¢åœ¨å±å¤–é¢„æ¸²æŸ“ã€‚
- `visibilitychange` äº‹ä»¶ï¼Œè¯¥äº‹ä»¶ä¼šåœ¨æ–‡æ¡£ä»éšè—å˜å¯è§ï¼ˆæˆ–åä¹‹ï¼‰æ—¶è§¦å‘ã€‚
- `document.hidden` å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºé¡µé¢æ˜¯å¦éšè—ã€‚è¿™å¯èƒ½æ„å‘³ç€é¡µé¢åœ¨åå°æ ‡ç­¾é¡µæˆ–åœ¨æµè§ˆå™¨ä¸­è¢«æœ€å°åŒ–äº†ã€‚è¿™ä¸ªå€¼æ˜¯ä¸ºäº†å‘åå…¼å®¹æ‰ç»§ç»­è¢«æµè§ˆå™¨æ”¯æŒçš„ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨ `document.visibilityState` æ£€æµ‹é¡µé¢å¯è§æ€§ã€‚

â€‹		è¦æƒ³åœ¨é¡µé¢ä»å¯è§å˜ä¸ºéšè—æˆ–ä»éšè—å˜ä¸ºå¯è§æ—¶å¾—åˆ°é€šçŸ¥ï¼Œéœ€è¦ç›‘å¬ `visibilitychange` äº‹ä»¶ã€‚

```js
document.onvisibilitychange = function(e) {
    switch (document.visibilityState) {
        case "hidden":
            new Notification("é¡µé¢å·²ç»è¢«éšè—äº†ï¼");
            break;
        case "visible":
            new Notification("é¡µé¢æ­£åœ¨è¢«æ˜¾ç¤ºæˆ–é¢„è§ˆï¼"); 
            break;
        case "prerender":
            new Notification("é¡µé¢æ­£åœ¨å±å¤–é¢„æ¸²æŸ“ï¼");
            break;
    }
}
```

â€‹		`document.visibilityState` çš„å€¼æ˜¯ä»¥ä¸‹ä¸‰ä¸ªå­—ç¬¦ä¸²ä¹‹ä¸€ï¼š

- `"hidden"`ï¼šå½“é¡µé¢å¯¹ç”¨æˆ·å®Œå…¨ä¸å¯è§æ—¶çš„çŠ¶æ€ï¼Œé¡µé¢å¯èƒ½åœ¨åå°æ ‡ç­¾é¡µæˆ–è¢«æœ€å°åŒ–äº†ã€‚
- `"visible"`ï¼šå½“é¡µé¢å¯¹ç”¨æˆ·éƒ¨åˆ†æˆ–å®Œå…¨å¯è§æ—¶çš„çŠ¶æ€ï¼Œé¡µé¢å¯èƒ½åœ¨å‰å°æ ‡ç­¾é¡µæˆ–æ­£åœ¨ä»»åŠ¡æ ä¸­è¢«é¢„è§ˆã€‚
- `"prerender"`ï¼šå½“é¡µé¢æ­£åœ¨æ¸²æŸ“æ—¶çš„çŠ¶æ€ï¼Œæ­¤æ—¶é¡µé¢å¯¹ç”¨æˆ·ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚è¯¥å€¼å¯èƒ½å·²è¢«åºŸé™¤ã€‚



### `Streams API`

â€‹		`Streams API` æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªç®€å•ä½†åˆåŸºç¡€çš„é—®é¢˜è€Œç”Ÿçš„ï¼š`Web` åº”ç”¨å¦‚ä½•æ¶ˆè´¹æœ‰åºçš„å°ä¿¡æ¯å—è€Œä¸æ˜¯å¤§å—ä¿¡æ¯ï¼Ÿè¿™ç§èƒ½åŠ›ä¸»è¦æœ‰ä¸¤ç§åº”ç”¨åœºæ™¯ã€‚

- å¤§å—æ•°æ®å¯èƒ½ä¸ä¼šä¸€æ¬¡æ€§éƒ½å¯ç”¨ã€‚ç½‘ç»œè¯·æ±‚çš„å“åº”å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ã€‚ç½‘ç»œè´Ÿè½½æ˜¯ä»¥è¿ç»­ä¿¡æ¯åŒ…å½¢å¼äº¤ä»˜çš„ï¼Œè€Œæµå¼å¤„ç†å¯ä»¥è®©åº”ç”¨åœ¨æ•°æ®ä¸€åˆ°è¾¾å°±èƒ½ä½¿ç”¨ï¼Œè€Œä¸å¿…ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½åŠ è½½å®Œæ¯•ã€‚
- å¤§å—æ•°æ®å¯èƒ½éœ€è¦åˆ†å°éƒ¨åˆ†å¤„ç†ã€‚è§†é¢‘å¤„ç†ã€æ•°æ®å‹ç¼©ã€å›¾åƒç¼–ç å’Œ `JSON` è§£æéƒ½æ˜¯å¯ä»¥åˆ†æˆå°éƒ¨åˆ†è¿›è¡Œå¤„ç†ï¼Œè€Œä¸å¿…ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­æ—¶å†å¤„ç†çš„ä¾‹å­ã€‚

â€‹		ã€Šç½‘ç»œè¯·æ±‚ä¸è¿œç¨‹èµ„æºã€‹ä¸€ç« åœ¨è®¨è®ºç½‘ç»œè¯·æ±‚å’Œè¿œç¨‹èµ„æºæ—¶ä¼šä»‹ç» `Streams API` åœ¨ `fetch()` ä¸­çš„åº”ç”¨ï¼Œä¸è¿‡ `Streams API` æœ¬èº«æ˜¯é€šç”¨çš„ã€‚å®ç° `Observable` æ¥å£çš„ `JavaScript` åº“å…±äº«äº†å¾ˆå¤šæµçš„åŸºç¡€æ¦‚å¿µã€‚

â€‹		æ³¨æ„ï¼šè™½ç„¶ `Fetch API` å·²ç»å¾—åˆ°æ‰€æœ‰ä¸»æµæµè§ˆå™¨æ”¯æŒï¼Œä½† `Streams API` åˆ™æ²¡æœ‰é‚£ä¹ˆå¿«å¾—åˆ°æ”¯æŒã€‚



#### ç†è§£æµ

â€‹		æåˆ°æµï¼Œå¯ä»¥æŠŠæ•°æ®æƒ³åƒæˆæŸç§é€šè¿‡ç®¡é“è¾“é€çš„æ¶²ä½“ã€‚`JavaScript` ä¸­çš„æµå€Ÿç”¨äº†ç®¡é“ç›¸å…³çš„æ¦‚å¿µï¼Œå› ä¸ºäºŒè€…åŸç†æ˜¯ç›¸é€šçš„ã€‚æ ¹æ®è§„èŒƒï¼Œâ€œè¿™äº› `API` å®é™…æ˜¯ä¸ºæ˜ å°„ä½çº§ `I/O` åŸè¯­è€Œè®¾è®¡ï¼ŒåŒ…æ‹¬é€‚å½“æ—¶å€™å¯¹å­—èŠ‚æµçš„è§„èŒƒåŒ–â€ã€‚`Stream API` ç›´æ¥è§£å†³çš„é—®é¢˜æ˜¯å¤„ç†ç½‘ç»œè¯·æ±‚å’Œè¯»å†™ç£ç›˜ã€‚

> åŸè¯­ï¼š`primitive`
>
> â€‹		è®¡ç®—æœºè¿›ç¨‹çš„æ§åˆ¶é€šå¸¸ç”±åŸè¯­å®Œæˆã€‚æ‰€è°“åŸè¯­ï¼Œä¸€èˆ¬æ˜¯æŒ‡ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ç¨‹åºæ®µï¼Œç”¨æ¥å®ç°æŸä¸ªç‰¹å®šåŠŸèƒ½ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å¯è¢«ä¸­æ–­ã€‚åœ¨[æ“ä½œç³»ç»Ÿ](https://baike.baidu.com/item/æ“ä½œç³»ç»Ÿ/192?fromModule=lemma_inlink)ä¸­ï¼ŒæŸäº›è¢«è¿›ç¨‹è°ƒç”¨çš„æ“ä½œï¼Œå¦‚é˜Ÿåˆ—æ“ä½œã€å¯¹ä¿¡å·é‡çš„æ“ä½œã€æ£€æŸ¥å¯åŠ¨å¤–è®¾æ“ä½œç­‰ï¼Œä¸€æ—¦å¼€å§‹æ‰§è¡Œï¼Œå°±ä¸èƒ½è¢«ä¸­æ–­ï¼Œå¦åˆ™å°±ä¼šå‡ºç°æ“ä½œé”™è¯¯ï¼Œé€ æˆç³»ç»Ÿæ··ä¹±ã€‚æ‰€ä»¥ï¼Œè¿™äº›æ“ä½œéƒ½è¦ç”¨åŸè¯­æ¥å®ç°ã€‚åŸè¯­æ˜¯æ“ä½œç³»ç»Ÿæ ¸å¿ƒï¼ˆä¸æ˜¯ç”±è¿›ç¨‹ï¼Œè€Œæ˜¯ç”±ä¸€ç»„ç¨‹åºæ¨¡å—ç»„æˆï¼‰çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå¹¶ä¸”å¸¸é©»å†…å­˜ï¼Œé€šå¸¸åœ¨ç®¡æ€ä¸‹æ‰§è¡Œã€‚åŸè¯­ä¸€æ—¦å¼€å§‹æ‰§è¡Œï¼Œå°±è¦è¿ç»­æ‰§è¡Œå®Œï¼Œä¸å…è®¸è¢«ä¸­æ–­ã€‚
>
> â€‹		è®¡ç®—æœºç½‘ç»œä¸­ä¹Ÿæœ‰â€œåŸè¯­â€ä¸€è¯ï¼Œå®ƒä¸æ“ä½œç³»ç»Ÿçš„â€œåŸè¯­â€æ¦‚å¿µå¹¶ä¸ç›¸åŒã€‚æœåŠ¡åŸè¯­æ˜¯æŒ‡åè®®ä¸­çš„ä¸‹å±‚åè®®é€šè¿‡æ¥å£ä¸ºä¸Šå±‚åè®®æä¾›æŸç§æœåŠ¡è€Œå‘é€çš„åŸè¯­æ“ä½œã€‚å…¶åŸè¯­åˆ†ä¸ºå››ç±»ï¼šè¯·æ±‚ï¼ˆ`Req`ï¼‰å‹åŸè¯­ï¼Œç”¨äºé«˜å±‚å‘ä½å±‚è¯·æ±‚æŸç§ä¸šåŠ¡ï¼›è¯å®ï¼ˆ`Cfm`ï¼‰å‹åŸè¯­ï¼Œç”¨äºæä¾›ä¸šåŠ¡çš„å±‚è¯å®æŸä¸ªåŠ¨ä½œå·²ç»å®Œæˆï¼›æŒ‡ç¤ºï¼ˆ`Ind`ï¼‰å‹åŸè¯­ï¼Œç”¨äºæä¾›ä¸šåŠ¡çš„å±‚å‘é«˜å±‚æŠ¥å‘Šä¸€ä¸ªä¸ç‰¹å®šä¸šåŠ¡ç›¸å…³çš„åŠ¨ä½œï¼›å“åº”(`Res`)å‹åŸè¯­ï¼Œç”¨äºåº”ç­”ï¼Œè¡¨ç¤ºæ¥è‡ªé«˜å±‚çš„æŒ‡ç¤ºåŸè¯­å·²æ”¶åˆ°ã€‚

â€‹		`Stream API` å®šä¹‰äº†ä¸‰ç§æµã€‚

- å¯è¯»æµï¼šå¯ä»¥é€šè¿‡æŸä¸ªå…¬å…±æ¥å£è¯»å–æ•°æ®å—çš„æµã€‚æ•°æ®åœ¨å†…éƒ¨ä»åº•å±‚æºè¿›å…¥æµï¼Œç„¶åç”±æ¶ˆè´¹è€…ï¼ˆ`consumer`ï¼‰è¿›è¡Œå¤„ç†ã€‚
- å¯å†™æµï¼šå¯ä»¥é€šè¿‡æŸä¸ªå…¬å…±æ¥å£å†™å…¥æ•°æ®å—çš„æµã€‚ç”Ÿäº§è€…ï¼ˆ`producer`ï¼‰å°†æ•°æ®å†™å…¥æµï¼Œæ•°æ®åœ¨å†…éƒ¨ä¼ å…¥åº•å±‚æ•°æ®æ§½ï¼ˆ`sink`ï¼‰ã€‚
- è½¬æ¢æµï¼šç”±ä¸¤ç§æµç»„æˆï¼Œå¯å†™æµç”¨äºæ¥æ”¶æ•°æ®ï¼ˆå¯å†™ç«¯ï¼Œå†™å…¥æ•°æ®ï¼‰ï¼Œå¯è¯»æµç”¨äºè¾“å‡ºæ•°æ®ï¼ˆå¯è¯»ç«¯ï¼Œè¯»å–æ•°æ®ï¼‰ã€‚è¿™ä¸¤ä¸ªæµä¹‹é—´æ˜¯è½¬æ¢ç¨‹åºï¼ˆ`transformer`ï¼‰ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ£€æŸ¥å’Œä¿®æ”¹æµå†…å®¹ã€‚

##### å—

â€‹		æµçš„åŸºæœ¬å•ä½æ˜¯å—ï¼ˆ`chunk`ï¼‰ã€‚å—å¯ä»¥æ˜¯ä»»æ„æ•°æ®ç±»å‹ï¼Œä½†é€šå¸¸æ˜¯å®šå‹æ•°ç»„ã€‚æ¯ä¸ªå—éƒ½æ˜¯ç¦»æ•£çš„æµç‰‡æ®µï¼Œå¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥å¤„ç†ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå—ä¸æ˜¯å›ºå®šå¤§å°çš„ï¼Œä¹Ÿä¸ä¸€å®šæŒ‰å›ºå®šé—´éš”åˆ°è¾¾ã€‚åœ¨ç†æƒ³çš„æµå½“ä¸­ï¼Œå—çš„å¤§å°é€šå¸¸è¿‘ä¼¼ç›¸åŒï¼Œåˆ°è¾¾é—´éš”ä¹Ÿè¿‘ä¼¼ç›¸ç­‰ã€‚ä¸è¿‡å¥½çš„æµå®ç°éœ€è¦è€ƒè™‘è¾¹ç•Œæƒ…å†µã€‚

â€‹		å‰é¢æåˆ°çš„å„ç§ç±»å‹çš„æµéƒ½æœ‰å…¥å£å’Œå‡ºå£çš„æ¦‚å¿µã€‚æœ‰æ—¶å€™ï¼Œç”±äºæ•°æ®è¿›å‡ºé€Ÿç‡ä¸åŒï¼Œå¯èƒ½ä¼šå‡ºç°ä¸åŒ¹é…çš„æƒ…å†µã€‚ä¸ºæ­¤æµå¹³è¡¡å¯èƒ½å‡ºç°å¦‚ä¸‹ä¸‰ç§æƒ…å½¢ï¼ˆå°†æ•°æ®æµæƒ³è±¡åœ¨ä¸€ä¸ªç®¡é“ä¸­ï¼Œæ›´å®¹æ˜“ç†è§£ä¸‹åˆ—æƒ…å½¢ï¼‰ã€‚

- æµå‡ºå£å¤„ç†æ•°æ®çš„é€Ÿåº¦æ¯”å…¥å£æä¾›æ•°æ®çš„é€Ÿåº¦å¿«ï¼ˆæµå‡ºçš„é€Ÿåº¦å¤§äºæµå…¥ï¼‰ã€‚æµå‡ºå£ç»å¸¸ç©ºé—²ï¼ˆå¯èƒ½æ„å‘³ç€æµå…¥å£æ•ˆç‡è¾ƒä½ï¼‰ï¼Œä½†åªä¼šæµªè´¹ä¸€ç‚¹å†…å­˜æˆ–è®¡ç®—èµ„æºï¼Œå› æ­¤è¿™ç§æµçš„ä¸å¹³è¡¡æ˜¯å¯ä»¥æ¥å—çš„ã€‚
- æµå…¥å’Œæµå‡ºå‡è¡¡ï¼ˆæµå‡ºçš„é€Ÿåº¦ç­‰äºæµå…¥ï¼‰ã€‚è¿™æ˜¯ç†æƒ³çŠ¶æ€ã€‚
- æµå…¥å£æä¾›æ•°æ®çš„é€Ÿåº¦æ¯”å‡ºå£å¤„ç†æ•°æ®çš„é€Ÿåº¦å¿«ï¼ˆæµå‡ºçš„é€Ÿåº¦å°äºæµå…¥ï¼‰ã€‚è¿™ç§æµä¸å¹³è¡¡æ˜¯å›ºæœ‰çš„é—®é¢˜ã€‚æ­¤æ—¶ä¸€å®šä¼šåœ¨æŸä¸ªåœ°æ–¹å‡ºç°æ•°æ®ç§¯å‹ï¼Œæµå¿…é¡»ç›¸åº”åšå‡ºå¤„ç†ã€‚

##### å†…éƒ¨é˜Ÿåˆ—

â€‹		æµä¸å¹³è¡¡æ˜¯å¸¸è§é—®é¢˜ï¼Œä½†æµä¹Ÿæä¾›äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„å·¥å…·ã€‚æ‰€æœ‰æµéƒ½ä¼šä¸ºå·²è¿›å…¥æµä½†å°šæœªç¦»å¼€æµçš„å—æä¾›ä¸€ä¸ªå†…éƒ¨é˜Ÿåˆ—ã€‚åœ¨å‡è¡¡çš„æµä¸­ï¼Œè¿™ä¸ªå†…éƒ¨é˜Ÿåˆ—ä¸­ä¼šæœ‰é›¶ä¸ªæˆ–å°‘é‡æ’é˜Ÿçš„å—ï¼Œå› ä¸ºæµå‡ºå£å—å‡ºåˆ—çš„é€Ÿåº¦ä¸æµå…¥å£å—å…¥åˆ—çš„é€Ÿåº¦è¿‘ä¼¼ç›¸ç­‰ã€‚è¿™ç§æµçš„å†…éƒ¨é˜Ÿåˆ—æ‰€å ç”¨çš„å†…å­˜ç›¸å¯¹æ¯”è¾ƒå°ã€‚

##### åå‹

â€‹		å¦‚æœå—å…¥åˆ—é€Ÿåº¦å¿«äºå‡ºåˆ—é€Ÿåº¦ï¼Œåˆ™å†…éƒ¨é˜Ÿåˆ—ä¼šä¸æ–­å¢å¤§ã€‚æµä¸èƒ½å…è®¸å…¶å†…éƒ¨é˜Ÿåˆ—æ— é™å¢å¤§ï¼Œå› æ­¤å®ƒä¼šä½¿ç”¨åå‹ï¼ˆ`backpressure`ï¼‰é€šçŸ¥æµå…¥å£åœæ­¢å‘é€æ•°æ®ï¼Œç›´åˆ°é˜Ÿåˆ—å¤§å°é™åˆ°æŸä¸ªæ—¢å®šçš„é˜ˆå€¼ä¹‹ä¸‹ã€‚è¿™ä¸ªé˜ˆå€¼ç”±æ’åˆ—ç­–ç•¥å†³å®šï¼Œè¿™ä¸ªç­–ç•¥å®šä¹‰äº†å†…éƒ¨é˜Ÿåˆ—å¯ä»¥å ç”¨çš„æœ€å¤§å†…å­˜ï¼Œå³é«˜æ°´ä½çº¿ï¼ˆ`high water mark`ï¼‰ã€‚



#### å¯è¯»æµ

â€‹		å¯è¯»æµæ˜¯å¯¹åº•å±‚æ•°æ®æºçš„å°è£…ã€‚åº•å±‚æ•°æ®æºå¯ä»¥å°†æ•°æ®å¡«å……åˆ°æµä¸­ï¼Œå…è®¸æ¶ˆè´¹è€…ï¼ˆ`consumer`ï¼‰é€šè¿‡æµçš„å…¬å…±æ¥å£è¯»å–æ•°æ®ã€‚

##### `ReadableStream`

â€‹		æ¥çœ‹ä¸‹é¢çš„ç”Ÿæˆå™¨ï¼Œå®ƒæ¯ 1000 æ¯«ç§’å°±ä¼šç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°ã€‚

```js
async function* ints() {
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
}
```

â€‹		è¿™ä¸ªç”Ÿæˆå™¨çš„å€¼å¯ä»¥é€šè¿‡å¯è¯»æµçš„æ§åˆ¶å™¨ä¼ å…¥å¯è¯»æµã€‚è®¿é—®è¿™ä¸ªæ§åˆ¶å™¨æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åˆ›å»º `ReadableStream` çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶åœ¨è¿™ä¸ªæ„é€ å‡½æ•°çš„ `underlyingSource` å‚æ•°ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ä¸­å®šä¹‰ `start()` æ–¹æ³•ï¼Œç„¶ååœ¨è¯¥æ–¹æ³•ä¸­ä½¿ç”¨ä½œä¸ºå‚æ•°ä¼ å…¥çš„ `controller` æ§åˆ¶å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ§åˆ¶å™¨å‚æ•°æ˜¯ `ReadableStreamDefaultController` çš„ä¸€ä¸ªå®ä¾‹ï¼š

```js
const readableStream = new ReadableStream({ 
 	start(controller) { 
 		console.log(controller); // ReadableStreamDefaultControllerÂ {desiredSize: 1}
 	} 
});

/*
ReadableStreamDefaultController {
	desiredSize: 1,
	[[Prototype]]: ReadableStreamDefaultController {
		close: Æ’ close(),
		desiredSize: (...),
		enqueue: Æ’ enqueue(),
		error: Æ’ error(),
		constructor: Æ’ ReadableStreamDefaultController(),
		Symbol(Symbol.toStringTag): "ReadableStreamDefaultController",
		get desiredSize: Æ’ desiredSize(),
		[[Prototype]]: Object
	}
*/
```

â€‹		è°ƒç”¨æ§åˆ¶å™¨çš„ `enqueue()` æ–¹æ³•å¯ä»¥æŠŠå€¼ä¼ å…¥æ§åˆ¶å™¨ã€‚æ‰€æœ‰å€¼éƒ½ä¼ å®Œä¹‹åï¼Œè°ƒç”¨ `close()` å…³é—­æµï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 
const readableStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of ints()) { 
			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
});
```

##### `ReadableStreamDefaultReader`

â€‹		å‰é¢çš„ä¾‹å­æŠŠ 5 ä¸ªå€¼åŠ å…¥äº†æµçš„é˜Ÿåˆ—ï¼Œä½†æ²¡æœ‰æŠŠå®ƒä»¬ä»é˜Ÿåˆ—ä¸­è¯»å‡ºæ¥ã€‚ä¸ºæ­¤ï¼Œéœ€è¦ä¸€ä¸ª `ReadableStreamDefaultReader` çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥é€šè¿‡æµçš„ `getReader()` æ–¹æ³•è·å–ã€‚è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šè·å¾—æµçš„é”ï¼Œä¿è¯åªæœ‰è¿™ä¸ªè¯»å–å™¨å¯ä»¥ä»æµä¸­è¯»å–å€¼ï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
}

const readableStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of ints()) { 
 			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
}); 

console.log(readableStream.locked); // false 
const readableStreamDefaultReader = readableStream.getReader(); // è·å–è¯»å–å™¨
console.log(readableStream.locked); // true
```

â€‹		æ¶ˆè´¹è€…ä½¿ç”¨è¿™ä¸ªè¯»å–å™¨å®ä¾‹çš„ `read()` æ–¹æ³•å¯ä»¥è¯»å‡ºå€¼ï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 

const readableStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of ints()) { 
 			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
}); 

console.log(readableStream.locked); // false 
const readableStreamDefaultReader = readableStream.getReader(); 
console.log(readableStream.locked); // true 

// æ¶ˆè´¹è€…
(async function() { 
 	while(true) { 
 		const { done, value } = await readableStreamDefaultReader.read(); 
 		if (done) { 
 			break; 
 		} else { 
 			console.log(value); 
 		} 
 	} 
})(); 

// 0 
// 1 
// 2 
// 3 
// 4
```



#### å¯å†™æµ

â€‹		å¯å†™æµæ˜¯åº•å±‚æ•°æ®æ§½çš„å°è£…ã€‚åº•å±‚æ•°æ®æ§½å¤„ç†é€šè¿‡æµçš„å…¬å…±æ¥å£å†™å…¥çš„æ•°æ®ã€‚

##### `WritableStream`

â€‹		æ¥çœ‹ä¸‹é¢çš„ç”Ÿæˆå™¨ï¼Œå®ƒæ¯ 1000 æ¯«ç§’å°±ä¼šç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°ï¼š

```js
async function* ints() {
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
}
```

â€‹		è¿™äº›å€¼é€šè¿‡å¯å†™æµçš„å…¬å…±æ¥å£å¯ä»¥å†™å…¥æµã€‚åœ¨ä¼ ç»™ `WritableStream` æ„é€ å‡½æ•°çš„ `underlyingSink` å‚æ•°ä¸­ï¼Œé€šè¿‡å®ç° `write()` æ–¹æ³•å¯ä»¥è·å¾—å†™å…¥çš„æ•°æ®ï¼š

```js
const readableStream = new WritableStream({ 
 	write(value) { 
 		console.log(value); 
 	} 
});
```

##### `WritableStreamDefaultWriter`

â€‹		è¦æŠŠè·å¾—çš„æ•°æ®å†™å…¥æµï¼Œå¯ä»¥é€šè¿‡æµçš„ `getWriter()` æ–¹æ³•è·å– `WritableStreamDefaultWriter` çš„å®ä¾‹ã€‚è¿™æ ·ä¼šè·å¾—æµçš„é”ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªå†™å…¥å™¨å¯ä»¥å‘æµä¸­å†™å…¥æ•°æ®ï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 

const writableStream = new WritableStream({ 
 	write(value) { 
 		console.log(value); 
 	} 
}); 

console.log(writableStream.locked); // false 
const writableStreamDefaultWriter = writableStream.getWriter(); // è·å–å†™å…¥å™¨
console.log(writableStream.locked); // true
```

â€‹		åœ¨å‘æµä¸­å†™å…¥æ•°æ®å‰ï¼Œç”Ÿäº§è€…å¿…é¡»ç¡®ä¿å†™å…¥å™¨å¯ä»¥æ¥æ”¶å€¼ã€‚å†™å…¥å™¨çš„ `ready` å±æ€§æ˜¯ä¸€ä¸ªæœŸçº¦ï¼Œæ­¤æœŸçº¦ä¼šåœ¨èƒ½å¤Ÿå‘æµä¸­å†™å…¥æ•°æ®æ—¶è§£å†³ã€‚ç„¶åï¼Œå°±å¯ä»¥æŠŠå€¼ä¼ ç»™å†™å…¥å™¨ `write()` æ–¹æ³•ã€‚å†™å…¥æ•°æ®ä¹‹åï¼Œé¡»è°ƒç”¨å†™å…¥å™¨çš„ `close()` æ–¹æ³•å°†æµå…³é—­ï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 

const writableStream = new WritableStream({
	write(value) { 
 		console.log(value); 
 	} 
}); 

console.log(writableStream.locked); // false 
const writableStreamDefaultWriter = writableStream.getWriter(); 
console.log(writableStream.locked); // true 

// ç”Ÿäº§è€…
(async function() { 
 	for await (let chunk of ints()) { 
 		await writableStreamDefaultWriter.ready; // å†™å…¥å™¨å°±ç»ªåï¼Œè¿›è¡Œæ•°æ®å†™å…¥
 		writableStreamDefaultWriter.write(chunk); 
 	} 
 	writableStreamDefaultWriter.close(); 
})();
```



#### è½¬æ¢æµ

â€‹		è½¬æ¢æµç”¨äºç»„åˆå¯è¯»æµå’Œå¯å†™æµã€‚æ•°æ®å—åœ¨ä¸¤ä¸ªæµä¹‹é—´çš„è½¬æ¢æ˜¯é€šè¿‡ `transform()` æ–¹æ³•å®Œæˆçš„ã€‚

â€‹		æ¥çœ‹ä¸‹é¢çš„ç”Ÿæˆå™¨ï¼Œå®ƒæ¯ 1000 æ¯«ç§’å°±ä¼šç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°ï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
}
```

â€‹		ä¸‹é¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ª `TransformStream` çš„å®ä¾‹ï¼Œé€šè¿‡ `transform()` æ–¹æ³•å°†æ¯ä¸ªå€¼ç¿»å€ï¼š

```js
async function* ints() {
	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 

const { writable, readable } = new TransformStream({ 
    // å¯è¯»æµä¸­çš„æ•°æ®å—ï¼Œå¯è¯»æµçš„æ§åˆ¶å™¨
 	transform(chunk, controller) { 
 		controller.enqueue(chunk * 2); // å°†å¯è¯»æµä¸­çš„æ•°æ®å—ç¿»å€ä¹‹åï¼Œå†ä¼ å…¥å¯è¯»æµçš„æ§åˆ¶å™¨ã€‚
 	} 
});
```

â€‹		å‘è½¬æ¢æµçš„ç»„ä»¶æµï¼ˆå¯è¯»æµå’Œå¯å†™æµï¼‰ä¼ å…¥æ•°æ®å’Œä»ä¸­è·å–æ•°æ®ï¼Œä¸å‰é¢ä»‹ç»çš„æ–¹æ³•ç›¸åŒï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 

// è½¬æ¢å™¨
const { writable, readable } = new TransformStream({ 
 	transform(chunk, controller) { 
 		controller.enqueue(chunk * 2);
	} 
}); 

const readableStreamDefaultReader = readable.getReader(); 
const writableStreamDefaultWriter = writable.getWriter(); 

// æ¶ˆè´¹è€…
(async function() { 
 	while (true) { 
 		const { done, value } = await readableStreamDefaultReader.read(); 
 		if (done) { 
 			break; 
 		} else { 
 			console.log(value); // æ‰“å°ä»å¯è¯»æµçš„æ§åˆ¶å™¨ä¸­è¯»å–åˆ°çš„æ•°æ®
 		} 
 	} 
})(); 

// ç”Ÿäº§è€…
(async function() { 
 	for await (let chunk of ints()) { 
 		await writableStreamDefaultWriter.ready; 
 		writableStreamDefaultWriter.write(chunk); 
 	} 
 	writableStreamDefaultWriter.close(); 
})();
```



#### è¿æ¥æµ

â€‹		æµå¯ä»¥é€šè¿‡ç®¡é“è¿æ¥æˆä¸€ä¸²ã€‚æœ€å¸¸è§çš„ç”¨ä¾‹æ˜¯ä½¿ç”¨ `pipeThrough()` æ–¹æ³•æŠŠ `ReadableStream` æ¥å…¥ `TransformStream`ã€‚ä»å†…éƒ¨çœ‹ï¼Œ`ReadableStream` å…ˆæŠŠè‡ªå·±çš„å€¼ä¼ ç»™ `TransformStream` å†…éƒ¨çš„ `WritableStream`ï¼Œç„¶åæ‰§è¡Œè½¬æ¢ï¼Œæ¥ç€è¯»å–è½¬æ¢åçš„å€¼ï¼Œä½¿å®ƒä»¬åˆåœ¨æ–°çš„ `ReadableStream` ä¸Šå‡ºç°ã€‚ä¸‹é¢çš„ä¾‹å­å°†ä¸€ä¸ªæ•´æ•°çš„ `ReadableStream` ä¼ å…¥ `TransformStream`ï¼Œ`TransformStream` å¯¹æ¯ä¸ªå€¼åšåŠ å€å¤„ç†ï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 

const integerStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of ints()) { 
 			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
}); 

const doublingStream = new TransformStream({ 
 	transform(chunk, controller) { 
 		controller.enqueue(chunk * 2);
	} 
}); 

// é€šè¿‡ç®¡é“è¿æ¥æµï¼ˆæµå…¥ä¸æµå‡ºçš„æ˜¯åŒç§ç±»å‹çš„æµï¼Œåªæ˜¯å®ƒå¯èƒ½å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼‰
const pipedStream = integerStream.pipeThrough(doublingStream); 

// ä»è¿æ¥æµçš„è¾“å‡ºè·å¾—è¯»å–å™¨
const pipedStreamDefaultReader = pipedStream.getReader(); 

// æ¶ˆè´¹è€…
(async function() { 
 	while(true) { 
 		const { done, value } = await pipedStreamDefaultReader.read(); 
 		if (done) { 
 			break; 
 		} else { 
 			console.log(value); 
 		} 
 	} 
})(); 
// 0 
// 2 
// 4 
// 6 
// 8
```

â€‹		å¦å¤–ï¼Œä½¿ç”¨ `pipeTo()` æ–¹æ³•ä¹Ÿå¯ä»¥å°† `ReadableStream` è¿æ¥åˆ° `WritableStream`ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸ä½¿ç”¨ `pipeThrough()` ç±»ä¼¼ï¼š

```js
async function* ints() { 
 	// æ¯ 1000 æ¯«ç§’ç”Ÿæˆä¸€ä¸ªé€’å¢çš„æ•´æ•°
 	for (let i = 0; i < 5; ++i) { 
 		yield await new Promise((resolve) => setTimeout(resolve, 1000, i)); 
 	} 
} 

const integerStream = new ReadableStream({ 
 	async start(controller) { 
 		for await (let chunk of ints()) { 
 			controller.enqueue(chunk); 
 		} 
 		controller.close(); 
 	} 
}); 

const writableStream = new WritableStream({ 
 	write(value) { 
 		console.log(value); 
 	} 
});

// ç›´æ¥è¿æ¥è¯»å–æµå’Œå†™å…¥æµï¼ˆè¾¹è¯»å–è¾¹å†™å…¥ï¼‰
const pipedStream = integerStream.pipeTo(writableStream); 

// 0 
// 1
// 2 
// 3 
// 4
```

â€‹		æ³¨æ„ï¼Œè¿™é‡Œçš„ç®¡é“è¿æ¥æ“ä½œéšå¼ä» `ReadableStream` è·å¾—äº†ä¸€ä¸ªè¯»å–å™¨ï¼Œå¹¶æŠŠäº§ç”Ÿçš„å€¼å¡«å……åˆ° `WritableStream`ã€‚



### è®¡æ—¶ `API`

â€‹		é¡µé¢æ€§èƒ½å§‹ç»ˆæ˜¯ `Web` å¼€å‘è€…å…³å¿ƒçš„è¯é¢˜ã€‚`Performance` æ¥å£é€šè¿‡ `JavaScript API` æš´éœ²äº†æµè§ˆå™¨å†…éƒ¨çš„åº¦é‡æŒ‡æ ‡ï¼Œå…è®¸å¼€å‘è€…ç›´æ¥è®¿é—®è¿™äº›ä¿¡æ¯å¹¶åŸºäºè¿™äº›ä¿¡æ¯å®ç°è‡ªå·±æƒ³è¦çš„åŠŸèƒ½ã€‚è¿™ä¸ªæ¥å£æš´éœ²åœ¨ `window.performance` å¯¹è±¡ä¸Šã€‚æ‰€æœ‰ä¸é¡µé¢ç›¸å…³çš„æŒ‡æ ‡ï¼ŒåŒ…æ‹¬å·²ç»å®šä¹‰å’Œå°†æ¥ä¼šå®šä¹‰çš„ï¼Œéƒ½ä¼šå­˜åœ¨äºè¿™ä¸ªå¯¹è±¡ä¸Šã€‚ã€`performance`ï¼šn.æ€§èƒ½ï¼›adj.æ€§èƒ½å“è¶Šçš„ï¼Œé«˜æ€§èƒ½çš„ã€‘

â€‹		`Performance` æ¥å£ç”±å¤šä¸ª `API` æ„æˆï¼š

- `High Resolution Time API`ã€é«˜åˆ†è¾¨ç‡ï¼ˆé«˜ç²¾åº¦ï¼‰è®¡æ—¶ `API`ã€‘
- `Performance Timeline API`ã€æ€§èƒ½æ—¶é—´çº¿ `API`ã€‘
- `Navigation Timing API`
- `User Timing API`
- `Resource Timing API`
- `Paint Timing API`

â€‹		æœ‰å…³è¿™äº›è§„èŒƒçš„æ›´å¤šä¿¡æ¯ä»¥åŠæ–°å¢çš„æ€§èƒ½ç›¸å…³è§„èŒƒï¼Œå¯ä»¥å…³æ³¨ `W3C` æ€§èƒ½å·¥ä½œç»„çš„ `GitHub` é¡¹ç›®é¡µé¢ã€‚

â€‹		æ³¨æ„ï¼šæµè§ˆå™¨é€šå¸¸æ”¯æŒè¢«åºŸå¼ƒçš„ `Level 1` å’Œä½œä¸ºæ›¿ä»£çš„ `Level 2`ã€‚æœ¬èŠ‚å°½é‡ä»‹ç» `Level 2` çº§è§„èŒƒã€‚



#### `High Resolution Time API`

â€‹		`Date.now()` æ–¹æ³•åªé€‚ç”¨äºæ—¥æœŸæ—¶é—´ç›¸å…³æ“ä½œï¼Œè€Œä¸”æ˜¯**ä¸è¦æ±‚è®¡æ—¶ç²¾åº¦**çš„æ“ä½œã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå‡½æ•° `foo()` è°ƒç”¨å‰ååˆ†åˆ«è®°å½•äº†ä¸€ä¸ªæ—¶é—´æˆ³ï¼š

```js
const t0 = Date.now();
foo();
const t1 = Date.now();

const duration = t1 - t0;
console.log(duration);
```

â€‹		è€ƒè™‘å¦‚ä¸‹ `duration` ä¼šåŒ…å«æ„å¤–å€¼çš„æƒ…å†µã€‚

- `duration` æ˜¯ 0ã€‚`Date.now()` åªæœ‰**æ¯«ç§’çº§ç²¾åº¦**ï¼Œå¦‚æœ `foo()` æ‰§è¡Œè¶³å¤Ÿå¿«ï¼Œåˆ™ä¸¤ä¸ªæ—¶é—´æˆ³çš„å€¼å¯èƒ½ä¼šç›¸ç­‰ã€‚
- `duration` æ˜¯è´Ÿå€¼æˆ–æå¤§å€¼ã€‚å¦‚æœåœ¨ `foo()` æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿæ—¶é’Ÿè¢«å‘åæˆ–å‘å‰è°ƒæ•´äº†ï¼ˆå¦‚åˆ‡æ¢åˆ°å¤ä»¤æ—¶ï¼‰ï¼Œåˆ™æ•è·çš„æ—¶é—´æˆ³ä¸ä¼šè€ƒè™‘è¿™ç§æƒ…å†µï¼Œå› æ­¤æ—¶é—´å·®ä¸­ä¼šåŒ…å«è¿™äº›è°ƒæ•´ã€‚

â€‹		ä¸ºæ­¤ï¼Œå¿…é¡»ä½¿ç”¨ä¸åŒçš„è®¡æ—¶ `API` æ¥ç²¾ç¡®ä¸”å‡†ç¡®åœ°åº¦é‡æ—¶é—´çš„æµé€ã€‚æ˜¾ç„¶ï¼Œå¯¹äºå¾®å¦™çº§ç²¾åº¦çš„è®¡æ—¶ `Date.now` æ˜¯éš¾ä»¥èƒœä»»çš„ã€‚äºæ˜¯ï¼Œ`High Resolution Time API` å®šä¹‰äº† `window.performance.now()`ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª**å¾®ç§’ç²¾åº¦**çš„æµ®ç‚¹å€¼ã€‚å› æ­¤ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å…ˆåæ•è·çš„æ—¶é—´æˆ³æ›´ä¸å¯èƒ½å‡ºç°ç›¸ç­‰çš„æƒ…å†µï¼ˆå®é™…ä¸Šä»ä¼šå‡ºç°ç›¸ç­‰çš„æƒ…å†µï¼‰ã€‚è€Œä¸”è¿™ä¸ªæ–¹æ³•å¯ä»¥**ä¿è¯æ—¶é—´æˆ³å•è°ƒå¢é•¿**ã€‚

```js
const t0 = performance.now(); 
foo();
const t1 = performance.now(); 

console.log(t0); // 10.600000023841858
console.log(t1); // 10.699999988079071

const duration = t1 - t0; 
console.log(duration); // 0.09999996423721313
```

â€‹		`performance.now()` è®¡æ—¶å™¨é‡‡ç”¨ç›¸å¯¹åº¦é‡ã€‚è¿™ä¸ªè®¡æ—¶å™¨åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡åˆ›å»ºæ—¶ä» 0 å¼€å§‹è®¡æ—¶ã€‚ä¾‹å¦‚ï¼Œæ‰“å¼€é¡µé¢æˆ–åˆ›å»ºå·¥ä½œçº¿ç¨‹æ—¶ï¼Œ`performance.now()` å°±ä¼šä» 0 å¼€å§‹è®¡æ—¶ã€‚ç”±äºè¿™ä¸ªè®¡æ—¶å™¨åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­åˆå§‹åŒ–æ—¶å¯èƒ½å­˜åœ¨æ—¶é—´å·®ï¼Œå› æ­¤ä¸åŒä¸Šä¸‹æ–‡ä¹‹é—´å¦‚æœæ²¡æœ‰å…±äº«å‚ç…§ç‚¹åˆ™ä¸å¯èƒ½ç›´æ¥æ¯”è¾ƒ `performance.now()`ã€‚`performance.timeOrigin` å±æ€§è¿”å›è®¡æ—¶å™¨åˆå§‹åŒ–æ—¶å…¨å±€ç³»ç»Ÿæ—¶é’Ÿçš„å€¼ã€‚

```js
const relativeTimestamp = performance.now(); 
const absoluteTimestamp = performance.timeOrigin + relativeTimestamp; 

console.log(relativeTimestamp); // 1360.8999999761581
console.log(absoluteTimestamp); // 1679901860082.2998
```

â€‹		æ³¨æ„ï¼šé€šè¿‡ä½¿ç”¨ `performance.now()` æµ‹é‡ `L1` ç¼“å­˜ä¸ä¸»å†…å­˜çš„å»¶è¿Ÿå·®ï¼Œå¹½çµæ¼æ´ï¼ˆ`Spectre`ï¼‰å¯ä»¥æ‰§è¡Œç¼“å­˜æ¨æ–­æ”»å‡»ã€‚ä¸ºå¼¥è¡¥è¿™ä¸ªå®‰å…¨æ¼æ´ï¼Œæ‰€æœ‰çš„ä¸»æµæµè§ˆå™¨æœ‰çš„é€‰æ‹©é™ä½ `performance.now()` çš„ç²¾åº¦ï¼Œæœ‰çš„é€‰æ‹©åœ¨æ—¶é—´æˆ³é‡Œæ··å…¥ä¸€äº›éšæœºæ€§ã€‚`WebKit` åšå®¢ä¸Šæœ‰ä¸€ç¯‡ç›¸å…³ä¸»é¢˜çš„ä¸é”™çš„æ–‡ç« ã€Š`What Spectre and Meltdown Mean For WebKit`ã€‹ï¼Œä½œè€…æ˜¯ `Filip Pizlo`ã€‚

â€‹		æ›´å¤šå‚è€ƒï¼š[`High Resolution Time`](https://w3c.github.io/hr-time/) 



#### `Performance Timeline API`

â€‹		`Performance Timeline API` ä½¿ç”¨ä¸€å¥—ç”¨äºåº¦é‡å®¢æˆ·ç«¯å»¶è¿Ÿçš„å·¥å…·æ‰©å±•äº† `Performance` æ¥å£ã€‚æ€§èƒ½åº¦é‡å°†ä¼šé‡‡ç”¨è®¡ç®—ç»“æŸä¸å¼€å§‹æ—¶é—´å·®çš„å½¢å¼ã€‚è¿™äº›å¼€å§‹å’Œç»“æŸæ—¶é—´ä¼šè¢«è®°å½•ä¸º `DOMHighResTimeStamp` å€¼ï¼Œè€Œå°è£…è¿™ä¸ªæ—¶é—´æˆ³çš„å¯¹è±¡æ˜¯ `PerformanceEntry` çš„å®ä¾‹ã€‚

â€‹		æµè§ˆå™¨ä¼šè‡ªåŠ¨è®°å½•å„ç§ `PerformanceEntry` å¯¹è±¡ï¼Œè€Œä½¿ç”¨ `performance.mark()` ä¹Ÿå¯ä»¥è®°å½•è‡ªå®šä¹‰çš„ `PerformanceEntry` å¯¹è±¡ã€‚åœ¨ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­è¢«è®°å½•çš„æ‰€æœ‰æ€§èƒ½æ¡ç›®å¯ä»¥é€šè¿‡ `performance.getEntries()` è·å–ï¼š

```js
console.log(performance.getEntries()); // [PerformanceNavigationTiming, PerformanceResourceTiming, ... ]
```

â€‹		è¿™ä¸ªè¿”å›çš„é›†åˆä»£è¡¨æµè§ˆå™¨çš„æ€§èƒ½æ—¶é—´çº¿ï¼ˆ`performance timeline`ï¼‰ã€‚æ¯ä¸ª `PerformanceEntry` å¯¹è±¡éƒ½æœ‰ `name`ã€`entryType`ã€`startTime` å’Œ `duration` å±æ€§ï¼š

```js
const entry = performance.getEntries()[0]; 

console.log(entry.name); 		// "first-paint" 
console.log(entry.entryType); 	// "paint" 
console.log(entry.startTime); 	// 25.599999964237213 
console.log(entry.duration); 	// 0
```

â€‹		ä¸è¿‡ï¼Œ`PerformanceEntry` å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ã€‚æ‰€æœ‰è®°å½•æ¡ç›®è™½ç„¶éƒ½ç»§æ‰¿ `PerformanceEntry`ï¼Œä½†æœ€ç»ˆè¿˜æ˜¯å¦‚ä¸‹æŸä¸ªå…·ä½“ç±»çš„å®ä¾‹ï¼š

- `PerformanceMark`
- `PerformanceMeasure`
- `PerformanceFrameTiming`
- `PerformanceNavigationTiming`
- `PerformanceResourceTiming`
- `PerformancePaintTiming`

â€‹		ä¸Šé¢æ¯ä¸ªç±»éƒ½ä¼šå¢åŠ å„è‡ªçš„å±æ€§ï¼Œç”¨äºæè¿°ä¸ç›¸åº”æ¡ç›®æœ‰å…³çš„å…ƒæ•°æ®ã€‚æ¯ä¸ªå®ä¾‹çš„ `name` å’Œ `entryType` å±æ€§ä¼šå› ä¸ºå„è‡ªçš„ç±»ä¸åŒè€Œä¸åŒã€‚

##### `User Timing API` 

â€‹		`User Timing API` ç”¨äºè®°å½•å’Œåˆ†æè‡ªå®šä¹‰æ€§èƒ½æ¡ç›®ã€‚å¦‚å‰æ‰€è¿°ï¼Œè®°å½•è‡ªå®šä¹‰æ€§èƒ½æ¡ç›®è¦ä½¿ç”¨ `performance.mark()` æ–¹æ³•ï¼š

```js
performance.mark('foo'); 

console.log(performance.getEntriesByType('mark')[0]); 
/* 
PerformanceMarkÂ {
	detail: null, 
	name: 'foo', 
	entryType: 'mark', 
	startTime: 7.399999976158142, 
	duration: 0,
	[[Prototype]]: PerformanceMark
}
*/
```

â€‹		åœ¨è®¡ç®—å¼€å§‹å‰å’Œç»“æŸåå„åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ€§èƒ½æ¡ç›®å¯ä»¥è®¡ç®—æ—¶é—´å·®ã€‚æœ€æ–°çš„æ ‡è®°ï¼ˆ`mark`ï¼‰ä¼šè¢«æ¨åˆ° `getEntriesByType()` è¿”å›æ•°ç»„çš„å°¾éƒ¨ï¼š

```js
performance.mark('foo'); 
for (let i = 0; i < 1E6; ++i) {} 
performance.mark('bar'); 

const [startMark, endMark] = performance.getEntriesByType('mark'); 
console.log(endMark.startTime - startMark.startTime); // 1.600000023841858
```

â€‹		é™¤äº†è‡ªå®šä¹‰æ€§èƒ½æ¡ç›®ï¼Œè¿˜å¯ä»¥ç”Ÿæˆ `PerformanceMeasure`ï¼ˆæ€§èƒ½åº¦é‡ï¼‰æ¡ç›®ï¼Œå¯¹åº”ç”±åå­—ä½œä¸ºæ ‡è¯†çš„ä¸¤ä¸ªæ ‡è®°ä¹‹é—´çš„é—´éš”æ—¶é—´ã€‚`PerformanceMeasure` çš„å®ä¾‹ç”± `performance.measure()` æ–¹æ³•ç”Ÿæˆï¼š

```js
console.log(performance.mark('foo')); // PerformanceMarkÂ {name: 'foo', startTime: 11.099999964237213, ...}
for (let i = 0; i < 1E6; ++i) { }
console.log(performance.mark('bar')); // PerformanceMarkÂ {name: 'bar', startTime: 12.799999952316284, ...}

performance.measure('baz', 'foo', 'bar');

const [differenceMark] = performance.getEntriesByType('measure');
console.log(differenceMark); 
/*
PerformanceMeasureÂ {
	detail: null, 
	name: 'baz', 
	entryType: 'measure', 
	startTime: 11.099999964237213, 
	duration: 1.699999988079071,
	[[Prototype]]: PerformanceMeasure
}
*/
```

##### `Navigation Timing API`

â€‹		`Navigation Timing API` æä¾›äº†é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼Œç”¨äºåº¦é‡å½“å‰é¡µé¢åŠ è½½é€Ÿåº¦ã€‚æµè§ˆå™¨ä¼šåœ¨å¯¼èˆªäº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨è®°å½• `PerformanceNavigationTiming` æ¡ç›®ã€‚è¿™ä¸ªå¯¹è±¡ä¼šæ•è·å¤§é‡æ—¶é—´æˆ³ï¼Œç”¨äºæè¿°é¡µé¢æ˜¯ä½•æ—¶ä»¥åŠå¦‚ä½•åŠ è½½çš„ã€‚

â€‹		ä¸‹é¢çš„ä¾‹å­è®¡ç®—äº† `loadEventStart` å’Œ `loadEventEnd` æ—¶é—´æˆ³ä¹‹é—´çš„å·®ï¼š

```js
// æ­¤ä»£ç å¿…é¡»åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸‹ï¼ˆçƒ­æ›´æ–°é¡µé¢ä¸­ï¼‰è¿è¡Œ
const [performanceNavigationTimingEntry] = performance.getEntriesByType('navigation'); 
console.log(performanceNavigationTimingEntry); 
/*
PerformanceNavigationTiming { 
	activationStart: 0
	connectEnd: 0.5999999642372131
	connectStart: 0.5999999642372131
	decodedBodySize: 2177
	domComplete: 14.199999988079071
	domContentLoadedEventEnd: 12.5
	domContentLoadedEventStart: 12.5
	domInteractive: 12.399999976158142
	domainLookupEnd: 0.5999999642372131
	domainLookupStart: 0.5999999642372131
	duration: 14.699999988079071
	encodedBodySize: 2177
	entryType: "navigation"
	fetchStart: 0.5999999642372131
	initiatorType: "navigation"
	loadEventEnd: 14.699999988079071
	loadEventStart: 14.199999988079071
	name: "http://127.0.0.1:60508/DOM.html"
	nextHopProtocol: ""
	redirectCount: 0
	redirectEnd: 0
	redirectStart: 0
	renderBlockingStatus: "non-blocking"
	requestStart: 3.099999964237213
	responseEnd: 5.399999976158142
	responseStart: 4.599999964237213
	responseStatus: 200
	secureConnectionStart: 0
	serverTiming: []
	startTime: 0
	transferSize: 300
	type: "reload"
	unloadEventEnd: 7.5
	unloadEventStart: 7.5
	workerStart: 0
	[[Prototype]]: PerformanceNavigationTiming
} 
*/

console.log(
    performanceNavigationTimingEntry.loadEventEnd - performanceNavigationTimingEntry.loadEventStart
); 
// åº”å½“æ˜¯ï¼š0.5ï¼Œä½†å®é™…ä¸Šæ˜¯ï¼š-14.199999988079071ã€‚å› ä¸ºï¼Œåœ¨å‚ä¸è¿ç®—æ—¶loadEventEndçš„å€¼å˜ä¸ºäº†ï¼š0ã€‚
```

##### `Resource Timing API` 

â€‹		`Resource Timing API` æä¾›äº†é«˜ç²¾åº¦æ—¶é—´æˆ³ï¼Œç”¨äºåº¦é‡å½“å‰é¡µé¢åŠ è½½æ—¶è¯·æ±‚èµ„æºçš„é€Ÿåº¦ã€‚æµè§ˆå™¨ä¼šåœ¨åŠ è½½èµ„æºæ—¶è‡ªåŠ¨è®°å½• `PerformanceResourceTiming`ã€‚è¿™ä¸ªå¯¹è±¡ä¼šæ•è·å¤§é‡æ—¶é—´æˆ³ï¼Œç”¨äºæè¿°èµ„æºåŠ è½½çš„é€Ÿåº¦ã€‚

â€‹		ä¸‹é¢çš„ä¾‹å­è®¡ç®—äº†åŠ è½½ä¸€ä¸ªç‰¹å®šèµ„æºæ‰€èŠ±çš„æ—¶é—´ï¼š

```js
// æ­¤ä»£ç å¿…é¡»åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸‹ï¼ˆçƒ­æ›´æ–°é¡µé¢ä¸­ï¼‰è¿è¡Œ
window.addEventListener("load", (event) => {
    const performanceResourceTimingEntry = performance.getEntriesByType('resource')[0];
    console.log(performanceResourceTimingEntry); 
});
/* 
PerformanceResourceTiming { 
	connectEnd: 10.300000011920929,
	connectStart: 10.300000011920929,
	decodedBodySize: 0,
	domainLookupEnd: 10.300000011920929,
	domainLookupStart: 10.300000011920929,
	duration: 7.399999976158142, 
	encodedBodySize: 0,
	entryType: "resource",
	fetchStart: 10.300000011920929,
	initiatorType: "img",
	name: "http://127.0.0.1:60508/protect1/images/agito.png", 
	nextHopProtocol: "",
	redirectEnd: 0,
	redirectStart: 0,
	renderBlockingStatus: "non-blocking",
	requestStart: 13,
	responseEnd: 17.69999998807907,
	responseStart: 17,
	responseStatus: 200,
	secureConnectionStart: 0,
	serverTiming: [],
	startTime: 10.300000011920929,
	transferSize: 300,
	workerStart: 0,
    [[Prototype]]: PerformanceResourceTiming
} 
*/
console.log(
    performanceResourceTimingEntry.responseEnd - performanceResourceTimingEntry.requestStart
); 
// 4.699999988079071
```

â€‹		é€šè¿‡è®¡ç®—å¹¶åˆ†æä¸åŒæ—¶é—´çš„å·®ï¼Œå¯ä»¥æ›´å…¨é¢åœ°å®¡è§†æµè§ˆå™¨åŠ è½½é¡µé¢çš„è¿‡ç¨‹ï¼Œå‘ç°å¯èƒ½å­˜åœ¨çš„æ€§èƒ½ç“¶é¢ˆã€‚



### `Web` ç»„ä»¶

â€‹		è¿™é‡Œæ‰€è¯´çš„ `Web` ç»„ä»¶æŒ‡çš„æ˜¯ä¸€å¥—ç”¨äºå¢å¼º `DOM` è¡Œä¸ºçš„å·¥å…·ï¼ŒåŒ…æ‹¬å½±å­ `DOM`ã€è‡ªå®šä¹‰å…ƒç´ å’Œ `HTML` æ¨¡æ¿ã€‚è¿™ä¸€å¥—æµè§ˆå™¨ `API` ç‰¹åˆ«æ··ä¹±ã€‚

- å¹¶æ²¡æœ‰ç»Ÿä¸€çš„ `"Web Components"` è§„èŒƒï¼šæ¯ä¸ª `Web` ç»„ä»¶éƒ½åœ¨ä¸€ä¸ªä¸åŒçš„è§„èŒƒä¸­å®šä¹‰ã€‚
- æœ‰äº› `Web` ç»„ä»¶å¦‚å½±å­ `DOM` å’Œè‡ªå®šä¹‰å…ƒç´ ï¼Œå·²ç»å‡ºç°äº†å‘åä¸å…¼å®¹çš„ç‰ˆæœ¬é—®é¢˜ã€‚
- æµè§ˆå™¨å®ç°æå…¶ä¸ä¸€è‡´ã€‚

â€‹		æ³¨æ„ï¼šæœ¬ç« åªä»‹ç» `Web` ç»„ä»¶çš„æœ€æ–°ç‰ˆæœ¬ã€‚



#### `HTML` æ¨¡æ¿

â€‹		åœ¨ `Web` ç»„ä»¶ä¹‹å‰ï¼Œä¸€ç›´ç¼ºå°‘åŸºäº `HTML` è§£ææ„å»º `DOM` å­æ ‘ï¼Œç„¶ååœ¨éœ€è¦æ—¶å†æŠŠè¿™ä¸ªå­æ ‘æ¸²æŸ“å‡ºæ¥çš„æœºåˆ¶ã€‚ä¸€ç§é—´æ¥æ–¹æ¡ˆæ˜¯ä½¿ç”¨ `innerHTML` æŠŠæ ‡è®°å­—ç¬¦ä¸²è½¬æ¢ä¸º `DOM` å…ƒç´ ï¼Œä½†è¿™ç§æ–¹å¼å­˜åœ¨ä¸¥é‡çš„å®‰å…¨éšæ‚£ã€‚å¦ä¸€ç§é—´æ¥æ–¹æ¡ˆæ˜¯ä½¿ç”¨ `document.createElement()` æ„å»ºæ¯ä¸ªå…ƒç´ ï¼Œç„¶åé€ä¸ªæŠŠå®ƒä»¬æ·»åŠ åˆ°å­¤å„¿æ ¹èŠ‚ç‚¹ï¼ˆä¸æ˜¯æ·»åŠ åˆ° `DOM`ï¼‰ï¼Œä½†è¿™æ ·åšç‰¹åˆ«éº»çƒ¦ï¼Œå®Œå…¨ä¸æ ‡è®°æ— å…³ã€‚

â€‹		ç›¸åï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯æå‰åœ¨é¡µé¢ä¸­å†™å‡ºç‰¹æ®Šæ ‡è®°ï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å°†å…¶è§£æä¸º `DOM` å­æ ‘ï¼Œä½†è·³è¿‡æ¸²æŸ“ã€‚è¿™æ­£æ˜¯ `HTML` æ¨¡æ¿çš„æ ¸å¿ƒæ€æƒ³ï¼Œè€Œ `<template>` æ ‡ç­¾æ­£æ˜¯ä¸ºè¿™ä¸ªç›®çš„è¯ç”Ÿçš„ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ `HTML` æ¨¡æ¿çš„ä¾‹å­ï¼š

```html
<template id="foo"> 
 	<p>I'm inside a template!</p> 
</template>
```

##### ä½¿ç”¨ `DocumentFragment`

â€‹		åœ¨æµè§ˆå™¨ä¸­æ¸²æŸ“æ—¶ï¼Œä¸Šé¢ä¾‹å­ä¸­çš„æ–‡æœ¬ä¸ä¼šè¢«æ¸²æŸ“åˆ°é¡µé¢ä¸Šã€‚å› ä¸º `<template>` çš„å†…å®¹ä¸å±äºæ´»åŠ¨æ–‡æ¡£ï¼Œæ‰€ä»¥ `document.querySelector()` ç­‰ `DOM` æŸ¥è¯¢æ–¹æ³•ä¸ä¼šå‘ç°å…¶ä¸­çš„ `<p>` æ ‡ç­¾ã€‚è¿™æ˜¯å› ä¸º `<p>` å­˜åœ¨äºä¸€ä¸ªåŒ…å«åœ¨ `HTML` æ¨¡æ¿ä¸­çš„ `DocumentFragment` èŠ‚ç‚¹å†…ã€‚

â€‹		åœ¨æµè§ˆå™¨ä¸­é€šè¿‡å¼€å‘è€…å·¥å…·æ£€æŸ¥ç½‘é¡µå†…å®¹æ—¶ï¼Œå¯ä»¥çœ‹åˆ° `<template>` ä¸­çš„ `DocumentFragment`ï¼š

```js
console.log(document.querySelector('#foo').content); // #document-fragment
```

â€‹		æ­¤æ—¶çš„ `DocumentFragment` å°±åƒä¸€ä¸ªå¯¹åº”å­æ ‘çš„æœ€å°åŒ– `document` å¯¹è±¡ï¼ˆæ–‡æ¡£ç‰‡æ®µï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œ`DocumentFragment` ä¸Šçš„ `DOM` åŒ¹é…æ–¹æ³•å¯ä»¥æŸ¥è¯¢å…¶å­æ ‘ä¸­çš„èŠ‚ç‚¹ï¼š

```js
const fragment = document.querySelector('#foo').content; 
console.log(document.querySelector('p')); // null 
console.log(fragment.querySelector('p')); // <p>...<p>
```

â€‹		`DocumentFragment` ä¹Ÿæ˜¯æ‰¹é‡å‘ `HTML` ä¸­æ·»åŠ å…ƒç´ çš„é«˜æ•ˆå·¥å…·ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³ä»¥æœ€å¿«çš„æ–¹å¼ç»™æŸä¸ª `HTML` å…ƒç´ æ·»åŠ å¤šä¸ªå­å…ƒç´ ã€‚å¦‚æœè¿ç»­è°ƒç”¨ `document.appendChild()`ï¼Œä¸ä»…è´¹äº‹ï¼Œè¿˜ä¼šå¯¼è‡´å¤šæ¬¡å¸ƒå±€é‡æ’ã€‚è€Œä½¿ç”¨ `DocumentFragment` å¯ä»¥ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œæœ€å¤šåªä¼šæœ‰ä¸€æ¬¡å¸ƒå±€é‡æ’ï¼š

```html
<!-- åˆå§‹é¡µé¢ -->
<div id="foo"></div> 
```

```js
// ä¹Ÿå¯ä»¥ä½¿ç”¨ document.createDocumentFragment() 
const fragment = new DocumentFragment(); 
const foo = document.querySelector('#foo'); 

// ä¸º DocumentFragment æ·»åŠ å­å…ƒç´ ä¸ä¼šå¯¼è‡´å¸ƒå±€é‡æ’
fragment.appendChild(document.createElement('p')); 
fragment.appendChild(document.createElement('p')); 
fragment.appendChild(document.createElement('p')); 

console.log(fragment.children.length); // 3 

foo.appendChild(fragment);

console.log(fragment.children.length); // 0
```

```html
<!-- æœ€ç»ˆé¡µé¢ -->
<div id="foo"> 
	<p></p> 
	<p></p> 
	<p></p> 
</div>
```

##### ä½¿ç”¨ `<template>` æ ‡ç­¾

â€‹		æ³¨æ„ï¼Œåœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œ`DocumentFragment` çš„æ‰€æœ‰å­èŠ‚ç‚¹éƒ½é«˜æ•ˆåœ°è½¬ç§»åˆ°äº† `foo` å…ƒç´ ä¸Šï¼Œè½¬ç§»ä¹‹å `DocumentFragment` å°±å˜æˆç©ºçš„äº†ã€‚åŒæ ·çš„è¿‡ç¨‹ä¹Ÿå¯ä»¥ä½¿ç”¨ `<template>` æ ‡ç­¾é‡ç°ï¼š

```html
<!-- åˆå§‹é¡µé¢ -->
<div id="foo"></div> 
<template id="bar"> 
	<p></p> 
	<p></p> 
	<p></p> 
</template> 
```

```js
const fooElement = document.querySelector('#foo'); 
const barTemplate = document.querySelector('#bar'); 
const barFragment = barTemplate.content; 

fooElement.appendChild(barFragment); 
```

```html
<!-- æœ€ç»ˆé¡µé¢ -->
<div id="foo"> 
	<p></p> 
	<p></p> 
	<p></p> 
</div> 
<tempate id="bar"></template>
```

â€‹		å¦‚æœæƒ³è¦å¤åˆ¶æ¨¡æ¿ï¼Œå¯ä»¥ä½¿ç”¨ `importNode()` æ–¹æ³•å…‹éš† `DocumentFragment`ï¼š

- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¦å¤åˆ¶çš„èŠ‚ç‚¹æˆ–æ–‡æ¡£ç‰‡æ®µ
- ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æ·±å¤åˆ¶ä»¥åŒ…å«å…¶å­æ ‘

```html
<!-- åˆå§‹é¡µé¢ -->
<div id="foo"></div> 
<template id="bar"> 
	<p></p> 
	<p></p> 
	<p></p> 
</template> 
```

```js
const fooElement = document.querySelector('#foo'); 
const barTemplate = document.querySelector('#bar'); 
const barFragment = barTemplate.content; 

fooElement.appendChild(document.importNode(barFragment, true)); 
```

```html
<div id="foo"> 
	<p></p> 
	<p></p> 
	<p></p>
</div> 
<template id="bar"> 
	<p></p> 
	<p></p> 
	<p></p> 
</template>
```

##### æ¨¡æ¿è„šæœ¬

â€‹		è„šæœ¬æ‰§è¡Œå¯ä»¥æ¨è¿Ÿåˆ°å°† `DocumentFragment` çš„å†…å®¹å®é™…æ·»åŠ åˆ° `DOM` æ ‘ä¸­ä¹‹åã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ï¼š

```html
<div id="foo"></div> 
<template id="bar"> 
	<script>console.log('Template script executed');</script> 
</template> 
```

```js
const fooElement = document.querySelector('#foo'); 
const barTemplate = document.querySelector('#bar'); 
const barFragment = barTemplate.content; 

console.log('About to add template'); 
fooElement.appendChild(barFragment); 
console.log('Added template'); 

/*
> About to add template 
> Template script executed 
> Added template
*/
```

â€‹		å¦‚æœæ–°æ·»åŠ çš„å…ƒç´ éœ€è¦è¿›è¡ŒæŸäº›åˆå§‹åŒ–ï¼Œåˆ™è¿™ç§å»¶è¿Ÿæ‰§è¡Œæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚



#### å½±å­ `DOM`

â€‹		æ¦‚å¿µä¸Šè®²ï¼Œå½±å­ `DOM`ï¼ˆ`shadow DOM`ï¼‰ `Web` ç»„ä»¶ç›¸å½“ç›´è§‚ï¼Œé€šè¿‡å®ƒå¯ä»¥å°†ä¸€ä¸ªå®Œæ•´çš„ `DOM` æ ‘ä½œä¸ºèŠ‚ç‚¹æ·»åŠ åˆ°çˆ¶ `DOM` æ ‘ã€‚è¿™æ ·å¯ä»¥å®ç° `DOM` å°è£…ï¼Œæ„å‘³ç€ `CSS` æ ·å¼å’Œ `CSS` é€‰æ‹©ç¬¦å¯ä»¥é™åˆ¶åœ¨å½±å­ `DOM` å­æ ‘è€Œä¸æ˜¯æ•´ä¸ªé¡¶çº§ `DOM` æ ‘ä¸­ã€‚

â€‹		å½±å­ `DOM` ä¸ `HTML` æ¨¡æ¿å¾ˆç›¸ä¼¼ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ç±»ä¼¼ `document` çš„ç»“æ„ï¼Œå¹¶å…è®¸ä¸é¡¶çº§ `DOM` æœ‰ä¸€å®šç¨‹åº¦çš„åˆ†ç¦»ã€‚ä¸è¿‡ï¼Œå½±å­ `DOM` ä¸ `HTML` æ¨¡æ¿è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œä¸»è¦è¡¨ç°åœ¨å½±å­ `DOM` çš„å†…å®¹ä¼šå®é™…æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œè€Œ `HTML` æ¨¡æ¿çš„å†…å®¹ä¸ä¼šã€‚

##### ç†è§£å½±å­ `DOM` 

â€‹		å‡è®¾æœ‰ä»¥ä¸‹ `HTML` æ ‡è®°ï¼Œå…¶ä¸­åŒ…å«å¤šä¸ªç±»ä¼¼çš„ `DOM` å­æ ‘ï¼š

```html
<div> 
 	<p>Make me red!</p> 
</div> 
<div> 
 	<p>Make me blue!</p> 
</div> 
<div> 
 	<p>Make me green!</p> 
</div>
```

â€‹		ä»å…¶ä¸­çš„æ–‡æœ¬èŠ‚ç‚¹å¯ä»¥æ¨æ–­å‡ºï¼Œè¿™ 3 ä¸ª `DOM` å­æ ‘ä¼šåˆ†åˆ«æ¸²æŸ“ä¸ºä¸åŒçš„é¢œè‰²ã€‚å¸¸è§„æƒ…å†µä¸‹ï¼Œä¸ºäº†ç»™æ¯ä¸ªå­æ ‘åº”ç”¨å”¯ä¸€çš„æ ·å¼ï¼Œåˆä¸ä½¿ç”¨ `style` å±æ€§ï¼Œå°±éœ€è¦ç»™æ¯ä¸ªå­æ ‘æ·»åŠ ä¸€ä¸ªå”¯ä¸€çš„ç±»åï¼Œç„¶åé€šè¿‡ç›¸åº”çš„é€‰æ‹©ç¬¦ä¸ºå®ƒä»¬æ·»åŠ æ ·å¼ï¼š

```html
<div class="red-text"> 
 	<p>Make me red!</p> 
</div> 
<div class="green-text"> 
 	<p>Make me green!</p> 
</div> 
<div class="blue-text"> 
 	<p>Make me blue!</p> 
</div> 
<style> 
.red-text { 
 	color: red; 
} 
.green-text { 
 	color: green; 
} 
.blue-text { 
 	color: blue; 
} 
</style>
```

â€‹		å½“ç„¶ï¼Œè¿™ä¸ªæ–¹æ¡ˆä¹Ÿä¸æ˜¯ååˆ†ç†æƒ³ï¼Œå› ä¸ºè¿™è·Ÿåœ¨å…¨å±€å‘½åç©ºé—´ä¸­å®šä¹‰å˜é‡æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚å°½ç®¡çŸ¥é“è¿™äº›æ ·å¼ä¸å…¶ä»–åœ°æ–¹æ— å…³ï¼Œä½†æ‰€æœ‰çš„ `CSS` æ ·å¼è¿˜æ˜¯ä¼šåº”ç”¨åˆ°æ•´ä¸ª `DOM`ã€‚ä¸ºæ­¤ï¼Œå°±è¦ä¿æŒ `CSS` é€‰æ‹©ç¬¦è¶³å¤Ÿç‰¹åˆ«ï¼Œä»¥é˜²è¿™äº›æ ·å¼æ¸—é€åˆ°å…¶ä»–åœ°æ–¹ã€‚ä½†è¿™ä¹Ÿä»…ä»…æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„åŠæ³•è€Œå·²ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥èƒ½å¤ŸæŠŠ `CSS` é™åˆ¶åœ¨ä½¿ç”¨å®ƒä»¬çš„ `DOM` ä¸Šï¼šè¿™æ­£æ˜¯å½±å­ `DOM` æœ€åˆçš„ä½¿ç”¨åœºæ™¯ã€‚

##### åˆ›å»ºå½±å­ `DOM`

â€‹		è€ƒè™‘åˆ°å®‰å…¨åŠé¿å…å½±å­ `DOM` å†²çªï¼Œå¹¶éæ‰€æœ‰å…ƒç´ éƒ½å¯ä»¥åŒ…å«å½±å­ `DOM`ã€‚å°è¯•ç»™æ— æ•ˆå…ƒç´ æˆ–è€…å·²ç»æœ‰äº†å½±å­ `DOM` çš„å…ƒç´ æ·»åŠ å½±å­ `DOM` ä¼šå¯¼è‡´æŠ›å‡ºé”™è¯¯ã€‚

â€‹		ä»¥ä¸‹æ˜¯å¯ä»¥å®¹çº³å½±å­ `DOM` çš„å…ƒç´ ã€‚

- ä»»ä½•ä»¥æœ‰æ•ˆåç§°åˆ›å»ºçš„è‡ªå®šä¹‰å…ƒç´ ï¼ˆå‚è§ `HTML` è§„èŒƒä¸­ç›¸å…³çš„å®šä¹‰ï¼‰
- `<article>`
- `<aside>`
- `<blockquote>`
- `<body>`
- `<div>`
- `<footer>`
- `<h1>`
- `<h2>`
- `<h3>`
- `<h4>`
- `<h5>`
- `<h6>`
- `<header>`
- `<main>`
- `<nav>`
- `<p>`
- `<section>`
- `<span>`

â€‹		å½±å­ `DOM` æ˜¯é€šè¿‡ `attachShadow()` æ–¹æ³•åˆ›å»ºå¹¶æ·»åŠ ç»™æœ‰æ•ˆçš„ `HTML` å…ƒç´ çš„ã€‚å®¹çº³å½±å­ `DOM` çš„å…ƒç´ è¢«ç§°ä¸ºå½±å­å®¿ä¸»ï¼ˆè¯‘ï¼š`shadow host`ï¼‰ã€‚å½±å­ `DOM` çš„æ ¹èŠ‚ç‚¹ï¼ˆå¦‚ï¼š`#shadow-root (open)` æˆ– `#shadow-root (closed)`ï¼‰è¢«ç§°ä¸ºå½±å­æ ¹ï¼ˆ`shadow root`ï¼‰ã€‚æ³¨æ„ï¼Œä¸€ä¸ªå½±å­å®¿ä¸»ä¸­åªèƒ½æœ‰ä¸€ä¸ªå½±å­æ ¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½±å­æ ‘ä¸èƒ½å¹¶åˆ—å­˜åœ¨ï¼ˆä½†å¯ä»¥ç›¸äº’åµŒå¥—ï¼‰ã€‚

â€‹		`attachShadow()` æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ª `shadowRootInit` å¯¹è±¡ï¼Œè¿”å›å½±å­ `DOM` çš„å®ä¾‹ã€‚`shadowRootInit` å¯¹è±¡å¿…é¡»åŒ…å«ä¸€ä¸ª `mode` å±æ€§ï¼Œå€¼ä¸º `"open"` æˆ– `"closed"`ã€‚å¯¹ `"open"` å½±å­ `DOM` çš„å¼•ç”¨å¯ä»¥é€šè¿‡ `shadowRoot` å±æ€§åœ¨ `HTML` å…ƒç´ ä¸Šè·å¾—ï¼Œè€Œå¯¹ `"closed"` å½±å­ `DOM` çš„å¼•ç”¨åˆ™æ— æ³•è¿™æ ·è·å–ã€‚

â€‹		ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†ä¸åŒ `mode` çš„åŒºåˆ«ï¼š

```js
document.body.innerHTML = ` 
 	<div id="foo"></div> 
 	<div id="bar"></div> 
`; 

const foo = document.querySelector('#foo'); 
const bar = document.querySelector('#bar'); 

const openShadowDOM = foo.attachShadow({ mode: 'open' }); 
const closedShadowDOM = bar.attachShadow({ mode: 'closed' }); 

console.log(openShadowDOM); 	// #shadow-root (open)
console.log(closedShadowDOM); 	// #shadow-root (closed)

console.log(foo.shadowRoot); 	// #shadow-root (open) 
console.log(bar.shadowRoot); 	// null
```

â€‹		ä¸€èˆ¬æ¥è¯´ï¼Œéœ€è¦åˆ›å»ºä¿å¯†ï¼ˆ`closed`ï¼‰å½±å­ `DOM` çš„åœºæ™¯å¾ˆå°‘ã€‚è™½ç„¶è¿™æ ·å¯ä»¥é™åˆ¶é€šè¿‡å½±å­å®¿ä¸»è®¿é—®å½±å­ `DOM`ï¼Œä½†æ¶æ„ä»£ç æœ‰å¾ˆå¤šæ–¹æ³•ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ¢å¤å¯¹å½±å­ `DOM` çš„è®¿é—®ã€‚ç®€è¨€ä¹‹ï¼Œä¸èƒ½ä¸ºäº†å®‰å…¨è€Œåˆ›å»ºä¿å¯†å½±å­ `DOM`ã€‚

â€‹		æ³¨æ„ï¼šå¦‚æœæƒ³ä¿æŠ¤ç‹¬ç«‹çš„ `DOM` æ ‘ä¸å—æœªä¿¡ä»»ä»£ç å½±å“ï¼Œå½±å­ `DOM` å¹¶ä¸é€‚åˆè¿™ä¸ªéœ€æ±‚ã€‚å¯¹ `<iframe>` æ–½åŠ çš„è·¨æºé™åˆ¶ä¼šæ›´å¯é ã€‚

##### ä½¿ç”¨å½±å­ `DOM`

â€‹		æŠŠå½±å­ `DOM` æ·»åŠ åˆ°å…ƒç´ ä¹‹åï¼Œå¯ä»¥åƒä½¿ç”¨å¸¸è§„ `DOM` ä¸€æ ·ä½¿ç”¨å½±å­ `DOM`ã€‚

â€‹		æ¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œè¿™é‡Œé‡æ–°åˆ›å»ºäº†å‰é¢çº¢ / ç»¿ / è“å­æ ‘çš„ç¤ºä¾‹ï¼š

```js
for (let color of ['red', 'green', 'blue']) { 
 	const div = document.createElement('div'); 
 	const shadowDOM = div.attachShadow({ mode: 'open' }); 
    
 	document.body.appendChild(div); 
 	shadowDOM.innerHTML = ` 
 		<p>Make me ${color}</p> 
 		<style> 
 			p { 
 				color: ${color}; 
 			} 
 		</style> 
 	`; 
}
```

â€‹		è™½ç„¶è¿™é‡Œä½¿ç”¨ç›¸åŒçš„é€‰æ‹©ç¬¦åº”ç”¨äº† 3 ç§ä¸åŒçš„é¢œè‰²ï¼Œä½†æ¯ä¸ªé€‰æ‹©ç¬¦åªä¼šæŠŠæ ·å¼åº”ç”¨åˆ°å®ƒä»¬æ‰€åœ¨çš„å½±å­ `DOM` ä¸Šã€‚ä¸ºæ­¤ï¼Œ3 ä¸ª `<p>` å…ƒç´ ä¼šå‡ºç° 3 ç§ä¸åŒçš„é¢œè‰²ã€‚

â€‹		å¯ä»¥è¿™æ ·éªŒè¯è¿™äº›å…ƒç´ åˆ†åˆ«ä½äºå®ƒä»¬è‡ªå·±çš„å½±å­ `DOM` ä¸­ï¼š

```js
for (let color of ['red', 'green', 'blue']) { 
 	const div = document.createElement('div'); 
 	const shadowDOM = div.attachShadow({ mode: 'open' }); 
    
 	document.body.appendChild(div); 
 	shadowDOM.innerHTML = ` 
		<p>Make me ${color}</p>
 		<style> 
 			p { 
				color: ${color}; 
 			} 
 		</style> 
 	`; 
} 

function countP(node) { 
 	console.log(node.querySelectorAll('p').length); 
}

countP(document); // 0 

for (let element of document.querySelectorAll('div')) { 
 	countP(element.shadowRoot); 
} 
// 1 
// 1 
// 1
```

â€‹		åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­å¯ä»¥æ›´æ¸…æ¥šåœ°çœ‹åˆ°å½±å­ `DOM`ã€‚ä¾‹å¦‚ï¼Œå‰é¢çš„ä¾‹å­åœ¨æµè§ˆå™¨æ£€æŸ¥çª—å£ä¸­ä¼šæ˜¾ç¤ºæˆè¿™æ ·ï¼š

```html
<body> 
	<div> 
        #shadow-root (open) 
            <p>Make me red!</p>
            <style> p { color: red; } </style> 
	</div> 
	<div> 
        #shadow-root (open) 
            <p>Make me green!</p>
            <style> p { color: green; } </style>
    </div> 
	<div> 
        #shadow-root (open) 
            <p>Make me blue!</p>
            <style> p { color: blue; } </style> 
	</div> 
</body>
```

â€‹		å½±å­ `DOM` å¹¶éé“æ¿ä¸€å—ã€‚`HTML` å…ƒç´ å¯ä»¥åœ¨ `DOM` æ ‘ï¼ˆåŒ…æ‹¬å½±å­ `DOM`ï¼‰ä¸­æ— é™åˆ¶åœ°ç§»åŠ¨ï¼š

```html
<!-- åˆå§‹é¡µé¢ -->
<div></div> 
<p id="foo">Move me</p> 
```

```js
const divElement = document.querySelector('div'); 
const pElement = document.querySelector('p'); 

const shadowDOM = divElement.attachShadow({ mode: 'open' }); 

// ä»çˆ¶ DOM ä¸­ç§»é™¤å…ƒç´ 
divElement.parentElement.removeChild(pElement); 

// æŠŠå…ƒç´ æ·»åŠ åˆ°å½±å­ DOM 
shadowDOM.appendChild(pElement); 

// æ£€æŸ¥å…ƒç´ æ˜¯å¦ç§»åŠ¨åˆ°äº†å½±å­ DOM ä¸­
console.log(shadowDOM.innerHTML); // <p id="foo">Move me</p>
```

```html
<!-- æœ€ç»ˆé¡µé¢ -->
<div>
	#shadow-root (open) 
    	<p id="foo">Move me</p>
</div> 
```

##### åˆæˆä¸å½±å­ `DOM` æ§½ä½

â€‹		å½±å­ `DOM` æ˜¯ä¸ºè‡ªå®šä¹‰ `Web` ç»„ä»¶è®¾è®¡çš„ï¼Œä¸ºæ­¤éœ€è¦æ”¯æŒåµŒå¥— `DOM` ç‰‡æ®µã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œå¯ä»¥è¿™ä¹ˆè¯´ï¼šä½äºå½±å­å®¿ä¸»ä¸­çš„ `HTML` éœ€è¦ä¸€ç§æœºåˆ¶ä»¥æ¸²æŸ“åˆ°å½±å­ `DOM` ä¸­å»ï¼Œä½†è¿™äº› `HTML` åˆä¸å¿…å±äºå½±å­ `DOM` æ ‘ã€‚å¦å¤–ï¼Œä¸ `shadow DOM` ç›¸å¯¹çš„æ˜¯ `light DOM`ã€‚

â€‹		é»˜è®¤æƒ…å†µä¸‹ï¼Œå½±å­å®¿ä¸»ä¸­çš„éå½±å­ `DOM` å†…å®¹ä¼šè¢«éšè—ï¼ˆå¹¶éåˆ é™¤ï¼‰ã€‚æ¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå…¶ä¸­çš„æ–‡æœ¬åœ¨ 1000 æ¯«ç§’åä¼šè¢«éšè—ï¼š

```html
<!-- æœ€åˆé¡µé¢ -->
<div> 
    <p>Foo</p>
</div>
```

```js
setTimeout(() => document.querySelector('div').attachShadow({ mode: 'open' }), 1000);
```

```html
<!-- æœ€ç»ˆé¡µé¢ -->
<div> 
    #shadow-root (open) 
    <p>Foo</p> <!-- äºŒè€…åŒçº§ï¼Œä½†è¯¥å…ƒç´ è¢«é»˜è®¤éšè— -->
</div>
```

â€‹		å½±å­ `DOM` ä¸€æ·»åŠ åˆ°å…ƒç´ ä¸­ï¼Œæµè§ˆå™¨å°±ä¼šèµ‹äºˆå®ƒæœ€é«˜ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆæ¸²æŸ“å®ƒçš„å†…å®¹è€Œä¸æ˜¯åŸæ¥çš„æ–‡æœ¬ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”±äºå½±å­ `DOM` æ˜¯ç©ºçš„ï¼Œå› æ­¤ `<div>` ä¼šåœ¨ 1000 æ¯«ç§’åå°†æ²¡æœ‰ä»»ä½•å¯æ˜¾ç¤ºçš„å†…å®¹ã€‚

â€‹		ä¸ºäº†æ˜¾ç¤ºæ–‡æœ¬å†…å®¹ï¼Œéœ€è¦ä½¿ç”¨ `<slot>` æ ‡ç­¾æŒ‡ç¤ºæµè§ˆå™¨åœ¨å“ªé‡Œæ”¾ç½®åŸæ¥çš„ `HTML`ã€‚ä¸‹é¢çš„ä»£ç ä¿®æ”¹äº†å‰é¢çš„ä¾‹å­ï¼Œè®©å½±å­å®¿ä¸»ä¸­çš„æ–‡æœ¬å‡ºç°åœ¨äº†å½±å­ `DOM` ä¸­ï¼š

```js
document.body.innerHTML = ` 
	<div id="foo"> 
		<p>Foo</p>
	</div>
`;

document.querySelector('div').attachShadow({ mode: 'open' }).innerHTML = `
    <div id="bar"> 
        <slot></slot> 
    <div>
`;
```

â€‹		ç°åœ¨ï¼ŒæŠ•å°„è¿›å»çš„å†…å®¹å°±åƒè‡ªå·±å­˜åœ¨äºå½±å­ `DOM` ä¸­ä¸€æ ·ã€‚äºæ˜¯ï¼Œåº”å‘ˆç°çš„ `DOM` å†…å®¹å¦‚ä¸‹ï¼š

```html
<body> 
	<div id="foo"> 
 		#shadow-root (open) 
 			<div id="bar"> 
				<p>Foo</p> 
 			</div> 
	</div> 
</body>
```

â€‹		ä½†è¿™å¹¶ä¸æ˜¯å®é™…çš„ `DOM` ç»“æ„ï¼Œå½±å­ `DOM` ä¸­çš„ `<p>` å®é™…ä¸Šåªæ˜¯ä¸€ä¸ªæŠ•å°„ï¼ˆ`projection`ï¼‰ã€‚å®é™…çš„ `<p>` ä»å¤„äºå¤–éƒ¨çš„ `DOM` ä¸­ï¼š

```js
document.body.innerHTML = ` 
	<div id="foo"> 
 		<p>Foo</p> 
	</div> 
`; 

document.querySelector('div').attachShadow({ mode: 'open' }).innerHTML = ` 
 	<div id="bar"> 
 		<slot></slot> 
 	</div>
`; 

console.log(document.querySelector('p').parentElement); // <div id="foo">â€¦</div>
```

â€‹		å®é™…çš„ `DOM` æ˜¯è¿™æ ·çš„ï¼š`<p>` å¤„äº `<div id="foo">` ä¸­ï¼Œä¸ `#shadow-root (open)` æ˜¯åŒçº§ã€‚æµè§ˆå™¨åªæ˜¯å°† `<p>` å…ƒç´ æ˜¾ç¤ºåœ¨ `<div id="bar">` çš„ `<slot>` æ’æ§½ä¸­ï¼Œå¹¶ä¸æ˜¯çœŸçš„å°†å®ƒç§»å…¥æ’æ§½äº†ã€‚ã€`reveal`ï¼šæ˜¾ç¤ºã€‘

â€‹                                                     ![image-20230328172636304](images/JS%20API/image-20230328172636304.png) 

â€‹		ä¸‹é¢æ˜¯ä½¿ç”¨æ§½ä½ï¼ˆ`slot`ï¼‰æ”¹å†™çš„å‰é¢çº¢ / ç»¿ / è“å­æ ‘çš„ä¾‹å­ï¼Œæ–‡æœ¬èŠ‚ç‚¹å°†è¢«æŠ•å°„åˆ°æ’æ§½ä¸­ï¼š

```js
for (let color of ['red', 'green', 'blue']) { 
 	const divElement = document.createElement('div'); 
 	divElement.innerText = `Make me ${color}`; 
 	document.body.appendChild(divElement); 
    
 	divElement.attachShadow({ mode: 'open' }).innerHTML = ` 
 		<p><slot></slot></p> 
 		<style> 
     		p { 
 				color: ${color}; 
 			} 
 		</style> 
 	`; 
}
```

â€‹		é™¤äº†é»˜è®¤æ§½ä½ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å‘½åæ§½ä½ / å…·åæ’æ§½ï¼ˆ`named slot`ï¼‰å®ç°å¤šä¸ªæŠ•å°„ã€‚è¿™æ˜¯é€šè¿‡åŒ¹é…çš„ `slot/name` å±æ€§å¯¹å®ç°çš„ã€‚å¸¦æœ‰ `slot="foo"` å±æ€§çš„å…ƒç´ ä¼šè¢«æŠ•å°„åˆ°å¸¦æœ‰ `name="foo"` çš„ `<slot>` ä¸Šã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•æ”¹å˜å½±å­å®¿ä¸»å­å…ƒç´ çš„æ¸²æŸ“é¡ºåºï¼š

```js
document.body.innerHTML = ` 
	<div> 
 		<p slot="foo">Foo</p> 
 		<p slot="bar">Bar</p> 
	</div> 
`; 

document.querySelector('div').attachShadow({ mode: 'open' }).innerHTML = ` 
 	<slot name="bar"></slot> 
 	<slot name="foo"></slot> 
`; 

/* é¡µé¢æ˜¾ç¤ºï¼š 
	Bar 
	Foo
*/
```

##### äº‹ä»¶é‡å®šå‘

â€‹		å¦‚æœå½±å­ `DOM` ä¸­å‘ç”Ÿäº†æµè§ˆå™¨äº‹ä»¶ï¼ˆå¦‚ï¼š`click`ï¼‰ï¼Œé‚£ä¹ˆæµè§ˆå™¨éœ€è¦ä¸€ç§æ–¹å¼ä»¥è®©çˆ¶ `DOM` å¤„ç†äº‹ä»¶ã€‚ä¸è¿‡ï¼Œå®ç°ä¹Ÿå¿…é¡»è€ƒè™‘å½±å­ `DOM` çš„è¾¹ç•Œï¼ˆå³ï¼šå½±å­å®¿ä¸»ï¼‰ã€‚ä¸ºæ­¤ï¼Œäº‹ä»¶ä¼šé€ƒå‡ºå½±å­ `DOM` å¹¶ç»è¿‡äº‹ä»¶é‡å®šå‘ï¼ˆ`event retarget`ï¼‰åœ¨å¤–éƒ¨è¢«å¤„ç†ã€‚é€ƒå‡ºåï¼Œäº‹ä»¶å°±å¥½åƒæ˜¯ç”±å½±å­å®¿ä¸»æœ¬èº«è€ŒéçœŸæ­£çš„åŒ…è£…å…ƒç´ è§¦å‘çš„ä¸€æ ·ã€‚ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹ï¼š

```js
// åˆ›å»ºä¸€ä¸ªå…ƒç´ ä½œä¸ºå½±å­å®¿ä¸»
document.body.innerHTML = `
	<div onclick="console.log(event.target.tagName, event.currentTarget.tagName, 1)"></div> 
`;

// æ·»åŠ å½±å­ DOM å¹¶å‘å…¶ä¸­æ’å…¥ HTML 
document.querySelector('div').attachShadow({ mode: 'open' }).innerHTML = ` 
	<p onclick="console.log(event.target.tagName, event.currentTarget.tagName, 2)">
		<button onclick="console.log(event.target.tagName, event.currentTarget.tagName, 3)">Foo</button>
	</p>
`;

// è¾¹ç•Œæµ‹è¯•
document.onclick = (e) => {
    console.log(e.target.tagName, e.currentTarget, 0);
};

/* ç‚¹å‡»æŒ‰é’®æ—¶ï¼š
> BUTTON BUTTON 3
> BUTTON P 		2
> DIV DIV 		1
> DIV #document 0
*/
```

â€‹		æ³¨æ„ï¼Œäº‹ä»¶é‡å®šå‘ï¼ˆå³ï¼šé‡æ–°æŒ‡å®šäº‹ä»¶ç›®æ ‡ï¼‰åªä¼šå‘ç”Ÿåœ¨å½±å­ `DOM` ä¸­å®é™…å­˜åœ¨çš„å…ƒç´ ä¸Šã€‚ä½¿ç”¨ `<slot>` æ ‡ç­¾ä»å¤–éƒ¨æŠ•å°„è¿›æ¥çš„å…ƒç´ ä¸ä¼šå‘ç”Ÿäº‹ä»¶é‡å®šå‘ï¼Œå› ä¸ºä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™äº›å…ƒç´ ä»ç„¶å­˜åœ¨äºå½±å­ `DOM` å¤–éƒ¨ã€‚

```js
// åˆ›å»ºä¸€ä¸ªå…ƒç´ ä½œä¸ºå½±å­å®¿ä¸»
document.body.innerHTML = ` 
	<div onclick="console.log(event.target.tagName, event.currentTarget.tagName, 1)">
		<button onclick="console.log(event.target.tagName, event.currentTarget.tagName, 3)">Foo</button>
	</div> 
`;

// æ·»åŠ å½±å­ DOM å¹¶å‘å…¶ä¸­æ’å…¥ HTML 
document.querySelector('div').attachShadow({ mode: 'open' }).innerHTML = ` 
	<p onclick="console.log(event.target.tagName, event.currentTarget.tagName, 2)">
		<slot></slot>
	</p>
`;

// è¾¹ç•Œæµ‹è¯•
document.onclick = (e) => {
    console.log(e.target.tagName, e.currentTarget, 0);
};

/* ç‚¹å‡»æŒ‰é’®æ—¶ï¼š
> BUTTON BUTTON 	3
> BUTTON P 			2
> BUTTON DIV 		1
> BUTTON #document 	0
*/
```

â€‹		å†çœ‹ä¸€ä¸ªä¾‹å­ï¼š`<b>` æ˜¯å®é™…å­˜åœ¨äºå½±å­ `DOM` ä¸­çš„å…ƒç´ ï¼ˆå‘ç”Ÿé‡å®šå‘ï¼‰ï¼Œ`<button>` åˆ™æ˜¯ä»å¤–éƒ¨æŠ•å°„è¿›æ¥çš„å…ƒç´ ï¼ˆæœªè¢«é‡å®šå‘ï¼‰ã€‚

```js
// åˆ›å»ºä¸€ä¸ªå…ƒç´ ä½œä¸ºå½±å­å®¿ä¸»
document.body.innerHTML = `
	<div onclick="console.log(event.target.tagName, event.currentTarget.tagName, 1)">
		<button>John Smith</button>    
	</div> 
`;

// æ·»åŠ å½±å­ DOM å¹¶å‘å…¶ä¸­æ’å…¥ HTML 
let shadow = document.querySelector('div').attachShadow({ mode: 'open' });

shadow.innerHTML = ` 
	<p>
		<b>Name:</b> <slot></slot>
	</p>
`;

// ç»™<p>å…ƒç´ æ·»åŠ clickå¤„ç†ç¨‹åºï¼Œç›´æ¥åœ¨å…ƒç´ ä¸Šæ·»åŠ ä¼šæŠ¥é”™ã€‚
shadow.firstElementChild.onclick = e => console.log(e.target.tagName, e.currentTarget.tagName, 2);

// è¾¹ç•Œæµ‹è¯•
document.onclick = (e) => {
    console.log(e.target.tagName, e.currentTarget, 0);
};

/*
ç‚¹å‡»ï¼šbutton
> BUTTON P 			2
> BUTTON DIV 		1
> BUTTON #document 	0

ç‚¹å‡»ï¼šb
> B   P 		2
> DIV DIV 		1
> DIV #document 0
*/
```

##### äº‹ä»¶å†’æ³¡

â€‹		å‡ºäºäº‹ä»¶å†’æ³¡çš„ç›®çš„ï¼Œä½¿ç”¨æ‰å¹³ `DOM`ï¼ˆ`flattened DOM`ï¼‰ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ª `<slot>` å…ƒç´ ï¼Œå¹¶ä¸”äº‹ä»¶å‘ç”Ÿåœ¨å®ƒçš„å†…éƒ¨æŸä¸ªåœ°æ–¹ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå†’æ³¡åˆ° `<slot>` å¹¶ç»§ç»­å‘ä¸Šã€‚

â€‹		ä½¿ç”¨ `event.composedPath()` è·å¾—åŸå§‹äº‹ä»¶ç›®æ ‡çš„å®Œæ•´è·¯å¾„ä»¥åŠæ‰€æœ‰ `shadow` å…ƒç´ ã€‚æ­£å¦‚æˆ‘ä»¬ä»æ–¹æ³•åç§°ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œè¯¥è·¯å¾„æ˜¯åœ¨ç»„åˆï¼ˆ`composition`ï¼‰ä¹‹åè·å–çš„ã€‚

```js
document.body.innerHTML = `
	<div>
		<button onclick="console.log(event.composedPath())">è·å–ç›®æ ‡å…ƒç´ é“¾</button>    
	</div> 
`;

document.querySelector('div').attachShadow({ mode: 'open' }).innerHTML = ` 
	<p>
		<b>Name:</b> <slot></slot>
	</p>
`;

// [button, slot, p, document-fragment, div, body, html, document, Window]
```

â€‹		å› æ­¤ï¼Œç‚¹å‡»æŒ‰é’®è°ƒç”¨ `event.composedPath()` åè¿”å›ä¸€ä¸ªæ•°ç»„ï¼š`[button, slot, p, document-fragment, div, body, html, document, Window]`ã€‚åœ¨ç»„åˆä¹‹åï¼Œè¿™æ­£æ˜¯æ‰å¹³ `DOM` ä¸­çš„ç›®æ ‡å…ƒç´ é“¾ã€‚

â€‹		`Shadow` æ ‘è¯¦ç»†ä¿¡æ¯ä»…æä¾›ç»™ `{mode:'open'}` æ ‘ã€‚å¦‚æœ `shadow` æ ‘æ˜¯ç”¨ `{mode: 'closed'}` åˆ›å»ºçš„ï¼Œé‚£ä¹ˆç»„åˆè·¯å¾„å°±ä» `host` å¼€å§‹ï¼šå½±å­å®¿ä¸»åŠå…¶æ›´ä¸Šå±‚ã€‚è¿™ä¸ä½¿ç”¨ `shadow DOM` çš„å…¶ä»–æ–¹æ³•çš„åŸç†ç±»ä¼¼ã€‚`closed` æ ‘å†…éƒ¨æ˜¯å®Œå…¨éšè—çš„ã€‚

â€‹		å¤§å¤šæ•°äº‹ä»¶èƒ½æˆåŠŸå†’æ³¡åˆ° `shadow DOM` è¾¹ç•Œã€‚å¾ˆå°‘æœ‰äº‹ä»¶ä¸èƒ½å†’æ³¡åˆ° `shadow DOM` è¾¹ç•Œã€‚è¿™ç”± `composed` äº‹ä»¶å¯¹è±¡å±æ€§ï¼ˆå®ƒä¹‹å‰å« `scoped`ï¼‰æ§åˆ¶ã€‚å¦‚æœ `composed` æ˜¯ `true`ï¼Œé‚£ä¹ˆäº‹ä»¶å°±èƒ½ç©¿è¿‡è¾¹ç•Œã€‚å¦åˆ™å®ƒä»…èƒ½åœ¨ `shadow DOM` å†…éƒ¨æ•è·ã€‚

â€‹		å¦‚æœä½ æµè§ˆä¸€ä¸‹ [`UI` äº‹ä»¶è§„èŒƒ](https://www.w3.org/TR/uievents) å°±çŸ¥é“ï¼Œå¤§éƒ¨åˆ†äº‹ä»¶çš„ `event.composed` éƒ½æ˜¯ `true`ï¼š

- `blur`ï¼Œ`focus`ï¼Œ`focusin`ï¼Œ`focusout`ï¼›
- `click`ï¼Œ`dblclick`ï¼›
- `mousedown`ï¼Œ`mouseup` `mousemove`ï¼Œ`mouseout`ï¼Œ`mouseover`ï¼›
- `wheel`ï¼›
- `beforeinput`ï¼Œ`input`ï¼Œ`keydown`ï¼Œ`keyup`ã€‚

â€‹		æ‰€æœ‰è§¦æ‘¸äº‹ä»¶ï¼ˆ`touch events`ï¼‰åŠæŒ‡é’ˆäº‹ä»¶ï¼ˆ`pointer events`ï¼‰çš„ `event.composed` éƒ½æ˜¯ `true`ã€‚

â€‹		ä½†ä¹Ÿæœ‰äº›äº‹ä»¶çš„ `event.composed` æ˜¯ `false`ï¼š

- `mouseenter`ï¼Œ`mouseleave`ï¼ˆå®ƒä»¬æ ¹æœ¬ä¸ä¼šå†’æ³¡ï¼‰ï¼›ã€`Chrome`ä¸­ä¸º `true`ï¼Œ`Firefox` ä¸­ä¸º `false`ã€‘
- `load`ï¼Œ`unload`ï¼Œ`abort`ï¼Œ`error`ï¼›
- `select`ï¼›
- `slotchange`ã€‚

â€‹		è¿™äº›äº‹ä»¶ä»…èƒ½åœ¨äº‹ä»¶ç›®æ ‡æ‰€åœ¨çš„åŒä¸€ `DOM` ä¸­çš„å…ƒç´ ä¸Šæ•è·ã€‚

##### è‡ªå®šä¹‰äº‹ä»¶

â€‹		å½“æˆ‘ä»¬å‘é€ï¼ˆ`dispatch`ï¼‰è‡ªå®šä¹‰äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½® `bubbles` å’Œ `composed` å±æ€§éƒ½ä¸º `true` ä»¥ä½¿å…¶å†’æ³¡å¹¶ä»ç»„ä»¶ä¸­å†’æ³¡å‡ºæ¥ã€‚

â€‹		ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ `div#outer` å½±å­ `DOM` å†…éƒ¨åˆ›å»ºä¸€ä¸ª `div` å¹¶åœ¨å…¶ä¸Šè§¦å‘ä¸¤ä¸ªäº‹ä»¶ï¼Œåˆ™åªæœ‰ `composed: true` çš„é‚£ä¸ªè‡ªå®šä¹‰äº‹ä»¶æ‰ä¼šè®©è¯¥äº‹ä»¶æœ¬èº«å†’æ³¡åˆ°æ–‡æ¡£å¤–é¢ï¼š

```html
<div id="outer"></div>
<script>
    // è„šæœ¬ä¼šè‡ªåŠ¨è·å–è®¾ç½®äº†IDå±æ€§çš„æ‰€æœ‰å…ƒç´ ã€‚
    outer.attachShadow({ mode: 'open' });
    let inner = document.createElement('div');
    outer.shadowRoot.append(inner);

    document.addEventListener('test', event => console.log(event.detail));

    inner.dispatchEvent(new CustomEvent('test', {
        bubbles: true,
        composed: true,
        detail: "composed"
    }));

    inner.dispatchEvent(new CustomEvent('test', {
        bubbles: true,
        composed: false,
        detail: "not composed"
    }));
</script>
```

â€‹		äº‹ä»¶ä»…ä»…æ˜¯åœ¨å®ƒä»¬çš„ `composed` æ ‡å¿—è®¾ç½®ä¸º `true` çš„æ—¶å€™æ‰èƒ½é€šè¿‡ `shadow DOM` è¾¹ç•Œã€‚å¦‚æœè¦å‘é€ä¸€ä¸ª `CustomEvent`ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ˜¾å¼åœ°è®¾ç½® `composed: true`ã€‚

â€‹		è¯·æ³¨æ„ï¼Œå¦‚æœæ˜¯åµŒå¥—ç»„ä»¶ï¼Œåˆ™ä¸€ä¸ª `shadow DOM` å¯èƒ½åµŒå¥—åœ¨å¦å¤–ä¸€ä¸ª `shadow DOM` ä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹åˆæˆäº‹ä»¶å†’æ³¡åˆ°æ‰€æœ‰ `shadow DOM` è¾¹ç•Œã€å­˜ç–‘ã€‘ï¼Œ`composed` ä¸º `true` çš„æ™®é€šäº‹ä»¶ç›´æ¥å†’æ³¡åˆ°é¡¶å±‚ `shadow DOM` è¾¹ç•Œã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªäº‹ä»¶ä»…ç”¨äºç›´æ¥å°é—­ç»„ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ `shadow host` ä¸Šå‘é€å®ƒå¹¶è®¾ç½® `composed: false`ã€‚è¿™æ ·å®ƒå°±ä¸åœ¨ç»„ä»¶ `shadow DOM` ä¸­ï¼Œä¹Ÿä¸ä¼šå†’æ³¡åˆ°æ›´é«˜çº§åˆ«çš„ `DOM`ã€‚

```html
<div id="outer"></div>
<script>
outer.attachShadow({ mode: 'open' }).innerHTML = `<div id="inner"></div>`;

let inner = outer.shadowRoot.firstElementChild;

inner.attachShadow({ mode: 'open' }).innerHTML = `<div></div>`;

inner.addEventListener('test', event => console.log(event.detail, event.target, 'inner'));
document.addEventListener('test', event => console.log(event.detail, event.target, 'document'));

inner.dispatchEvent(new CustomEvent('test', {
	bubbles: true,
    composed: true,
    detail: "composed"
}));

// å°é—­ç»„ä»¶
inner.dispatchEvent(new CustomEvent('test', {
	bubbles: true,
    composed: false,
    detail: "not composed"
}));
    
/*
> composed <div id="inner">â€¦</div> inner
> composed <div id="outer">â€¦</div> document
> not composed <div id="inner">â€¦</div> inner
*/
</script>
```



#### è‡ªå®šä¹‰å…ƒç´ 

â€‹		å¦‚æœä½ ä½¿ç”¨ `JavaScript` æ¡†æ¶ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ç†Ÿæ‚‰è‡ªå®šä¹‰å…ƒç´ çš„æ¦‚å¿µã€‚è¿™æ˜¯å› ä¸ºæ‰€æœ‰ä¸»æµæ¡†æ¶éƒ½ä»¥æŸç§å½¢å¼æä¾›äº†è¿™ä¸ªç‰¹æ€§ã€‚è‡ªå®šä¹‰å…ƒç´ ä¸º `HTML` å…ƒç´ å¼•å…¥äº†é¢å‘å¯¹è±¡ç¼–ç¨‹çš„é£æ ¼ã€‚åŸºäºè¿™ç§é£æ ¼ï¼Œå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„ã€å¤æ‚çš„å’Œå¯é‡ç”¨çš„å…ƒç´ ï¼Œè€Œä¸”åªè¦ä½¿ç”¨ç®€å•çš„ `HTML` æ ‡ç­¾æˆ–å±æ€§å°±å¯ä»¥åˆ›å»ºç›¸åº”çš„å®ä¾‹ã€‚

##### åˆ›å»ºè‡ªå®šä¹‰å…ƒç´ 

â€‹		æµè§ˆå™¨ä¼šå°è¯•å°†æ— æ³•è¯†åˆ«çš„å…ƒç´ ä½œä¸ºé€šç”¨å…ƒç´ æ•´åˆè¿› `DOM`ã€‚å½“ç„¶ï¼Œè¿™äº›å…ƒç´ é»˜è®¤ä¹Ÿä¸ä¼šåšä»»ä½•é€šç”¨ `HTML` å…ƒç´ ä¸èƒ½åšçš„äº‹ã€‚æ¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå…¶ä¸­èƒ¡ä¹±ç¼–é€ çš„ `<x-foo >` æ ‡ç­¾ä¼šå˜æˆä¸€ä¸ª `HTMLElement` å®ä¾‹ï¼š

```js
document.body.innerHTML = `<x-foo >I'm inside a nonsense element.</x-foo >`; 

console.log(document.querySelector('x-foo') instanceof HTMLElement); // true
```

â€‹		è‡ªå®šä¹‰å…ƒç´ åœ¨æ­¤åŸºç¡€ä¸Šæ›´è¿›ä¸€æ­¥ã€‚åˆ©ç”¨è‡ªå®šä¹‰å…ƒç´ ï¼Œå¯ä»¥åœ¨ `<x-foo>` æ ‡ç­¾å‡ºç°æ—¶ä¸ºå®ƒå®šä¹‰å¤æ‚çš„è¡Œä¸ºï¼ŒåŒæ ·ä¹Ÿå¯ä»¥åœ¨ `DOM` ä¸­å°†å…¶çº³å…¥å…ƒç´ ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚è‡ªå®šä¹‰å…ƒç´ è¦ä½¿ç”¨å…¨å±€å±æ€§ `customElements`ï¼Œè¿™ä¸ªå±æ€§ä¼šè¿”å› `CustomElementRegistry` çš„å®ä¾‹ã€‚

```js
console.log(customElements); // CustomElementRegistryÂ {}

/*
CustomElementRegistryÂ {
	[[Prototype]]: CustomElementRegistry {
		define: Æ’ define(),
		get: Æ’ (),
		upgrade: Æ’ upgrade(),
		whenDefined: Æ’ whenDefined(),
		constructor: Æ’ CustomElementRegistry(),
		Symbol(Symbol.toStringTag): "CustomElementRegistry",
		[[Prototype]]: Object
	}
}
*/
```

â€‹		è°ƒç”¨ `customElements.define()` æ–¹æ³•å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰å…ƒç´ ã€‚ä¸‹é¢åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰å…ƒç´ ï¼Œè¯¥å…ƒç´ ç»§æ‰¿è‡ª `HTMLElement`ï¼š

```js
class FooElement extends HTMLElement {} 
customElements.define('x-foo', FooElement); // é€šå¸¸ä¼ å…¥HTMLElementçš„å­ç±»

document.body.innerHTML = `<x-foo >I'm inside a nonsense element.</x-foo >`; 

console.log(document.querySelector('x-foo') instanceof FooElement); // true
```

â€‹		æ³¨æ„ï¼šè‡ªå®šä¹‰å…ƒç´ åå¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªè¿å­—ç¬¦ï¼ˆä¸å¯åœ¨é¦–å’Œå°¾ï¼‰ã€‚è¿‡å»ï¼Œå…ƒç´ æ ‡ç­¾ä¸èƒ½è‡ªå…³é—­ï¼Œç°åœ¨ä¼šåœ¨ `</body>` å‰é¢è‡ªåŠ¨é—­åˆã€‚

â€‹		è‡ªå®šä¹‰å…ƒç´ çš„å¨åŠ›æºè‡ªç±»å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨è‡ªå®šä¹‰å…ƒç´ çš„æ„é€ å‡½æ•°æ¥æ§åˆ¶è¿™ä¸ªç±»åœ¨ `DOM` ä¸­æ¯ä¸ªå®ä¾‹çš„è¡Œä¸ºï¼š

```js
class FooElement extends HTMLElement { 
 	constructor() { 
 		super(); // é‡å†™constructorï¼Œå°±å¿…é¡»å…ˆè°ƒç”¨super()ã€‚è‹¥ä¸é‡å†™ï¼Œåˆ™ä¸å¿…è¦ã€‚
 		console.log('x-foo') 
 	} 
} 

customElements.define('x-foo', FooElement); 

document.body.innerHTML = ` 
    <x-foo></x-foo> 
    <x-foo></x-foo> 
    <x-foo></x-foo> 
`;

// x-foo 
// x-foo 
// x-foo
```

â€‹		æ³¨æ„ï¼šåœ¨è‡ªå®šä¹‰å…ƒç´ çš„æ„é€ å‡½æ•°ä¸­å¿…é¡»å§‹ç»ˆå…ˆè°ƒç”¨ `super()`ã€‚å¦‚æœå…ƒç´ ç»§æ‰¿äº† `HTMLElement` æˆ–ç›¸ä¼¼ç±»å‹è€Œä¸ä¼šè¦†ç›–æ„é€ å‡½æ•°ï¼Œåˆ™æ²¡æœ‰å¿…è¦è°ƒç”¨ `super()`ï¼Œå› ä¸ºåŸå‹æ„é€ å‡½æ•°é»˜è®¤ä¼šåšè¿™ä»¶äº‹ã€‚å¾ˆå°‘æœ‰åˆ›å»ºè‡ªå®šä¹‰å…ƒç´ è€Œä¸ç»§æ‰¿ `HTMLElement` çš„ã€‚

â€‹		å¦‚æœè‡ªå®šä¹‰å…ƒç´ ç»§æ‰¿äº†ä¸€ä¸ªå…·ä½“çš„å…ƒç´ ç±»ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ `is` å±æ€§å’Œ `extends` é€‰é¡¹å°†æ ‡ç­¾æŒ‡å®šä¸ºè¯¥è‡ªå®šä¹‰å…ƒç´ çš„å®ä¾‹ï¼š

```js
class FooElement extends HTMLDivElement {
	constructor() {
		super();
        console.log('x-foo');
    }
}

customElements.define('x-foo', FooElement, { extends: 'div' });

document.body.innerHTML = ` 
	<div is="x-foo" id='xf1'></div> 
	<div is="x-woo" id='xf2'></div> 
	<nav is="x-foo" id='xf3'></nav> 
`;

console.log(xf1 instanceof FooElement);
console.log(xf2 instanceof FooElement);
console.log(xf3 instanceof FooElement);

/*
> x-foo
> true
> false
> false
*/
```

##### æ·»åŠ  `Web` ç»„ä»¶å†…å®¹

â€‹		å› ä¸ºæ¯æ¬¡å°†è‡ªå®šä¹‰å…ƒç´ æ·»åŠ åˆ° `DOM` ä¸­éƒ½ä¼šè°ƒç”¨å…¶ç±»æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è‡ªåŠ¨ç»™è‡ªå®šä¹‰å…ƒç´ æ·»åŠ å­ `DOM` å†…å®¹ã€‚è¿‡å»ï¼Œä¸èƒ½ç›´æ¥åœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ å­ `DOM`ï¼ˆä¼šæŠ›å‡º `DOMException`ï¼‰ï¼Œä½†å¯ä»¥ä¸ºè‡ªå®šä¹‰å…ƒç´ æ·»åŠ å½±å­ `DOM` å¹¶å°†å†…å®¹æ·»åŠ åˆ°è¿™ä¸ªå½±å­ `DOM` ä¸­ï¼š

```js
class FooElement extends HTMLElement { 
 	constructor() { 
 		super(); 
 		// this å¼•ç”¨ Web ç»„ä»¶èŠ‚ç‚¹ï¼ˆå³è‡ªå®šä¹‰å…ƒç´ ï¼‰
 		this.attachShadow({ mode: 'open' }); 
 		this.shadowRoot.innerHTML = `<p>I'm inside a custom element!</p>`; 
 	} 
} 

customElements.define('x-foo', FooElement); 

document.body.innerHTML = `<x-foo></x-foo`; 
```

```html
<x-foo> 
	#shadow-root (open) 
		<p>I'm inside a custom element!</p> 
<x-foo> 
```

â€‹		ç°åœ¨ï¼Œå¯ä»¥ç›´æ¥ä¸ºè‡ªå®šä¹‰å…ƒç´ å†™å…¥å­ `DOM` äº†ã€‚

```js
class FooElement extends HTMLElement {
	constructor() {
		super();
		this.innerHTML = `<p>I'm inside a custom element!</p>`;
	}
}

customElements.define('x-foo', FooElement);

document.body.innerHTML = `<x-foo></x-foo`; 
```

```html
<x-foo>
	<p>I'm inside a custom element!</p> 
<x-foo> 
```

â€‹		ä¸ºé¿å…å­—ç¬¦ä¸²æ¨¡æ¿å’Œ `innerHTML` ä¸å¹²å‡€ï¼ˆæœ‰è¢«é‡å†™çš„é£é™©ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `HTML` æ¨¡æ¿å’Œ `document.appendChild()` é‡æ„è¯¥ä¾‹å­ï¼š

```html
<template id="x-foo-tpl"> 
    #document-fragment
		<p>I'm inside a custom element template!</p> 
</template>
```

```js
const template = document.querySelector('#x-foo-tpl');

class FooElement extends HTMLElement {
	constructor() {
		super();
		this.appendChild(template.content.cloneNode(true));
	}
}

customElements.define('x-foo', FooElement);
document.body.innerHTML += `<x-foo></x-foo`; 
```

```html
<template id="x-foo-tpl"> 
    #document-fragment
		<p>I'm inside a custom element template!</p>
</template> 
<x-foo> 
	<p>I'm inside a custom element template!</p>
<x-foo>
```

â€‹		è¿™æ ·å¯ä»¥åœ¨è‡ªå®šä¹‰å…ƒç´ ä¸­å®ç°é«˜åº¦çš„ `HTML` å’Œä»£ç é‡ç”¨ï¼Œä»¥åŠ `DOM` å°è£…ã€‚ä¸è¿‡ï¼Œä½¿ç”¨è¿™ç§æ¨¡å¼è™½ç„¶èƒ½å¤Ÿè‡ªç”±åˆ›å»ºå¯é‡ç”¨çš„ç»„ä»¶ï¼Œä½†ç»„ä»¶å†…éƒ¨æ ·å¼å¯èƒ½æ±¡æŸ“å¤–éƒ¨æ ·å¼æˆ–è¢«å¤–éƒ¨æ ·å¼æ±¡æŸ“ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥å°†å­ `DOM` å°è£…åœ¨ç»„ä»¶çš„å½±å­ `DOM` ä¸­ã€‚

```html
<template id="x-foo-tpl"> 
    #document-fragment
		<p>I'm inside a custom element template!</p> 
</template>
```

```js
const template = document.querySelector('#x-foo-tpl'); 

class FooElement extends HTMLElement { 
 	constructor() { 
 		super(); 
 		this.attachShadow({ mode: 'open' }); 
 		this.shadowRoot.appendChild(template.content.cloneNode(true)); 
 	} 
} 

customElements.define('x-foo', FooElement); 
document.body.innerHTML += `<x-foo></x-foo`; 
```

```html
<template id="x-foo-tpl"> 
    #document-fragment
		<p>I'm inside a custom element template!</p>
</template> 
<x-foo> 
	#shadow-root (open) 
		<p>I'm inside a custom element template!</p>
<x-foo>
```

â€‹		è¿™æ ·å°±èƒ½å¤Ÿè‡ªç”±åˆ›å»ºå¯é‡ç”¨çš„ç»„ä»¶è€Œä¸å¿…æ‹…å¿ƒç»„ä»¶å†…å¤–æ ·å¼çš„äº’ç›¸æ±¡æŸ“ã€‚

##### ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

â€‹		å¯ä»¥åœ¨è‡ªå®šä¹‰å…ƒç´ çš„ä¸åŒç”Ÿå‘½å‘¨æœŸæ‰§è¡Œä»£ç ã€‚å¸¦æœ‰ç›¸åº”åç§°çš„è‡ªå®šä¹‰å…ƒç´ ç±»çš„å®ä¾‹æ–¹æ³•ä¼šåœ¨ä¸åŒç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¢«è°ƒç”¨ã€‚è‡ªå®šä¹‰å…ƒç´ æœ‰ä»¥ä¸‹ 5 ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

- `constructor()`ï¼šåœ¨åˆ›å»ºå…ƒç´ å®ä¾‹æˆ–å°†å·²æœ‰ `DOM` å…ƒç´ å‡çº§ä¸ºè‡ªå®šä¹‰å…ƒç´ æ—¶è°ƒç”¨ã€‚
- `connectedCallback()`ï¼šåœ¨æ¯æ¬¡å°†è¿™ä¸ªè‡ªå®šä¹‰å…ƒç´ å®ä¾‹æ·»åŠ åˆ° `DOM` ä¸­æ—¶è°ƒç”¨ã€‚
- `disconnectedCallback()`ï¼šåœ¨æ¯æ¬¡å°†è¿™ä¸ªè‡ªå®šä¹‰å…ƒç´ å®ä¾‹ä» `DOM` ä¸­ç§»é™¤æ—¶è°ƒç”¨ã€‚
- `attributeChangedCallback()`ï¼šåœ¨æ¯æ¬¡å¯è§‚å¯Ÿå±æ€§çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶è°ƒç”¨ã€‚åœ¨å…ƒç´ å®ä¾‹åˆå§‹åŒ–æ—¶ï¼Œåˆå§‹å€¼çš„å®šä¹‰ä¹Ÿç®—ä¸€æ¬¡å˜åŒ–ã€‚
- `adoptedCallback()`ï¼šåœ¨é€šè¿‡ `document.adoptNode()` å°†è¿™ä¸ªè‡ªå®šä¹‰å…ƒç´ å®ä¾‹ç§»åŠ¨åˆ°æ–°æ–‡æ¡£å¯¹è±¡æ—¶è°ƒç”¨ã€‚ã€`adopt`ï¼šç§»å±…ã€‘

â€‹		ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†è¿™äº›æ„å»ºã€è¿æ¥å’Œæ–­å¼€è¿æ¥çš„å›è°ƒï¼ˆåä¸¤ç§å°†åœ¨ä¸‹æ–‡é™†ç»­å±•å¼€ï¼‰ï¼š

```js
class FooElement extends HTMLElement { 
 	constructor() { 
 		super(); 
 		console.log('ctor'); 
 	} 
    
 	connectedCallback() { 
 		console.log('connected'); 
 	} 
    
 	disconnectedCallback() { 
 		console.log('disconnected'); 
 	}
}

customElements.define('x-foo', FooElement); 
const fooElement = document.createElement('x-foo'); // ctor 

document.body.appendChild(fooElement); // connected 

document.body.removeChild(fooElement); // disconnected
```

##### åå°„è‡ªå®šä¹‰å…ƒç´ å±æ€§

â€‹		è‡ªå®šä¹‰å…ƒç´ æ—¢æ˜¯ `DOM` å®ä½“åˆæ˜¯ `JavaScript` å¯¹è±¡ï¼ˆè™šæ‹Ÿ `DOM` ä¾¿æ˜¯å¯¹ `DOM` å®ä½“æ˜ å°„åçš„ `js` å¯¹è±¡ï¼‰ï¼Œå› æ­¤ä¸¤è€…ä¹‹é—´åº”è¯¥åŒæ­¥å˜åŒ–ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹ `DOM` çš„ä¿®æ”¹åº”è¯¥åæ˜ åˆ° `JavaScript` å¯¹è±¡ï¼Œåä¹‹äº¦ç„¶ã€‚è¦ä» `JavaScript` å¯¹è±¡åå°„åˆ° `DOM`ï¼Œå¸¸è§çš„æ–¹å¼æ˜¯ä½¿ç”¨è·å–å‡½æ•°å’Œè®¾ç½®å‡½æ•°ã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†åœ¨ `JavaScript` å¯¹è±¡å’Œ `DOM` ä¹‹é—´åå°„ `bar` å±æ€§çš„è¿‡ç¨‹ï¼š

```js
document.body.innerHTML = `<x-foo></x-foo>`; 

class FooElement extends HTMLElement { 
 	constructor() { 
 		super(); 
 		this.bar = true; // è°ƒç”¨set barè®¾ç½®barçš„å±æ€§å€¼
 	} 
    
    // è®¿é—®barå±æ€§å€¼æ—¶è§¦å‘
 	get bar() { 
 		return this.getAttribute('bar'); 
 	} 
    
    // ä¿®æ”¹barå±æ€§å€¼æ—¶è§¦å‘
 	set bar(value) { 
 		this.setAttribute('bar', value) 
 	} 
} 

customElements.define('x-foo', FooElement); 

console.log(document.body.innerHTML); // <x-foo bar="true"></x-foo>
```

â€‹		å¦ä¸€ä¸ªæ–¹å‘çš„åå°„ï¼ˆä» `DOM` åˆ° `JavaScript` å¯¹è±¡ï¼‰éœ€è¦ç»™ç›¸åº”çš„å±æ€§æ·»åŠ ç›‘å¬å™¨ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨é™æ€ `observedAttributes()` è·å–å‡½æ•°è®©è‡ªå®šä¹‰å…ƒç´ çš„å±æ€§å€¼æ¯æ¬¡æ”¹å˜æ—¶éƒ½è°ƒç”¨ `attributeChangedCallback()`ï¼š

```js
class FooElement extends HTMLElement { 
    // æ¯å½“è§‚å¯Ÿåˆ°å±æ€§å˜åŒ–æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ observedAttributes() æ–¹æ³•ã€‚
 	static get observedAttributes() { 
 		// è¿”å›è§¦å‘ attributeChangedCallback() é’©å­æ‰§è¡Œçš„å±æ€§ã€‚
 		return ['bar']; // æ•°ç»„ä¸­çš„å±æ€§å¿…é¡»æ˜¯åˆšå‘ç”Ÿå˜åŒ–çš„å±æ€§ï¼Œå®ƒä»¬ä¼šä¾æ¬¡ä½œä¸ºé¦–å‚è°ƒç”¨attributeChangedCallbacké’©å­ã€‚
 	} 
    
 	get bar() { 
 		return this.getAttribute('bar'); 
 	} 
    
 	set bar(value) { 
 		this.setAttribute('bar', value) 
 	}
    
    // æ¯æ¬¡ä»observedAttributesè¿”å›çš„æ•°ç»„ä¸­å–å‡ºä¸€ä¸ªå±æ€§ä½œä¸ºé¦–å‚ï¼Œå¹¶ä¸”å®Œæˆè¯¥å±æ€§çš„å˜åŒ–ã€‚
    attributeChangedCallback(name, oldValue, newValue) { 
 		if (oldValue !== newValue) { 
 			console.log(`${oldValue} -> ${newValue}`); 
 			this[name] = newValue; 
 		} 
 	} 
} 

customElements.define('x-foo', FooElement); 

document.body.innerHTML = `<x-foo bar="false"></x-foo>`;   // null -> false 

document.querySelector('x-foo').setAttribute('bar', true); // false -> true
```

##### å‡çº§è‡ªå®šä¹‰å…ƒç´ 

â€‹		å¹¶éå§‹ç»ˆåªèƒ½å…ˆå®šä¹‰è‡ªå®šä¹‰å…ƒç´ ï¼Œç„¶åå†åœ¨ `DOM` ä¸­ä½¿ç”¨å®ƒä»¬ã€‚ä¸ºè§£å†³è¿™ä¸ªå…ˆåæ¬¡åºé—®é¢˜ï¼Œ`Web` ç»„ä»¶åœ¨ `CustomElementRegistry` ä¸Šé¢å¤–æš´éœ²äº†ä¸€äº›æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•å¯ä»¥ç”¨æ¥æ£€æµ‹è‡ªå®šä¹‰å…ƒç´ æ˜¯å¦å®šä¹‰å®Œæˆï¼Œç„¶åå¯ä»¥ç”¨å®ƒæ¥å‡çº§å·²æœ‰çš„è‡ªå®šä¹‰å…ƒç´ ã€‚

â€‹		å¦‚æœè‡ªå®šä¹‰å…ƒç´ å·²ç»æœ‰äº†å®šä¹‰ï¼Œé‚£ä¹ˆ `CustomElementRegistry.get()` æ–¹æ³•ä¼šè¿”å›ç›¸åº”è‡ªå®šä¹‰å…ƒç´ çš„ç±»ã€‚ç±»ä¼¼åœ°ï¼Œ`whenDefined()` æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªæœŸçº¦ï¼Œåœ¨ç›¸åº”è‡ªå®šä¹‰å…ƒç´ æœ‰å®šä¹‰ä¹‹åè§£å†³ï¼š

```js
customElements.whenDefined('x-foo').then(() => console.log('defined!'));

console.log(customElements.get('x-foo')); // undefined 

// è°ƒç”¨ define() å®šä¹‰è‡ªå®šä¹‰å…ƒç´ 
customElements.define('x-foo', class FooElement {}); // defined! 

console.log(customElements.get('x-foo')); // class FooElement {}
```

â€‹		å·²ç»è¿æ¥åˆ° `DOM` çš„è‡ªå®šä¹‰å…ƒç´ ä¼šåœ¨è¯¥è‡ªå®šä¹‰å…ƒç´ æœ‰å®šä¹‰æ—¶è‡ªåŠ¨å‡çº§ã€‚å¦‚æœæƒ³åœ¨è‡ªå®šä¹‰å…ƒç´ è¿æ¥åˆ° `DOM` ä¹‹å‰å°†å…¶å¼ºåˆ¶å‡çº§ï¼Œå¯ä»¥ä½¿ç”¨ `CustomElementRegistry.upgrade()` æ–¹æ³•ï¼š

```js
// åœ¨è‡ªå®šä¹‰å…ƒç´ æœ‰å®šä¹‰ä¹‹å‰ä¼šåˆ›å»º HTMLUnknownElement å¯¹è±¡
const fooElement1 = document.createElement('x-foo'); // æœªå®šä¹‰çš„è‡ªå®šä¹‰å…ƒç´ 

// åˆ›å»ºè‡ªå®šä¹‰å…ƒç´ 
class FooElement extends HTMLElement {} 
customElements.define('x-foo', FooElement); // å®šä¹‰è‡ªå®šä¹‰å…ƒç´ ï¼Œä½¿æœ‰å®šä¹‰çš„<x-foo>å…ƒç´ æˆä¸ºFooElementçš„å®ä¾‹ã€‚

const fooElement2 = document.createElement('x-foo'); // æœ‰å®šä¹‰çš„è‡ªå®šä¹‰å…ƒç´ 

// æœ‰å®šä¹‰çš„è‡ªå®šä¹‰å…ƒç´ å·²æˆä¸ºFooElementçš„å®ä¾‹ï¼Œè€Œæœªå®šä¹‰çš„åˆ™è¿˜ä¸æ˜¯ã€‚
console.log(fooElement1 instanceof FooElement); // false
console.log(fooElement2 instanceof FooElement); // true

// å¼ºåˆ¶å‡çº§ï¼ˆå°†è‡ªå®šä¹‰å…ƒç´ ä»æœªå®šä¹‰çŠ¶æ€å‡çº§ä¸ºæœ‰å®šä¹‰çŠ¶æ€ï¼‰
customElements.upgrade(fooElement1); 

console.log(fooElement1 instanceof FooElement); // true
```

â€‹		æ³¨æ„ï¼šè¿˜æœ‰ä¸€ä¸ª `HTML Imports Web` ç»„ä»¶ï¼Œä½†è¿™ä¸ªè§„èŒƒç›®å‰è¿˜æ˜¯è‰æ¡ˆï¼Œæ²¡æœ‰ä¸»è¦æµè§ˆå™¨æ”¯æŒã€‚æµè§ˆå™¨æœ€ç»ˆæ˜¯å¦ä¼šæ”¯æŒè¿™ä¸ªè§„èŒƒç›®å‰è¿˜æ˜¯æœªçŸ¥æ•°ã€‚



### `Web Cryptography API`

â€‹		`Web Cryptography API` æè¿°äº†ä¸€å¥—å¯†ç å­¦å·¥å…·ï¼Œè§„èŒƒäº† `JavaScript` å¦‚ä½•ä»¥å®‰å…¨å’Œç¬¦åˆæƒ¯ä¾‹çš„æ–¹å¼å®ç°åŠ å¯†ã€‚è¿™äº›å·¥å…·åŒ…æ‹¬ç”Ÿæˆã€ä½¿ç”¨å’Œåº”ç”¨åŠ å¯†å¯†é’¥å¯¹ï¼ŒåŠ å¯†å’Œè§£å¯†æ¶ˆæ¯ï¼Œä»¥åŠå¯é åœ°ç”Ÿæˆéšæœºæ•°ã€‚

â€‹		æ³¨æ„ï¼šåŠ å¯†æ¥å£çš„ç»„ç»‡æ–¹å¼æœ‰ç‚¹å¥‡æ€ªï¼Œå…¶å¤–éƒ¨æ˜¯ä¸€ä¸ª `Crypto` å¯¹è±¡ï¼Œå†…éƒ¨æ˜¯ä¸€ä¸ª `SubtleCrypto` å¯¹è±¡ã€‚åœ¨ `Web Cryptography API` æ ‡å‡†åŒ–ä¹‹å‰ï¼Œ`window.crypto` å±æ€§åœ¨ä¸åŒæµè§ˆå™¨ä¸­çš„å®ç°å·®å¼‚éå¸¸å¤§ã€‚ä¸ºå®ç°è·¨æµè§ˆå™¨å…¼å®¹ï¼Œæ ‡å‡†çš„ `API` éƒ½æš´éœ²äº†åœ¨ `SubtleCrypto` å¯¹è±¡ä¸Šã€‚



#### ç”Ÿæˆéšæœºæ•°

â€‹		åœ¨éœ€è¦ç”Ÿæˆéšæœºå€¼æ—¶ï¼Œå¾ˆå¤šäººä¼šä½¿ç”¨ `Math.random()`ã€‚è¿™ä¸ªæ–¹æ³•åœ¨æµè§ˆå™¨ä¸­æ˜¯ä»¥ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆ`PRNG`ï¼Œ`PseudoRandom Number Generator`ï¼‰æ–¹å¼å®ç°çš„ã€‚æ‰€è°“ â€œä¼ªâ€ æŒ‡çš„æ˜¯ç”Ÿæˆå€¼çš„è¿‡ç¨‹**ä¸æ˜¯çœŸçš„éšæœº**ã€‚`PRNG` ç”Ÿæˆçš„å€¼åªæ˜¯æ¨¡æ‹Ÿäº†éšæœºçš„ç‰¹æ€§ã€‚æµè§ˆå™¨çš„ `PRNG` å¹¶æœªä½¿ç”¨çœŸæ­£çš„éšæœºæºï¼Œåªæ˜¯å¯¹ä¸€ä¸ªå†…éƒ¨çŠ¶æ€åº”ç”¨äº†å›ºå®šçš„ç®—æ³•ã€‚æ¯æ¬¡è°ƒç”¨ `Math.random()`ï¼Œè¿™ä¸ªå†…éƒ¨çŠ¶æ€éƒ½ä¼šè¢«ä¸€ä¸ªå›ºå®šçš„ç®—æ³•ä¿®æ”¹ï¼Œè€Œç»“æœä¼šè¢«è½¬æ¢ä¸ºä¸€ä¸ªæ–°çš„éšæœºå€¼ã€‚ä¾‹å¦‚ï¼Œ`V8` å¼•æ“ä½¿ç”¨äº†ä¸€ä¸ªåä¸º `xorshift128+` çš„ç®—æ³•æ¥æ‰§è¡Œè¿™ç§ä¿®æ”¹ã€‚

â€‹		ç”±äºç®—æ³•æœ¬èº«æ˜¯å›ºå®šçš„ï¼Œå…¶è¾“å…¥ä¹Ÿåªæ˜¯ä¹‹å‰çš„çŠ¶æ€ï¼Œå› æ­¤éšæœºæ•°çš„é¡ºåºæ˜¯ç¡®å®šçš„ã€‚`xorshift128+` ä½¿ç”¨ 128 ä½å†…éƒ¨çŠ¶æ€ï¼Œè€Œç®—æ³•çš„è®¾è®¡è®©ä»»ä½•åˆå§‹çŠ¶æ€åœ¨é‡å¤è‡ªèº«ä¹‹å‰éƒ½ä¼šäº§ç”Ÿ 2<sup>128</sup> â€“ 1 ä¸ªä¼ªéšæœºå€¼ã€‚è¿™ç§å¾ªç¯è¢«ç§°ä¸ºç½®æ¢å¾ªç¯ï¼ˆ`permutation cycle`ï¼‰ï¼Œè€Œè¿™ä¸ªå¾ªç¯çš„é•¿åº¦è¢«ç§°ä¸ºä¸€ä¸ªå‘¨æœŸï¼ˆ`period`ï¼‰ã€‚å¾ˆæ˜æ˜¾ï¼Œå¦‚æœæ”»å‡»è€…çŸ¥é“ `PRNG` çš„å†…éƒ¨çŠ¶æ€ï¼Œå°±å¯ä»¥é¢„æµ‹åç»­ç”Ÿæˆçš„ä¼ªéšæœºå€¼ã€‚å¦‚æœå¼€å‘è€…æ— æ„ä¸­ä½¿ç”¨ `PRNG` ç”Ÿæˆäº†ç§æœ‰å¯†é’¥ç”¨äºåŠ å¯†ï¼Œåˆ™æ”»å‡»è€…å°±å¯ä»¥åˆ©ç”¨ `PRNG` çš„è¿™ä¸ªç‰¹æ€§ç®—å‡ºç§æœ‰å¯†é’¥ã€‚

â€‹		ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ä¸»è¦ç”¨äºå¿«é€Ÿè®¡ç®—å‡ºçœ‹èµ·æ¥éšæœºçš„å€¼ï¼Œä½†æ˜¯å¹¶ä¸é€‚åˆç”¨äºåŠ å¯†è®¡ç®—ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯†ç å­¦å®‰å…¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆ`CSPRNG`ï¼Œ`Cryptographically Secure PseudoRandom Number Generator`ï¼‰é¢å¤–å¢åŠ äº†ä¸€ä¸ªç†µä½œä¸ºè¾“å…¥ï¼Œä¾‹å¦‚æµ‹è¯•ç¡¬ä»¶æ—¶é—´æˆ–å…¶ä»–æ— æ³•é¢„è®¡è¡Œä¸ºçš„ç³»ç»Ÿç‰¹æ€§ã€‚è¿™æ ·ä¸€æ¥ï¼Œè®¡ç®—é€Ÿåº¦æ˜æ˜¾æ¯”å¸¸è§„ `PRNG` æ…¢å¾ˆå¤šï¼Œä½† `CSPRNG` ç”Ÿæˆçš„å€¼å°†å¾ˆéš¾é¢„æµ‹ï¼Œä¹Ÿå°±å¯ä»¥ç”¨äºåŠ å¯†äº†ã€‚

â€‹		`Web Cryptography API` å¼•å…¥äº† `CSPRNG`ï¼Œè¿™ä¸ª `CSPRNG` å¯ä»¥é€šè¿‡ `crypto.getRandomValues()` åœ¨å…¨å±€ `Crypto` å¯¹è±¡ä¸Šè®¿é—®ã€‚ä¸ `Math.random()` è¿”å›ä¸€ä¸ªä»‹äº 0 å’Œ 1 ä¹‹é—´çš„æµ®ç‚¹æ•°ä¸åŒï¼Œ`getRandomValues()` ä¼šæŠŠéšæœºå€¼å†™å…¥ä½œä¸ºå‚æ•°ä¼ ç»™å®ƒçš„å®šå‹æ•°ç»„ã€‚å®šå‹æ•°ç»„çš„ç±»ä¸é‡è¦ï¼Œå› ä¸ºåº•å±‚ç¼“å†²åŒºä¼šè¢«éšæœºçš„äºŒè¿›åˆ¶ä½å¡«å……ï¼ˆå› æ­¤ï¼Œç”Ÿæˆçš„éšæœºæ•°ä¸ä¼šè¶…è¿‡ç¼“å†²åŒºçš„å¤§å°ï¼‰ã€‚

â€‹		ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†ç”Ÿæˆ 5 ä¸ªæ— ç¬¦å·çš„ 8 ä½ï¼ˆå³ï¼š0 ~ 255 ä¹‹é—´ï¼Œå¯ç”¨ 2 ä½çš„åå…­è¿›åˆ¶æ•°æ¥è¡¨ç¤ºï¼‰éšæœºå€¼ï¼š

```js
const array = new Uint8Array(1); // 1ä¸ªå­—èŠ‚ = 8ä½ = 2ä½åå…­è¿›åˆ¶æ•°è¡¨ç¤º => [0, 255]ã€‚

for (let i = 0; i < 5; ++i) { 
    // å› ä¸ºä½¿ç”¨äº†Uint8Arrayï¼Œæ‰€ä»¥éšæœºå€¼èŒƒå›´[0, 255]
 	console.log(crypto.getRandomValues(array)); 
} 

/*
> Uint8Array [68] 
> Uint8Array [143] 
> Uint8Array [169] 
> Uint8Array [164] 
> Uint8Array [131]
*/
```

â€‹		`getRandomValues()` æœ€å¤šå¯ä»¥ç”Ÿæˆ 2<sup>16</sup>ï¼ˆ65 536ï¼‰å­—èŠ‚ï¼Œè¶…å‡ºåˆ™ä¼šæŠ›å‡ºé”™è¯¯ï¼š

```js
const fooArray = new Uint8Array(2 ** 16); 
console.log(window.crypto.getRandomValues(fooArray)); // Uint8Array(65536) [...] 

const barArray = new Uint8Array((2 ** 16) + 1); 
console.log(window.crypto.getRandomValues(barArray)); // Uncaught DOMException
```

â€‹		è¦ä½¿ç”¨ `CSPRNG` é‡æ–°å®ç° `Math.random()`ï¼Œå¯ä»¥é€šè¿‡ç”Ÿæˆä¸€ä¸ªéšæœºçš„ 32 ä½æ•°å€¼ï¼Œç„¶åç”¨å®ƒå»é™¤æœ€å¤§çš„å¯èƒ½å€¼ `0xFFFFFFFF`ã€‚è¿™æ ·å°±ä¼šå¾—åˆ°ä¸€ä¸ªä»‹äº 0 å’Œ 1 ä¹‹é—´çš„å€¼ï¼š

```js
function randomFloat() { 
 	// ç”Ÿæˆ 32 ä½éšæœºå€¼
 	const fooArray = new Uint32Array(1); 
 	// æœ€å¤§å€¼æ˜¯ 2^32 â€“ 1
 	const maxUint32 = 0xFFFFFFFF; 
 	// ç”¨æœ€å¤§å¯èƒ½çš„å€¼æ¥é™¤
 	return crypto.getRandomValues(fooArray)[0] / maxUint32; 
} 

console.log(randomFloat()); // 0.5033651619458955
```



#### ä½¿ç”¨ `SubtleCrypto` å¯¹è±¡

â€‹		`Web Cryptography API` é‡å¤´ç‰¹æ€§éƒ½æš´éœ²åœ¨äº† `SubtleCrypto` å¯¹è±¡ä¸Šï¼Œå¯ä»¥é€šè¿‡ `window.crypto.subtle` è®¿é—®ï¼š

```js
console.log(crypto.subtle); // SubtleCrypto {}

/*
SubtleCrypto {
	[[Prototype]]: SubtleCrypto {
		decrypt: Æ’ decrypt(),
		deriveBits: Æ’ deriveBits(),
		deriveKey: Æ’ deriveKey(),
		digest: Æ’ digest(),
		encrypt: Æ’ encrypt(),
		exportKey: Æ’ exportKey(),
		generateKey: Æ’ generateKey(),
		importKey: Æ’ importKey(),
		sign: Æ’ sign(),
		unwrapKey: Æ’ unwrapKey(),
		verify: Æ’ verify(),
		wrapKey: Æ’ wrapKey(),
		constructor: Æ’ SubtleCrypto(),
		Symbol(Symbol.toStringTag): "SubtleCrypto",
		[[Prototype]]: Object
	}
}
*/
```

â€‹		è¿™ä¸ªå¯¹è±¡åŒ…å«å¦‚ä¸Šçš„æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œå¸¸è§çš„å¯†ç å­¦åŠŸèƒ½ï¼Œå¦‚ï¼šåŠ å¯†ã€æ•£åˆ—ã€ç­¾åå’Œç”Ÿæˆå¯†é’¥ã€‚å› ä¸ºæ‰€æœ‰å¯†ç å­¦æ“ä½œéƒ½åœ¨åŸå§‹äºŒè¿›åˆ¶æ•°æ®ä¸Šæ‰§è¡Œï¼Œæ‰€ä»¥ `SubtleCrypto` çš„æ¯ä¸ªæ–¹æ³•éƒ½è¦ç”¨åˆ° `ArrayBuffer` å’Œ `ArrayBufferView` ç±»å‹ã€‚åˆå› å­—ç¬¦ä¸²æ˜¯å¯†ç å­¦æ“ä½œçš„é‡è¦åº”ç”¨åœºæ™¯ï¼Œå› æ­¤ `TextEncoder` å’Œ `TextDecoder` æ˜¯ç»å¸¸ä¸ `SubtleCrypto` ä¸€èµ·ä½¿ç”¨çš„ç±»ï¼Œç”¨äºå®ç°äºŒè¿›åˆ¶æ•°æ®ä¸å­—ç¬¦ä¸²ä¹‹é—´çš„ç›¸äº’è½¬æ¢ã€‚

â€‹		æ³¨æ„ï¼š`SubtleCrypto` å¯¹è±¡åªèƒ½åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆ`https`ï¼‰ä¸­ä½¿ç”¨ã€‚åœ¨ä¸å®‰å…¨çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ`subtle` å±æ€§æ˜¯ `undefined`ã€‚

##### ç”Ÿæˆå¯†ç å­¦æ‘˜è¦

â€‹		è®¡ç®—æ•°æ®çš„å¯†ç å­¦æ‘˜è¦æ˜¯éå¸¸å¸¸ç”¨çš„å¯†ç å­¦æ“ä½œã€‚è¿™ä¸ªè§„èŒƒæ”¯æŒ 4 ç§æ‘˜è¦ç®—æ³•ï¼š`SHA-1` å’Œ 3 ç§ `SHA-2`ã€‚

- `SHA-1`ï¼ˆ`Secure Hash Algorithm 1`ï¼‰ï¼šæ¶æ„ç±»ä¼¼ `MD5` çš„æ•£åˆ—å‡½æ•°ã€‚æ¥æ”¶ä»»æ„å¤§å°çš„è¾“å…¥ï¼Œç”Ÿæˆ 160 ä½æ¶ˆæ¯æ•£åˆ—ã€‚ç”±äºå®¹æ˜“å—åˆ°ç¢°æ’æ”»å‡»ï¼Œè¿™ä¸ªç®—æ³•å·²ç»ä¸å†å®‰å…¨ã€‚
- `SHA-2`ï¼ˆ`Secure Hash Algorithm 2`ï¼‰ï¼šæ„å»ºäºç›¸åŒè€ç¢°æ’å•å‘å‹ç¼©å‡½æ•°ä¹‹ä¸Šçš„ä¸€å¥—æ•£åˆ—å‡½æ•°ã€‚è§„èŒƒæ”¯æŒå…¶ä¸­ 3 ç§ï¼š`SHA-256`ã€`SHA-384` å’Œ `SHA-512`ã€‚ç”Ÿæˆçš„æ¶ˆæ¯æ‘˜è¦å¯ä»¥æ˜¯ 256 ä½ï¼ˆ`SHA-256`ï¼‰ã€384 ä½ï¼ˆ`SHA-384`ï¼‰æˆ– 512 ä½ï¼ˆ`SHA-512`ï¼‰ã€‚è¿™ä¸ªç®—æ³•è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œå¹¿æ³›åº”ç”¨äºå¾ˆå¤šé¢†åŸŸå’Œåè®®ï¼ŒåŒ…æ‹¬ `TLS`ã€`PGP` å’ŒåŠ å¯†è´§å¸ï¼ˆå¦‚ï¼šæ¯”ç‰¹å¸ï¼‰ã€‚

â€‹		`SubtleCrypto.digest()` æ–¹æ³•ç”¨äºç”Ÿæˆæ¶ˆæ¯æ‘˜è¦ã€‚è¦ä½¿ç”¨çš„æ•£åˆ—ç®—æ³•é€šè¿‡å­—ç¬¦ä¸² `"SHA-1"`ã€`"SHA-256"`ã€`"SHA-384"` æˆ– `"SHA-512"` æŒ‡å®šã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†ä¸€ä¸ªä½¿ç”¨ `SHA-256` ç®—æ³•ä¸ºå­—ç¬¦ä¸² `"foo"` ç”Ÿæˆæ¶ˆæ¯æ‘˜è¦çš„ä¾‹å­ï¼š

```js
(async function() { 
 	const textEncoder = new TextEncoder(); 
 	const message = textEncoder.encode('foo'); 	// TypedArray
 	const messageDigest = await crypto.subtle.digest('SHA-256', message); // ArrayBuffer
    
 	console.log(new Uint32Array(messageDigest)); // TypedArray
})(); 
// Uint32Array(8)Â [1806968364, 2412183400, 1011194873, 876687389, 1882014227, 2696905572, 2287897337, 2934400610]
```

â€‹		é€šå¸¸åœ¨ä½¿ç”¨æ—¶ï¼ŒäºŒè¿›åˆ¶çš„æ¶ˆæ¯æ‘˜è¦ä¼šè½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²æ ¼å¼ã€‚é€šè¿‡å°†äºŒè¿›åˆ¶æ•°æ®æŒ‰ 8 ä½è¿›è¡Œåˆ†å‰²ï¼Œç„¶åå†è°ƒç”¨ `toString(16)` å°±å¯ä»¥æŠŠä»»ä½•æ•°ç»„ç¼“å†²åŒºè½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼š

```js
(async function() { 
 	const textEncoder = new TextEncoder(); 
 	const message = textEncoder.encode('foo'); 
 	const messageDigest = await crypto.subtle.digest('SHA-256', message); 
    // ä½¿ç”¨Uint8Arrayå°†äºŒè¿›åˆ¶æ•°æ®æŒ‰8ä½åˆ†å‰²ï¼Œç„¶åå°†å®ƒä»¬è½¬ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²ã€‚
 	const hexDigest = Array.from(new Uint8Array(messageDigest))
    					   .map((x) => x.toString(16).padStart(2, '0')).join(''); 
    
 	console.log(hexDigest); 
})(); 
// 2c26b46b68ffc68ff99b453c1d30413413422d706483bfa0f98a5e886266e7ae
```

â€‹		è½¯ä»¶å…¬å¸é€šå¸¸ä¼šå…¬å¼€è‡ªå·±è½¯ä»¶äºŒè¿›åˆ¶å®‰è£…åŒ…çš„æ‘˜è¦ï¼Œä»¥ä¾¿ç”¨æˆ·éªŒè¯è‡ªå·±ä¸‹è½½åˆ°çš„ç¡®å®æ˜¯è¯¥å…¬å¸å‘å¸ƒçš„ç‰ˆæœ¬ï¼ˆè€Œä¸æ˜¯è¢«æ¶æ„è½¯ä»¶ç¯¡æ”¹è¿‡çš„ç‰ˆæœ¬ï¼‰ã€‚ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†ä¸‹è½½ `Firefox v67.0`ï¼Œé€šè¿‡ `SHA-512` è®¡ç®—å…¶æ•£åˆ—ï¼Œå†ä¸‹è½½å…¶ `SHA-512` äºŒè¿›åˆ¶éªŒè¯æ‘˜è¦ï¼Œæœ€åæ£€æŸ¥ä¸¤ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸²æ˜¯å¦åŒ¹é…ï¼š

```js
(async function() { 
 	const mozillaCdnUrl = '// download-origin.cdn.mozilla.net/pub/firefox/releases/67.0 /'; 
 	const firefoxBinaryFilename = 'linux-x86_64/en-US/firefox-67.0.tar.bz2'; 
 	const firefoxShaFilename = 'SHA512SUMS'; 
    
 	console.log('è·å– Firefox äºŒè¿›åˆ¶æ–‡ä»¶...'); 
    
 	const fileArrayBuffer = await (await fetch(mozillaCdnUrl + firefoxBinaryFilename)).arrayBuffer(); 
    
 	console.log('è®¡ç®— Firefox æ‘˜è¦...'); 
    
 	const firefoxBinaryDigest = await crypto.subtle.digest('SHA-512', fileArrayBuffer);
 	const firefoxHexDigest = Array.from(new Uint8Array(firefoxBinaryDigest)) 
 							   	  .map((x) => x.toString(16).padStart(2, '0')).join(''); 
    
 	console.log('è·å–å·²å‘å¸ƒçš„äºŒè¿›åˆ¶æ‘˜è¦...'); 
    
 	// SHA æ–‡ä»¶åŒ…å«æ­¤æ¬¡å‘å¸ƒçš„æ‰€æœ‰ Firefox äºŒè¿›åˆ¶æ–‡ä»¶çš„æ‘˜è¦ï¼Œå› æ­¤è¦æ ¹æ®å…¶æ ¼å¼è¿›åˆ¶æ‹†åˆ†ã€‚
 	const shaPairs = (await (await fetch(mozillaCdnUrl + firefoxShaFilename)).text()).split(/\n/).map((x) => x.split(/\s+/)); 
    
 	let verified = false;
    
	console.log('æ ¹æ®å·²å‘å¸ƒçš„æ‘˜è¦æ£€æŸ¥è®¡ç®—çš„æ‘˜è¦...'); 
    
 	for (const [sha, filename] of shaPairs) { 
 		if (filename === firefoxBinaryFilename) { 
 			if (sha === firefoxHexDigest) { 
 				verified = true; 
 				break; 
 			} 
 		} 
 	} 
    
 	console.log('è¯å®ï¼š', verified); 
})(); 

/* 
> è·å– Firefox äºŒè¿›åˆ¶æ–‡ä»¶...
> è®¡ç®— Firefox æ‘˜è¦...
> è·å–å·²å‘å¸ƒçš„äºŒè¿›åˆ¶æ‘˜è¦...
> æ ¹æ®å·²å‘å¸ƒçš„æ‘˜è¦æ£€æŸ¥è®¡ç®—çš„æ‘˜è¦...
> è¯å®ï¼štrue
*/
```

##### `CryptoKey` ä¸ç®—æ³•

â€‹		å¦‚æœæ²¡äº†å¯†é’¥ï¼Œé‚£å¯†ç å­¦ä¹Ÿå°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ã€‚`SubtleCrypto` å¯¹è±¡ä½¿ç”¨ `CryptoKey` ç±»çš„å®ä¾‹æ¥ç”Ÿæˆå¯†é’¥ã€‚`CryptoKey` ç±»æ”¯æŒå¤šç§åŠ å¯†ç®—æ³•ï¼Œå…è®¸æ§åˆ¶å¯†é’¥æŠ½å–å’Œä½¿ç”¨ã€‚

â€‹		`CryptoKey` ç±»æ”¯æŒä»¥ä¸‹ç®—æ³•ï¼ŒæŒ‰å„è‡ªçš„çˆ¶å¯†ç ç³»ç»Ÿå½’ç±»ã€‚

- `RSA`ï¼ˆ`Rivest-Shamir-Adleman`ï¼Œåˆ†åˆ«æŒ‡ä¸‰ä½å‘æ˜è€…ï¼‰ï¼šå…¬é’¥å¯†ç ç³»ç»Ÿï¼Œä½¿ç”¨ä¸¤ä¸ªå¤§ç´ æ•°è·å¾—ä¸€å¯¹å…¬é’¥å’Œç§é’¥ï¼Œå¯ç”¨äºç­¾å/éªŒè¯æˆ–åŠ å¯†/è§£å¯†æ¶ˆæ¯ã€‚`RSA` çš„é™·é—¨å‡½æ•°è¢«ç§°ä¸ºåˆ†è§£éš¾é¢˜ï¼ˆ`factoring problem`ï¼‰ã€‚
- `RSASSA-PKCS1-v1_5`ï¼š`RSA` çš„ä¸€ä¸ªåº”ç”¨ï¼Œç”¨äºä½¿ç”¨ç§é’¥ç»™æ¶ˆæ¯ç­¾åï¼Œå…è®¸ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾åã€‚
  - `SSA`ï¼ˆ`Signature Schemes with Appendix`ï¼‰ï¼Œè¡¨ç¤ºç®—æ³•æ”¯æŒç­¾åç”Ÿæˆå’ŒéªŒè¯æ“ä½œã€‚
  - `PKCS1`ï¼ˆ`Public-Key Cryptography Standards #1`ï¼‰ï¼Œè¡¨ç¤ºç®—æ³•å±•ç¤ºå‡ºçš„ `RSA` å¯†é’¥å¿…éœ€çš„æ•°å­¦ç‰¹æ€§ã€‚
  - `RSASSA-PKCS1-v1_5` æ˜¯ç¡®å®šæ€§çš„ï¼Œæ„å‘³ç€åŒæ ·çš„æ¶ˆæ¯å’Œå¯†é’¥æ¯æ¬¡éƒ½ä¼šç”Ÿæˆç›¸åŒçš„ç­¾åã€‚
- `RSA-PSS`ï¼š`RSA` çš„å¦ä¸€ä¸ªåº”ç”¨ï¼Œç”¨äºç­¾åå’ŒéªŒè¯æ¶ˆæ¯ã€‚
  - `PSS`ï¼ˆ`Probabilistic Signature Scheme`ï¼‰ï¼Œè¡¨ç¤ºç”Ÿæˆç­¾åæ—¶ä¼šåŠ ç›ä»¥å¾—åˆ°éšæœºç­¾åã€‚
  - ä¸ `RSASSA-PKCS1-v1_5` ä¸åŒï¼ŒåŒæ ·çš„æ¶ˆæ¯å’Œå¯†é’¥æ¯æ¬¡éƒ½ä¼šç”Ÿæˆä¸åŒçš„ç­¾åã€‚
  - ä¸ `RSASSA-PKCS1-v1_5` ä¸åŒï¼Œ`RSA-PSS` æœ‰å¯èƒ½çº¦ç®€åˆ° `RSA` åˆ†è§£éš¾é¢˜çš„éš¾åº¦ã€‚
  - é€šå¸¸ï¼Œè™½ç„¶ `RSASSA-PKCS1-v1_5` ä»è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œä½† **`RSA-PSS` åº”è¯¥ç”¨äºä»£æ›¿ `RSASSA-PKCS1-v1_5`**ã€‚
- `RSA-OAEP`ï¼š`RSA` çš„ä¸€ä¸ªåº”ç”¨ï¼Œç”¨äºä½¿ç”¨å…¬é’¥åŠ å¯†æ¶ˆæ¯ï¼Œç”¨ç§é’¥æ¥è§£å¯†ã€‚
  - `OAEP`ï¼ˆ`Optimal Asymmetric Encryption Padding`ï¼‰ï¼Œè¡¨ç¤ºç®—æ³•åˆ©ç”¨äº† `Feistel` ç½‘ç»œåœ¨åŠ å¯†å‰å¤„ç†æœªåŠ å¯†çš„æ¶ˆæ¯ã€‚
  - `OAEP` ä¸»è¦å°†ç¡®å®šæ€§ `RSA` åŠ å¯†æ¨¡å¼è½¬æ¢ä¸ºæ¦‚ç‡æ€§åŠ å¯†æ¨¡å¼ã€‚
- `ECC`ï¼ˆ`Elliptic-Curve Cryptography`ï¼‰ï¼šå…¬é’¥å¯†ç ç³»ç»Ÿï¼Œä½¿ç”¨ä¸€ä¸ªç´ æ•°å’Œä¸€ä¸ªæ¤­åœ†æ›²çº¿è·å¾—ä¸€å¯¹å…¬é’¥å’Œç§é’¥ï¼Œå¯ç”¨äºç­¾å/éªŒè¯æ¶ˆæ¯ã€‚`ECC` çš„é™·é—¨å‡½æ•°è¢«ç§°ä¸ºæ¤­åœ†æ›²çº¿ç¦»æ•£å¯¹æ•°é—®é¢˜ï¼ˆ`elliptic curve discrete logarithm problem`ï¼‰ã€‚ç›®å‰ `ECC` è¢«è®¤ä¸ºä¼˜äº `RSA`ã€‚è™½ç„¶ `RSA` å’Œ `ECC` åœ¨å¯†ç å­¦æ„ä¹‰ä¸Šéƒ½å¾ˆå¼ºï¼Œä½† `ECC` å¯†é’¥æ¯” `RSA` å¯†é’¥çŸ­ï¼Œè€Œä¸” `ECC` å¯†ç å­¦æ“ä½œæ¯” `RSA` æ“ä½œå¿«ã€‚
- `ECDSA`ï¼ˆ`Elliptic Curve Digital Signature Algorithm`ï¼‰ï¼š`ECC` çš„ä¸€ä¸ªåº”ç”¨ï¼Œç”¨äºç­¾åå’ŒéªŒè¯æ¶ˆæ¯ã€‚è¿™ä¸ªç®—æ³•æ˜¯æ•°å­—ç­¾åç®—æ³•ï¼ˆ`DSA`ï¼Œ`Digital Signature Algorithm`ï¼‰çš„ä¸€ä¸ªæ¤­åœ†æ›²çº¿é£æ ¼çš„å˜ä½“ã€‚
- `ECDH`ï¼ˆ`Elliptic Curve Diffie-Hellman`ï¼‰ï¼š`ECC` çš„å¯†é’¥ç”Ÿæˆå’Œå¯†é’¥åå•†åº”ç”¨ï¼Œå…è®¸ä¸¤æ–¹é€šè¿‡å…¬å¼€é€šä¿¡æ¸ é“å»ºç«‹å…±äº«çš„æœºå¯†ã€‚è¿™ä¸ªç®—æ³•æ˜¯ `Diffie-Hellman` å¯†é’¥äº¤æ¢ï¼ˆ`DH`ï¼Œ`Diffie-Hellman key exchange`ï¼‰åè®®çš„ä¸€ä¸ªæ¤­åœ†æ›²çº¿é£æ ¼çš„å˜ä½“ã€‚
- `AES`ï¼ˆ`Advanced Encryption Standard`ï¼‰ï¼šå¯¹ç§°å¯†é’¥å¯†ç ç³»ç»Ÿï¼Œä½¿ç”¨æ´¾ç”Ÿè‡ªç½®æ¢ç»„åˆç½‘ç»œçš„åˆ†ç»„å¯†ç åŠ å¯†å’Œè§£å¯†æ•°æ®ã€‚`AES` åœ¨ä¸åŒæ¨¡å¼ä¸‹ä½¿ç”¨ï¼Œä¸åŒæ¨¡å¼ç®—æ³•çš„ç‰¹æ€§ä¹Ÿä¸åŒã€‚
- `AES-CTR`ï¼š`AES` çš„è®¡æ•°å™¨æ¨¡å¼ï¼ˆ`counter mode`ï¼‰ã€‚è¿™ä¸ªæ¨¡å¼ä½¿ç”¨é€’å¢è®¡æ•°å™¨ç”Ÿæˆå…¶å¯†é’¥æµï¼Œå…¶è¡Œä¸ºç±»ä¼¼å¯†æ–‡æµã€‚ä½¿ç”¨æ—¶å¿…é¡»ä¸ºå…¶æä¾›ä¸€ä¸ªéšæœºæ•°ï¼Œç”¨ä½œåˆå§‹åŒ–å‘é‡ã€‚`AES-CTR` åŠ å¯†/è§£å¯†å¯ä»¥å¹¶è¡Œã€‚
- `AES-CBC`ï¼š`AES` çš„å¯†ç åˆ†ç»„é“¾æ¨¡å¼ï¼ˆ`cipher block chaining mode`ï¼‰ã€‚åœ¨åŠ å¯†çº¯æ–‡æœ¬çš„æ¯ä¸ªåˆ†ç»„ä¹‹å‰ï¼Œå…ˆä½¿ç”¨ä¹‹å‰çš„å¯†æ–‡åˆ†ç»„æ±‚ `XOR`ï¼Œä¹Ÿå°±æ˜¯åå­—ä¸­çš„â€œé“¾â€ã€‚ä½¿ç”¨ä¸€ä¸ªåˆå§‹åŒ–å‘é‡ä½œä¸ºç¬¬ä¸€ä¸ªåˆ†ç»„çš„ `XOR` è¾“å…¥ã€‚
- `AES-GCM`ï¼š`AES` çš„ä¼½ç½—ç“¦/è®¡æ•°å™¨æ¨¡å¼ï¼ˆ`Galois/Counter mode`ï¼‰ã€‚è¿™ä¸ªæ¨¡å¼ä½¿ç”¨è®¡æ•°å™¨å’Œåˆå§‹åŒ–å‘é‡ç”Ÿæˆä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼ä¼šä¸æ¯ä¸ªåˆ†ç»„çš„çº¯æ–‡æœ¬è®¡ç®— `XOR`ã€‚ä¸ `CBC` ä¸åŒï¼Œè¿™ä¸ªæ¨¡å¼çš„ `XOR` è¾“å…¥ä¸ä¾èµ–ä¹‹å‰åˆ†ç»„çš„å¯†æ–‡ã€‚å› æ­¤ `GCM` æ¨¡å¼å¯ä»¥å¹¶è¡Œã€‚ç”±äºå…¶å“è¶Šçš„æ€§èƒ½ï¼Œ`AES-GCM` åœ¨å¾ˆå¤šç½‘ç»œå®‰å…¨åè®®ä¸­éƒ½å¾—åˆ°äº†åº”ç”¨ã€‚
- `AES-KW`ï¼š`AES` çš„å¯†é’¥åŒ…è£…æ¨¡å¼ï¼ˆ`key wrapping mode`ï¼‰ã€‚è¿™ä¸ªç®—æ³•å°†åŠ å¯†å¯†é’¥åŒ…è£…ä¸ºä¸€ä¸ªå¯ç§»æ¤ä¸”åŠ å¯†çš„æ ¼å¼ï¼Œå¯ä»¥åœ¨ä¸ä¿¡ä»»çš„æ¸ é“ä¸­ä¼ è¾“ã€‚ä¼ è¾“ä¹‹åï¼Œæ¥æ”¶æ–¹å¯ä»¥è§£åŒ…å¯†é’¥ã€‚ä¸å…¶ä»– `AES` æ¨¡å¼ä¸åŒï¼Œ`AES-KW` ä¸éœ€è¦åˆå§‹åŒ–å‘é‡ã€‚
- `HMAC`ï¼ˆ`Hash-Based Message Authentication Code`ï¼‰ï¼šç”¨äºç”Ÿæˆæ¶ˆæ¯è®¤è¯ç çš„ç®—æ³•ï¼Œç”¨äºéªŒè¯é€šè¿‡ä¸å¯ä¿¡ç½‘ç»œæ¥æ”¶çš„æ¶ˆæ¯æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚ä¸¤æ–¹ä½¿ç”¨æ•£åˆ—å‡½æ•°å’Œå…±äº«ç§é’¥æ¥ç­¾åå’ŒéªŒè¯æ¶ˆæ¯ã€‚
- `KDF`ï¼ˆ`Key Derivation Functions`ï¼‰ï¼šå¯ä»¥ä½¿ç”¨æ•£åˆ—å‡½æ•°ä»ä¸»å¯†é’¥è·å¾—ä¸€ä¸ªæˆ–å¤šä¸ªå¯†é’¥çš„ç®—æ³•ã€‚`KDF` èƒ½å¤Ÿç”Ÿæˆä¸åŒé•¿åº¦çš„å¯†é’¥ï¼Œä¹Ÿèƒ½æŠŠå¯†é’¥è½¬æ¢ä¸ºä¸åŒæ ¼å¼ã€‚
- `HKDF`ï¼ˆ`HMAC-Based Key Derivation Function`ï¼‰ï¼šå¯†é’¥æ¨å¯¼å‡½æ•°ï¼Œä¸é«˜ç†µè¾“å…¥ï¼ˆå¦‚ï¼šå·²æœ‰å¯†é’¥ï¼‰ä¸€èµ·ä½¿ç”¨ã€‚
- `PBKDF2`ï¼ˆ`Password-Based Key Derivation Function 2`ï¼‰ï¼šå¯†é’¥æ¨å¯¼å‡½æ•°ï¼Œä¸ä½ç†µè¾“å…¥ï¼ˆå¦‚ï¼šå¯†é’¥å­—ç¬¦ä¸²ï¼‰ä¸€èµ·ä½¿ç”¨ã€‚

â€‹		æ³¨æ„ï¼š`CryptoKey` æ”¯æŒå¾ˆå¤šç®—æ³•ï¼Œä½†å…¶ä¸­åªæœ‰éƒ¨åˆ†ç®—æ³•èƒ½å¤Ÿç”¨äº `SubtleCrypto` çš„æ–¹æ³•ã€‚è¦äº†è§£å“ªä¸ªæ–¹æ³•æ”¯æŒä»€ä¹ˆç®—æ³•ï¼Œå¯ä»¥å‚è€ƒ `W3C` ç½‘ç«™ä¸Š `Web Cryptography API` è§„èŒƒçš„ `â€œAlgorithm Overviewâ€`ã€‚

â€‹		ä¸Šè¿°åŠ å¯†ç®—æ³•ä¸­ï¼Œ

- `RSA` å’Œ `ECC` éƒ½æ˜¯éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯¹åº”çš„æ“ä½œæ˜¯ï¼šç­¾åæ¶ˆæ¯å’ŒéªŒè¯æ¶ˆæ¯ã€‚
- `AES` æ˜¯å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯¹åº”çš„æ“ä½œæ˜¯ï¼šåŠ å¯†æ¶ˆæ¯å’Œè§£å¯†æ¶ˆæ¯ã€‚

##### ç”Ÿæˆ `CryptoKey`

â€‹		ä½¿ç”¨ `SubtleCrypto.generateKey()` æ–¹æ³•å¯ä»¥ç”Ÿæˆéšæœº `CryptoKey`ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªæœŸçº¦ï¼Œè§£å†³ä¸ºä¸€ä¸ªæˆ–å¤šä¸ª `CryptoKey` å®ä¾‹ã€‚ä½¿ç”¨æ—¶éœ€è¦ç»™è¿™ä¸ªæ–¹æ³•ä¾æ¬¡ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼šä¸€ä¸ªæŒ‡å®šç›®æ ‡ç®—æ³•çš„å‚æ•°å¯¹è±¡ã€ä¸€ä¸ªè¡¨ç¤ºå¯†é’¥æ˜¯å¦å¯ä»¥ä» `CryptoKey` å¯¹è±¡ä¸­æå–å‡ºæ¥çš„å¸ƒå°”å€¼ï¼Œä»¥åŠä¸€ä¸ªè¡¨ç¤ºè¿™ä¸ªå¯†é’¥å¯ä»¥ä¸å“ªä¸ª `SubtleCrypto` æ–¹æ³•ä¸€èµ·ä½¿ç”¨çš„å­—ç¬¦ä¸²æ•°ç»„ï¼ˆ`keyUsages`ï¼‰ã€‚

â€‹		ç”±äºä¸åŒçš„å¯†ç ç³»ç»Ÿéœ€è¦ä¸åŒçš„è¾“å…¥æ¥ç”Ÿæˆå¯†é’¥ï¼Œä¸Šè¿°çš„é¦–å‚å‚æ•°å¯¹è±¡ä¸ºæ¯ç§å¯†ç ç³»ç»Ÿéƒ½è§„å®šäº†å¿…éœ€çš„è¾“å…¥ï¼š

- `RSA` å¯†ç ç³»ç»Ÿä½¿ç”¨ `RsaHashedKeyGenParams` å¯¹è±¡ï¼›
- `ECC` å¯†ç ç³»ç»Ÿä½¿ç”¨ `EcKeyGenParams` å¯¹è±¡ï¼›
- `HMAC` å¯†ç ç³»ç»Ÿä½¿ç”¨ `HmacKeyGenParams` å¯¹è±¡ï¼›
- `AES` å¯†ç ç³»ç»Ÿä½¿ç”¨ `AesKeyGenParams` å¯¹è±¡ã€‚

â€‹		`keyUsages` å¯¹è±¡ç”¨äºè¯´æ˜å¯†é’¥å¯ä»¥ä¸å“ªä¸ªç®—æ³•ä¸€èµ·ä½¿ç”¨ã€‚è‡³å°‘è¦åŒ…å«ä¸‹åˆ—ä¸­çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼š

- `encrypt`
- `decrypt`
- `sign`
- `verify`
- `deriveKey`
- `deriveBits`
- `wrapKey`
- `unwrapKey`

â€‹		å‡è®¾è¦ç”Ÿæˆä¸€ä¸ªæ»¡è¶³å¦‚ä¸‹æ¡ä»¶çš„å¯¹ç§°å¯†é’¥ï¼š

- æ”¯æŒ `AES-CTR` ç®—æ³•ï¼›
- å¯†é’¥é•¿åº¦ 128 ä½ï¼›
- ä¸èƒ½ä» `CryptoKey` å¯¹è±¡ä¸­æå–ï¼›
- å¯ä»¥è·Ÿ `encrypt()` å’Œ `decrypt()` æ–¹æ³•ä¸€èµ·ä½¿ç”¨ã€‚

â€‹		é‚£ä¹ˆå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š

```js
(async function() {
 	const params = { 
 		name: 'AES-CTR', 
 		length: 128 
 	}; 
    
 	const keyUsages = ['encrypt', 'decrypt']; 
    
 	const key = await crypto.subtle.generateKey(params, false, keyUsages); 
    
 	console.log(key); // CryptoKeyÂ {type: 'secret', extractable: false, algorithm: {â€¦}, usages: Array(2)}
})();

/*
CryptoKeyÂ {
	algorithm: {name: 'AES-CTR', length: 128}, 	// ç®—æ³•
	extractable: false, 						// æ˜¯å¦å¯æŠ½å–
	type: 'secret', 
	usages: ['encrypt', 'decrypt']
}
*/
```

â€‹		å‡è®¾è¦ç”Ÿæˆä¸€ä¸ªæ»¡è¶³å¦‚ä¸‹æ¡ä»¶çš„éå¯¹ç§°å¯†é’¥ï¼š

- æ”¯æŒ `ECDSA` ç®—æ³•ï¼›
- ä½¿ç”¨ `P-256` æ¤­åœ†æ›²çº¿ï¼›
- å¯ä»¥ä» `CryptoKey` ä¸­æå–ï¼›
- å¯ä»¥è·Ÿ `sign()` å’Œ `verify()` æ–¹æ³•ä¸€èµ·ä½¿ç”¨ã€‚

â€‹		é‚£ä¹ˆå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š

```js
(async function() {
 	const params = { 
 		name: 'ECDSA', 
 		namedCurve: 'P-256' 
 	}; 
    
 	const keyUsages = ['sign', 'verify']; 
 	const {publicKey, privateKey} = await crypto.subtle.generateKey(params, true, keyUsages);
    
    console.log(publicKey); 
    // CryptoKeyÂ {type: 'public', extractable: true, algorithm: {â€¦}, usages: Array(1)}
    
 	console.log(privateKey); 
    // CryptoKeyÂ {type: 'private', extractable: true, algorithm: {â€¦}, usages: Array(1)}
})();
```

â€‹		æ›´å¤šå‚è€ƒï¼š[`SubtleCrypto.generateKey()`](https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/generateKey) 

##### å¯¼å‡ºå’Œå¯¼å…¥å¯†é’¥

â€‹		å¦‚æœå¯†é’¥æ˜¯å¯æå–çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨ `CryptoKey` å¯¹è±¡å†…éƒ¨æš´éœ²å¯†é’¥åŸå§‹çš„äºŒè¿›åˆ¶å†…å®¹ã€‚ä½¿ç”¨ `exportKey()` æ–¹æ³•ä¼ å…¥ `CryptoKey` å®ä¾‹å¹¶æŒ‡å®šç›®æ ‡æ ¼å¼ï¼ˆ`"raw"`ã€`"pkcs8"`ã€`"spki"` æˆ– `"jwk"`ï¼‰å°±å¯ä»¥ä»ä¸­å–å¾—å¯†é’¥ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªæœŸçº¦ï¼Œè§£å†³åçš„ `ArrayBuffer` ä¸­åŒ…å«å¯†é’¥ï¼š

```js
(async function() { 
 	const params = { 
 		name: 'AES-CTR', 
 		length: 128 
 	}; 
    
 	const keyUsages = ['encrypt', 'decrypt']; 
 	const key = await crypto.subtle.generateKey(params, true, keyUsages); 
 	const rawKey = await crypto.subtle.exportKey('raw', key); 
    
 	console.log(new Uint8Array(rawKey)); 
 	// Uint8Array(16)Â [97, 213, 131, 161, 150, 106, 213, 90, 185, 100, 169, 54, 13, 207, 30, 156]
})();
```

â€‹		ä¸ `exportKey()` ç›¸åçš„æ“ä½œä½¿ç”¨ `importKey()` æ–¹æ³•å®ç°ã€‚`importKey()` æ–¹æ³•çš„ç­¾åå®é™…ä¸Šæ˜¯ `generateKey()` å’Œ `exportKey()` çš„ç»„åˆã€‚ä¸‹é¢çš„æ–¹æ³•ä¼šç”Ÿæˆå¯†é’¥ã€å¯¼å‡ºå¯†é’¥ï¼Œç„¶åå†å¯¼å…¥å¯†é’¥ï¼š

```js
(async function() { 
 	const params = { 
 		name: 'AES-CTR', 
 		length: 128 
 	}; 
    
 	const keyUsages = ['encrypt', 'decrypt']; 
 	const keyFormat = 'raw'; 
 	const isExtractable = true; 
    
 	const key = await crypto.subtle.generateKey(params, isExtractable, keyUsages); 
    
 	const rawKey = await crypto.subtle.exportKey(keyFormat, key); 
    
 	const importedKey = await crypto.subtle.importKey(keyFormat, rawKey, params.name, isExtractable, keyUsages); 
    
 	console.log(importedKey); 
 	// CryptoKeyÂ {type: 'secret', extractable: true, algorithm: {â€¦}, usages: Array(2)}
})();
```

â€‹		æ³¨æ„ï¼š`key` ä¸ `importedKey` çš„å†…å®¹å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¯¹è±¡ã€‚

##### ä»ä¸»å¯†é’¥æ´¾ç”Ÿå¯†é’¥

â€‹		ä½¿ç”¨ `SubtleCrypto` å¯¹è±¡å¯é€šè¿‡å¯é…ç½®çš„å±æ€§ä»å·²æœ‰çš„å¯†é’¥æ´¾ç”Ÿå‡ºæ–°çš„å¯†é’¥ã€‚`SubtleCrypto` æ”¯æŒä¸€ä¸ª `deriveKey()` æ–¹æ³•å’Œä¸€ä¸ª `deriveBits()` æ–¹æ³•ï¼Œå‰è€…è¿”å›ä¸€ä¸ªè§£å†³ä¸º `CryptoKey` çš„æœŸçº¦ï¼Œåè€…è¿”å›ä¸€ä¸ªè§£å†³ä¸º `ArrayBuffer` çš„æœŸçº¦ã€‚

â€‹		æ³¨æ„ï¼š`deriveKey()` ä¸ `deriveBits()` çš„åŒºåˆ«å¾ˆå¾®å¦™ï¼Œå› ä¸ºè°ƒç”¨ `deriveKey()` å®é™…ä¸Šä¸è°ƒç”¨ `deriveBits()` ä¹‹åå†æŠŠç»“æœä¼ ç»™ `importKey()` ç›¸åŒã€‚

â€‹		`deriveBits()` æ–¹æ³•æ¥æ”¶ä¸€ä¸ªç®—æ³•å‚æ•°å¯¹è±¡ã€ä¸»å¯†é’¥å’Œè¾“å‡ºçš„ä½é•¿ä½œä¸ºå‚æ•°ã€‚å½“ä¸¤ä¸ªäººåˆ†åˆ«æ‹¥æœ‰è‡ªå·±çš„å¯†é’¥å¯¹ï¼Œä½†å¸Œæœ›è·å¾—å…±äº«çš„åŠ å¯†å¯†é’¥æ—¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚ä¸‹é¢çš„ä¾‹å­ä½¿ç”¨ `ECDH` ç®—æ³•åŸºäºä¸¤ä¸ªå¯†é’¥å¯¹ç”Ÿæˆäº†å¯¹ç­‰å¯†é’¥ï¼Œå¹¶ç¡®ä¿å®ƒä»¬æ´¾ç”Ÿç›¸åŒçš„å¯†é’¥ä½ï¼š

```js
(async function() { 
 	const ellipticCurve = 'P-256'; 	// æ¤­åœ†æ›²çº¿
 	const algoIdentifier = 'ECDH'; 	// ç®—æ³•æ ‡è¯†ç¬¦
 	const derivedKeySize = 128; 	// æ´¾ç”Ÿå¯†é’¥ä½
 	const params = { 
 		name: algoIdentifier, 
 		namedCurve: ellipticCurve 
 	}; 
 	const keyUsages = ['deriveBits']; 
    
 	const keyPairA = await crypto.subtle.generateKey(params, true, keyUsages); 
 	const keyPairB = await crypto.subtle.generateKey(params, true, keyUsages); 
    
 	// ä» A çš„å…¬é’¥å’Œ B çš„ç§é’¥ä¸­æ´¾ç”Ÿå¯†é’¥
 	const derivedBitsAB = await crypto.subtle.deriveBits(
		Object.assign({ public: keyPairA.publicKey }, params), // {public: keyPairA.publicKey, ...params}
 		keyPairB.privateKey, 
 		derivedKeySize
    ); 
    
 	// ä» B çš„å…¬é’¥å’Œ A çš„ç§é’¥ä¸­æ´¾ç”Ÿå¯†é’¥
 	const derivedBitsBA = await crypto.subtle.deriveBits(
 		Object.assign({ public: keyPairB.publicKey }, params), 
 		keyPairA.privateKey, 
 		derivedKeySize
    ); 
    
    // ç”Ÿæˆçš„ä¸¤ä¸ªæ–°å¯†é’¥ï¼šarrayABå’ŒarrayBAäºŒè€…å†…å®¹å®Œå…¨ç›¸åŒ
 	const arrayAB = new Uint32Array(derivedBitsAB); 
 	const arrayBA = new Uint32Array(derivedBitsBA); 
    
 	// ç¡®ä¿å¯†é’¥æ•°ç»„ç›¸ç­‰
 	console.log(arrayAB.length === arrayBA.length && arrayAB.every((v, i) => v === arrayBA[i])); // true 
})();
```

â€‹		`deriveKey()` æ–¹æ³•æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯ `CryptoKey` çš„å®ä¾‹è€Œä¸æ˜¯ `ArrayBuffer`ã€‚ä¸‹é¢çš„ä¾‹å­åŸºäºä¸€ä¸ªåŸå§‹å­—ç¬¦ä¸²ï¼Œåº”ç”¨ `PBKDF2` ç®—æ³•å°†å…¶å¯¼å…¥ä¸€ä¸ªåŸå§‹ä¸»å¯†é’¥ï¼Œç„¶åæ´¾ç”Ÿäº†ä¸€ä¸ª `AES-GCM` æ ¼å¼çš„æ–°å¯†é’¥ï¼š

```js
(async function() { 
 	const password = 'foobar'; 
 	const salt = crypto.getRandomValues(new Uint8Array(16)); 
 	const algoIdentifier = 'PBKDF2'; 
 	const keyFormat = 'raw'; 
 	const isExtractable = false; 
 	const params = {
      	name: algoIdentifier 
 	};
    
    // ä¸»å¯†é’¥
 	const masterKey = await window.crypto.subtle.importKey( 
 		keyFormat, 
 		(new TextEncoder()).encode(password), 
 		params, 
 		isExtractable, 
 		['deriveKey'] 
 	); 
    
 	const deriveParams = { 
 		name: 'AES-GCM', 
 		length: 128 
 	}; 
    
    // æ´¾ç”Ÿå¯†é’¥
 	const derivedKey = await window.crypto.subtle.deriveKey( 
 		Object.assign({salt, iterations: 1E5, hash: 'SHA-256'}, params), 
 		masterKey, 
 		deriveParams, 
 		isExtractable, 
 		['encrypt']
 	);
    
 	console.log(derivedKey); 
    // CryptoKeyÂ {type: 'secret', extractable: false, algorithm: {â€¦}, usages: Array(1)}
})();

/*
CryptoKeyÂ {
	algorithm: {name: 'AES-GCM', length: 128},
	extractable: false, 
	type: 'secret', 
	usages: ['encrypt']
}
*/
```

##### éå¯¹ç§°å¯†é’¥ç­¾åå’ŒéªŒè¯æ¶ˆæ¯

â€‹		é€šè¿‡ `SubtleCrypto` å¯¹è±¡å¯ä»¥ä½¿ç”¨å…¬é’¥ç®—æ³•ç”¨ç§é’¥ç”Ÿæˆç­¾åï¼Œæˆ–è€…ç”¨å…¬é’¥éªŒè¯ç­¾åã€‚è¿™ä¸¤ç§æ“ä½œåˆ†åˆ«é€šè¿‡ `SubtleCrypto.sign()` å’Œ `SubtleCrypto.verify()` æ–¹æ³•å®Œæˆã€‚ã€`sign`ï¼šç­¾åï¼›`verify`ï¼šéªŒè¯ã€‘

â€‹		ç­¾åæ¶ˆæ¯éœ€è¦ä¼ å…¥ä¸€ä¸ªå‚æ•°å¯¹è±¡ä»¥æŒ‡å®šç®—æ³•å’Œå¿…è¦çš„å€¼ã€ä¸€ä¸ªç§é’¥å’Œä¸€ä¸ªè¦ç­¾åçš„ `ArrayBuffer` æˆ– `ArrayBufferView`ã€‚ä¸‹é¢çš„ä¾‹å­ä¼šç”Ÿæˆä¸€ä¸ªæ¤­åœ†æ›²çº¿å¯†é’¥å¯¹ï¼Œå¹¶ä½¿ç”¨ç§é’¥ç­¾åæ¶ˆæ¯ï¼š

```js
(async function() { 
 	const keyParams = { 
 		name: 'ECDSA', 
 		namedCurve: 'P-256' 
 	}; 
    
 	const keyUsages = ['sign', 'verify']; 
    
 	const {publicKey, privateKey} = await crypto.subtle.generateKey(keyParams, true, keyUsages); 
    
 	const message = (new TextEncoder()).encode('I am Satoshi Nakamoto'); 
    
 	const signParams = { 
 		name: 'ECDSA', 
 		hash: 'SHA-256' 
 	}; 
    
 	const signature = await crypto.subtle.sign(signParams, privateKey, message); // ArrayBuffer
    
 	console.log(new Uint32Array(signature)); 
 	// Uint32Array(16)Â [585798599, 2795372323, 954752990, 3860631372, 742469050, 4039991331, ...]
})();
```

â€‹		å¸Œæœ›é€šè¿‡è¿™ä¸ªç­¾åéªŒè¯æ¶ˆæ¯çš„äººå¯ä»¥ä½¿ç”¨å…¬é’¥å’Œ `SubtleCrypto.verify()` æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„ç­¾åå‡ ä¹ä¸ `sign()` ç›¸åŒï¼Œåªæ˜¯å¿…é¡»æä¾›å…¬é’¥ä»¥åŠç­¾åã€‚ä¸‹é¢çš„ä¾‹å­é€šè¿‡éªŒè¯ç”Ÿæˆçš„ç­¾åæ‰©å±•äº†å‰é¢çš„ä¾‹å­ï¼š

```js
(async function() { 
 	const keyParams = { 
 		name: 'ECDSA', 
 		namedCurve: 'P-256' 
 	}; 
 	const keyUsages = ['sign', 'verify']; 
 	const {publicKey, privateKey} = await crypto.subtle.generateKey(keyParams, true, keyUsages); 
 	const message = (new TextEncoder()).encode('I am Satoshi Nakamoto'); 
 	const signParams = { 
 		name: 'ECDSA', 
 		hash: 'SHA-256' 
 	}; 
    
 	const signature = await crypto.subtle.sign(signParams, privateKey, message); 
 	const verified = await crypto.subtle.verify(signParams, publicKey, signature, message); 
    
 	console.log(verified); // true 
})();
```

##### å¯¹ç§°å¯†é’¥åŠ å¯†å’Œè§£å¯†æ¶ˆæ¯

â€‹		`SubtleCrypto` å¯¹è±¡æ”¯æŒä½¿ç”¨å…¬é’¥å’Œå¯¹ç§°ç®—æ³•æ¥åŠ å¯†å’Œè§£å¯†æ¶ˆæ¯ã€‚ä½¿ç”¨ `SubtleCrypto.encrypt()` å’Œ `SubtleCrypto.decrypt()` æ–¹æ³•å®Œæˆã€‚ã€`encrypt`ï¼šåŠ å¯†ï¼›`decrypt`ï¼šè§£å¯†ã€‘

â€‹		åŠ å¯†æ¶ˆæ¯éœ€è¦ä¼ å…¥å‚æ•°å¯¹è±¡ä»¥æŒ‡å®šç®—æ³•å’Œå¿…è¦çš„å€¼ã€åŠ å¯†å¯†é’¥å’Œè¦åŠ å¯†çš„æ•°æ®ã€‚ä¸‹é¢çš„ä¾‹å­ä¼šç”Ÿæˆå¯¹ç§° `AES-CBC` å¯†é’¥ï¼Œç”¨å®ƒåŠ å¯†æ¶ˆæ¯ï¼Œæœ€åè§£å¯†æ¶ˆæ¯ï¼š

```js
(async function() { 
 	const algoIdentifier = 'AES-CBC'; 
 	const keyParams = { 
 		name: algoIdentifier, 
 		length: 256 
 	}; 
 	const keyUsages = ['encrypt', 'decrypt']; 
    
    // åŠ å¯†å¯†é’¥
 	const key = await crypto.subtle.generateKey(keyParams, true, keyUsages); 
    // åŸå§‹æ•°æ®
 	const originalPlaintext = (new TextEncoder()).encode('I am Satoshi Nakamoto'); 
    // å‚æ•°å¯¹è±¡
 	const encryptDecryptParams = { 
 		name: algoIdentifier, 
 		iv: crypto.getRandomValues(new Uint8Array(16)) 
 	}; 
    
    // ç”Ÿæˆå¯†æ–‡
 	const ciphertext = await crypto.subtle.encrypt(encryptDecryptParams, key, originalPlaintext);
    
    console.log(ciphertext); // ArrayBuffer(32) {} 
    
    // è§£å¯†å¯†æ–‡
 	const decryptedPlaintext = await crypto.subtle.decrypt(encryptDecryptParams, key, ciphertext); 
 
    console.log((new TextDecoder()).decode(decryptedPlaintext)); // 'I am Satoshi Nakamoto'
})();
```

##### åŒ…è£…å’Œè§£åŒ…å¯†é’¥

â€‹		`SubtleCrypto` å¯¹è±¡æ”¯æŒåŒ…è£…å’Œè§£åŒ…å¯†é’¥ï¼Œä»¥ä¾¿å¯†é’¥å¯ä»¥åœ¨éä¿¡ä»»çš„æ¸ é“ä¸­ä¼ è¾“ã€‚è¿™ä¸¤ç§æ“ä½œåˆ†åˆ«é€šè¿‡ `SubtleCrypto.wrapKey()` å’Œ `SubtleCrypto.unwrapKey()` æ–¹æ³•å®Œæˆã€‚

â€‹		åŒ…è£…å¯†é’¥éœ€è¦ä¼ å…¥ä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ã€è¦åŒ…è£…çš„ `CryptoKey` å®ä¾‹ã€æ‰§è¡ŒåŒ…è£…çš„ `CryptoKey`ï¼Œä»¥åŠä¸€ä¸ªå‚æ•°å¯¹è±¡ç”¨äºæŒ‡å®šç®—æ³•å’Œå¿…è¦çš„å€¼ã€‚ä¸‹é¢çš„ä¾‹å­ç”Ÿæˆäº†ä¸€ä¸ªå¯¹ç§° `AES-GCM` å¯†é’¥ï¼Œç”¨ `AES-KW` æ¥åŒ…è£…è¿™ä¸ªå¯†é’¥ï¼Œæœ€ååˆå°†åŒ…è£…çš„å¯†é’¥è§£åŒ…ï¼š

```js
(async function() { 
 	const keyFormat = 'raw'; 
 	const extractable = true; 
    
 	const wrappingKeyAlgoIdentifier = 'AES-KW'; 
 	const wrappingKeyUsages = ['wrapKey', 'unwrapKey']; 
 	const wrappingKeyParams = { 
 		name: wrappingKeyAlgoIdentifier, 
 		length: 256 
 	}; 
    
 	const keyAlgoIdentifier = 'AES-GCM'; 
 	const keyUsages = ['encrypt']; 
 	const keyParams = { 
 		name: keyAlgoIdentifier, 
 		length: 256 
 	}; 
    
    // æ‰§è¡ŒåŒ…è£…çš„å¯†é’¥
 	const wrappingKey = await crypto.subtle.generateKey(wrappingKeyParams, extractable, wrappingKeyUsages); 
    console.log(wrappingKey); 
 	// CryptoKey {type: "secret", extractable: true, algorithm: {...}, usages: Array(2)} 
 
   	// è¦åŒ…è£…çš„å¯†é’¥
    const key = await crypto.subtle.generateKey(keyParams, extractable, keyUsages); 
    console.log(key); 
 	// CryptoKey {type: "secret", extractable: true, algorithm: {...}, usages: Array(1)} 
 	
    // å·²åŒ…è£…çš„å¯†é’¥
    const wrappedKey = await crypto.subtle.wrapKey(keyFormat, key, wrappingKey, wrappingKeyAlgoIdentifier); 
    console.log(wrappedKey); // ArrayBuffer(40) {} 
 
    // å·²è§£åŒ…çš„å¯†é’¥
    const unwrappedKey = await crypto.subtle.unwrapKey(
        keyFormat, wrappedKey, wrappingKey, wrappingKeyParams, keyParams, extractable, keyUsages
    ); 
    console.log(unwrappedKey); 
 	// CryptoKey {type: "secret", extractable: true, algorithm: {...}, usages: Array(1)} 
})()
```

â€‹		å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨åŒ…è£…å’Œè§£åŒ…å¯†é’¥çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜éœ€è¦å€ŸåŠ©ä¸€ä¸ªé¢å¤–çš„å¯†é’¥æ¥æ‰§è¡ŒåŒ…è£…å’Œè§£åŒ…ã€‚



### å°ç»“

â€‹		é™¤äº†å®šä¹‰æ–°æ ‡ç­¾ï¼Œ`HTML5` è¿˜å®šä¹‰äº†ä¸€äº› `JavaScript API`ã€‚è¿™äº› `API` å¯ä»¥ä¸ºå¼€å‘è€…æä¾›æ›´ä¾¿æ·çš„ `Web` æ¥å£ï¼Œæš´éœ²å ªæ¯”æ¡Œé¢åº”ç”¨çš„èƒ½åŠ›ã€‚æœ¬ç« ä¸»è¦ä»‹ç»äº†ä»¥ä¸‹ `API`ã€‚

- `Atomics API` ç”¨äºä¿æŠ¤ä»£ç åœ¨å¤šçº¿ç¨‹å†…å­˜è®¿é—®æ¨¡å¼ä¸‹ä¸å‘ç”Ÿèµ„æºäº‰ç”¨ã€‚
- `postMessage() API` æ”¯æŒä»ä¸åŒæºè·¨æ–‡æ¡£å‘é€æ¶ˆæ¯ï¼ŒåŒæ—¶ä¿è¯å®‰å…¨å’Œéµå¾ªåŒæºç­–ç•¥ã€‚
- `Encoding API` ç”¨äºå®ç°å­—ç¬¦ä¸²ä¸ç¼“å†²åŒºä¹‹é—´çš„æ— ç¼è½¬æ¢ï¼ˆè¶Šæ¥è¶Šå¸¸è§çš„æ“ä½œï¼‰ã€‚
- `File API` æä¾›äº†å‘é€ã€æ¥æ”¶å’Œè¯»å–å¤§å‹äºŒè¿›åˆ¶å¯¹è±¡çš„å¯é å·¥å…·ã€‚
- åª’ä½“å…ƒç´  `<audio>` å’Œ `<video>` æ‹¥æœ‰è‡ªå·±çš„ `API`ï¼Œç”¨äºæ“ä½œéŸ³é¢‘å’Œè§†é¢‘ã€‚å¹¶ä¸æ˜¯æ¯ä¸ªæµè§ˆå™¨éƒ½ä¼šæ”¯æŒæ‰€æœ‰åª’ä½“æ ¼å¼ï¼Œä½¿ç”¨ `canPlayType()` æ–¹æ³•å¯ä»¥æ£€æµ‹æµè§ˆå™¨æ”¯æŒæƒ…å†µã€‚
- æ‹–æ”¾ `API` æ”¯æŒæ–¹ä¾¿åœ°å°†å…ƒç´ æ ‡è¯†ä¸ºå¯æ‹–åŠ¨ï¼Œå¹¶åœ¨æ“ä½œç³»ç»Ÿå®Œæˆæ”¾ç½®æ—¶ç»™å‡ºå›åº”ã€‚å¯ä»¥åˆ©ç”¨å®ƒåˆ›å»ºè‡ªå®šä¹‰å¯æ‹–åŠ¨å…ƒç´ å’Œæ”¾ç½®ç›®æ ‡ã€‚
- `Notifications API` æä¾›äº†ä¸€ç§æµè§ˆå™¨ä¸­ç«‹çš„æ–¹å¼ï¼Œä»¥æ­¤å‘ç”¨æˆ·å±•ç¤ºæ¶ˆé€šçŸ¥å¼¹å±‚ã€‚
- `Streams API` æ”¯æŒä»¥å…¨æ–°çš„æ–¹å¼è¯»å–ã€å†™å…¥å’Œå¤„ç†æ•°æ®ã€‚
- `Timing API` æä¾›äº†ä¸€ç»„åº¦é‡æ•°æ®è¿›å‡ºæµè§ˆå™¨æ—¶é—´çš„å¯é å·¥å…·ã€‚
- `Web Components API` ä¸ºå…ƒç´ é‡ç”¨å’Œå°è£…æŠ€æœ¯å‘å‰è¿ˆè¿›æä¾›äº†æœ‰åŠ›æ”¯æ’‘ã€‚
- `Web Cryptography API` è®©ç”Ÿæˆéšæœºæ•°ã€åŠ å¯†å’Œç­¾åæ¶ˆæ¯æˆä¸ºä¸€ç±»ç‰¹æ€§ã€‚

