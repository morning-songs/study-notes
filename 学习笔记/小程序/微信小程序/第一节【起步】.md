# 微信小程序

​		小程序是一种不需要下载安装即可使用的应用，它实现了应用 “触手可及” 的梦想，用户扫一扫或者搜一下即可打开应用。也体现了 “用完即走” 的理念，用户不用关心是否安装太多应用的问题。应用将无处不在，随时可用，但又无需安装卸载。

​		小程序（`Mini Program`）的主要优势：对于开发者来说，小程序开发门槛相对较低，难度不及 `APP`，能够满足简单的基础应用，适合生活服务类线下商铺以及非刚需低频应用的转换。对于用户来说，能够节约使用时间成本和手机内存空间；对于运营者来说，也能节约开发和推广成本。

​		小程序主要拥有以下的 7 个功能：包括线下扫码、对话分享、消息通知、小程序切换、历史列表、公众号关联和搜索查找。

- 线下扫码：用户可以在小程序中使用扫一扫。
- 对话分享：用户可以分享小程序或其中的任何一个页面给好友或群聊。
- 消息通知：商户可以发送模板消息给接受过服务的用户，用户可以在小程序内联系客服，支持文字和图片。
- 小程序切换：用户可以在使用小程序的过程中快速返回聊天。
- 历史列表：用户使用过的小程序会被放入列表，方便下次使用。
- 公众号关联：微信小程序可与公众号进行关联。
- 搜索查找：用户可直接根据名称或品牌搜索小程序。
- 识别二维码：用户可长按识别二维码进入小程序。
- 第三方平台：让商户的小程序开发更省心，也方便第三方批量管理商户。
- 附近小程序：用户可以在微信中快速找到附近的小程序和服务，同时也能够帮助线下商户更直接地触达用户，让小程序融入更多生活场景。
- 定义关键字：为方便用户找到所需小程序，并帮助小程序更准确地触达用户，我们向小程序的开发者提供了自定义关键词的功能。
- 打开应用：支持在小程序中打开相关的应用 `App`，或前往其他的小程序。
- 小程序直播：用户可以在小程序中进行直播或观看直播。



### 起步

#### 简介

​		小程序是一种全新的连接用户与服务的方式，它可以在微信内被便捷地获取和传播，同时具有出色的使用体验。

​		市面上的小程序有很多，比如：百度小程序、抖音小程序、微信小程序等等。得益于微信 `app`，微信小程序是使用者最多的。

##### 小程序技术发展史

​		小程序并非凭空冒出来的一个概念。当微信中的 `WebView` 逐渐成为移动 `Web` 的一个重要入口时，微信就有相关的 `JS API` 了。

​		使用 `WeixinJSBridge` 预览图片：

```js
WeixinJSBridge.invoke('imagePreview', {
    current: 'http://inews.gtimg.com/newsapp_bt/0/1693121381/641',
    urls: [ // 所有图片的 URL 列表，数组格式
        'https://img1.gtimg.com/10/1048/104857/10485731_980x1200_0.jpg',
        'https://img1.gtimg.com/10/1048/104857/10485726_980x1200_0.jpg',
        'https://img1.gtimg.com/10/1048/104857/10485729_980x1200_0.jpg'
    ]
}, function(res) {
    console.log(res.err_msg)
})
```

​		上述代码是一个调用微信原生组件浏览图片的 `JS API`，相比于额外引入一个 `JS` 图片预览组件库，这种调用方式显得非常简洁和高效。

​		实际上，微信官方是没有对外暴露过如此调用的，此类 `API` 最初是提供给腾讯内部一些业务使用，很多外部开发者发现了之后，依葫芦画瓢地使用了，逐渐成为微信中网页的事实标准。2015年初，微信发布了一整套网页开发工具包，称之为 **`JS-SDK`**，开放了拍摄、录音、语音识别、二维码、地图、支付、分享、卡券等几十个 `API`。给所有的 `Web` 开发者打开了一扇全新的窗户，让所有开发者都可以使用到微信的原生能力，去完成一些之前做不到或者难以做到的事情。

​		同样是调用原生的浏览图片，调用方式如下述代码所示。

​		使用 `JS-SDK` 调用图片预览组件：

```js
wx.previewImage({
  	current: 'https://img1.gtimg.com/10/1048/104857/10485726_980x1200_0.jpg',
  	urls: [ // 所有图片的 URL 列表，数组格式
    	'https://img1.gtimg.com/10/1048/104857/10485731_980x1200_0.jpg',
    	'https://img1.gtimg.com/10/1048/104857/10485726_980x1200_0.jpg',
    	'https://img1.gtimg.com/10/1048/104857/10485729_980x1200_0.jpg'
  	],
  	success: function(res) {
    	console.log(res)
  	}
})
```

​		`JS-SDK` 是对之前的 `WeixinJSBridge` 的一个包装，以及新能力的释放，并且由对内开放转为了对所有开发者开放，在很短的时间内获得了极大的关注。从数据监控来看，绝大部分在微信内传播的移动网页都使用到了相关的接口。

​		`JS-SDK` 解决了移动网页能力不足的问题，通过暴露微信的接口使得 `Web` 开发者能够拥有更多的能力，然而在更多的能力之外，`JS-SDK` 的模式并没有解决使用移动网页遇到的体验不良的问题。用户在访问网页的时候，在浏览器开始显示之前都会有一个白屏的过程，在移动端，受限于设备性能和网络速度，白屏会更加明显。我们团队把很多技术精力放置在如何帮助平台上的 `Web` 开发者解决这个问题。因此我们设计了一个 `JS-SDK` 的增强版本，其中有一个重要的功能，称之为 **“微信 `Web` 资源离线存储”**。

​		以下文字引用自内部的文档（没有最终对外开放）：

> 微信 `Web` 资源离线存储是面向 `Web` 开发者提供的基于微信内的 `Web` 加速方案。
>
> 通过使用微信离线存储，`Web` 开发者可借助微信提供的资源存储能力，直接从微信本地加载 `Web` 资源而不需要再从服务端拉取，从而减少网页加载时间，为微信用户提供更优质的网页浏览体验。每个公众号下所有 `Web App` 累计最多可缓存 `5M` 的资源。

​		这个设计有点类似 `HTML5` 的 `Application Cache`，但在设计上规避了一些 `Application Cache` 的不足。

​		在内部测试中，我们发现离线存储能够解决一些问题，但对于一些复杂的页面依然会有白屏问题，例如页面加载了大量的 `CSS` 或者是 `JavaScript` 文件。除了白屏，影响 `Web` 体验的问题还有缺少操作的反馈，主要表现在两个方面：页面切换的生硬和点击的迟滞感。

​		微信面临的问题是如何设计一个比较好的系统，使得所有开发者在微信中都能获得比较好的体验。这个问题是之前的 `JS-SDK` 所处理不了的，需要一个全新的系统来完成，它需要使得所有的开发者都能做到：

- *快速的加载*
- *更强大的能力*
- *原生的体验*
- *易用且安全的微信数据开放*
- *高效和简单的开发*

​		这就是小程序的由来。

##### 与普通网页的区别

​		小程序的主要开发语言是 `JavaScript` ，小程序的开发同普通的网页开发相比有很大的相似性。对于前端开发者而言，从网页开发迁移到小程序的开发成本并不高，但是二者还是有些许区别的。

​		网页开发渲染线程和脚本线程是互斥的，这也是为什么长时间的脚本运行可能会导致页面失去响应，而在小程序中，二者是分开的，分别运行在不同的线程中。网页开发者可以使用到各种浏览器暴露出来的 `DOM API`，进行 `DOM` 选中和操作。而如上文所述，小程序的逻辑层和渲染层是分开的，逻辑层运行在 `JSCore` 中，并没有一个完整浏览器对象，因而缺少相关的 `DOM API` 和 `BOM API`。这一区别导致了前端开发非常熟悉的一些库，例如 `jQuery`、 `Zepto` 等，在小程序中是无法运行的。同时 `JSCore` 的环境同 `NodeJS` 环境也是不尽相同的，所以一些 `NPM` 的包在小程序中也无法运行。

​		网页开发者需要面对的环境是各式各样的浏览器，`PC` 端需要面对 `IE`、`Chrome` 浏览器等，在移动端需要面对 `Safari`、`Chrome` 以及 `iOS`、`Android` 系统中的各式 `WebView` 。而小程序开发过程中需要面对的是两大操作系统 `iOS` 和 `Android` 的微信客户端，以及用于辅助开发的小程序开发者工具。不过，小程序中的这三大运行环境也是有所区别的，如表所示。

|   **运行环境**   |    **逻辑层**    |     **渲染层**      |
| :--------------: | :--------------: | :-----------------: |
|      `iOS`       | `JavaScriptCore` |     `WKWebView`     |
|       安卓       |       `V8`       | `chromium` 定制内核 |
| 小程序开发者工具 |      `NWJS`      |  `Chrome WebView`   |

​		由于运行环境的不同，小程序无法调用浏览器的 `BOM` 和 `DOM` 的 `API`，所以它实现了自己的 `API`。如：支付 `API`、扫码 `API`等。

​		网页开发者在开发网页的时候，只需要使用到浏览器，并且搭配上一些辅助工具或者编辑器即可。小程序的开发则有所不同，需要经过申请小程序帐号、安装小程序开发者工具、配置项目等等过程方可完成。

更多参考：[小程序与普通网页开发的区别](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%8E%E6%99%AE%E9%80%9A%E7%BD%91%E9%A1%B5%E5%BC%80%E5%8F%91%E7%9A%84%E5%8C%BA%E5%88%AB) 

​		总结，主要有以下几点：

- 运行环境：网页开发 ==> 浏览器；微信小程序 ==> 微信客户端。
- `API` 不同：网页开发使用浏览器提供的 `API`；微信小程序使用微信客户端提供的 `API`。
- 开发模式：网页开发 ==> 浏览器 + 任意编辑器；小程序开发 ==> 注册小程序帐号、安装开发者工具、创建并配置小程序项目。

更多参考：[小程序简介](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%AE%80%E4%BB%8B) 

##### 体验小程序

​		开发者可使用微信客户端（6.7.2 及以上版本）扫码下方小程序码，体验小程序。也可[查看小程序示例源码](https://github.com/wechat-miniprogram/miniprogram-demo)。

​																	<img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82%E3%80%90%E8%B5%B7%E6%AD%A5%E3%80%91/image-20230202223350756.png" alt="image-20230202223350756" style="zoom:67%;" /> 

#### 开始

​		开发小程序的第一步，你需要拥有一个小程序帐号，通过这个帐号你就可以管理你的小程序。

##### 申请帐号

​		进入 [小程序注册页](https://mp.weixin.qq.com/wxopen/waregister?action=step1) 根据指引填写信息和提交相应的资料，就可以拥有自己的小程序帐号。

​		注册好小程序帐号之后，会进入一个小程序的管理页面。在这个小程序管理平台，你可以管理你的小程序的权限，查看数据报表，发布小程序等操作。登录 [小程序后台](https://mp.weixin.qq.com/) ，我们可以在菜单 “开发” -- “开发管理” -- “开发设置” -- “开发者 `ID`” 中看到小程序的 **`AppID`** 。

<img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82/image-20230201124540060.png" alt="image-20230201124540060" style="zoom:80%;" /> 

​		小程序的 `AppID` 相当于小程序平台的一个身份证，后续会在很多地方用到它（注意这里要区别于服务号或订阅号的 `AppID`）。有了小程序帐号之后，我们需要一个工具来开发小程序。

##### 开发工具

​		前往 [开发者工具下载页面](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html) ，根据自己的操作系统下载对应的安装包进行安装，有关开发者工具更详细的介绍可以查看 [《开发者工具介绍》](https://developers.weixin.qq.com/miniprogram/dev/devtools/devtools.html) 。

​		打开小程序开发者工具，用微信扫码登录开发者工具，准备开发你的第一个小程序吧！

##### 创建项目

​		新建项目选择小程序项目，选择代码存放的硬盘路径，填入刚刚申请到的小程序的 `AppID`，给你的项目起一个好听的名字，勾选 "不使用云服务" （注意：你要选择一个空的目录才可以创建项目），点击新建，你就得到了你的第一个小程序了，点击顶部菜单编译就可以在微信开发者工具中预览你的第一个小程序。

​		如果想得到一个干净的小程序，则可以在创建时的模板选择中，选择 “不使用模板”。

​                      <img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82/image-20230202142416563.png" alt="image-20230202142416563" style="zoom: 67%;" /> 

##### 编译预览

​		点击工具上的编译按钮，可以在工具的左侧模拟器界面看到这个小程序的表现，也可以点击预览按钮，通过微信的扫一扫在手机上体验你的第一个小程序。

<img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82/image-20230202142551488.png" alt="image-20230202142551488" style="zoom:80%;" /> 

更多参考：[开始你的第一个小程序](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/getstart.html) 



#### 项目构成

​		一个空白的小程序，通常由以下的基本文件构成：

- `pages`：用来存放所有小程序的页面（官方建议将每个页面都单独放在一个文件夹中）。
- `utils`：用来存放工具性质的模块（例如：格式化时间的定义模块）。
- `.eslintrc.js`：是一个名为 `ESLINT` 的工具的配置文件，目的是使代码更加一致并避免错误。
- `app.js`：小程序的项目入口文件。
- `app.json`：小程序项目的全局配置文件。
- `app.wxss`：小程序项目的全局样式文件。
- `project.config.json`：项目公共配置文件。
- `project.private.config.json`：项目个人配置文件，相同设置优先级高于公共配置文件。
- `sitemap.json`：用来配置小程序及其页面是否允许被微信索引。更多参考：[`sitemap` 配置](https://developers.weixin.qq.com/miniprogram/dev/framework/sitemap.html)。

​		前面，我们通过开发者工具快速创建了一个 `QuickStart` 项目。你可以留意到这个项目里边生成了不同类型的文件：

- `.json` 后缀的 `JSON` 配置文件
- `.wxml` 后缀的 `WXML` 模板文件
- `.wxss` 后缀的 `WXSS` 样式文件
- `.js` 后缀的 `JS` 脚本逻辑文件

​		接下来我们分别看看这 4 种文件的作用。

##### 配置文件

​		`JSON` 是一种数据格式，并不是一门编程语言，在小程序中，`JSON` 扮演着静态配置的角色。

​		我们可以看到在项目的根目录有一个 `app.json`、`project.config.json`、`project.private.config.json` 和 `sitemap.json`，此外在 `pages/index` 目录下还有一个 `index.json`，我们依次来说明一下它们的用途。

###### 全局配置

​		`app.json` 是当前小程序的全局配置，包括了小程序的所有页面路径、界面表现、网络超时时间、底部 `tab` 等。一个干净的项目里边的 `app.json` 配置内容如下：

```json
{
    "pages": [
        "pages/index/index"
    ],
    "window": {
        "backgroundTextStyle": "light",
        "navigationBarBackgroundColor": "#fff",
        "navigationBarTitleText": "Weixin",
        "navigationBarTextStyle": "black"
    },
    "style": "v2",
    "sitemapLocation": "sitemap.json"
}
```

​		我们简单说一下这个配置各个项的含义：

- `pages` 字段 —— 用于描述当前小程序所有页面路径，这是为了让微信客户端知道当前你的小程序页面定义在哪个目录。

- `window` 字段 —— 定义小程序所有页面的顶部背景颜色，文字颜色定义等。

​		在 `pages` 字段中填写的路径会被自动创建为对应的页面，其他配置项细节可以参考文档 [小程序的配置 `app.json`](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html)。

​		以下是一个包含了部分常用配置选项的 `app.json`：

```json
{
  	"pages": [
    	"pages/index/index",
    	"pages/logs/index"
  	],
  	"window": {
    	"navigationBarTitleText": "Demo"
  	},
  	"tabBar": {
    	"list": [{
      		"pagePath": "pages/index/index",
      		"text": "首页"
    	}, {
      		"pagePath": "pages/logs/index",
      		"text": "日志"
    	}]
  	},
  	"networkTimeout": {
    	"request": 10000,
    	"downloadFile": 10000
  	},
  	"debug": true
}
```

###### 工具配置

​		通常大家在使用一个工具的时候，都会针对各自喜好做一些个性化配置，例如界面颜色、编译配置等等，当你换了另外一台电脑重新安装工具的时候，你还要重新配置。

​		考虑到这点，小程序开发者工具在每个项目的根目录都会生成一个 `project.config.json`，你在工具上做的任何配置都会写入到这个文件，当你重新安装工具或者换电脑工作时，你只要载入同一个项目的代码包，开发者工具就自动会帮你恢复到当时你开发项目时的个性化配置，其中会包括编辑器的颜色、代码上传时自动压缩等等一系列选项。

​		其他配置项细节可以参考文档 [开发者工具的配置](https://developers.weixin.qq.com/miniprogram/dev/devtools/projectconfig.html)。

​		除了 `project.config.json` 文件，还有一个 `project.private.config.json` 文件。前者是项目的公共配置，后者是项目的个人配置，同样的配置后者优先于前者。值得注意的是，项目名称（`projectname`）字段被移到了个人配置文件中。

​		一个空白小程序项目的公共工具配置中，通常有如下的配置：

```json
{
  	"appid": "wx8dacfc14f55a4a8e",
  	"compileType": "miniprogram",
  	"libVersion": "2.30.0",
  	"packOptions": {
    	"ignore": [],
    	"include": []
  	},
  	"setting": {
    	"coverView": true,
    	"es6": true,
    	"postcss": true,
    	"minified": true,
    	"enhance": true,
    	"showShadowRootInWxmlPanel": true,
    	"packNpmRelationList": [],
    	"babelSetting": {
      		"ignore": [],
      		"disablePlugins": [],
      		"outputPath": ""
    	}
  	},
  	"condition": {},
  	"editorSetting": {
    	"tabIndent": "insertSpaces",
    	"tabSize": 2
  	}
}
```

​		一个空白小程序项目的个人工具配置中，通常有如下的配置：

```json
{
  	"description": "项目私有配置文件。此文件中的内容将覆盖 project.config.json 中的相同字段。项目的改动优先同步到此文件中。详见文档：https://developers.weixin.qq.com/miniprogram/dev/devtools/projectconfig.html",
  	"projectname": "miniprogram-1",
  	"setting": {
    	"compileHotReLoad": true
  	}
}
```

###### 页面配置

​		这里的 `page.json` 其实用来表示 `pages` 目录下的小程序各个页面的配置文件。

​		如果你整个小程序的风格是蓝色调，那么你可以在 `app.json` 里边声明顶部颜色是蓝色即可。实际情况可能不是这样，可能你小程序里边的每个页面都有不一样的色调来区分不同功能模块，因此我们提供了 `page.json`，让开发者可以独立定义每个页面的一些属性，例如刚刚说的顶部颜色、是否允许下拉刷新等等。

​		其他配置项细节可以参考文档 [页面配置](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#页面配置)。

​		常见的页面配置如下：

```json
{
  	"navigationBarBackgroundColor": "#ffffff",
  	"navigationBarTextStyle": "black",
  	"navigationBarTitleText": "微信接口功能演示",
  	"backgroundColor": "#eeeeee",
  	"backgroundTextStyle": "light"
}
```

###### `JSON` 语法

​		这里说一下小程序里 `JSON` 配置的一些注意事项。

​		`JSON`文件都是被包裹在一个大括号中 `{}`，通过 `key-value` 的方式来表达数据。`JSON` 的 `Key` 必须包裹在一个双引号中，在实践中，编写 `JSON` 的时候，忘了给 K~ey 值加双引号或者是把双引号写成单引号是常见错误。

​		`JSON` 的值只能是以下几种数据格式，其他任何格式都会触发报错，例如 `JavaScript` 中的 `undefined`。

- 数字：包含浮点数和整数。
- 字符串：需要包裹在双引号中
- `Bool` 值：`true` 或者 `false`
- 数组：需要包裹在方括号中 `[]`
- 对象：需要包裹在大括号中 `{}`
- `Null`

​		还需要注意的是 `JSON` 文件中**无法使用注释**，试图添加注释将会引发报错。

##### 模板文件

​		从事过网页编程的人知道，网页编程采用的是 `HTML + CSS + JS` 这样的组合，其中 `HTML` 是用来描述当前这个页面的结构，`CSS` 用来描述页面的样子，`JS` 通常是用来处理这个页面和用户的交互。

​		同样道理，在小程序中也有同样的角色，其中 `WXML` 充当的就是类似 `HTML` 的角色。打开 `pages/index/index.wxml`，你会看到以下的内容：

```html
<view class="container">
  <view class="userinfo">
    <button wx:if="{{!hasUserInfo && canIUse}}"> 获取头像昵称 </button>
    <block wx:else>
      <image src="{{userInfo.avatarUrl}}" background-size="cover"></image>
      <text class="userinfo-nickname">{{userInfo.nickName}}</text>
    </block>
  </view>
  <view class="usermotto">
    <text class="user-motto">{{motto}}</text>
  </view>
</view>
```

​		和 `HTML` 非常相似，`WXML` 由标签、属性等等构成。但是也有很多不一样的地方，我们来一一阐述一下：

- 标签名不一样

  ​		往往写 `HTML` 的时候，经常会用到的标签是 `div`，`p`，`span`，开发者在写一个页面的时候可以根据这些基础的标签组合出不一样的组件，例如日历、弹窗等等。换个思路，既然大家都需要这些组件，为什么我们不能把这些常用的组件包装起来，大大提高我们的开发效率。

  ​		从上边的例子可以看到，小程序的 `WXML` 用的标签是 `view`，`button`，`text` 等等，这些标签就是**小程序给开发者包装好的**基本能力，我们还提供了地图、视频、音频等等组件能力。更多详细的组件讲述参考：[小程序的能力](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/framework.html)。

- 多了一些 `wx:if` 这样的属性以及 `{{}}` 这样的表达式

  ​		在网页的一般开发流程中，我们通常会通过 `JS` 操作 `DOM`（对应 `HTML` 的描述产生的树），以引起界面的一些变化响应用户的行为。例如，用户点击某个按钮的时候，`JS` 会记录一些状态到 `JS` 变量里边，同时通过 `DOM API` 操控 `DOM` 的属性或者行为，进而引起界面一些变化。当项目越来越大的时候，你的代码会充斥着非常多的界面交互逻辑和程序的各种状态变量，显然这不是一个很好的开发模式，因此就有了 `MVVM` 的开发模式（例如 `React`，`Vue`），提倡把渲染和逻辑分离。简单来说就是不要再让 `JS` 直接操控 `DOM`，`JS` 只需要管理状态即可，然后再通过一种模板语法来描述状态和界面结构的关系即可。

​		小程序的框架也是用到了这个思路，如果你需要把一个 `Hello World` 的字符串显示在界面上。

​		`WXML` 是这么写：

```html
<text>{{msg}}</text>
```

​		`JS` 只需要管理状态即可：

```js
this.setData({ msg: "Hello World" })
```

​		通过 `{{}}` 的语法把一个变量绑定到界面上，我们称为**数据绑定**。仅仅通过数据绑定还不够完整的描述状态和界面的关系，还需要 `if`/`else`，`for` 等控制能力，在小程序里边，这些控制能力都用 `wx:` 开头的属性来表达。

​		更详细的文档可以参考 [`WXML`](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/)。

##### 样式文件

​		`WXSS` 具有 `CSS` 大部分的特性，小程序在 `WXSS` 也做了一些扩充和修改。

- 新增了尺寸单位：在写 `CSS` 样式时，开发者需要考虑到手机设备的屏幕会有不同的宽度和设备像素比，采用一些技巧来换算一些像素单位。`WXSS` 在底层支持新的尺寸单位 `rpx` ，开发者可以免去换算的烦恼，只要交给小程序底层来换算即可，由于换算采用的浮点数运算，所以运算结果会和预期结果有一点点偏差。

- 提供了全局的样式和局部样式：和前边 `app.json`，`page.json` 的概念相同，你可以写一个 `app.wxss` 作为全局样式，会作用于当前小程序的所有页面，局部页面样式 `page.wxss` 仅对当前页面生效。

- 此外 `WXSS` 仅支持部分 `CSS` 选择器。

​		更详细的文档可以参考 [`WXSS`](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html)。

##### 逻辑文件

​		一个服务仅仅只有界面展示是不够的，还需要和用户做交互：响应用户的点击、获取用户的位置等等。在小程序里边，我们就通过编写 `JS` 脚本文件来处理用户的操作。

```html
<view>{{ msg }}</view>
<button bindtap="clickMe">点击我</button>
```

​		点击 `button` 按钮的时候，我们希望把界面上 `msg` 显示成 `"Hello World"`，于是我们在 `button` 上声明一个属性：`bindtap` ，在 `JS` 文件里边声明了 `clickMe` 方法来响应这次点击操作：

```js
Page({
  	clickMe: function() {
    	this.setData({ msg: "Hello World" })
  	}
})
```

​		响应用户的操作就是这么简单，更详细的事件可以参考文档 [`WXML` - 事件](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/event.html)。

​		此外你还可以在 `JS` 中调用小程序提供的丰富的 `API`，利用这些 `API` 可以很方便的调起微信提供的能力，例如获取用户信息、本地存储、微信支付等。更多 `API` 可以参考文档 [小程序的 `API`](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/api.html) 。

​		通过这个章节，你了解了小程序涉及到的文件类型以及对应的角色，在[下个章节](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/framework.html)中，我们把这一章所涉及到的文件通过 “小程序的框架” 给 “串” 起来，让他们都工作起来。



#### 宿主环境

​		我们称微信客户端给小程序所提供的环境为**宿主环境**。小程序借助宿主环境提供的能力，可以完成许多普通网页无法完成的功能。

​		前面，我们把小程序涉及到的文件类型阐述了一遍，我们结合 `QuickStart` 这个项目来讲一下这些文件是怎么配合工作的。

##### 运行环境

​		首先，我们来简单了解下小程序的运行环境。**小程序的运行环境分成渲染层和逻辑层**，其中 `WXML` 模板和 `WXSS` 样式工作在渲染层，`JS` 脚本工作在逻辑层。

​		小程序的渲染层和逻辑层分别由 2 个线程管理：渲染层的界面使用了 `WebView` 进行渲染；逻辑层采用 `JsCore` 线程运行 `JS` 脚本。一个小程序存在多个界面，所以渲染层存在多个 `WebView` 线程，这两个线程的通信会经由微信客户端（下文中也会采用 `Native` 来代指微信客户端）做中转，逻辑层发送网络请求也经由 `Native` 转发，小程序的通信模型下图所示。

​                                   <img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82/image-20230202164817286.png" alt="image-20230202164817286" style="zoom: 67%;" />  

​		有关渲染层和逻辑层的详细文档参考 [小程序框架](https://developers.weixin.qq.com/miniprogram/dev/framework/MINA.html) 。

##### 程序与页面

​		微信客户端在打开小程序之前，会把整个小程序的代码包下载到本地。

​		紧接着通过 `app.json` 的 `pages` 字段就可以知道你当前小程序的所有页面路径：

```json
{
	"pages":[
    	"pages/index/index",
    	"pages/logs/logs"
  	]
}
```

​		这个配置说明在 `QuickStart` 项目定义了两个页面，分别位于 `pages/index/index` 和 `pages/logs/logs`。而写在 `pages` 字段的第一个页面就是这个小程序的首页（打开小程序看到的第一个页面）。

​		于是微信客户端就把首页的代码装载进来，通过小程序底层的一些机制，就可以渲染出这个首页。

​		小程序启动之后，在 `app.js` 定义的 `App` 实例的 `onLaunch` 回调会被执行：

```js
App({
  	onLaunch: function () {
    	// 小程序启动之后触发
  	}
})
```

​		整个小程序只有一个 `App` 实例，是全部页面共享的，更多的事件回调参考文档 [注册程序 `App`](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/app.html) 。

​		接下来我们简单看看小程序的一个页面是怎么写的。

​		你可以观察到 `pages/logs/logs` 下其实是包括了 4 种文件的，微信客户端会先根据 `logs.json` 配置生成一个界面，顶部的颜色和文字你都可以在这个 `json` 文件里边定义好。紧接着客户端就会装载这个页面的 `WXML` 结构和 `WXSS` 样式。最后客户端会装载 `logs.js` ，你可以看到 `logs.js` 的大体内容就是：

```js
Page({
  	data: { // 参与页面渲染的数据
    	logs: []
  	},
  	onLoad: function () {
    	// 页面渲染后执行
  	}
})
```

​		`Page` 是一个页面构造器，这个构造器就生成了一个页面。在生成页面的时候，小程序框架会把 `data` 数据和 `index.wxml` 一起渲染出最终的结构，于是就得到了你看到的小程序的样子。

​		在渲染完界面之后，页面实例就会收到一个 `onLoad` 的回调，你可以在这个回调处理你的逻辑。

​		有关于 `Page` 构造器更多详细的文档参考 [注册页面 `Page`](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/page.html) 。

##### 组件

​		小程序提供了丰富的基础组件给开发者，开发者可以像搭积木一样，组合各种组件拼合成自己的小程序。

​		就像 `HTML` 的 `div`，`p` 等标签一样，在小程序里边，你只需要在 `WXML` 写上对应的组件标签名字就可以把该组件显示在界面上，例如，你需要在界面上显示地图，你只需要这样写即可：

```html
<map></map>
```

​		使用组件的时候，还可以通过属性传递值给组件，让组件可以以不同的状态去展现，例如，我们希望地图一开始的中心的经纬度是广州，那么你需要声明地图的 `longitude`（中心经度） 和 `latitude`（中心纬度）两个属性：

```html
<map longitude="广州经度" latitude="广州纬度"></map>
```

​		组件的内部行为也会通过事件的形式让开发者可以感知，例如用户点击了地图上的某个标记，你可以在 `js` 编写 `markertap` 函数来处理：

```html
<map bindmarkertap="markertap" longitude="广州经度" latitude="广州纬度"></map>
```

​		当然你也可以通过 `style` 或者 `class` 来控制组件的外层样式，以便适应你的界面宽高度等等。

​		更多的组件可以参考 [小程序的组件](https://developers.weixin.qq.com/miniprogram/dev/component/)。

##### `API`

​		为了让开发者可以很方便的调起微信提供的能力，例如获取用户信息、微信支付等等，小程序提供了很多 `API` 给开发者去使用。

​		要获取用户的地理位置时，只需要：

```js
wx.getLocation({
  	type: 'wgs84',
  	success: (res) => {
    	var latitude = res.latitude // 纬度
    	var longitude = res.longitude // 经度
  	}
})
```

​		调用微信扫一扫能力，只需要：

```js
wx.scanCode({
  	success: (res) => {
    	console.log(res)
  	}
})
```

​		需要注意的是：多数 `API` 的回调都是异步，你需要处理好代码逻辑的异步问题。更多的 `API` 能力见 [小程序的 `API`](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/api.html)。

​		通过这个章节你已经大概了解了小程序运行的一些基本概念，当你开发完一个小程序之后，你就需要发布你的小程序。在[下个章节](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/release.html)，你会知道发布前需要做什么准备。



#### 协同工作与发布

​		在中大型的公司里，人员的分工非常仔细，一般会有不同岗位角色的员工同时参与同一个小程序项目。为此，小程序平台设计了不同的权限管理使得项目管理者可以更加高效管理整个团队的协同工作。

​		以往我们在开发完网页之后，需要把网页的代码和资源放在服务器上，让用户通过互联网来访问。在小程序的平台里，开发者完成开发之后，需要在开发者工具提交小程序的代码包，然后在[小程序后台](https://mp.weixin.qq.com/)发布小程序，用户可以通过搜索或者其它入口来进入该小程序。

​		在这一章我们会把团队的协同工作的注意事项和小程序发布前后涉及的概念和流程做一些介绍。

##### 协同工作

​		如果你只是一个人开发小程序，可以暂时先跳过这部分，如果是一个团队需要先了解一些概念。

​		多数情况下，一个团队多人同时参与同一个小程序项目，每个角色所承担的工作或者权限不一样，中大公司的分工更为仔细。为了更形象的表达团队不同角色的关系以及权限的管理，我们通过虚拟一个项目成员组织结构来描述日常如何协同合作完成一个小程序的发布，组织关系如图所示。

​		                                              <img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82/image-20230202175306785.png" alt="image-20230202175306785" style="zoom: 67%;" /> 

​		项目管理成员负责统筹整个项目的进展和风险、把控小程序对外发布的节奏，产品组提出需求，设计组与产品讨论并对需求进行抽象，设计出可视化流程与图形，输出设计方案。开发组依据设计方案，进行程序代码的编写，代码编写完成后，产品组与设计组体验小程序的整体流程，测试组编写测试用例并对小程序进行各种边界测试。项目一般的成员构成与工作流程如图所示。

​                                        		<img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82/image-20230202175443543.png" alt="image-20230202175443543" style="zoom:67%;" /> 

##### 成员管理

​		小程序成员管理包括对小程序项目成员及体验成员的管理。

- 项目成员：表示参与小程序开发、运营的成员，可登录小程序管理后台，包括运营者、开发者及数据分析者。管理员可在 “成员管理” 中添加、删除项目成员，并设置项目成员的角色。
- 体验成员：表示参与小程序内测体验的成员，可使用体验版小程序，但不属于项目成员。管理员及项目成员均可添加、删除体验成员。

​		不同项目成员拥有不同的权限，从而保证小程序开发安全有序。

|      权限      | 运营者 | 开发者 | 数据分析者 |
| :------------: | :----: | :----: | :--------: |
|   开发者权限   |        |   √    |            |
|   体验者权限   |   √    |   √    |     √      |
|      登录      |   √    |   √    |     √      |
|    数据分析    |        |        |     √      |
|    微信支付    |   √    |        |            |
|      推广      |   √    |        |            |
|    开发管理    |   √    |        |            |
|    开发设置    |        |   √    |            |
|    暂停服务    |   √    |        |            |
| 解除关联公众号 |   √    |        |            |
|   腾讯云管理   |        |   √    |            |
|   小程序插件   |   √    |        |            |
|  游戏运营管理  |   √    |        |            |

​		各权限功能说明

- 开发者权限：可使用小程序开发者工具及开发版小程序进行开发
- 体验者权限：可使用体验版小程序
- 登录：可登录小程序管理后台，无需管理员确认
- 数据分析：使用小程序统计模块功能查看小程序数据
- 微信支付：使用小程序微信支付（虚拟支付）模块
- 推广：使用小程序流量主、广告主模块
- 开发管理：小程序提交审核、发布、回退
- 开发设置：设置小程序服务器域名、消息推送及扫描普通链接二维码打开小程序
- 暂停服务设置：暂停小程序线上服务
- 解除关联公众号：可解绑小程序已关联的公众号
- 小程序插件：可进行小程序插件开发管理和设置
- 游戏运营管理：可使用小游戏管理后台的素材管理、游戏圈管理等功能

​		需要留意，项目管理者控制整个小程序的发布、回退、下架等敏感操作，不应把敏感操作的权限分配给不相关人员。

##### 项目版本

​		一般的软件开发流程，开发者编写代码自测开发版程序，直到程序达到一个稳定可体验的状态时，开发者会把这个体验版本给到产品经理和测试人员进行体验测试，最后修复完程序的 `Bug` 后发布供外部用户正式使用。小程序的版本根据这个流程设计了小程序版本的概念，如表所示。

|  **权限**  | **说明**                                                     |
| :--------: | :----------------------------------------------------------- |
|  开发版本  | 使用开发者工具，可将代码上传到开发版本中。 <br />开发版本只保留每人最新的一份上传的代码。 点击提交审核，可将代码提交审核。<br />开发版本可删除，不影响线上版本和审核中版本的代码。 |
|  体验版本  | 可以选择某个开发版本作为体验版，并且选取一份体验版。         |
| 审核中版本 | 只能有一份代码处于审核中。有审核结果后可以发布到线上，也可直接重新提交审核，覆盖原审核版本。 |
|  线上版本  | 线上所有用户使用的代码版本，该版本代码在新版本代码发布后被覆盖更新。 |

​		考虑到项目是协同开发的模式，一个小程序可能同时由多个开发者进行开发，往往开发者在小程序开发者工具上编写完代码后需要到手机进行真机体验，所以每个开发者拥有自己对应的一个开发版本。因为处于开发中的版本是不稳定的，开发者随时会修改代码覆盖开发版，为了让测试和产品经理有一个完整稳定的版本可以体验测试，小程序平台允许把其中一个开发版本设置成体验版，因此建议在项目开发阶段特殊分配一个开发角色，用于上传稳定可供体验测试的代码，并把他上传的开发版本设置成体验版。

##### 发布上线

​		一个小程序从开发完到上线一般要经过：预览效果 ==> 上传代码 ==> 提交审核 ==> 发布上线等步骤。

###### 预览效果

​		使用开发者工具可以预览小程序，帮助开发者检查小程序在移动客户端上的真实表现。

​		点击开发者工具顶部操作栏的预览按钮，开发者工具会自动打包当前项目，并上传小程序代码至微信的服务器，成功之后会在界面上显示一个二维码。使用当前小程序开发者的微信扫码即可看到小程序在手机客户端上的真实表现。

###### 上传代码

​		同预览不同，上传代码是用于提交体验或者审核使用的。

​		点击开发者工具顶部操作栏的上传按钮，填写版本号以及项目备注，需要注意的是，这里版本号以及项目备注是为了方便管理员检查版本使用的，开发者可以根据自己的实际要求来填写这两个字段。

​		上传成功之后，“登录[小程序管理后台](https://mp.weixin.qq.com/) -- 版本管理 -- 开发版本” 就可以找到刚提交上传的版本了。

​		可以将这个版本设为体验版或者是提交审核。

###### 提交审核

​		为了保证小程序的质量，以及符合相关的规范，小程序的发布是需要经过审核的。

​		在开发者工具中上传了小程序代码之后，“登录[小程序管理后台](https://mp.weixin.qq.com/) -- 版本管理 -- 开发版本” 找到提交上传的版本。

​		在开发版本的列表中，点击**提交审核**按照页面提示，填写相关的信息，即可以将小程序提交审核。

​		需要注意的是，**请开发者严格测试了版本之后，再提交审核**，过多的审核不通过，可能会影响后续的时间。

###### 发布上线

​		审核通过之后，管理员的微信中会收到小程序通过审核的通知，此时登录 [小程序管理后台](https://mp.weixin.qq.com/) - 开发管理 - 审核版本中可以看到通过审核的版本。

​		点击发布后，即可发布小程序。小程序提供了两种发布模式：全量发布和分阶段发布。全量发布是指当点击发布之后，所有用户访问小程序时都会使用当前最新的发布版本。分阶段发布是指分不同时间段来控制部分用户使用最新的发布版本，分阶段发布我们也称为**灰度发布**。一般来说，普通小程序发布时采用全量发布即可，当小程序承载的功能越来越多，使用的用户数越来越多时，采用分阶段发布是一个非常好的控制风险的办法。

###### 小程序码

​		很多场景下用户会通过扫码快速进入一个小程序，在小程序设计的初期，小程序平台提供了二维码的形式。我们发现用户在扫一个二维码时，他并不知道当前这次扫码会出现什么样的服务，因为二维码的背后有可能是公众号、小程序、网页服务、支付页面、添加好友等不同的服务。为了让用户在扫码之前就有一个明确的预期，因此微信设计了小程序码，如图所示。

​                                                                            		<img src="images/%E7%AC%AC%E4%B8%80%E8%8A%82/image-20230202212658941.png" alt="image-20230202212658941" style="zoom:50%;" />  

​		小程序码在样式上更具辨识度和视觉冲击力，相对于二维码来说，小程序主题的品牌形象更加清晰明显，可以帮助开发者更好地推广小程序。在发布小程序之后，小程序管理平台会提供对应的小程序码的预览和下载，开发者可以自行下载用于线上和线下的小程序服务推广。

##### 运营数据

​		有两种方式可以方便地看到小程序的[运营数据](https://developers.weixin.qq.com/miniprogram/analysis/index.html)：

- 方法一：登录[小程序管理后台](https://mp.weixin.qq.com/) -- 统计（点击相应的 `tab` 可以看到相关的数据）。

- 方法二：使用小程序数据助手，在微信中方便地查看运营数据。



#### 开发指南

更多参考：[小程序开发指南](https://developers.weixin.qq.com/ebook?action=get_post_info&docid=0008aeea9a8978ab0086a685851c0a)。



#### 目录结构

​		小程序包含一个描述整体程序的 `app` 和多个描述各自页面的 `page`。

​		一个小程序主体部分由三个文件组成，必须放在项目的根目录，如下：

|                             文件                             |  必需  |       作用       |
| :----------------------------------------------------------: | :----: | :--------------: |
| [`app.js`](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/app.html) | **是** |    小程序逻辑    |
| [`app.json`](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html) | **是** |  小程序公共配置  |
| [`app.wxss`](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html) |   否   | 小程序公共样式表 |

​		一个小程序页面由四个文件组成，分别是：

|                           文件类型                           |  必需  |    作用    |
| :----------------------------------------------------------: | :----: | :--------: |
| [`js`](https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/page.html) | **是** |  页面逻辑  |
| [`wxml`](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/) | **是** |  页面结构  |
| [`json`](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#页面配置) |   否   |  页面配置  |
| [`wxss`](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html) |   否   | 页面样式表 |

​		**注意：为了方便开发者减少配置项，描述页面的四个文件必须具有相同的路径与文件名。**

##### 允许上传的文件

​		在项目目录中，以下文件会经过编译，因此上传之后无法直接访问到：*`.js`、`app.json`、*`.wxml`、`*.wxss`（其中 `wxml` 和 `wxss` 文件仅针对在 `app.json` 中配置了的页面）。除此之外，只有后缀名在白名单内的文件可以被上传，不在白名单列表内文件在开发工具能被访问到，但无法被上传。具体白名单列表如下：

|   1    |   2   |   3    |   4    |   5   |   6    |
| :----: | :---: | :----: | :----: | :---: | :----: |
| `wxs`  | `png` | `jpg`  | `jpeg` | `gif` | `svg`  |
| `json` | `cer` | `mp3`  | `aac`  | `m4a` | `mp4`  |
| `wav`  | `ogg` | `silk` | `wasm` | `br`  | `cert` |

